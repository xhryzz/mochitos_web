<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Regla - Mochita</title>
<link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">

<!-- ====== Estilos ====== -->
<style>
@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Dancing+Script:wght@700&display=swap');

:root{
  --primary:#e84393; --secondary:#fd79a8; --accent:#a29bfe;
  --ink:#2d3436; --muted:#6b7280; --card:#fff; --line:#eee;
  --shadow:0 15px 30px rgba(0,0,0,.08);
  --gradient:linear-gradient(135deg,#e84393,#fd79a8 50%,#a29bfe);

  --flow-none:#e5e7eb; --flow-low:#60a5fa; --flow-mid:#f59e0b; --flow-high:#ef4444;
  --secondary-color:var(--accent);
}

*{box-sizing:border-box}
html,body{margin:0;padding:0}
body{
  font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  color:var(--ink); background:linear-gradient(135deg,#ffe8f3,#dfe6e9); min-height:100vh; padding:16px;
}

/* Contenedor y cabecera */
.container{
  background:var(--card); border-radius:20px; box-shadow:var(--shadow);
  overflow:hidden; max-width:1100px; margin:24px auto; border:1px solid rgba(255,255,255,.6);
}
.container > h1{
  font-family:'Dancing+Script',cursive; font-size:42px; margin:0; padding:22px 16px 8px;
  text-align:center; background:var(--gradient); -webkit-background-clip:text; background-clip:text;
  color:transparent; text-shadow:0 3px 6px rgba(0,0,0,.15);
}
.subtitle{
  margin:0 0 18px; text-align:center; color:#fff; padding:0 16px 18px;
  background:var(--gradient); border-bottom:1px solid rgba(255,255,255,.3); font-weight:600; opacity:.95;
}

/* Tarjetas */
.card{ background:#fff; border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:var(--shadow); margin:18px; }

/* Toolbar minimal */
.toolbar{
  display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:space-between;
  background:#fafafa; border:1px solid #eee; border-radius:16px; padding:14px 16px; box-shadow:0 6px 14px rgba(0,0,0,.05);
}
.toolbar .left, .toolbar .right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.pill{
  padding:10px 14px; border:none; border-radius:999px; background:#eee; font-weight:700; cursor:pointer;
  transition:.2s; box-shadow:0 6px 14px rgba(0,0,0,.06);
}
.pill:hover{ transform:translateY(-2px) }
.pill.primary{ color:#fff; background:var(--primary) }
.pill.accent{ color:#fff; background:var(--accent) }
.pill.danger{ color:#fff; background:#ff7675 }
.pill[disabled]{ opacity:.55; cursor:not-allowed; transform:none }
select.pill{ background:#fff; border:2px solid #eee; }

/* Calendario */
.cal-head{ display:flex; align-items:center; gap:10px; margin-bottom:10px; padding:4px 0 8px; border-bottom:1px solid #f0f0f0; }
.arrow{
  width:40px; height:40px; border:none; border-radius:12px; background:#fff; cursor:pointer; display:grid; place-items:center;
  box-shadow:0 6px 14px rgba(0,0,0,.06); transition:.2s;
}
.arrow:hover{ transform:translateY(-2px); background:#f7f7f7 }
.month-title{ font-weight:800; font-size:1.15rem }

.week{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-bottom:8px; color:#6b7280; font-weight:700; text-transform:uppercase; font-size:.85rem }
.grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:8px }
.day{
  position:relative; background:#fff; border:1px solid #eee; border-radius:14px;
  min-height:96px; padding:10px; display:flex; flex-direction:column; gap:8px;
  box-shadow:0 6px 14px rgba(0,0,0,.04); transition:.15s;
}
.day:hover{ transform:translateY(-2px); box-shadow:0 10px 22px rgba(0,0,0,.08) }
.day.muted{ background:#fafafa }
.day.today{ outline:2px dashed var(--secondary-color); outline-offset:-6px; background:#fcfcff }
.day .top{
  display:flex; align-items:center; justify-content:space-between; gap:6px;
}
.day .num{ font-weight:800 }
.mood-btn{
  min-width:34px; height:28px; padding:0 8px; border:none; border-radius:999px; background:#f5f5f5; cursor:pointer;
  font-weight:800; display:flex; align-items:center; justify-content:center; box-shadow:0 1px 4px rgba(0,0,0,.06);
  opacity:.9;
}
.mood-btn[disabled]{ opacity:.5; cursor:not-allowed }
.mood-btn:hover{ filter:brightness(1.02) }

/* Indicador de flujo (clicable) */
.flow-dot{ width:100%; height:12px; border-radius:7px; background:var(--flow-none); margin-top:auto; border:1px solid rgba(0,0,0,.05); cursor:pointer }
.flow-low{  background:var(--flow-low) }
.flow-mid{  background:var(--flow-mid) }
.flow-high{ background:var(--flow-high) }
.flow-none{ background:var(--flow-none) }

/* Selecci√≥n rango (vista previa) */
.day.range{ box-shadow:0 0 0 3px rgba(232,67,147,.25) inset }

/* Inicio / fin */
.day.start-day{ box-shadow:0 0 0 3px rgba(232,67,147,.55), 0 10px 24px rgba(232,67,147,.18); border-color:#fda4af }
.day.end-day{   box-shadow:0 0 0 3px rgba(162,155,254,.55), 0 10px 24px rgba(162,155,254,.18); border-color:#c7d2fe }
.flag{
  position:absolute; top:6px; right:6px; font-size:.75rem; padding:3px 8px; border-radius:999px; border:1px solid; font-weight:800;
}
.flag.start{ background:#ffe4e6; border-color:#fecdd3; color:#9f1239; right:auto; left:6px }
.flag.end{   background:#ede9fe; border-color:#ddd6fe; color:#4c1d95 }

.help{ color:var(--muted); font-size:.9rem; text-align:center; padding:6px 0 }

/* Responsivo */
@media (max-width:640px){
  .container > h1{ font-size:34px }
  .day{ min-height:86px }
}
</style>
</head>
<body>
<div class="container">
  <h1>Regla Mochita</h1>
  <p class="subtitle">Click en la <b>barra de color</b> para flujo ¬∑ Click en el <b>emoji</b> para √°nimo ¬∑ Rango para varios d√≠as.</p>

  <!-- Toolbar simplificada -->
  <div class="toolbar card">
    <div class="left">
      <button class="pill" id="rangeToggle" aria-pressed="false">üìè Modo rango</button>
      <label style="font-weight:700;">Flujo:</label>
      <select id="rangeFlow" class="pill">
        <option value="poco">poco</option>
        <option value="medio" selected>medio</option>
        <option value="mucho">mucho</option>
      </select>
      <button class="pill primary" id="applyRange" disabled>üíæ Guardar rango</button>
      <button class="pill danger" id="clearRange" disabled>üóëÔ∏è Borrar rango</button>
    </div>
    <div class="right">
      <button class="pill" id="todayBtn">Hoy</button>
    </div>
  </div>

  <div class="card">
    <div class="cal-head">
      <button class="arrow" id="prevBtn" aria-label="Mes anterior">‚Äπ</button>
      <div class="month-title" id="monthTitle">‚Äî</div>
      <button class="arrow" id="nextBtn" aria-label="Mes siguiente">‚Ä∫</button>
    </div>
    <div class="week"><div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div><div>Dom</div></div>
    <div class="grid" id="daysGrid"></div>
    <div class="help" id="rangeHelp" style="display:none;">Elige <b>inicio</b> y <b>fin</b> con un click.</div>
  </div>
</div>

<script>
// ------- Permisos (solo mochita edita) -------
const CAN_EDIT = {{ 'true' if (session.get('username')=='mochita') else 'false' }};

// ------- Helpers DOM -------
const $ = (s,p=document)=>p.querySelector(s);
const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));

// ------- Fechas -------
const MONTHS = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
const pad=n=>n<10?'0'+n:n;
const iso=(y,m,d)=>`${y}-${pad(m)}-${pad(d)}`;
const parseIso=s=>{const [Y,M,D]=s.split('-').map(Number); return new Date(Y,M-1,D);};
const addDays=(dt,n)=>{const d=new Date(dt); d.setDate(d.getDate()+n); return d;};
const toIsoDate=d=>iso(d.getFullYear(), d.getMonth()+1, d.getDate());
const daysInMonth=(y,m)=>new Date(y,m,0).getDate();
const firstWeekday=(y,m)=>{const js=new Date(y,m-1,1).getDay(); return (js+6)%7;};
const isToday=(y,m,d)=>{const t=new Date();return t.getFullYear()==y && t.getMonth()+1==m && t.getDate()==d;};

// ------- API -------
const API_LIST='/api/cycle';
const SAVE_DAY='/cycle/save';
const DEL_DAY='/cycle/delete';

// ------- Estado -------
const state = {
  y:(new Date()).getFullYear(),
  m:(new Date()).getMonth()+1,
  entries:{}, // { 'YYYY-MM-DD': {mood, flow} }
  range:{start:null,end:null},
  rangeMode:false
};

// ------- √Ånimos / Flujo -------
const MOOD_ORDER = ['', 'feliz','normal','triste','estresada','sensible','cansada','irritable','con_energia'];
const MOOD_EMO = { feliz:'üòÄ', normal:'üôÇ', triste:'üòî', estresada:'üòµ‚Äçüí´', sensible:'ü•∫', cansada:'üò¥', irritable:'üò†', con_energia:'‚ö°' };
const nextMood = (m)=>MOOD_ORDER[(MOOD_ORDER.indexOf(m)+1) % MOOD_ORDER.length];

const FLOW_ORDER = ['','poco','medio','mucho'];
const nextFlow = (f)=>FLOW_ORDER[(FLOW_ORDER.indexOf(f)+1) % FLOW_ORDER.length];

// ------- Carga (3 meses centrados) -------
function ymPrev(y,m){ const d=new Date(y,m-2,1); return [d.getFullYear(), d.getMonth()+1]; }
async function loadMonth(){
  const [py, pm] = ymPrev(state.y, state.m);
  const from = `${py}-${pad(pm)}`;
  const url = `${API_LIST}?from=${from}&months=3&user=mochita`;
  try{
    const res = await fetch(url, {credentials:'same-origin'});
    const j = await res.json();
    const map={};
    (j.entries||[]).forEach(e=>{
      const day=(e.day||e.date||'').trim(); if(!day) return;
      map[day]={ mood:(e.mood||'')||'', flow:(e.flow||'')||'' };
    });
    state.entries = map;
  }catch(e){ state.entries = {}; }
  renderCalendar();
}

// ------- Render -------
function setMonthTitle(){ $('#monthTitle').textContent = `${MONTHS[state.m-1][0].toUpperCase()+MONTHS[state.m-1].slice(1)} ${state.y}`; }
function inPreviewRange(dayIso){ const {start,end}=state.range; return !!(start && end && dayIso>=start && dayIso<=end); }

function renderCalendar(){
  setMonthTitle();
  const grid = $('#daysGrid'); grid.innerHTML='';
  const prev = firstWeekday(state.y, state.m);
  for(let i=0;i<prev;i++){ const d=document.createElement('div'); d.className='day muted'; grid.appendChild(d); }

  const DIM=daysInMonth(state.y,state.m);
  for(let d=1; d<=DIM; d++){
    const wrap=document.createElement('div'); wrap.className='day';
    if(isToday(state.y,state.m,d)) wrap.classList.add('today');
    const id = iso(state.y,state.m,d); wrap.dataset.iso = id;

    if(state.rangeMode && inPreviewRange(id)) wrap.classList.add('range');

    // C√°lculo inicio/fin de ciclo
    const entry = state.entries[id] || {};
    const prevId = toIsoDate(addDays(parseIso(id), -1));
    const nextId = toIsoDate(addDays(parseIso(id), +1));
    const hasFlow = !!entry.flow;
    const prevFlow = !!(state.entries[prevId]?.flow);
    const nextFlowB = !!(state.entries[nextId]?.flow);
    if(hasFlow && !prevFlow){ const f=document.createElement('span'); f.className='flag start'; f.textContent='Inicio'; wrap.appendChild(f); wrap.classList.add('start-day'); }
    if(hasFlow && !nextFlowB){ const f=document.createElement('span'); f.className='flag end';   f.textContent='Fin';    wrap.appendChild(f); wrap.classList.add('end-day'); }

    // Top row: n√∫mero + mood button
    const top=document.createElement('div'); top.className='top';
    const num=document.createElement('div'); num.className='num'; num.textContent=d;
    const moodBtn=document.createElement('button'); moodBtn.className='mood-btn'; moodBtn.title='√Ånimo';
    const emo = entry.mood ? (MOOD_EMO[entry.mood]||'üôÇ') : 'üôÇ';
    moodBtn.textContent = emo;
    if(!CAN_EDIT || state.rangeMode) moodBtn.disabled = true;
    moodBtn.addEventListener('click', async (e)=>{
      if(!CAN_EDIT || state.rangeMode) return;
      const newMood = nextMood(entry.mood||'');
      await saveOrDelete(id, newMood, entry.flow||'');
      renderCalendar();
    });
    top.appendChild(num); top.appendChild(moodBtn);

    // Flow bar (click to cycle)
    const dot=document.createElement('div');
    dot.className='flow-dot ' + (
      entry.flow==='poco'  ? 'flow-low'  :
      entry.flow==='medio' ? 'flow-mid'  :
      entry.flow==='mucho' ? 'flow-high' : 'flow-none'
    );
    if(!CAN_EDIT || state.rangeMode) dot.style.cursor='default';
    dot.title = CAN_EDIT ? 'Click para cambiar el flujo' : '';
    dot.addEventListener('click', async ()=>{
      if(!CAN_EDIT || state.rangeMode) return;
      const newFlow = nextFlow(entry.flow||'');
      await saveOrDelete(id, entry.mood||'', newFlow);
      renderCalendar();
    });

    // Click de selecci√≥n de rango (sobre la tarjeta)
    wrap.addEventListener('click', ()=>{
      if(!state.rangeMode) return;
      selectInRange(id);
    });

    wrap.appendChild(top);
    wrap.appendChild(dot);
    grid.appendChild(wrap);
  }

  const total = prev + DIM;
  const post = (7 - (total % 7)) % 7;
  for(let i=0;i<post;i++){ const d=document.createElement('div'); d.className='day muted'; grid.appendChild(d); }

  // Botones de rango habilitados seg√∫n selecci√≥n
  const hasSel = !!(state.range.start && state.range.end);
  $('#applyRange').disabled = !CAN_EDIT || !hasSel;
  $('#clearRange').disabled = !CAN_EDIT || !hasSel;
}

// ------- Guardar / borrar -------
async function saveOneDay(dayIso, mood, flow){
  const payload = { for_user:'mochita', day:dayIso, mood:(mood||''), flow:(flow||'') };
  const res = await fetch(SAVE_DAY, {
    method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'},
    body: JSON.stringify(payload), credentials:'same-origin'
  });
  if(res.ok){ state.entries[dayIso] = { mood:(mood||''), flow:(flow||'') }; }
}

async function deleteOneDay(dayIso){
  const fd = new URLSearchParams(); fd.set('for_user','mochita'); fd.set('day',dayIso);
  const res = await fetch(DEL_DAY, { method:'POST', body:fd, credentials:'same-origin' });
  if(res.ok){ delete state.entries[dayIso]; }
}

// Si ambos vac√≠os => borrar; si no => guardar
async function saveOrDelete(dayIso, mood, flow){
  if(!CAN_EDIT) return;
  const mm=(mood||'').trim(), ff=(flow||'').trim();
  if(!mm && !ff){
    await deleteOneDay(dayIso);
  }else{
    await saveOneDay(dayIso, mm, ff);
  }
}

// ------- Rango -------
function resetRange(){ state.range={start:null,end:null}; $('#rangeHelp').style.display='none'; renderCalendar(); }
function selectInRange(id){
  const {start,end}=state.range;
  if(!start){ state.range.start=id; $('#rangeHelp').style.display='block'; }
  else if(!end){
    if(id < start){ state.range={start:id,end:start}; }
    else { state.range.end=id; }
  } else {
    state.range={start:id,end:null};
  }
  renderCalendar();
}
function isoList(a,b){
  const A=parseIso(a), B=parseIso(b); const out=[];
  for(let d=new Date(A); d<=B; d.setDate(d.getDate()+1)){ out.push(toIsoDate(d)); }
  return out;
}
async function applyRange(flowVal){
  const {start,end}=state.range; if(!start||!end) return;
  const days = isoList(start,end);
  for(const d of days){
    const existing = state.entries[d]||{};
    await saveOrDelete(d, existing.mood||'', flowVal||'');
  }
  resetRange();
}
async function clearRange(){
  const {start,end}=state.range; if(!start||!end) return;
  const days = isoList(start,end);
  for(const d of days){ await saveOrDelete(d, (state.entries[d]?.mood||''), ''); }
  resetRange();
}

// ------- Controles -------
$('#prevBtn').addEventListener('click', ()=>{
  const dt = new Date(state.y, state.m-2, 1); state.y=dt.getFullYear(); state.m=dt.getMonth()+1; resetRange(); loadMonth();
});
$('#nextBtn').addEventListener('click', ()=>{
  const dt = new Date(state.y, state.m, 1); state.y=dt.getFullYear(); state.m=dt.getMonth()+1; resetRange(); loadMonth();
});
$('#todayBtn').addEventListener('click', ()=>{
  const t = new Date(); state.y=t.getFullYear(); state.m=t.getMonth()+1; resetRange(); loadMonth();
});

$('#rangeToggle').addEventListener('click', ()=>{
  if(!CAN_EDIT) return;
  state.rangeMode = !state.rangeMode;
  $('#rangeToggle').classList.toggle('primary', state.rangeMode);
  $('#rangeToggle').setAttribute('aria-pressed', String(state.rangeMode));
  $('#rangeHelp').style.display = state.rangeMode ? 'block' : 'none';
  if(!state.rangeMode) resetRange(); else renderCalendar();
});
$('#applyRange').addEventListener('click', ()=> applyRange($('#rangeFlow').value||'medio'));
$('#clearRange').addEventListener('click', ()=> clearRange());

// Habilitar/deshabilitar controles por permiso
(function applyPermissions(){
  if(!CAN_EDIT){
    $('#rangeToggle').setAttribute('disabled','');
    $('#rangeFlow').setAttribute('disabled','');
    $('#applyRange').setAttribute('disabled','');
    $('#clearRange').setAttribute('disabled','');
  }
})();

// ------- SSE live -------
try{
  const es = new EventSource('/events');
  es.addEventListener('cycle_update', (ev)=>{
    const j = JSON.parse(ev.data||'{}');
    if(!j.user || j.user==='mochita'){ loadMonth(); }
  });
}catch(e){ console.warn('SSE no disponible', e); }

// ------- Init -------
(function init(){
  const t=new Date(); state.y=t.getFullYear(); state.m=t.getMonth()+1;
  loadMonth();
})();
</script>
</body>
</html>

