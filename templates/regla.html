<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ciclo ðŸ’–</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root{
      --primary-color:#e84393; --secondary-color:#fd79a8; --accent-color:#a29bfe;
      --card-bg:#fff; --shadow:0 15px 30px rgba(0,0,0,.08);
      --text:#2d3436; --muted:#94a3b8; --gradient:linear-gradient(135deg,#e84393,#fd79a8 50%,#a29bfe);
      --flow-none:#cbd5e1; --flow-low:#fecdd3; --flow-mid:#fb7185; --flow-high:#dc2626;
      --range-bg:rgba(232,67,147,.10);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Montserrat',sans-serif; background:linear-gradient(135deg,#ffe8f3,#dfe6e9);
      color:var(--text); min-height:100vh; padding:16px;
    }
    .container{
      background:var(--card-bg); border-radius:20px; box-shadow:var(--shadow);
      overflow:hidden; max-width:980px; margin:24px auto; border:1px solid rgba(255,255,255,.6);
    }
    header{
      background:var(--gradient); color:#fff; text-align:center; padding:22px 16px;
    }
    header h1{ font-family:'Dancing Script',cursive; font-size:42px; text-shadow:0 3px 6px rgba(0,0,0,.2); }

    .toolbar{
      display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:#fafafa; border-top:1px solid #eee;
      flex-wrap:wrap; gap:10px;
    }
    .month-nav{ display:flex; align-items:center; gap:10px; font-weight:800; }
    .icon-btn{
      width:36px; height:36px; border-radius:999px; border:1px solid #eee; background:#fff; cursor:pointer;
      display:grid; place-items:center;
    }
    .right-tools{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .chip-toggle{
      padding:8px 12px; border-radius:999px; border:1px solid #eee; background:#fff; font-weight:700; cursor:pointer;
    }
    .chip-toggle.active{ background:var(--primary-color); color:#fff; border-color:transparent; }

    /* barra de rango */
    .rangebar{
      display:none; gap:10px; align-items:center; padding:12px 16px; background:#fff; border-top:1px solid #eee;
      flex-wrap:wrap;
    }
    .rangebar.show{ display:flex; }
    .pill{ background:#f1f5f9; border:1px solid #e5e7eb; padding:6px 10px; border-radius:999px; font-weight:700; }
    .btn{ padding:10px 14px; border:none; border-radius:999px; font-weight:700; cursor:pointer; }
    .btn.ghost{ background:#eee; }
    .btn.primary{ background:var(--gradient); color:#fff; }

    /* Calendario */
    .calendar{ padding:18px; }
    .dow{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-bottom:6px; }
    .dow div{ text-align:center; font-weight:800; color:#6b7280; }
    .grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; user-select:none; }
    .day{
      background:#fff; border:1px solid #eee; border-radius:12px; min-height:92px; padding:8px; position:relative; cursor:pointer;
      display:flex; flex-direction:column; gap:6px; justify-content:flex-start;
    }
    .day.muted{ opacity:.45; cursor:default }
    .day .num{ font-weight:800; color:#475569 }
    .day.today{ outline:2px solid var(--secondary-color) }
    .day.range{ background:var(--range-bg); border-color:#fbcfe8 }
    .badges{ display:flex; gap:6px; flex-wrap:wrap }
    .badge{
      font-size:.78rem; font-weight:800; padding:4px 8px; border-radius:999px; background:#f1f5f9; color:#334155; border:1px solid #e5e7eb;
    }
    .flow-dot{
      position:absolute; bottom:6px; right:6px; width:10px; height:10px; border-radius:999px; border:2px solid #fff;
      box-shadow:0 1px 4px rgba(0,0,0,.15);
    }
    .flow-none{ background:var(--flow-none) }
    .flow-low{  background:var(--flow-low)  }
    .flow-mid{  background:var(--flow-mid)  }
    .flow-high{ background:var(--flow-high) }

    .flag{
      position:absolute; top:6px; right:6px; background:#fee2e2; color:#991b1b; border:1px solid #fecaca;
      border-radius:6px; font-size:.68rem; font-weight:800; padding:2px 6px;
    }
    .flag.start{ left:6px; right:auto; }
    .legend{ display:flex; gap:12px; padding:0 18px 18px; color:#475569; flex-wrap:wrap }
    .legend .item{ display:flex; align-items:center; gap:8px; }
    .legend .sw{ width:14px; height:14px; border-radius:4px; border:1px solid #e5e7eb }
    .legend small{ color:var(--muted) }

    /* Popover ediciÃ³n dÃ­a */
    .popover{
      position:fixed; z-index:1000; background:#fff; border:1px solid #eee; border-radius:14px; box-shadow:0 18px 40px rgba(0,0,0,.18);
      padding:12px; width:min(360px,92vw); display:none;
    }
    .popover.show{ display:block }
    .popover h3{ margin-bottom:8px; font-family:'Dancing Script',cursive; font-size:28px; color:var(--primary-color); text-align:center; }
    .field{ display:grid; gap:6px; margin:8px 0; }
    .field label{ font-weight:700; color:#334155 }
    select{
      width:100%; border:2px solid #eee; border-radius:10px; padding:10px 12px; background:#fafafa; font-weight:600;
    }
    .popover .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Ciclo ðŸ’–</h1>
    </header>

    <div class="toolbar">
      <div class="month-nav">
        <button class="icon-btn" id="prevBtn" title="Mes anterior"><i class="fa-solid fa-chevron-left"></i></button>
        <div id="monthTitle">â€”</div>
        <button class="icon-btn" id="nextBtn" title="Mes siguiente"><i class="fa-solid fa-chevron-right"></i></button>
      </div>
      <div class="right-tools">
        <button class="chip-toggle" id="dayModeBtn" aria-pressed="true">Editar dÃ­a</button>
        <button class="chip-toggle" id="rangeModeBtn" aria-pressed="false">Modo regla (rango)</button>
      </div>
    </div>

    <!-- barra de rango -->
    <div class="rangebar" id="rangeBar">
      <span class="pill" id="rangeInfo">Selecciona inicio y finâ€¦</span>
      <label class="pill" style="display:flex;gap:6px;align-items:center;">
        Intensidad:
        <select id="rangeFlow">
          <option value="poco">Poco</option>
          <option value="medio" selected>Medio</option>
          <option value="mucho">Mucho</option>
        </select>
      </label>
      <button class="btn ghost" id="rangeCancel">Cancelar</button>
      <button class="btn primary" id="rangeSave">Guardar rango</button>
    </div>

    <div class="calendar">
      <div class="dow">
        <div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div>
      </div>
      <div class="grid" id="daysGrid" aria-live="polite"></div>
    </div>

    <div class="legend">
      <div class="item"><span class="sw" style="background:var(--flow-none)"></span> <span>Sin sangrado</span></div>
      <div class="item"><span class="sw" style="background:var(--flow-low)"></span> <span>Poco</span></div>
      <div class="item"><span class="sw" style="background:var(--flow-mid)"></span> <span>Medio</span></div>
      <div class="item"><span class="sw" style="background:var(--flow-high)"></span> <span>Mucho</span></div>
      <div class="item"><span class="badge">ðŸ™‚ Ã¡nimo</span> <small>(etiqueta en el dÃ­a)</small></div>
      <div class="item"><span class="pill">I</span> Inicio Â· <span class="pill">F</span> Fin</div>
    </div>
  </div>

  <!-- Popover dÃ­a -->
  <div class="popover" id="pop">
    <h3 id="popTitle">Editar dÃ­a</h3>
    <div class="field">
      <label>Estado de Ã¡nimo</label>
      <select id="moodSel">
        <option value="">â€”</option>
        <option>Alegre</option>
        <option>Estable</option>
        <option>Ansiosa</option>
        <option>Irritable</option>
        <option>Baja</option>
      </select>
    </div>
    <div class="field">
      <label>Sangrado</label>
      <select id="flowSel">
        <option value="">Sin sangrado</option>
        <option value="poco">Poco</option>
        <option value="medio">Medio</option>
        <option value="mucho">Mucho</option>
      </select>
    </div>
    <div class="actions">
      <button class="btn" id="popCancel">Cerrar</button>
      <button class="btn primary" id="popSave">Guardar</button>
    </div>
  </div>

  <script>
    // endpoints
    const API_CYCLE = "{{ url_for('api_cycle_get') if api_cycle_get is defined else '/api/cycle' }}";
    const SAVE_DAY  = "{{ url_for('cycle_save')     if cycle_save     is defined else '/cycle/save' }}";

    const MONTHS = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];

    // Estado global
    let state = {
      user: 'mochita',     // fijo
      y: new Date().getFullYear(),
      m: new Date().getMonth()+1, // 1..12
      entries: {},         // 'YYYY-MM-DD' -> {mood,flow}
      rangeMode: false,
      range: { start:null, end:null, flow:'medio' },
    };

    const $ = s => document.querySelector(s);
    function iso(y,m,d){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
    function daysInMonth(y,m){ return new Date(y, m, 0).getDate(); }
    function firstWeekday(y,m){ const js=new Date(y,m-1,1).getDay(); return (js+6)%7; } // 0=L
    function isToday(y,m,d){ const t=new Date(); return t.getFullYear()===y && (t.getMonth()+1)===m && t.getDate()===d; }
    function cmpIso(a,b){ return a<b?-1:a>b?1:0; }

    async function loadMonth(){
      const ym = `${state.y}-${String(state.m).padStart(2,'0')}`;
      const url = `${API_CYCLE}?user=${encodeURIComponent(state.user)}&from=${ym}&months=1`;
      try{
        const res = await fetch(url, {credentials:'same-origin', headers:{'Accept':'application/json'}});
        const ct = res.headers.get('content-type')||'';
        if(!ct.includes('application/json')) throw new Error('bad content-type');
        const j = await res.json();
        const ent = {};
        (j.entries||[]).forEach(e=>{
          ent[e.day] = { mood:e.mood||'', flow:e.flow||'' };
        });
        state.entries = ent;
      }catch(e){
        console.warn('No se pudieron cargar los datos', e);
        state.entries = {};
      }
      renderCalendar();
    }

    function inPreviewRange(id){
      const {start,end} = state.range;
      if(!start) return false;
      if(start && !end) return id===start;
      return (id>=start && id<=end);
    }

    function renderCalendar(){
      $('#monthTitle').textContent = `${MONTHS[state.m-1][0].toUpperCase()+MONTHS[state.m-1].slice(1)} ${state.y}`;
      const grid = $('#daysGrid'); grid.innerHTML='';
      const prev = firstWeekday(state.y, state.m);
      for(let i=0;i<prev;i++){ const d=document.createElement('div'); d.className='day muted'; grid.appendChild(d); }

      const dim = daysInMonth(state.y, state.m);
      for(let d=1; d<=dim; d++){
        const wrap = document.createElement('div');
        wrap.className='day';
        if(isToday(state.y, state.m, d)) wrap.classList.add('today');

        const id = iso(state.y, state.m, d);
        wrap.dataset.iso = id;

        // preview de rango
        if(state.rangeMode && inPreviewRange(id)) wrap.classList.add('range');

        // contenido
        const n = document.createElement('div'); n.className='num'; n.textContent = d;
        const badges = document.createElement('div'); badges.className='badges';

        const entry = state.entries[id] || {};
        if(entry.mood){
          const b = document.createElement('span'); b.className='badge'; b.textContent = entry.mood;
          badges.appendChild(b);
        }
        // punto de flujo
        const dot = document.createElement('span');
        dot.className = 'flow-dot ' + (
          entry.flow==='poco'  ? 'flow-low'  :
          entry.flow==='medio' ? 'flow-mid'  :
          entry.flow==='mucho' ? 'flow-high' : 'flow-none'
        );

        // banderitas de inicio/fin (dentro del mes)
        const prevId = d>1 ? iso(state.y,state.m,d-1) : null;
        const nextId = d<dim? iso(state.y,state.m,d+1) : null;
        const isFlow = !!entry.flow;
        const prevFlow = prevId ? !!(state.entries[prevId]?.flow) : false;
        const nextFlow = nextId ? !!(state.entries[nextId]?.flow) : false;
        if(isFlow && !prevFlow){ const f=document.createElement('span'); f.className='flag start'; f.textContent='I'; wrap.appendChild(f); }
        if(isFlow && !nextFlow){ const f=document.createElement('span'); f.className='flag'; f.textContent='F'; wrap.appendChild(f); }

        wrap.appendChild(n);
        wrap.appendChild(badges);
        wrap.appendChild(dot);

        wrap.addEventListener('click', ()=> onDayClick(wrap));

        grid.appendChild(wrap);
      }

      // cerrar fila
      const total = prev + dim;
      const post = (7 - (total % 7)) % 7;
      for(let i=0;i<post;i++){ const d=document.createElement('div'); d.className='day muted'; grid.appendChild(d); }
    }

    // ===== EdiciÃ³n por dÃ­a =====
    const pop = $('#pop');
    let popDay = null;

    function openPopover(dayEl){
      popDay = dayEl.dataset.iso;
      $('#popTitle').textContent = `Editar ${popDay}`;
      const e = state.entries[popDay] || {};
      $('#moodSel').value = e.mood || '';
      $('#flowSel').value = e.flow || '';

      // posiciÃ³n
      const r = dayEl.getBoundingClientRect();
      const pw = Math.min(360, window.innerWidth*0.92);
      const left = Math.min(Math.max(8, r.left + r.width/2 - pw/2), window.innerWidth - pw - 8);
      const below = r.bottom + 10;
      const above  = r.top - 10 - 240;
      pop.style.width = pw+'px';
      pop.style.left = left + 'px';
      pop.style.top = (below + 260 > window.innerHeight ? Math.max(8, above) : Math.max(8, below)) + 'px';
      pop.classList.add('show');
    }
    function closePopover(){ pop.classList.remove('show'); popDay=null; }
    $('#popCancel').addEventListener('click', closePopover);
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closePopover(); });
    document.addEventListener('click', e=>{
      if(!pop.classList.contains('show')) return;
      if(e.target.closest('#pop') || e.target.closest('.day')) return;
      closePopover();
    });

    async function saveOneDay(dayIso, mood, flow){
      const payload = { for_user:'mochita', day:dayIso, mood:mood||'', flow:flow||'' };
      const res = await fetch(SAVE_DAY, {
        method:'POST',
        headers:{'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify(payload),
        credentials:'same-origin'
      });
      const ct = res.headers.get('content-type')||'';
      if(!ct.includes('application/json')) throw new Error('not json');
      if(!res.ok) throw new Error('save failed');
      state.entries[dayIso] = { mood:mood||'', flow:flow||'' };
    }

    $('#popSave').addEventListener('click', async ()=>{
      if(!popDay) return;
      const mood = $('#moodSel').value.trim();
      const flow = $('#flowSel').value.trim();
      try{
        await saveOneDay(popDay, mood, flow);
        closePopover(); renderCalendar();
      }catch(e){
        alert('No se pudo guardar. Puede que no tengas sesiÃ³n de ediciÃ³n.');
      }
    });

    // ===== Rango (modo regla) =====
    function setRangeInfo(){
      const {start,end} = state.range;
      if(!start && !end){ $('#rangeInfo').textContent = 'Selecciona inicio y finâ€¦'; return; }
      if(start && !end){ $('#rangeInfo').textContent = `Inicio: ${start} Â· selecciona fin`; return; }
      // calcular dÃ­as
      const days = diffDaysISO(start,end) + 1;
      $('#rangeInfo').textContent = `Rango: ${start} â†’ ${end} (${days} dÃ­as)`;
    }
    function diffDaysISO(a,b){ const A=new Date(a), B=new Date(b); return Math.round((B-A)/(1000*60*60*24)); }
    function resetRange(){ state.range = {start:null,end:null,flow: $('#rangeFlow').value||'medio'}; setRangeInfo(); }
    function isoList(start,end){
      const out=[]; let d=new Date(start), D=new Date(end);
      for(let t=d; t<=D; t=new Date(t.getFullYear(), t.getMonth(), t.getDate()+1)){
        const y=t.getFullYear(), m=t.getMonth()+1, dd=t.getDate();
        out.push(iso(y,m,dd));
      }
      return out;
    }

    async function saveRange(){
      const {start,end} = state.range;
      if(!start || !end) return;
      const flow = $('#rangeFlow').value || 'medio';
      const days = isoList(start,end);
      try{
        // Para no borrar Ã¡nimos existentes, reenviamos el mood actual de cada dÃ­a (si lo hay)
        await Promise.all(days.map(d=> saveOneDay(d, (state.entries[d]?.mood)||'', flow)));
        resetRange(); toggleRangeBar(false); renderCalendar();
      }catch(e){
        alert('No se pudo guardar todo el rango (Â¿sesiÃ³n?). Se guardÃ³ lo posible.');
        resetRange(); toggleRangeBar(false); renderCalendar();
      }
    }

    function toggleRangeBar(show){
      $('#rangeBar').classList.toggle('show', show);
      $('#rangeModeBtn').classList.toggle('active', show);
      $('#rangeModeBtn').setAttribute('aria-pressed', show?'true':'false');
      $('#dayModeBtn').classList.toggle('active', !show);
      $('#dayModeBtn').setAttribute('aria-pressed', !show?'true':'false');
    }

    function onDayClick(dayEl){
      const id = dayEl.dataset.iso;
      if(state.rangeMode){
        if(!state.range.start){ state.range.start = id; state.range.end = null; }
        else if(!state.range.end){
          // segundo click define fin (si es anterior, intercambiamos)
          if(cmpIso(id, state.range.start) < 0){
            state.range.end = state.range.start; state.range.start = id;
          }else{
            state.range.end = id;
          }
        }else{
          // si ya hay ambos, reiniciamos y ponemos nuevo inicio
          state.range.start = id; state.range.end = null;
        }
        setRangeInfo(); renderCalendar();
      }else{
        openPopover(dayEl);
      }
    }

    // ===== Controles UI =====
    $('#prevBtn').addEventListener('click', ()=>{ state.m--; if(state.m<1){ state.m=12; state.y--; } loadMonth(); });
    $('#nextBtn').addEventListener('click', ()=>{ state.m++; if(state.m>12){ state.m=1; state.y++; } loadMonth(); });

    $('#dayModeBtn').addEventListener('click', ()=>{
      state.rangeMode = false; toggleRangeBar(false); resetRange(); renderCalendar();
    });
    $('#rangeModeBtn').addEventListener('click', ()=>{
      state.rangeMode = !state.rangeMode;
      toggleRangeBar(state.rangeMode);
      if(!state.rangeMode) resetRange();
      renderCalendar();
    });
    $('#rangeCancel').addEventListener('click', ()=>{ resetRange(); renderCalendar(); });
    $('#rangeSave').addEventListener('click', saveRange);
    $('#rangeFlow').addEventListener('change', ()=> state.range.flow = $('#rangeFlow').value);

    // init
    resetRange();
    loadMonth();
  </script>
</body>
</html>
