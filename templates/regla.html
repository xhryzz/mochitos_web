<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ciclo ‚Äî Mochitos</title>
<link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
<style>
:root{
  --bg:#fafafa; --card:#fff; --ink:#1f2937; --muted:#6b7280; --line:#e5e7eb;
  --brand:#e84393; --brand-2:#a29bfe;
  --ok:#10b981; --warn:#f59e0b; --err:#ef4444;

  /* Colores de flujo (editables por mochita con üé®) */
  --flow-none:#e5e7eb;
  --flow-low:#60a5fa;
  --flow-mid:#f59e0b;
  --flow-high:#ef4444;
  --secondary-color:#a29bfe;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.container{max-width:980px;margin:24px auto;padding:0 16px}

/* Tarjetas / barras */
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 2px 14px rgba(0,0,0,.04)}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:12px 0 16px}
.toolbar .spacer{flex:1}
h1{font-size:1.5rem;margin:0 0 6px}
.subtitle{margin:0 0 14px;color:var(--muted)}

/* Chips / botones compactos */
.chip-toggle{
  padding:10px 12px;border:1px solid var(--line);background:#fff;border-radius:12px;cursor:pointer;
}
.chip-toggle[disabled]{opacity:.55;cursor:not-allowed}
.chip-toggle.active{border-color:var(--brand);box-shadow:0 0 0 2px rgba(232,67,147,.25);}

/* Acciones positivas/negativas */
.toolbar .ok{ border-color:#bbf7d0; background:#ecfdf5; color:#065f46 }
.toolbar .ok:hover{ background:#dcfce7 }
.toolbar .danger{ border-color:#fee2e2; background:#fff5f5; color:#991b1b }
.toolbar .danger:hover{ background:#ffe4e6 }

/* Calendario */
.cal-head{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.arrow{width:36px;height:36px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;display:grid;place-items:center}
.month-title{font-weight:700;font-size:1.1rem}
.week{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:6px;color:#6b7280;font-size:.9rem}
.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.day{
  position:relative;background:#fff;border:1px solid var(--line);border-radius:12px;min-height:86px;padding:8px;display:flex;flex-direction:column;gap:6px;
}
.day.muted{background:#f9fafb}
.day.today{outline:2px dashed var(--secondary-color);outline-offset:-6px}
.day .num{font-weight:700}
.badges{display:flex;gap:6px;flex-wrap:wrap}
.badge{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#f8fafc;font-size:.8rem}
.badge.emoji{display:inline-flex;gap:6px;align-items:center;padding:4px 10px}
.badge .emo{font-size:1rem;line-height:1}

/* Punto de flujo */
.flow-dot{
  width:100%;height:8px;border-radius:6px;background:var(--flow-none);margin-top:auto;border:1px solid rgba(0,0,0,.05)
}
.flow-low{ background:var(--flow-low) }
.flow-mid{ background:var(--flow-mid) }
.flow-high{ background:var(--flow-high) }
.flow-none{ background:var(--flow-none) }

/* Selecci√≥n de rango (preview) */
.day.range{ box-shadow:0 0 0 2px rgba(232,67,147,.18) inset }

/* Inicio/fin muy visibles */
.day.start-day{ box-shadow:0 0 0 3px rgba(232,67,147,.55), 0 8px 18px rgba(232,67,147,.18); border-color:#fda4af; position:relative }
.day.end-day{   box-shadow:0 0 0 3px rgba(162,155,254,.55), 0 8px 18px rgba(162,155,254,.18); border-color:#c7d2fe; position:relative }
.flag{
  position:absolute; top:6px; right:6px; font-size:.78rem; padding:3px 8px; border-radius:999px; border:1px solid;
}
.flag.start{ background:#ffe4e6; border-color:#fecdd3; color:#9f1239; right:auto; left:6px }
.flag.end{   background:#ede9fe; border-color:#ddd6fe; color:#4c1d95 }

/* Popover de edici√≥n de d√≠a */
.pop{
  position:fixed; z-index:40; left:50%; top:50%; transform:translate(-50%,-50%);
  width:min(520px,94vw); background:#fff; border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow:0 20px 60px rgba(0,0,0,.18); display:none;
}
.pop.show{ display:block }
.pop h3{ margin:0 0 10px; font-size:1.05rem }
.form-row{display:flex; gap:10px; align-items:center; margin:8px 0}
.form-row label{min-width:120px}
select, input[type="text"], input[type="number"]{
  width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:#fff
}
.pop .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px }
.btn{ padding:10px 12px; border:1px solid var(--line); background:#fff; border-radius:10px; cursor:pointer }
.btn.primary{ background:var(--brand); color:#fff; border-color:var(--brand) }
.btn.danger{ background:#fee2e2; color:#991b1b; border-color:#fecaca }

/* Popover de paleta (colores) */
.popover{
  position:fixed; z-index:50; left:24px; top:24px; width:360px; background:#fff; border:1px solid var(--line); border-radius:14px; padding:14px; display:none; box-shadow:0 20px 60px rgba(0,0,0,.18)
}
.popover.show{ display:block }
#palettePop .row{ display:flex; align-items:center; gap:10px; margin:8px 0 }
#palettePop label{ min-width:160px }
#palettePop input[type="color"]{ width:42px; height:32px; border:1px solid #e5e7eb; border-radius:8px }

/* Info rango */
.range-bar{ display:flex; gap:10px; align-items:center; margin:6px 0 0; color:var(--muted); font-size:.95rem }
.range-bar .strong{ font-weight:600; color:#111 }
hr.sep{ border:none; border-top:1px solid var(--line); margin:10px 0 }
.small{ font-size:.9rem; color:var(--muted) }
</style>
</head>
<body>
<div class="container">
  <h1>ü©∏ Ciclo</h1>
  <p class="subtitle">_Mochita_ puede editar; _Mochito_ solo ve. Cambios se env√≠an al servidor y se reflejan en ambos al momento.</p>

  <div class="toolbar card">
    <button class="chip-toggle" id="dayModeBtn" aria-pressed="true">üñäÔ∏è Editar d√≠a</button>
    <button class="chip-toggle" id="rangeModeBtn" aria-pressed="false">üìè Modo regla (rango)</button>

    <div class="spacer"></div>

    <label class="small">Flujo del rango:</label>
    <select id="rangeFlowSel" class="chip-toggle" style="padding:8px 10px;border-radius:10px">
      <option value="poco">poco</option>
      <option value="medio" selected>medio</option>
      <option value="mucho">mucho</option>
    </select>

    <button class="chip-toggle ok" id="saveAllBtn" title="Guardar cambios">üíæ Guardar</button>
    <button class="chip-toggle danger" id="wipeMonthBtn" title="Borrar el mes visible">üßº Borrar mes</button>
    <button class="chip-toggle danger" id="wipeRangeBtn" title="Borrar por rango">üß® Borrar rango</button>
    <button class="chip-toggle" id="paletteBtn" title="Colores">üé® Colores</button>

    <div class="range-bar" id="rangeBar" style="display:none">
      <span id="rangeInfo">Selecciona inicio y fin‚Ä¶</span>
    </div>
  </div>

  <div class="card">
    <div class="cal-head">
      <button class="arrow" id="prevBtn" aria-label="Mes anterior">‚Äπ</button>
      <div class="month-title" id="monthTitle">‚Äî</div>
      <button class="arrow" id="nextBtn" aria-label="Mes siguiente">‚Ä∫</button>
      <div class="spacer"></div>
      <button class="chip-toggle" id="todayBtn">Hoy</button>
    </div>
    <div class="week">
      <div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div><div>Dom</div>
    </div>
    <div class="grid" id="daysGrid"></div>
  </div>
</div>

<!-- Popover edici√≥n d√≠a -->
<div class="pop" id="dayPop">
  <h3 id="popTitle">Editar d√≠a</h3>
  <div class="form-row">
    <label>√Ånimo</label>
    <select id="moodSel">
      <option value="">‚Äî</option>
      <option value="feliz">üòÄ Feliz</option>
      <option value="normal">üôÇ Normal</option>
      <option value="triste">üòî Triste</option>
      <option value="estresada">üòµ‚Äçüí´ Estresada</option>
      <option value="sensible">ü•∫ Sensible</option>
      <option value="cansada">üò¥ Cansada</option>
      <option value="irritable">üò† Irritable</option>
      <option value="con_energia">‚ö° Con energ√≠a</option>
    </select>
  </div>
  <div class="form-row">
    <label>Flujo</label>
    <select id="flowSel">
      <option value="">‚Äî (sin dato)</option>
      <option value="poco">poco</option>
      <option value="medio">medio</option>
      <option value="mucho">mucho</option>
    </select>
  </div>
  <div class="actions">
    <button class="btn" id="popCancel">Cancelar</button>
    <button class="btn danger" id="popDelete">Eliminar d√≠a</button>
    <button class="btn primary" id="popSave">Guardar</button>
  </div>
  <div class="small">Consejo: usa <b>Modo regla</b> para marcar un rango de d√≠as y guarda todo de golpe.</div>
</div>

<!-- Popover paleta de colores (solo mochita) -->
<div class="popover" id="palettePop">
  <h3>üé® Colores</h3><hr class="sep">
  <div class="row"><label>Sin sangrado</label><input type="color" id="cNone"></div>
  <div class="row"><label>Poco</label><input type="color" id="cLow"></div>
  <div class="row"><label>Medio</label><input type="color" id="cMid"></div>
  <div class="row"><label>Mucho</label><input type="color" id="cHigh"></div>
  <div class="row"><label>Accento</label><input type="color" id="cAccent"></div>
  <div class="actions">
    <button class="btn" id="paletteClose">Cerrar</button>
    <button class="btn primary" id="paletteApply">Aplicar</button>
  </div>
</div>

<script>
// ------- Permisos (solo mochita edita) -------
const CAN_EDIT = {{ 'true' if (session.get('username')=='mochita') else 'false' }};

// ------- Utilidades DOM -------
const $ = (sel, p=document)=>p.querySelector(sel);
const $$ = (sel, p=document)=>Array.from(p.querySelectorAll(sel));

// ------- Fechas / helpers -------
const MONTHS = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
const pad = n => (n<10?'0'+n:n);
const iso = (y,m,d)=>`${y}-${pad(m)}-${pad(d)}`;
const parseIso = s => { const [Y,M,D]=s.split('-').map(x=>+x); return new Date(Y, M-1, D); };
const addDays = (date, n)=>{ const d=new Date(date); d.setDate(d.getDate()+n); return d; };
const toIsoDate = d => iso(d.getFullYear(), d.getMonth()+1, d.getDate());
const daysInMonth = (y,m)=> new Date(y, m, 0).getDate();
const firstWeekday = (y,m)=>{ // 0 = Lunes
  const js = new Date(y, m-1, 1).getDay(); // 0=Dom..6=S√°b
  return (js+6)%7;
};
const isToday = (y,m,d)=>{ const t=new Date(); return t.getFullYear()==y && (t.getMonth()+1)==m && t.getDate()==d; };

// ------- API -------
const API_LIST = '/api/cycle';
const SAVE_DAY = '/cycle/save';
const DEL_DAY = '/cycle/delete';

// ------- Estado -------
const state = {
  y: (new Date()).getFullYear(),
  m: (new Date()).getMonth()+1,
  entries: {},   // { 'YYYY-MM-DD': {mood,flow} }
  rangeMode: false,
  range: { start:null, end:null }
};

// ------- Emojis de √°nimo -------
const MOOD_EMO = {
  feliz:'üòÄ', normal:'üôÇ', triste:'üòî', estresada:'üòµ‚Äçüí´',
  sensible:'ü•∫', cansada:'üò¥', irritable:'üò†', con_energia:'‚ö°'
};

// ------- Carga datos (3 meses centrados) -------
function ymPrev(y,m){ const d=new Date(y,m-2,1); return [d.getFullYear(), d.getMonth()+1]; }
async function loadMonth(){
  // Pedimos 3 meses (anterior, actual, siguiente) para detectar inicios/finales con precisi√≥n
  const [py, pm] = ymPrev(state.y, state.m);
  const from = `${py}-${pad(pm)}`;
  const url = `${API_LIST}?from=${from}&months=3&user=mochita`;
  const res = await fetch(url, { credentials:'same-origin' });
  const j = await res.json();
  const map = {};
  (j.entries||[]).forEach(e=>{
    const day = (e.day||e.date||'').trim();
    if(!day) return;
    map[day] = {
      mood: (e.mood||'')||'',
      flow: (e.flow||'')||''
    };
  });
  state.entries = map;
  renderCalendar();
}

// ------- Render calendario -------
function setMonthTitle(){
  $('#monthTitle').textContent = `${MONTHS[state.m-1][0].toUpperCase()+MONTHS[state.m-1].slice(1)} ${state.y}`;
}
function inPreviewRange(dayIso){
  const {start,end} = state.range;
  if(!start || !end) return false;
  return dayIso >= start && dayIso <= end;
}
function renderCalendar(){
  setMonthTitle();
  const grid = $('#daysGrid'); grid.innerHTML='';

  const prev = firstWeekday(state.y, state.m);
  for(let i=0;i<prev;i++){ const d=document.createElement('div'); d.className='day muted'; grid.appendChild(d); }

  const DIM = daysInMonth(state.y, state.m);
  for(let d=1; d<=DIM; d++){
    const wrap = document.createElement('div');
    wrap.className='day';
    if(isToday(state.y,state.m,d)) wrap.classList.add('today');

    const id = iso(state.y, state.m, d);
    wrap.dataset.iso = id;
    if(state.rangeMode && inPreviewRange(id)) wrap.classList.add('range');

    // N√∫mero
    const n = document.createElement('div');
    n.className='num'; n.textContent=d;

    // Badges (√°nimo con emoji)
    const badges = document.createElement('div'); badges.className='badges';
    const entry = state.entries[id] || {};
    if(entry.mood){
      const b = document.createElement('span'); b.className='badge emoji';
      const emo = MOOD_EMO[entry.mood] || 'üôÇ';
      const txt = entry.mood.replace('_',' ');
      b.innerHTML = `<span class="emo">${emo}</span> <span>${txt}</span>`;
      badges.appendChild(b);
    }

    // Punto de flujo
    const dot = document.createElement('span');
    dot.className = 'flow-dot ' + (
      entry.flow==='poco'  ? 'flow-low'  :
      entry.flow==='medio' ? 'flow-mid'  :
      entry.flow==='mucho' ? 'flow-high' : 'flow-none'
    );

    // Inicio / fin (considerando d√≠as vecinos, incluso fuera del mes: ya los tenemos en entries)
    const prevId = toIsoDate(addDays(parseIso(id), -1));
    const nextId = toIsoDate(addDays(parseIso(id), +1));
    const isFlow = !!(entry.flow && entry.flow!=='');
    const prevFlow = !!(state.entries[prevId]?.flow);
    const nextFlow = !!(state.entries[nextId]?.flow);
    if(isFlow && !prevFlow){
      const f=document.createElement('span'); f.className='flag start'; f.textContent='Inicio';
      wrap.appendChild(f); wrap.classList.add('start-day');
    }
    if(isFlow && !nextFlow){
      const f=document.createElement('span'); f.className='flag end'; f.textContent='Fin';
      wrap.appendChild(f); wrap.classList.add('end-day');
    }

    wrap.appendChild(n);
    wrap.appendChild(badges);
    wrap.appendChild(dot);

    // Click
    wrap.addEventListener('click', ()=> onDayClick(wrap));

    grid.appendChild(wrap);
  }

  const total = prev + DIM;
  const post = (7 - (total % 7)) % 7;
  for(let i=0;i<post;i++){ const d=document.createElement('div'); d.className='day muted'; grid.appendChild(d); }
}

// ------- Interacci√≥n -------
function toggleMode(btn, flag){
  state.rangeMode = flag;
  $('#dayModeBtn').classList.toggle('active', !flag);
  $('#rangeModeBtn').classList.toggle('active', flag);
  toggleRangeBar(flag);
  renderCalendar();
}
function toggleRangeBar(show){
  $('#rangeBar').style.display = show ? 'flex' : 'none';
  setRangeInfo();
}
function setRangeInfo(msg){
  const el = $('#rangeInfo');
  if(msg){ el.textContent = msg; return; }
  const {start,end} = state.range;
  if(start && end) el.innerHTML = `Rango: <span class="strong">${start}</span> ‚Üí <span class="strong">${end}</span>`;
  else if(start)   el.innerHTML = `Inicio: <span class="strong">${start}</span> (elige fin)`;
  else el.textContent = 'Selecciona inicio y fin‚Ä¶';
}
function resetRange(){ state.range.start=null; state.range.end=null; setRangeInfo(); }

function isoList(a,b){
  const A=parseIso(a), B=parseIso(b);
  const out=[]; for(let d=new Date(A); d<=B; d.setDate(d.getDate()+1)){ out.push(toIsoDate(d)); }
  return out;
}

function onDayClick(dayEl){
  const id = dayEl.dataset.iso;
  if(!state.rangeMode){
    openPopover(dayEl);
  }else{
    if(!CAN_EDIT) return;
    if(!state.range.start){ state.range.start = id; }
    else if(!state.range.end){
      if(id < state.range.start){ state.range.end = state.range.start; state.range.start = id; }
      else { state.range.end = id; }
    }else{ // reset si ya ten√≠amos ambos
      state.range.start = id; state.range.end = null;
    }
    setRangeInfo();
    renderCalendar();
  }
}

// ------- Popover de d√≠a -------
let currentDay = null;
function openPopover(anchor){
  currentDay = anchor.dataset.iso;
  const entry = state.entries[currentDay] || {};
  $('#popTitle').textContent = `Editar ${currentDay}`;
  $('#moodSel').value = entry.mood || '';
  $('#flowSel').value = entry.flow || '';

  // Permisos
  $('#popSave').disabled = !CAN_EDIT;
  $('#popDelete').disabled = !CAN_EDIT;

  $('#dayPop').classList.add('show');
}
function closePopover(){ $('#dayPop').classList.remove('show'); }

// Guardar / eliminar un d√≠a
async function saveOneDay(dayIso, mood, flow){
  if(!CAN_EDIT) return;
  const payload = { for_user:'mochita', day:dayIso, mood: (mood||''), flow:(flow||'') };
  const res = await fetch(SAVE_DAY, {
    method:'POST',
    headers:{'Content-Type':'application/json','Accept':'application/json'},
    body: JSON.stringify(payload),
    credentials:'same-origin'
  });
  if(!res.ok){ alert('No se pudo guardar'); return; }
  state.entries[dayIso] = { mood: mood||'', flow: flow||'' };
}
async function deleteOneDay(dayIso){
  if(!CAN_EDIT) return;
  const fd = new URLSearchParams();
  fd.set('for_user','mochita');
  fd.set('day', dayIso);
  const res = await fetch(DEL_DAY, { method:'POST', body:fd, credentials:'same-origin' });
  if(res.ok){ delete state.entries[dayIso]; }
}

// ------- Botones -------
$('#dayModeBtn').addEventListener('click', ()=> toggleMode(null,false));
$('#rangeModeBtn').addEventListener('click', ()=> toggleMode(null,true));
$('#todayBtn').addEventListener('click', ()=>{
  const t=new Date(); state.y=t.getFullYear(); state.m=t.getMonth()+1; loadMonth();
});
$('#prevBtn').addEventListener('click', ()=>{
  const d=new Date(state.y, state.m-2, 1); state.y=d.getFullYear(); state.m=d.getMonth()+1; resetRange(); loadMonth();
});
$('#nextBtn').addEventListener('click', ()=>{
  const d=new Date(state.y, state.m, 1); state.y=d.getFullYear(); state.m=d.getMonth()+1; resetRange(); loadMonth();
});

$('#popCancel').addEventListener('click', closePopover);
$('#popSave').addEventListener('click', async ()=>{
  if(!CAN_EDIT) return;
  await saveOneDay(currentDay, $('#moodSel').value, $('#flowSel').value);
  closePopover(); renderCalendar();
});
$('#popDelete').addEventListener('click', async ()=>{
  if(!CAN_EDIT) return;
  if(confirm(`Eliminar registro del ${currentDay}?`)){
    await deleteOneDay(currentDay);
    closePopover(); renderCalendar();
  }
});

// Guardar / borrar rango / mes
async function saveRange(){
  const {start,end} = state.range;
  if(!start || !end){ alert('Selecciona inicio y fin'); return; }
  const flow = $('#rangeFlowSel').value || 'medio';
  const days = isoList(start,end);
  for(const d of days){ await saveOneDay(d, (state.entries[d]?.mood || ''), flow); }
  renderCalendar();
}
async function wipeMonth(){
  if(!CAN_EDIT) return;
  const yes = confirm('¬øBorrar TODOS los registros del mes visible?');
  if(!yes) return;
  const dim=daysInMonth(state.y,state.m);
  for(let d=1; d<=dim; d++){
    const id=iso(state.y,state.m,d);
    if(state.entries[id]) await deleteOneDay(id);
  }
  renderCalendar();
}
async function wipeRange(){
  if(!CAN_EDIT) return;
  const {start,end} = state.range;
  if(!start || !end){ alert('Selecciona inicio y fin'); return; }
  if(!confirm(`¬øBorrar del ${start} al ${end}?`)) return;
  for(const d of isoList(start,end)){ if(state.entries[d]) await deleteOneDay(d); }
  resetRange(); renderCalendar();
}
$('#saveAllBtn').addEventListener('click', saveRange);
$('#wipeMonthBtn').addEventListener('click', wipeMonth);
$('#wipeRangeBtn').addEventListener('click', wipeRange);

// ------- Colores (solo sesi√≥n; no se guarda en localStorage) -------
function rgbToHex(rgb){
  const m = (rgb||'').match(/\d+/g); if(!m) return '#cccccc';
  const [r,g,b] = m.map(n=>(+n).toString(16).padStart(2,'0'));
  return `#${r}${g}${b}`;
}
function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name); }
function setVar(name,val){ document.documentElement.style.setProperty(name, val); }

function openPalette(anchor){
  const pop = $('#palettePop');
  // Posici√≥n simple
  pop.style.left = (window.innerWidth - 380) + 'px';
  pop.style.top  = '24px';
  // Cargar actuales
  $('#cNone').value  = rgbToHex(getVar('--flow-none'));
  $('#cLow').value   = rgbToHex(getVar('--flow-low'));
  $('#cMid').value   = rgbToHex(getVar('--flow-mid'));
  $('#cHigh').value  = rgbToHex(getVar('--flow-high'));
  $('#cAccent').value= rgbToHex(getVar('--secondary-color'));
  pop.classList.add('show');
}
$('#paletteBtn').addEventListener('click', ()=>{ if(CAN_EDIT) openPalette(); });
$('#paletteClose').addEventListener('click', ()=> $('#palettePop').classList.remove('show'));
$('#paletteApply').addEventListener('click', ()=>{
  if(!CAN_EDIT) return;
  setVar('--flow-none', $('#cNone').value);
  setVar('--flow-low',  $('#cLow').value);
  setVar('--flow-mid',  $('#cMid').value);
  setVar('--flow-high', $('#cHigh').value);
  setVar('--secondary-color', $('#cAccent').value);
  $('#palettePop').classList.remove('show');
});

// ------- Permisos UI -------
function applyPermissions(){
  if(!CAN_EDIT){
    $('#dayModeBtn').setAttribute('disabled','');
    $('#rangeModeBtn').setAttribute('disabled','');
    $('#saveAllBtn').setAttribute('disabled','');
    $('#wipeMonthBtn').setAttribute('disabled','');
    $('#wipeRangeBtn').setAttribute('disabled','');
    $('#paletteBtn').setAttribute('disabled','');
    $('#rangeFlowSel').setAttribute('disabled','');
  }
}
applyPermissions();

// ------- SSE: refresco en vivo (ambos lo ven al momento) -------
try{
  const es = new EventSource('/events');
  es.addEventListener('cycle_update', (ev)=>{
    // Si el evento es de mochita o general, recargamos el mes
    const j = JSON.parse(ev.data||'{}');
    if(!j.user || j.user==='mochita'){ loadMonth(); }
  });
}catch(e){ console.warn('SSE no disponible', e); }

// ------- Inicio -------
(function init(){
  const t=new Date(); state.y=t.getFullYear(); state.m=t.getMonth()+1;
  toggleMode(null,false); // por defecto edici√≥n de d√≠a
  loadMonth();
})();
</script>
</body>
</html>
