<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Christian y Clara üíñ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Montserrat:wght@300;400;500;600;700&family=Dancing+Script:wght@600;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="manifest" href="/static/manifest.webmanifest">
  <meta name="theme-color" content="#e84393">

  <!-- iOS PWA hints -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
  <style>
    :root {
      --primary-color: #e84393;
      --secondary-color: #fd79a8;
      --accent-color: #a29bfe;
      --light-pink: #ffe8f3;
      --dark-text: #2d3436;
      --light-text: #ffffff;
      --card-bg: rgba(255, 255, 255, 0.95);
      --shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
      --gradient: linear-gradient(135deg, #e84393 0%, #fd79a8 50%, #a29bfe 100%);
      --visited-color: #00b894;
      --wishlist-color: #fd79a8;
      --purchased-color: #b2bec3;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(135deg, #ffe8f3 0%, #dfe6e9 100%);
      color: var(--dark-text);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0 0 0 0;
      height: 100%;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%23e84393' fill-opacity='0.05' d='M0,224L48,213.3C96,203,192,181,288,160C384,139,480,117,576,122.7C672,128,768,160,864,170.7C960,181,1056,171,1152,165.3C1248,160,1344,160,1392,160L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
      background-size: cover;
      z-index: -1;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      padding-bottom: 40px;
    }

    /* Header y banner */
    .banner {
      position: relative;
      margin-bottom: 40px;
      border-radius: 25px;
      overflow: hidden;
      box-shadow: var(--shadow);
      height: 450px;
      transition: all 0.5s ease;
    }

    .banner img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 0.5s ease;
    }

    .banner:hover img {
      transform: scale(1.05);
    }

    .banner-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
      padding: 40px 30px 30px;
      color: white;
      text-align: center;
    }

    .banner h1 {
      font-family: 'Dancing Script', cursive;
      font-size: 4.5rem;
      margin-bottom: 15px;
      text-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
      letter-spacing: 2px;
    }

    .banner-form {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .custom-file-upload {
      background: rgba(255, 255, 255, 0.2);
      padding: 12px 25px;
      border-radius: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }

    .custom-file-upload:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Tarjetas */
    .section {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 255, 255, .5);
      transition: transform .3s, box-shadow .3s;
      position: relative;
      overflow: hidden;
    }

    .section::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: var(--gradient);
    }

    .section:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, .15);
    }

    .section h3 {
      color: var(--primary-color);
      font-family: 'Playfair Display', serif;
      font-size: 2.2rem;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 3px solid var(--secondary-color);
      display: inline-block;
      position: relative;
    }

    .section h3::after {
      content: "";
      position: absolute;
      bottom: -3px;
      left: 0;
      width: 50px;
      height: 3px;
      background: var(--accent-color);
    }

    /* Inputs & botones */
    form {
      margin-top: 20px;
    }

    input,
    button,
    textarea {
      font-family: 'Montserrat', sans-serif;
      border-radius: 50px;
      border: none;
      padding: 15px 25px;
      font-size: 1rem;
      transition: all .3s ease;
    }

    input[type="text"],
    input[type="password"],
    input[type="date"],
    input[type="url"],
    input[type="file"],
    textarea {
      background: #f8f8f8;
      border: 2px solid #eee;
      width: 100%;
      margin-bottom: 15px;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 4px rgba(162, 155, 254, .3);
    }

    button {
      background: var(--gradient);
      color: white;
      font-weight: 600;
      cursor: pointer;
      display: inline-block;
      box-shadow: 0 5px 15px rgba(232, 67, 147, .4);
      position: relative;
      overflow: hidden;
      z-index: 1;
    }

    button::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 0%;
      height: 100%;
      background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
      transition: all .5s ease;
      z-index: -1;
    }

    button:hover::before {
      width: 100%;
    }

    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(232, 67, 147, .5);
    }

    .autor-link {
      text-decoration: none;
      color: inherit;
      font-weight: bold;
    }

    .autor-link:hover {
      color: red;
    }

    .logout {
      position: fixed;
      top: 30px;
      right: 30px;
      background: white;
      color: var(--primary-color);
      text-decoration: none;
      padding: 12px 25px;
      border-radius: 50px;
      font-weight: 600;
      box-shadow: var(--shadow);
      z-index: 1000;
      transition: all .3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logout:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-3px);
    }

    /* Contadores */
    .counters {
      display: flex;
      flex-wrap: wrap;
      gap: 25px;
      margin-bottom: 25px;
    }

    .counter-item {
      flex: 1;
      min-width: 220px;
      text-align: center;
      padding: 25px;
      background: var(--gradient);
      border-radius: 18px;
      color: white;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .counter-item::before {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: rgba(255, 255, 255, .1);
      transform: rotate(45deg);
      transition: all .5s ease;
    }

    .counter-item:hover::before {
      transform: rotate(45deg) translate(20px, 20px);
    }

    .counter-item h4 {
      font-size: 1.1rem;
      margin-bottom: 15px;
      font-weight: 500;
    }

    .counter-item p {
      font-size: 2.5rem;
      font-weight: 700;
    }

    /* Login */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      background: var(--gradient);
    }

    .login-box {
      background: var(--card-bg);
      padding: 40px;
      border-radius: 25px;
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 450px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .login-box::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 8px;
      background: var(--gradient);
    }

    .login-box h3 {
      color: var(--primary-color);
      font-family: 'Playfair Display', serif;
      font-size: 2.5rem;
      margin-bottom: 25px;
    }

    .error-message {
      color: #e74c3c;
      margin-bottom: 20px;
      padding: 15px;
      background: #ffeded;
      border-radius: 12px;
      border-left: 5px solid #e74c3c;
    }

    /* Efectos */
    .floating-hearts {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: -1;
    }

    /* AFTER (scopeado) */
    .floating-hearts .heart {
      position: absolute;
      color: rgba(232, 67, 147, 0.3);
      font-size: 20px;
      animation: float 8s ease-in-out infinite;
    }

    @keyframes float {
      0% {
        transform: translateY(100vh) rotate(0deg);
        opacity: 0;
      }

      10% {
        opacity: 1;
      }

      90% {
        opacity: 1;
      }

      100% {
        transform: translateY(-100px) rotate(360deg);
        opacity: 0;
      }
    }

    /* Viajes */
    .travel-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #eee;
    }

    .travel-tab {
      padding: 12px 25px;
      cursor: pointer;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      transition: all .3s ease;
    }

    .travel-tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }

    .travel-tab:hover:not(.active) {
      color: var(--secondary-color);
    }

    .travel-content {
      display: none;
    }

    .travel-content.active {
      display: block;
    }

    .travels-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 25px;
      margin-top: 20px;
    }

    .travel-card {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
      transition: all .3s ease;
      position: relative;
    }

    .travel-card.visited {
      border-left: 5px solid var(--visited-color);
    }

    .travel-card.wishlist {
      border-left: 5px solid var(--wishlist-color);
    }

    .travel-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, .12);
    }

    .travel-cover {
      position: relative;
      height: 180px;
      overflow: hidden;
    }

    .travel-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform .5s ease;
    }

    .travel-card:hover .travel-cover img {
      transform: scale(1.05);
    }

    .travel-status {
      position: absolute;
      top: 15px;
      right: 15px;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: .8rem;
      font-weight: 600;
      color: white;
    }

    .status-visited {
      background: var(--visited-color);
    }

    .status-wishlist {
      background: var(--wishlist-color);
    }

    .travel-info {
      padding: 20px;
    }

    .travel-destination {
      font-family: 'Playfair Display', serif;
      font-size: 1.3rem;
      color: var(--dark-text);
      margin-bottom: 8px;
      font-weight: 700;
    }

    .travel-date {
      color: #777;
      font-size: .9rem;
      margin-bottom: 12px;
    }

    .travel-description {
      color: #555;
      margin-bottom: 15px;
      line-height: 1.5;
    }

    .travel-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      font-size: .9rem;
      color: #888;
    }

    .travel-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .travel-form {
      margin-top: 25px;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 12px;
    }

    /* Wishlist */
    .wishlist-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #eee;
    }

    .wishlist-tab {
      padding: 12px 25px;
      cursor: pointer;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      transition: all .3s ease;
    }

    .wishlist-tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }

    .wishlist-tab:hover:not(.active) {
      color: var(--secondary-color);
    }

    .wishlist-content {
      display: none;
    }

    .wishlist-content.active {
      display: block;
    }

    .wishlist-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 25px;
      margin-top: 20px;
    }

    .wishlist-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
      transition: all .3s ease;
      position: relative;
    }

    .wishlist-card.purchased {
      opacity: 0.7;
      border-left: 5px solid var(--purchased-color);
    }

    .wishlist-card:not(.purchased) {
      border-left: 5px solid var(--wishlist-color);
    }

    .wishlist-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, .12);
    }

    .wishlist-status {
      position: absolute;
      top: 15px;
      right: 15px;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: .8rem;
      font-weight: 600;
      color: white;
    }

    .status-purchased {
      background: var(--purchased-color);
    }

    .status-wanted {
      background: var(--wishlist-color);
    }

    .wishlist-product {
      font-family: 'Playfair Display', serif;
      font-size: 1.3rem;
      color: var(--dark-text);
      margin-bottom: 8px;
      font-weight: 700;
    }

    .wishlist-link {
      color: var(--accent-color);
      margin-bottom: 12px;
      display: block;
      text-decoration: none;
      transition: color .3s;
    }

    .wishlist-link:hover {
      color: var(--primary-color);
      text-decoration: underline;
    }

    .wishlist-notes {
      color: #555;
      margin-bottom: 15px;
      line-height: 1.5;
      font-style: italic;
    }

    .wishlist-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      font-size: .9rem;
      color: #888;
    }

    .wishlist-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .icon-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, .9);
      backdrop-filter: blur(5px);
      color: #e84393;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s;
    }

    .icon-btn:hover {
      background: #e84393;
      color: white;
      transform: scale(1.1);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, .85);
      backdrop-filter: blur(5px);
      overflow: auto;
      animation: fadeIn .3s ease;
    }

    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      position: relative;
      animation: slideIn .3s ease;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    @keyframes slideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      padding: 20px 25px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .close-modal {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color .2s;
    }

    .close-modal:hover {
      color: #e84393;
    }

    .modal-body {
      padding: 25px;
      overflow-y: auto;
    }

    /* Pregunta del d√≠a */
    .question {
      font-size: 1.4rem;
      margin-bottom: 20px;
      color: var(--dark-text);
      font-weight: 600;
      line-height: 1.5;
      padding: 20px;
      background: rgba(162, 155, 254, .1);
      border-radius: 15px;
      border-left: 5px solid var(--accent-color);
    }

    .answers {
      margin-top: 25px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .answer-item {
      background: #f8f8f8;
      padding: 15px 20px;
      border-radius: 12px;
      border-left: 5px solid var(--accent-color);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      overflow: hidden;
      flex-shrink: 0;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }


    /* Perfil */
    .profile-section {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .profile-picture {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary-color);
      box-shadow: 0 5px 15px rgba(0, 0, 0, .1);
    }

    .profile-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
    }

    .profile-form input[type="file"] {
      display: none;
    }

    .profile-form label {
      background: var(--gradient);
      color: white;
      padding: 10px 15px;
      border-radius: 50px;
      cursor: pointer;
      text-align: center;
      transition: all .3s;
    }

    .profile-form label:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(232, 67, 147, .4);
    }

    /* Aseg√∫rate de que el footer est√© fijo al fondo de la ventana */
    .site-footer {
      background: var(--gradient);
      color: white;
      text-align: center;
      padding: 20px;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      box-shadow: 0 -5px 15px rgba(0, 0, 0, .1);
      position: fixed;
      bottom: 0;
      /* Se posiciona al fondo de la pantalla */
      width: 100%;
      /* Aseg√∫rate de que ocupe todo el ancho */
      left: 0;
      transform: translateY(100%);
      /* Ocultar el footer inicialmente */
      transition: transform 0.3s ease-in-out;
      /* Transici√≥n suave */
    }

    /* Efecto de l√≠nea superior */
    .site-footer::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: rgba(255, 255, 255, .3);
    }

    .site-footer p {
      margin: 0;
      font-weight: 500;
      font-size: 1rem;
    }

    /* Para dispositivos peque√±os, podr√≠as ajustar el tama√±o del padding o del texto */
    @media (max-width: 768px) {
      .site-footer {
        padding: 15px;
      }
    }


    /* Icono ajustes */
    .settings-icon {
      position: fixed;
      top: 30px;
      left: 30px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: white;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: var(--shadow);
      z-index: 1000;
      cursor: pointer;
      transition: all .3s;
    }

    .settings-icon:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-3px) rotate(45deg);
    }

    /* Blur respuestas bloqueadas */
    .answer-item {
      position: relative;
    }

    .answer-item .answer-text {
      white-space: pre-wrap;
    }

    .answer-item.blurred .answer-text {
      filter: blur(10px);
      user-select: none;
    }

    .answer-item.blurred .blur-hint {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, .6);
      font-weight: 700;
      border-radius: 12px;
      text-align: center;
      padding: 10px;
    }

    /* Popover fotos */
    .travel-actions {
      position: relative;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .icon-btn.plus {
      background: var(--gradient);
      color: #fff;
    }

    .icon-btn.plus:hover {
      transform: scale(1.08);
    }

    .photo-popover {
      position: absolute;
      top: 48px;
      right: 0;
      width: min(420px, calc(100% - 20px));
      background: #fff;
      border: 1px solid #eee;
      border-radius: 14px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, .15);
      padding: 14px 14px 12px;
      transform: translateY(-8px);
      opacity: 0;
      pointer-events: none;
      transition: transform .22s ease, opacity .18s ease;
      z-index: 5;
    }

    .photo-popover.open {
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    .photo-popover::before {
      content: "";
      position: absolute;
      top: -8px;
      right: 18px;
      width: 16px;
      height: 16px;
      background: #fff;
      border-left: 1px solid #eee;
      border-top: 1px solid #eee;
      transform: rotate(45deg);
    }

    .photo-popover-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .photo-popover-title {
      font-weight: 700;
      color: var(--dark-text);
    }

    .photo-popover .close-btn {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: #f5f5f7;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .photo-popover .close-btn:hover {
      background: #efeff3;
    }

    .photo-form-inline {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .photo-form-inline input[type="url"] {
      flex: 1;
      min-width: 160px;
      margin: 0;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: .95rem;
      background: #fafafa;
    }

    .photo-form-inline input[type="url"]:focus {
      border-color: var(--accent-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(162, 155, 254, .15);
    }

    .photo-form-inline .button {
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 700;
    }

    .photo-hint {
      margin-top: 8px;
      font-size: .85rem;
      color: #8a8fa3;
    }

    /* Racha */
    .streak-badges {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin: -5px 0 15px 0;
    }

    .streak-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #f8f8f8;
      border: 2px solid #eee;
      padding: 10px 14px;
      border-radius: 14px;
      font-weight: 600;
      color: var(--dark-text);
    }

    .streak-badge i {
      font-size: 1.1rem;
      color: var(--primary-color);
    }

    .streak-badge.best {
      border-color: var(--accent-color);
    }

    /* Chips prioridad & regalo */
    .priority-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: .8rem;
      font-weight: 700;
      background: #f6f6f9;
      border: 2px solid #eee;
      color: #444;
      margin: 6px 0 10px 0;
    }

    .priority-high {
      background: #ffecec;
      border-color: #ff6b6b;
      color: #b80f0f;
    }

    .priority-mid {
      background: #fff6da;
      border-color: #ffd166;
      color: #996500;
    }

    .priority-low {
      background: #e7fffb;
      border-color: #6ddccf;
      color: #0f6b5c;
    }

    select[name="priority"] {
      background: #f8f8f8;
      border: 2px solid #eee;
      width: 100%;
      margin-bottom: 15px;
      padding: 15px 25px;
      border-radius: 50px;
      font-family: 'Montserrat', sans-serif;
      font-size: 1rem;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23e84393' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 20px center;
      background-size: 16px;
      cursor: pointer;
      transition: all .3s ease;
    }

    select[name="priority"]:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 4px rgba(162, 155, 254, .3);
      background-color: white;
    }

    select[name="priority"]:hover {
      border-color: #ddd;
      background-color: #f0f0f0;
    }

    select[name="priority"] option[value="alta"] {
      color: #ff6b6b;
      font-weight: 600;
    }

    select[name="priority"] option[value="media"] {
      color: #feca57;
      font-weight: 600;
    }

    select[name="priority"] option[value="baja"] {
      color: #48dbfb;
      font-weight: 600;
    }

    .gift-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: .8rem;
      font-weight: 700;
      background: #f2e7ff;
      border: 2px solid #b197fc;
      color: #4b2dbf;
      margin: 6px 0 10px 0;
    }

    .gift-mask {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 120px;
      border: 2px dashed #b197fc;
      border-radius: 12px;
      padding: 18px;
      background: #faf7ff;
      text-align: center;
      font-weight: 600;
      color: #4b2dbf;
      margin: 10px 0 12px 0;
    }

    .gift-mask small {
      display: block;
      margin-top: 6px;
      color: #6c5ce7;
      opacity: .8;
    }

    .wishlist-card.locked .wishlist-actions {
      display: none !important;
    }

    /* Toasts ‚Äî estilo glass + degradado como el sitio */
    #toasts {
      position: fixed;
      right: 16px;
      bottom: 16px;
      /* en m√≥vil aparecer√°n abajo; ver media-query */
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 9999;
      pointer-events: none;
    }

    .toast {
      --accent1: var(--primary-color);
      --accent2: var(--accent-color);
      --life: 3500ms;

      position: relative;
      pointer-events: auto;
      min-width: 280px;
      max-width: min(92vw, 420px);
      border-radius: 16px;
      overflow: hidden;

      background: rgba(255, 255, 255, .9);
      border: 1px solid rgba(255, 255, 255, .6);
      backdrop-filter: blur(10px);
      color: var(--dark-text);
      box-shadow: 0 20px 40px rgba(0, 0, 0, .12), 0 10px 24px rgba(232, 67, 147, .12);
      animation: toast-in .25s ease-out;
    }

    /* franja izq con tu gradiente */
    .toast::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 6px;
      background: linear-gradient(180deg, var(--accent1), var(--accent2));
    }

    /* variantes */
    .toast.info {
      --accent1: #60a5fa;
      --accent2: #3b82f6;
    }

    .toast.success {
      --accent1: #34d399;
      --accent2: #10b981;
    }

    .toast.error {
      --accent1: #f87171;
      --accent2: #ef4444;
    }

    /* contenido */
    .toast .toast-content {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px 12px 16px;
    }

    .toast .icon {
      width: 32px;
      height: 32px;
      flex-shrink: 0;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: #fff;
      box-shadow: 0 8px 18px rgba(0, 0, 0, .12);
    }

    .toast .text {
      line-height: 1.35;
      font-weight: 600;
    }

    /* acciones opcionales dentro del toast */
    .toast .actions {
      margin-left: auto;
      display: flex;
      gap: 8px;
    }

    .toast .btn {
      border: 0;
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 800;
      letter-spacing: .2px;
      cursor: pointer;
      background: #f3f4f6;
      color: #374151;
    }

    .toast .btn:hover {
      background: #edeef2;
    }

    /* cierre */
    .toast .close {
      margin-left: auto;
      background: rgba(0, 0, 0, .04);
      border: 0;
      color: #6b7280;
      font-size: 18px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 10px;
    }

    .toast .close:hover {
      background: rgba(0, 0, 0, .07);
      color: #374151;
    }

    /* barra de vida */
    .toast .progress {
      height: 3px;
      width: 100%;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      animation: toastlife var(--life) linear forwards;
    }

    /* animaciones */
    @keyframes toast-in {
      from {
        transform: translateY(12px);
        opacity: 0
      }

      to {
        transform: translateY(0);
        opacity: 1
      }
    }

    .toast.closing {
      animation: toast-out .22s ease-in forwards;
    }

    @keyframes toast-out {
      to {
        transform: translateY(6px);
        opacity: 0
      }
    }

    @keyframes toastlife {
      from {
        width: 100%
      }

      to {
        width: 0%
      }
    }

    /* en desktop opcional: arriba-derecha (pega a tu logout) */
    @media (min-width: 992px) {
      #toasts {
        top: 24px;
        bottom: auto;
        right: 24px;
      }
    }


    /* Paginaci√≥n & buscador viajes */
    .pager {
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .pager button {
      border: none;
      border-radius: 10px;
      padding: 8px 12px;
      cursor: pointer;
      background: #fff;
      box-shadow: 0 6px 16px rgba(0, 0, 0, .08);
      font-weight: 700;
      color: #444;
      transition: .2s;
    }

    .pager button:hover {
      transform: translateY(-2px);
    }

    .pager button[disabled] {
      opacity: .45;
      cursor: not-allowed;
      transform: none;
    }

    .pager .page-btn.active {
      background: var(--gradient);
      color: #fff;
      box-shadow: 0 8px 20px rgba(232, 67, 147, .35);
    }

    .travel-tools {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .travel-tools input[type="search"] {
      flex: 1;
      min-width: 220px;
      background: #f8f8f8;
      border: 2px solid #eee;
      border-radius: 12px;
      padding: 10px 14px;
      font-size: 1rem;
    }

    .travel-tools .clear-btn {
      border: none;
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      background: #fff;
      box-shadow: 0 6px 16px rgba(0, 0, 0, .08);
      font-weight: 700;
      color: #e84393;
    }

    .travel-tools .clear-btn:hover {
      transform: translateY(-2px);
    }

    /* Responsive */
    @media (max-width: 992px) {
      .banner h1 {
        font-size: 3.5rem;
      }

      .travels-grid,
      .wishlist-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }

      .distance-info {
        max-width: 250px;
      }
    }

    @media (max-width: 768px) {
      .banner {
        height: 350px;
      }

      .banner h1 {
        font-size: 2.8rem;
      }

      .inline-form {
        flex-direction: column;
        align-items: stretch;
      }

      .inline-form input {
        min-width: unset;
      }

      .counters {
        flex-direction: column;
      }

      .banner-form {
        flex-direction: column;
      }

      .logout {
        position: relative;
        top: unset;
        right: unset;
        margin-bottom: 20px;
        display: inline-flex;
      }

      .travels-grid,
      .wishlist-grid {
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      }

      .travel-tabs,
      .wishlist-tabs {
        flex-wrap: wrap;
      }

      .travel-tab,
      .wishlist-tab {
        padding: 8px 15px;
      }

      .distance-map-container {
        height: 350px;
      }

      .distance-info {
        position: relative;
        top: 0;
        right: 0;
        max-width: 100%;
        margin-bottom: 15px;
      }

      .profile-section {
        flex-direction: column;
        text-align: center;
      }
    }

    @media (max-width: 576px) {
      .section {
        padding: 20px;
      }

      .banner h1 {
        font-size: 2.2rem;
      }

      .section h3 {
        font-size: 1.8rem;
      }

      .login-box {
        padding: 30px 20px;
      }

      .travels-grid,
      .wishlist-grid {
        grid-template-columns: 1fr;
      }

      .distance-map-container {
        height: 300px;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
      }
    }

    /* Animaciones entrada */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-in {
      animation: fadeIn .6s ease forwards;
    }

    .delay-1 {
      animation-delay: .2s;
    }

    .delay-2 {
      animation-delay: .4s;
    }

    .delay-3 {
      animation-delay: .6s;
    }

    .delay-4 {
      animation-delay: .8s;
    }

    /* ================================
   BANNER ‚Äî versi√≥n bonita ‚ú®
   ================================ */
    .section.banner {
      position: relative;
      height: clamp(360px, 55vh, 640px);
      border-radius: 28px;
      overflow: hidden;
      box-shadow: 0 30px 60px rgba(232, 67, 147, .18);
      isolate: isolate;
      /* separa los pseudo-elementos */
    }

    /* Foto con Ken Burns (zoom + leve paneo) */
    .section.banner img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: saturate(1.08) contrast(1.05);
      transform-origin: center;
      animation: kenburns 18s ease-in-out infinite alternate;
      will-change: transform;
    }

    @keyframes kenburns {
      0% {
        transform: scale(1.05) translate3d(0, -1%, 0);
      }

      100% {
        transform: scale(1.14) translate3d(0, 1%, 0);
      }
    }

    /* Vi√±eteado suave + degradado superior para leer mejor */
    .section.banner::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(80% 60% at 50% 30%, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, .22) 100%),
        linear-gradient(to top, rgba(0, 0, 0, .50) 0%, rgba(0, 0, 0, 0) 40%);
      pointer-events: none;
      z-index: 1;
    }

    /* Onda decorativa en la base del banner */
    .section.banner::after {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      bottom: -1px;
      height: 110px;
      background:
        url("data:image/svg+xml,%3Csvg width='1440' height='110' viewBox='0 0 1440 110' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0,50 C200,120 420,0 720,70 C1020,140 1240,40 1440,90 L1440,110 L0,110 Z' fill='%23ffffff' fill-opacity='0.92'/%3E%3C/svg%3E") center/cover no-repeat;
      filter: drop-shadow(0 -6px 20px rgba(0, 0, 0, .08));
      z-index: 2;
      pointer-events: none;
    }

    /* Capa de contenido del banner */
    .banner-overlay {
      position: absolute;
      inset: 0;
      display: grid;
      align-content: end;
      justify-items: center;
      padding: clamp(16px, 3.5vw, 32px);
      padding-bottom: clamp(22px, 5.5vw, 48px);
      z-index: 3;
      /* quitamos el gradiente anterior porque ya lo aporta ::before */
      background: transparent;
    }

    /* T√≠tulo con degradado + contorno + tarjeta de vidrio detr√°s */
    .banner-overlay h1 {
      position: relative;
      margin: 0 0 12px 0;
      font-family: 'Dancing Script', cursive;
      font-size: clamp(2.2rem, 7vw, 5rem);
      line-height: 1.05;
      letter-spacing: 1.5px;

      /* degradado dentro del texto */
      background: linear-gradient(135deg, #fff 0%, #ffe8f3 40%, #ffd1ea 70%, #ffffff 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;

      /* contorno sutil para recorte sobre fondos claros */
      -webkit-text-stroke: 1px rgba(255, 255, 255, .45);
      text-shadow:
        0 2px 14px rgba(0, 0, 0, .35),
        0 8px 30px rgba(232, 67, 147, .35);
    }

    /* ‚ÄúTarjeta glass‚Äù detr√°s del t√≠tulo */
    .banner-overlay h1::before {
      content: "";
      position: absolute;
      inset: -8px -18px;
      background: linear-gradient(180deg, rgba(255, 255, 255, .18), rgba(255, 255, 255, .08));
      border: 1px solid rgba(255, 255, 255, .35);
      border-radius: 18px;
      backdrop-filter: blur(10px);
      z-index: -1;
      box-shadow:
        0 10px 30px rgba(0, 0, 0, .15),
        inset 0 1px 0 rgba(255, 255, 255, .25);
    }

    /* L√≠nea/acento bajo el t√≠tulo (sin texto extra) */
    .banner-overlay h1::after {
      content: "";
      display: block;
      height: 4px;
      width: 120px;
      margin: 10px auto 0 auto;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
      box-shadow: 0 6px 20px rgba(162, 155, 254, .45);
    }

    /* Controles dentro del banner: pill de vidrio */
    .banner-form {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      background: rgba(255, 255, 255, .16);
      border: 1px solid rgba(255, 255, 255, .35);
      backdrop-filter: blur(10px);
      padding: 8px;
      border-radius: 999px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .15);
    }

    /* Bot√≥n de ‚ÄúElegir imagen‚Äù: compacto y con icono centrado */
    .banner-form .custom-file-upload {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .9);
      border: 1px solid rgba(255, 255, 255, .65);
      color: var(--primary-color);
      font-weight: 700;
      transition: transform .15s ease, box-shadow .2s ease;
    }

    .banner-form .custom-file-upload:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(232, 67, 147, .25);
    }

    /* Bot√≥n ‚ÄúCambiar banner‚Äù: degradado m√°s premium */
    .banner-form button {
      border-radius: 999px;
      padding: 10px 18px;
      font-weight: 800;
      letter-spacing: .2px;
      background: linear-gradient(135deg, #ff6aa2, #a29bfe);
      border: 1px solid rgba(255, 255, 255, .35);
      box-shadow:
        0 8px 22px rgba(232, 67, 147, .35),
        inset 0 1px 0 rgba(255, 255, 255, .35);
    }

    .banner-form button:hover {
      transform: translateY(-2px);
    }

    /* Indicador de scroll (flecha) */
    .section.banner .scroll-hint {
      position: absolute;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      width: 14px;
      height: 22px;
      border-radius: 8px;
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, .6);
      opacity: .9;
    }

    .section.banner .scroll-hint::before {
      content: "";
      position: absolute;
      left: 50%;
      top: 4px;
      transform: translateX(-50%);
      width: 4px;
      height: 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .9);
      animation: floatDot 1.8s ease-in-out infinite;
    }

    @keyframes floatDot {
      0% {
        transform: translate(-50%, 0);
        opacity: .95;
      }

      100% {
        transform: translate(-50%, 10px);
        opacity: .2;
      }
    }

    /* Responsivo fino para m√≥viles */
    @media (max-width: 768px) {
      .banner-overlay h1 {
        font-size: clamp(2rem, 8vw, 3rem);
      }

      .banner-overlay h1::before {
        inset: -6px -12px;
        border-radius: 16px;
      }

      .banner-form {
        gap: 8px;
        padding: 6px;
      }

      .banner-form .custom-file-upload {
        padding: 8px 14px;
      }

      .banner-form button {
        padding: 8px 14px;
      }
    }

    /* ===== Intimidad (discreto) ===== */
    .intim-pin-wrap {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .intim-pin-wrap input[type="password"] {
      max-width: 200px;
    }

    .intim-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
      margin-top: 10px;
    }

    .intim-card {
      background: #fff;
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, .07);
      border-left: 5px solid var(--accent-color);
    }

    .intim-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .intim-actions input[type="text"],
    .intim-actions textarea {
      border-radius: 12px;
    }

    .intim-kpis {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .intim-kpis .kpi {
      flex: 1;
      min-width: 170px;
      background: var(--gradient);
      color: #fff;
      border-radius: 14px;
      padding: 14px;
      text-align: center;
      box-shadow: 0 8px 22px rgba(232, 67, 147, .15);
    }

    .intim-kpis .kpi h4 {
      font-size: .95rem;
      margin: 0 0 6px 0;
      font-weight: 600;
      opacity: .9;
    }

    .intim-kpis .kpi p {
      font-size: 1.6rem;
      margin: 0;
      font-weight: 800;
    }


    /* Estilos para eventos de intimidad */
    .intim-event-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .intim-event-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, .12);
    }

    .event-actions {
      opacity: 0.7;
      transition: opacity 0.2s ease;
    }

    .intim-event-card:hover .event-actions {
      opacity: 1;
    }

    /* Contador "Pregunta del d√≠a" */
    .dq-countdown {
      margin-top: 10px;
      margin-bottom: 10px;
    }

    .dq-countdown-card {
      display: flex;
      align-items: center;
      gap: 14px;
      flex-wrap: wrap;
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, .05);
      border-left: 6px solid var(--accent-color);
      border-radius: 14px;
      padding: 12px 16px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
    }

    .dq-countdown-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      color: var(--primary-color);
    }

    .dq-countdown-time {
      font-variant-numeric: tabular-nums;
      font-weight: 800;
      letter-spacing: .5px;
      font-size: 1.6rem;
      color: var(--dark-text);
      background: #f7f7fb;
      border: 1px solid #eeeeff;
      padding: 6px 12px;
      border-radius: 10px;
    }

    .dq-countdown-note {
      color: #7f8c8d;
      font-size: .9rem;
      margin-left: auto;
    }

    @media (max-width: 600px) {
      .dq-countdown-card {
        gap: 10px;
      }

      .dq-countdown-note {
        width: 100%;
        margin-left: 0;
      }
    }



    /* === Login mejorado === */
    .input-group {
      position: relative;
      margin-bottom: 14px;
    }

    .input-group input {
      background: #f8f8f8;
      border: 2px solid #eee;
      width: 100%;
      padding: 14px 48px 14px 44px;
      border-radius: 14px;
      transition: .25s;
    }

    .input-group input:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 4px rgba(162, 155, 254, .18);
      background: #fff;
    }

    .input-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: #9aa0a6;
      font-size: 16px;
    }

    .toggle-pass {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 38px;
      height: 38px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: #f3f4f6;
      color: #6b7280;
    }

    .toggle-pass:hover {
      background: #edeef2;
    }

    .remember-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin: 6px 0 14px 0;
    }

    .remember-check {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #4b5563;
      font-weight: 600;
    }

    .remember-check input {
      width: auto;
    }

    .forgot-link {
      color: var(--accent-color);
      text-decoration: none;
      font-weight: 700;
    }

    .forgot-link:hover {
      color: var(--primary-color);
      text-decoration: underline;
    }

    .caps-hint {
      margin: -6px 0 10px 0;
      font-size: .95rem;
      color: #b45309;
      background: #fff7ed;
      border-left: 4px solid #f59e0b;
      padding: 8px 10px;
      border-radius: 8px;
    }

    .btn-full {
      width: 100%;
      border-radius: 14px;
      padding: 14px 16px;
      font-weight: 800;
      letter-spacing: .3px;
      display: inline-flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
    }

    .btn-spinner {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, .35);
      border-top-color: #fff;
      display: none;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .btn-loading .btn-text {
      opacity: .8
    }

    .btn-loading .btn-spinner {
      display: inline-block
    }

    .login-note {
      color: #6b7280;
      font-size: .9rem;
      margin-top: 12px;
    }

    @media (max-width:576px) {
      .input-group input {
        padding: 13px 46px 13px 42px;
      }

      .toggle-pass {
        width: 36px;
        height: 36px;
      }
    }


    /* Enlace de Editar: discreto */
    .edit-link {
      font-weight: 700;
      text-decoration: none;
      color: #8a8fa3;
      /* gris suave, no azul */
      opacity: .9;
      padding: 4px 8px;
      border-radius: 10px;
      transition: color .15s ease, background .15s ease, opacity .15s ease;
    }

    .edit-link:hover {
      color: #6b7280;
      /* un poco m√°s oscuro al hover */
      background: #f3f4f6;
      /* pill suave al hover */
      opacity: 1;
    }

    /* Etiqueta (editado) estilo WhatsApp-ish */
    .edited-pill {
      opacity: .75;
      margin-left: 6px;
      font-size: .85em;
      font-style: italic;
      color: #6b7280;
    }


    /* Chip de talla */
    .size-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: .8rem;
      font-weight: 700;
      background: #eef2ff;
      border: 2px solid #c7d2fe;
      color: #3730a3;
      /* azul suave */
      margin: 6px 0 10px 0;
    }

    .size-chip i {
      font-size: .95rem;
    }


    /* Talla debajo del enlace */
    .wishlist-size {
      font-size: .95rem;
      color: #555;
      background: #f8f8f8;
      padding: 6px 10px;
      border-radius: 8px;
      margin-top: 8px;
      display: inline-block;
    }

    /* ==============================
   WISHLIST v2 ‚Äî tarjetas iguales
   ============================== */
    :root {
      /* Altura global de tarjeta (ajusta a tu gusto) */
      --wl-h: 280px;
    }

    /* Grid estable; cada celda tendr√° la misma altura visual */
    .wishlist-grid {
      grid-auto-rows: var(--wl-h);
    }

    /* Tarjeta: layout de columna, sin scroll, look m√°s minimal */
    .wishlist-card {
      height: var(--wl-h);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      /* nada de scroll interno */
      border: 1px solid #f1f1f4;
      /* m√°s limpio */
      box-shadow: 0 8px 22px rgba(0, 0, 0, .06);
      background:
        radial-gradient(120% 80% at 120% -10%, rgba(162, 155, 254, .08), transparent 50%),
        #fff;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }

    .wishlist-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 16px 34px rgba(0, 0, 0, .10);
      border-color: #ececf6;
    }

    /* Franja de estado m√°s compacta y legible */
    .wishlist-status {
      top: 12px;
      right: 12px;
      padding: 4px 10px;
      font-size: .78rem;
      letter-spacing: .2px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, .08);
    }

    /* Cabecera de chips: m√°s peque√±as y en una sola l√≠nea si cabe */
    .priority-chip,
    .gift-chip {
      padding: 5px 9px;
      font-size: .78rem;
      border-radius: 999px;
      margin: 2px 0 8px 0;
    }

    /* T√≠tulo con 2 l√≠neas m√°x. para evitar saltos de altura */
    .wishlist-product {
      font-size: 1.15rem;
      line-height: 1.25;
      margin: 6px 0 6px 0;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Enlace como ‚Äúchip‚Äù con ellipsis; sin romper la altura */
    .wishlist-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 11px;
      border-radius: 10px;
      background: #f7f7fb;
      border: 1px solid #eee;
      text-decoration: none;
      font-weight: 700;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .wishlist-link i {
      opacity: .75;
    }

    .wishlist-link:hover {
      background: #f1f1f9;
      color: var(--primary-color);
      border-color: #e9e9f4;
      text-decoration: none;
    }

    /* Talla estilo ‚Äúpill‚Äù (compacto) */
    .wishlist-size {
      font-size: .85rem;
      color: #3730a3;
      background: #eef2ff;
      border: 1px solid #c7d2fe;
      padding: 5px 9px;
      border-radius: 999px;
      margin-top: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* Notas: clamp a 3 l√≠neas para que todas midan igual */
    .wishlist-notes {
      color: #555;
      font-style: italic;
      line-height: 1.5;
      margin-top: 10px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Empuja ‚Äúmeta‚Äù y luego acciones al pie, sin scroll */
    .wishlist-meta {
      margin-top: auto !important;
      /* clave: ancla contenido superior */
      font-size: .88rem;
      color: #8a8fa3;
      padding-top: 10px;
      border-top: 1px dashed #eee;
    }

    .wishlist-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      padding-top: 8px;
    }

    /* Icon buttons m√°s suaves */
    .icon-btn {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      background: #fafafa;
      color: var(--primary-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, .06);
    }

    .icon-btn:hover {
      background: var(--primary-color);
      color: #fff;
      transform: translateY(-1px);
    }

    /* ‚ÄúComprado‚Äù m√°s sutil; ‚ÄúDeseado‚Äù con acento */
    .wishlist-card.purchased {
      opacity: 1;
      /* evita que parezca ‚Äúapagado‚Äù */
      border-left: 5px solid var(--purchased-color);
      background:
        radial-gradient(140% 80% at -10% 0%, rgba(178, 190, 195, .10), transparent 45%),
        #fff;
    }

    .wishlist-card:not(.purchased) {
      border-left: 5px solid var(--wishlist-color);
    }

    /* Regalo oculto: centra el bloque y evita que ‚Äúestire‚Äù */
    .wishlist-card.locked .gift-mask {
      min-height: auto;
      margin: 8px 0 4px 0;
    }

    /* Responsive: ajusta la altura com√∫n para que quepa todo sin scroll */
    @media (max-width: 992px) {
      :root {
        --wl-h: 300px;
      }
    }

    @media (max-width: 768px) {
      :root {
        --wl-h: 320px;
      }
    }

    @media (max-width: 576px) {
      :root {
        --wl-h: 340px;
      }
    }

    /* ===== Wishlist fix: altura visible sin cortes ===== */
    :root {
      /* Altura com√∫n m√°s generosa y fluida seg√∫n ancho */
      --wl-h: clamp(320px, 35vw, 380px);
    }

    /* Mant√©n las filas iguales, pero m√°s altas */
    .wishlist-grid {
      grid-auto-rows: var(--wl-h);
      align-items: stretch;
    }

    /* Tarjeta: aseguramos hueco al pie y sin recortes */
    .wishlist-card {
      height: var(--wl-h);
      padding-bottom: 14px;
      /* hueco extra abajo */
      overflow: hidden;
    }

    /* Notas m√°s compactas (2 l√≠neas) para ganar aire */
    .wishlist-notes {
      -webkit-line-clamp: 2;
      margin-top: 8px;
    }

    /* Chips un poco m√°s peque√±os */
    .priority-chip,
    .gift-chip {
      padding: 4px 8px;
      font-size: .76rem;
      margin: 0 0 6px 0;
    }

    /* Enlace compacto (chip) */
    .wishlist-link {
      padding: 6px 10px;
    }

    /* Meta y acciones: menos separaci√≥n */
    .wishlist-meta {
      padding-top: 8px;
      margin-top: auto !important;
      border-top: 1px dashed #eee;
    }

    .wishlist-actions {
      gap: 8px;
      margin-top: 8px;
      padding-top: 6px;
    }

    .icon-btn {
      width: 32px;
      height: 32px;
      border-radius: 9px;
    }

    /* ‚ÄúRegalo‚Äù sin altura m√≠nima alta para que no empuje */
    .wishlist-card.locked .gift-mask {
      min-height: 0;
      padding: 14px;
    }

    /* Ajustes por breakpoint: m√°s altura cuando hay menos ancho */
    @media (max-width: 992px) {
      :root {
        --wl-h: clamp(340px, 42vw, 410px);
      }
    }

    @media (max-width: 768px) {
      :root {
        --wl-h: 420px;
      }

      /* m√≥viles: m√°s alto para que quepa todo */
    }

    @media (max-width: 576px) {
      :root {
        --wl-h: 440px;
      }
    }



    /* ===== Price UI ===== */
    .price-card {
      background: rgba(255, 255, 255, .6);
      border: 1px solid rgba(0, 0, 0, .06);
      border-radius: 14px;
      padding: 12px;
      margin-top: 10px;
      backdrop-filter: blur(6px);
    }

    .price-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: .85rem;
      line-height: 1;
      border: 1px solid transparent;
    }

    .badge-on {
      background: rgba(16, 185, 129, .12);
      color: #065f46;
      border-color: rgba(16, 185, 129, .25);
    }

    .badge-off {
      background: rgba(107, 114, 128, .12);
      color: #374151;
      border-color: rgba(107, 114, 128, .25);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(0, 0, 0, .06);
      font-size: .9rem;
    }

    .chip.muted {
      opacity: .8
    }

    .btn-check {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, .12);
      background: #fff;
      cursor: pointer;
      transition: .15s transform, .15s box-shadow;
    }

    .btn-check:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
    }

    .btn-check[disabled] {
      opacity: .6;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .price-down {
      background: rgba(34, 197, 94, .14);
    }

    .price-same {
      background: rgba(59, 130, 246, .14);
    }

    .price-help details {
      margin-top: 6px;
    }

    .price-help summary {
      cursor: pointer;
      opacity: .8;
    }

    .price-form {
      display: grid;
      gap: 10px;
      margin-top: 8px;
    }

    @media (min-width:520px) {
      .price-form {
        grid-template-columns: 1fr 1fr;
      }
    }

    .input-wrap {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .input-wrap label {
      font-size: .9rem;
      opacity: .9;
    }

    .input-wrap input[type="number"],
    .input-wrap input[type="text"] {
      padding: 10px 12px;
      border: 1px solid rgba(0, 0, 0, .12);
      border-radius: 10px;
      background: #fff;
    }

    .helper {
      font-size: .8rem;
      opacity: .8;
    }

    .switch {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .switch input {
      display: none;
    }

    .switch label {
      position: relative;
      display: inline-block;
      width: 54px;
      height: 30px;
      background: rgba(0, 0, 0, .14);
      border-radius: 999px;
      cursor: pointer;
      transition: .2s background;
    }

    .switch label::after {
      content: "";
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .15);
      transition: .2s transform;
    }

    .switch input:checked+label {
      background: linear-gradient(90deg, #22c55e, #16a34a);
    }

    .switch input:checked+label::after {
      transform: translateX(24px);
    }

    .switch-text {
      font-weight: 600;
    }

    .flash {
      animation: flash .8s ease;
    }

    @keyframes flash {
      0% {
        box-shadow: 0 0 0 0 rgba(16, 185, 129, .5)
      }

      100% {
        box-shadow: 0 0 0 12px rgba(16, 185, 129, 0)
      }
    }

    /* -------- Gift chip en tarjetas (se ve como un botoncito pill) -------- */
    .gift-chip {
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      padding: .4rem .8rem;
      border-radius: 999px;
      font-weight: 700;
      letter-spacing: .2px;
      color: #fff;
      background: linear-gradient(135deg, var(--gift-start, #ff7ab6), var(--gift-end, #ff4d8d));
      box-shadow: 0 6px 14px rgba(255, 77, 141, .35), inset 0 0 0 1px rgba(255, 255, 255, .2);
      position: relative;
      transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
    }

    .gift-chip::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background:
        radial-gradient(120px 80px at -20% 0%, rgba(255, 255, 255, .35), transparent 40%),
        radial-gradient(120px 80px at 120% 100%, rgba(255, 255, 255, .18), transparent 40%);
      pointer-events: none;
    }

    .gift-chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(255, 77, 141, .45), inset 0 0 0 1px rgba(255, 255, 255, .25);
    }

    .gift-chip:active {
      transform: translateY(0);
      filter: brightness(.95);
    }

    /* -------- Toggle de regalo en el formulario (el checkbox se ‚Äúdisfraza‚Äù de bot√≥n) -------- */
    .wishlist-form .gift-toggle-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 6px 0 14px 0;
    }

    /* Ocultamos el checkbox real */
    .wishlist-form #is_gift {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    /* El label parece un bot√≥n */
    .wishlist-form label[for="is_gift"] {
      cursor: pointer;
      user-select: none;
      display: inline-flex;
      align-items: center;
      gap: .6rem;
      padding: .55rem .9rem;
      border-radius: 999px;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg, var(--gift-start, #ff7ab6), var(--gift-end, #ff4d8d));
      box-shadow: 0 6px 14px rgba(255, 77, 141, .35), inset 0 0 0 1px rgba(255, 255, 255, .2);
      transition: transform .15s ease, box-shadow .2s ease, filter .2s ease, opacity .2s ease;
      position: relative;
    }

    .wishlist-form label[for="is_gift"]::before {
      content: "üéÅ";
      font-size: 1rem;
      line-height: 1;
    }

    /* Estado activo cuando est√° marcado */
    .wishlist-form #is_gift:checked+label {
      box-shadow: 0 12px 26px rgba(255, 77, 141, .5), inset 0 0 0 1px rgba(255, 255, 255, .25);
      transform: translateY(-1px);
    }

    .wishlist-form #is_gift:checked+label::after {
      content: " ¬°Activado!";
      font-weight: 800;
    }

    /* Accesibilidad foco */
    .wishlist-form #is_gift:focus-visible+label,
    .wishlist-form label[for="is_gift"]:focus {
      outline: 2px solid rgba(255, 77, 141, .8);
      outline-offset: 2px;
    }

    /* Opcional: adapta a modo caf√© si usas tema ‚ÄúNico‚Äù */
    :root[data-theme="nico"] {
      --gift-start: #d0a676;
      /* caf√© con leche (tu brand) */
      --gift-end: #b98b5b;
    }


    /* Wishlist ‚Äî barra de orden */
    .wishlist-tools {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap;
      margin: 8px 0 6px;
    }

    .wishlist-tools select {
      border: 1px solid #eee;
      background: #fff;
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: 700;
      cursor: pointer;
    }


    /* === Sort toggle bonito === */
    .sort-toggle {
      position: relative;
      display: inline-flex;
      gap: 6px;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 999px;
      padding: 4px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, .06);
    }

    .sort-toggle .slider {
      position: absolute;
      left: 4px;
      top: 4px;
      bottom: 4px;
      width: 0;
      /* la ajusta el JS */
      border-radius: 999px;
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      box-shadow: 0 10px 24px rgba(232, 67, 147, .35);
      transition: transform .25s ease, width .25s ease;
      z-index: 1;
    }

    .sort-toggle button {
      position: relative;
      z-index: 2;
      appearance: none;
      border: 0;
      background: transparent;
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 800;
      letter-spacing: .2px;
      color: #6b7280;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: color .15s ease, transform .15s ease;
    }

    .sort-toggle button:hover {
      transform: translateY(-1px);
    }

    .sort-toggle button.active {
      color: #fff;
    }

    .sort-toggle:focus-visible {
      outline: none;
      box-shadow: 0 0 0 4px rgba(162, 155, 254, .25);
      border-color: #e9e9f3;
    }

    @media (max-width: 480px) {
      .sort-toggle button {
        padding: 8px 10px;
        font-weight: 700;
      }
    }

    /* ===== Presencia (chip) ===== */
    .presence-chip {
      position: fixed;
      top: 30px;
      left: 90px;
      /* al lado del icono de ajustes (izquierda) */
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 999px;
      padding: 8px 12px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, .08);
      z-index: 1000;
    }

    .presence-chip .avatar-mini {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--gradient);
      color: #fff;
      font-weight: 800;
      font-size: .9rem;
    }

    .presence-chip .avatar-mini img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .presence-name {
      font-weight: 700;
      color: #555;
    }

    .presence-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #9ca3af;
      /* gris por defecto */
      box-shadow: 0 0 0 2px rgba(0, 0, 0, .04) inset;
    }

    .presence-dot.online {
      background: #22c55e;
    }

    /* verde */
    .presence-text {
      font-weight: 700;
      color: #374151;
      /* En l√≠nea */
    }

    .presence-text.offline {
      color: #6b7280;
    }

    /* √öltima vez ... en gris */
    @media (max-width: 600px) {
      .presence-chip {
        left: 82px;
        padding: 6px 10px;
        gap: 6px;
      }

      .presence-name {
        display: none;
      }

      /* ahorra espacio en m√≥vil */
    }

    /* Bot√≥n Admin: mismo estilo que el del perfil, colocado debajo */
    .admin-icon {
      top: 92px;
    }

    /* 30px (margen superior) + 50px (alto del icono) + 12px (separaci√≥n) */

    /* =========================
   NAV + PANTALLAS (responsive)
   ========================= */

    /* Contenedor de p√°ginas (las iremos moviendo por JS) */
    #pages {
      width: 100%;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* Tabbar m√≥vil (abajo) + sidebar desktop (izquierda) */
    .app-nav {
      position: fixed;
      inset: auto 0 0 0;
      height: 64px;
      background: rgba(255, 255, 255, .9);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0, 0, 0, .06);
      display: grid;
      grid-auto-flow: column;
      justify-content: space-around;
      align-items: center;
      z-index: 1100;
      box-shadow: 0 -10px 24px rgba(0, 0, 0, .06);
    }

    .app-nav .nav-btn {
      appearance: none;
      border: 0;
      background: transparent;
      cursor: pointer;
      width: 44px;
      height: 44px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      transition: transform .15s ease, box-shadow .2s ease;
    }

    .app-nav .nav-btn:focus-visible {
      outline: 2px solid var(--accent-color);
      outline-offset: 2px;
    }

    .app-nav .nav-btn.active {
      box-shadow: 0 6px 14px rgba(232, 67, 147, .28), inset 0 0 0 1px rgba(0, 0, 0, .06);
    }

    .app-nav .nav-btn:hover {
      transform: translateY(-1px);
    }

    /* Oculta etiquetas en m√≥vil, solo emoji */
    .app-nav .nav-label {
      position: absolute;
      width: 1px;
      height: 1px;
      overflow: hidden;
      clip: rect(1px, 1px, 1px, 1px);
    }

    /* Margen inferior para que el tabbar no tape contenido en m√≥vil */
    .container {
      padding-bottom: 96px;
    }

    /* Desktop: sidebar izquierda */
    @media (min-width: 992px) {
      .app-nav {
        inset: 0 auto 0 0;
        width: 76px;
        height: auto;
        border-top: 0;
        border-right: 1px solid rgba(0, 0, 0, .06);
        grid-auto-flow: row;
        justify-content: center;
        gap: 10px;
        padding: 12px 0;
        box-shadow: 10px 0 24px rgba(0, 0, 0, .06);
      }

      .container {
        padding-left: 96px;
        padding-bottom: 40px;
      }
    }



    /* Navbar con Font Awesome: color al activo */
    .app-nav .nav-btn i {
      font-size: 20px;
      color: #6b7280;
      pointer-events: none;
    }

    .app-nav .nav-btn.active i {
      color: var(--primary-color);
    }


    /* ============================
   Floating UI responsive fix
   ‚Äî evita solapes con el navbar
   ============================ */

    /* Zonas seguras del nuevo navbar */
    :root {
      --nav-left-desktop: 76px;
      /* ancho de la sidebar en desktop */
      --nav-bottom-mobile: 64px;
      /* alto del tabbar en m√≥vil */
      --gap: 16px;
      /* separaci√≥n base */
    }

    /* Asegura que floten por encima del navbar */
    #presenceChip,
    .settings-icon,
    .admin-icon,
    .debug-fab,
    #enablePushBtn {
      z-index: 1200;
      /* navbar usa ~1100 */
    }

    /* ===== M√ìVIL / TABLET (navbar abajo) ===== */
    @media (max-width: 991.98px) {

      /* Colocamos en columna, arriba-izquierda, sin solapes entre s√≠ */
      .settings-icon {
        /* Usuario */
        position: fixed;
        top: calc(var(--gap));
        left: calc(var(--gap));
      }

      #presenceChip {
        /* Estado */
        position: fixed;
        top: calc(var(--gap) + 60px);
        /* debajo del bot√≥n de usuario */
        left: calc(var(--gap));
        right: auto;
      }

      .admin-icon {
        /* Admin */
        position: fixed;
        top: calc(var(--gap) + 60px + 60px);
        left: calc(var(--gap));
      }

      /* Bot√≥n de notificaciones (si lo usas) despejado del tabbar */
      .debug-fab,
      #enablePushBtn {
        position: fixed !important;
        right: 16px !important;
        bottom: calc(16px + var(--nav-bottom-mobile)) !important;
        /* por encima del tabbar */
      }

      /* Por si el chip de estado se hace muy ancho en m√≥vil */
      #presenceChip {
        max-width: calc(100vw - 2*var(--gap));
      }
    }

    /* ===== DESKTOP (navbar a la izquierda) ===== */
    @media (min-width: 992px) {
      .settings-icon {
        /* Usuario */
        position: fixed;
        top: 20px;
        left: calc(var(--nav-left-desktop) + var(--gap));
      }

      #presenceChip {
        /* Estado (debajo de usuario) */
        position: fixed;
        top: 88px;
        left: calc(var(--nav-left-desktop) + var(--gap));
      }

      .admin-icon {
        /* Admin (debajo de estado) */
        position: fixed;
        top: 156px;
        left: calc(var(--nav-left-desktop) + var(--gap));
      }

      /* Notificaciones: esquina inferior derecha normal */
      .debug-fab,
      #enablePushBtn {
        position: fixed !important;
        right: 16px !important;
        bottom: 16px !important;
      }
    }

    /* Opcional: mini pulido visual */
    #presenceChip {
      box-shadow: 0 8px 20px rgba(0, 0, 0, .08);
    }

    .settings-icon,
    .admin-icon {
      box-shadow: var(--shadow);
    }




    /* ===== Pel√≠culas & Series ===== */
    .media-tools {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .media-tools input[type="search"] {
      flex: 1;
      min-width: 220px;
      background: #f8f8f8;
      border: 2px solid #eee;
      border-radius: 12px;
      padding: 10px 14px;
      font-size: 1rem;
    }

    .media-tabs {
      display: flex;
      border-bottom: 2px solid #eee;
      margin: 8px 0 12px;
      flex-wrap: wrap;
    }

    .media-tab {
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 700;
      border-bottom: 3px solid transparent;
    }

    .media-tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }

    .media-tab:hover:not(.active) {
      color: var(--secondary-color);
    }

    .media-content {
      display: none;
    }

    .media-content.active {
      display: block;
    }

    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 18px;
    }

    .media-card {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 8px 22px rgba(0, 0, 0, .08);
      position: relative;
      border: 1px solid #f1f1f4;
      display: flex;
      flex-direction: column;
      min-height: 220px;
    }

    .media-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, .10);
    }

    .media-card.watched {
      border-left: 5px solid var(--visited-color);
    }

    .media-card:not(.watched) {
      border-left: 5px solid var(--wishlist-color);
    }

    .media-status {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: .78rem;
      font-weight: 800;
      color: #fff;
      box-shadow: 0 6px 16px rgba(0, 0, 0, .10);
    }

    .badge-wanted {
      background: var(--wishlist-color);
    }

    .badge-watched {
      background: var(--visited-color);
    }

    .media-head {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .media-kind {
      font-weight: 800;
      font-size: .82rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: #f7f7fb;
      border: 1px solid #eee;
      color: #6b7280;
    }

    .media-kind.movie {
      background: #fff7f9;
      border-color: #ffe0eb;
      color: #b91c1c;
    }

    .media-kind.show {
      background: #f1f8ff;
      border-color: #dbeafe;
      color: #1d4ed8;
    }

    .platform-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 9px;
      border-radius: 10px;
      background: #f8f8f8;
      border: 1px solid #eee;
      font-weight: 700;
      color: #374151;
    }

    .media-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.2rem;
      margin: 6px 0 8px;
    }

    .media-link {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      font-weight: 700;
      text-decoration: none;
      background: #f7f7fb;
      border: 1px solid #eee;
      padding: 7px 12px;
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .media-link:hover {
      background: #f1f1f9;
      color: var(--primary-color);
    }

    .media-notes {
      color: #555;
      font-style: italic;
      margin-top: 6px;
    }

    .progress-row {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: space-between;
      margin-top: 6px;
    }

    .progress-row.muted {
      opacity: .8;
    }

    .progress-form .icon-btn {
      width: 30px;
      height: 30px;
      border-radius: 8px;
    }

    .media-meta {
      margin-top: auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      color: #8a8fa3;
      font-size: .9rem;
      padding-top: 8px;
      border-top: 1px dashed #eee;
    }

    .media-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .media-form .grid2 {
      display: grid;
      gap: 10px;
    }

    @media (min-width:520px) {
      .media-form .grid2 {
        grid-template-columns: 1fr 1fr;
      }
    }

    .media-form .input-wrap {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .media-form input[type="text"],
    .media-form input[type="url"],
    .media-form input[type="number"],
    .media-form select,
    .media-form textarea {
      padding: 10px 12px;
      border: 1px solid rgba(0, 0, 0, .12);
      border-radius: 10px;
      background: #fff;
    }

    /* Rating (estrellas) */
    .rating {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 8px 0 2px;
    }

    .rating i.fa-star {
      font-size: 1.1rem;
    }

    .rating.readonly i.fas {
      color: #f59e0b;
    }

    .rating.editable i {
      cursor: pointer;
    }

    .rating.editable i.fas {
      color: #f59e0b;
    }

    .rating .rating-help {
      font-size: .85rem;
      color: #8a8fa3;
      margin-left: 6px;
    }

    /* Paginaci√≥n espec√≠fica media */
    #media-pager-towatch,
    #media-pager-watched {
      margin-top: 12px;
    }





    /* ===== P√°ginas: Media ===== */
    /* Oculto por defecto en Inicio */
    .section[data-section="media"] {
      display: none;
    }

    /* Cuando estamos en la p√°gina "media" */
    body.page-media .section[data-section="media"] {
      display: block;
    }

    /* En "media", ocultamos el resto de secciones del inicio (banner y otras tarjetas) */
    body.page-media .banner,
    body.page-media .section:not([data-section="media"]) {
      display: none !important;
    }



    /* Portada en tarjetas Media */
    .media-cover {
      position: relative;
      height: 160px;
      overflow: hidden;
      border-radius: 12px;
      margin: -4px -4px 10px -4px;
      background: #f6f7fb;
    }

    .media-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }


    /* Media grid: garantiza columnas ‚Äúreales‚Äù medibles */
    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 18px;
      /* opcional: pack si las alturas var√≠an mucho (suele no hacer falta) */
      /* grid-auto-flow: dense; */
    }

    /* Logos de plataformas como imagen */
    .platform-chip {
      display: inline-flex;
      align-items: center;
      padding: 0;
      border: 0;
      background: transparent;
    }

    .platform-chip img {
      height: 18px;
      width: auto;
      display: block;
    }

    /* Accesibilidad: texto solo para lectores de pantalla */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0 0 0 0);
      white-space: nowrap;
      border: 0;
    }

    /* === Brand toggles (Netflix / Prime) === */
    .brand-toggles {
      display: grid;
      gap: 12px;
    }

    @media (min-width:520px) {
      .brand-toggles {
        grid-template-columns: 1fr 1fr;
      }
    }

    .brand-toggle {
      position: relative;
    }

    .brand-toggle input {
      position: absolute;
      inset: 0;
      opacity: 0;
      pointer-events: none;
    }

    /* Bot√≥n pastilla con logo */
    .brand-toggle .brand {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      height: 48px;
      border-radius: 12px;
      border: 1px solid #eee;
      background: #fff;
      box-shadow: 0 8px 20px rgba(0, 0, 0, .06);
      cursor: pointer;
      font-weight: 800;
      letter-spacing: .1px;
      transition: .18s transform, .18s box-shadow, .18s border-color, .18s filter;
    }

    .brand-toggle .brand img {
      height: 20px;
      width: auto;
      display: block;
    }

    /* Colores de marca */
    .brand-toggle .brand.netflix {
      --brand: #e50914;
    }

    .brand-toggle .brand.prime {
      --brand: #00a8e1;
    }

    /* Estado activo (checked) */
    .brand-toggle input:checked+.brand {
      transform: translateY(-1px);
      border-color: var(--brand);
      box-shadow: 0 12px 28px rgba(0, 0, 0, .12), 0 0 0 2px var(--brand) inset;
    }

    /* Hover/focus */
    .brand-toggle .brand:hover {
      transform: translateY(-1px);
    }

    .brand-toggle input:focus-visible+.brand {
      outline: 2px solid var(--accent-color);
      outline-offset: 2px;
    }

    /* Modo oscuro opcional (si usas dark mode global) */
    @media (prefers-color-scheme: dark) {
      .brand-toggle .brand {
        background: #111827;
        border-color: #1f2937;
      }
    }


    /* Solo-logo, mini toggles */
    :root {
      --brand-size: 34px;
      /* cambia a 28‚Äì36px si quieres m√°s/menos peque√±o */
      --brand-img: 20px;
    }

    @media (max-width:480px) {
      :root {
        --brand-size: 30px;
        --brand-img: 18px;
      }
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0 0 0 0);
      white-space: nowrap;
      border: 0;
    }

    .brand-toggles-min {
      display: flex;
      gap: 10px;
      align-items: center;
      /* fila compacta */
    }

    .brand-icon-toggle {
      position: relative;
    }

    .brand-icon-toggle input {
      position: absolute;
      inset: 0;
      opacity: 0;
      pointer-events: none;
    }

    .brand-icon-toggle label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: var(--brand-size);
      height: var(--brand-size);
      /* Sin fondo, sin borde ‚Äî ‚Äúsin cuadro‚Äù */
      background: transparent;
      border: 0;
      border-radius: 8px;
      cursor: pointer;
      transition: transform .12s ease, filter .15s ease;
    }

    .brand-icon-toggle label img {
      height: var(--brand-img);
      width: auto;
      display: block;
      filter: grayscale(100%) opacity(.6);
      transition: filter .15s ease, transform .12s ease;
    }

    .brand-icon-toggle label:hover img {
      transform: translateY(-1px);
    }

    .brand-icon-toggle input:focus-visible+label {
      outline: 2px solid var(--accent-color);
      outline-offset: 2px;
    }

    /* Activo: solo el logo se pone a color (sin recuadro) */
    .brand-icon-toggle input:checked+label img {
      filter: none;
      opacity: 1;
    }


    /* Solo-logo, mini toggles ‚Äî versi√≥n con etiqueta */
    :root {
      /* ajusta aqu√≠ el tama√±o general */
      --brand-size: 52px;
      /* ancho del bot√≥n/columna */
      --brand-img: 30px;
      /* alto del logo */
    }

    @media (max-width:480px) {
      :root {
        --brand-size: 46px;
        --brand-img: 26px;
      }
    }

    .brand-toggles-min {
      display: flex;
      gap: 14px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .brand-icon-toggle {
      position: relative;
    }

    .brand-icon-toggle input {
      position: absolute;
      inset: 0;
      opacity: 0;
      pointer-events: none;
    }

    .brand-icon-toggle label {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 6px;
      width: var(--brand-size);
      /* columna compacta */
      height: auto;
      padding: 4px 0;
      background: transparent;
      border: 0;
      border-radius: 8px;
      /* sin cuadro */
      cursor: pointer;
      transition: transform .12s ease, filter .15s ease;
    }

    .brand-icon-toggle label img {
      height: var(--brand-img);
      width: auto;
      display: block;
      filter: grayscale(100%) opacity(.6);
      transition: filter .15s ease, transform .12s ease;
    }

    .brand-icon-toggle label:hover img {
      transform: translateY(-1px);
    }

    .brand-icon-toggle input:focus-visible+label {
      outline: 2px solid var(--accent-color);
      outline-offset: 2px;
    }

    /* Etiqueta visible bajo el icono */
    .brand-caption {
      font-size: .75rem;
      line-height: 1;
      font-weight: 700;
      letter-spacing: .2px;
      color: #8a8fa3;
      user-select: none;
    }

    /* Activo: logo a color + etiqueta con color de marca */
    .brand-icon-toggle input:checked+label img {
      filter: none;
      opacity: 1;
    }

    .brand-icon-toggle input:checked+label .brand-caption {
      color: #374151;
    }

    /* fallback */

    .brand-icon-toggle input:checked+label.netflix .brand-caption {
      color: #e50914;
    }

    .brand-icon-toggle input:checked+label.prime .brand-caption {
      color: #00a8e1;
    }


    /* === Chips r√°pidos en banner === */
    .home-chips {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 10px;
    }

    .chip-stat {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .85);
      border: 1px solid rgba(255, 255, 255, .5);
      font-weight: 800;
      letter-spacing: .2px;
      color: #374151;
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 22px rgba(0, 0, 0, .08);
    }

    .chip-stat i {
      opacity: .85;
    }

    .chip-stat.soon {
      background: linear-gradient(135deg, #ffe8f3, #ffffff);
      border-color: rgba(232, 67, 147, .35);
      box-shadow: 0 10px 26px rgba(232, 67, 147, .25);
    }

    @media (max-width:600px) {
      .chip-stat {
        padding: 7px 10px;
        font-weight: 700;
      }
    }

    /* === Utilidades del mapa === */
    .map-fab {
      position: absolute;
      bottom: 15px;
      right: 15px;
      width: 42px;
      height: 42px;
      border-radius: 12px;
      border: 0;
      cursor: pointer;
      background: #fff;
      color: #e84393;
      box-shadow: 0 10px 24px rgba(0, 0, 0, .12);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3;
      transition: transform .15s ease;
    }

    .map-fab:hover {
      transform: translateY(-2px);
    }

    .distance-map-container.full {
      height: 70vh;
      box-shadow: 0 16px 40px rgba(0, 0, 0, .12);
    }

    /* Barra de ‚Äúcercan√≠a‚Äù */
    .distance-bar {
      margin: 8px 0 6px;
      height: 10px;
      border-radius: 999px;
      overflow: hidden;
      background: #f1f1f5;
      border: 1px solid #ececf4;
    }

    .distance-bar .fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
      transition: width .35s ease;
    }


    /* <!-- NAVIDAD (tema) se puede borrar--> */



    /* ======== TEMA NAVIDAD ROJO (solo rojo) ======== */
    :root[data-theme="xmas"] {
      --primary-color: #c9182a;
      /* rojo principal */
      --secondary-color: #a50f23;
      /* rojo oscuro */
      --accent-color: #ff6a85;
      /* rojo rosado para acentos */
      --light-pink: #fff5f7;
      --gradient: linear-gradient(135deg, #8a0f1f 0%, #c9182a 55%, #ff6a85 100%);
    }

    body[data-theme="xmas"] {
      background: linear-gradient(135deg, #fff7f8 0%, #ffe9ef 100%);
    }

    /* Bot√≥n flotante üéÑ */
    .xmas-toggle {
      position: fixed;
      top: 30px;
      left: 150px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #fff;
      color: #c9182a;
      font-size: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
      z-index: 1200;
      cursor: pointer;
      border: 0;
      transition: .25s transform, .25s box-shadow, .25s filter;
    }

    .xmas-toggle:hover {
      transform: translateY(-3px);
    }

    .xmas-toggle[aria-pressed="true"] {
      background: linear-gradient(135deg, #8a0f1f, #c9182a);
      color: #fff;
      box-shadow: 0 12px 26px rgba(201, 24, 42, .35);
    }

    /* Responsive pos. del bot√≥n */
    @media (max-width: 991.98px) {
      .xmas-toggle {
        left: 120px;
        top: 16px;
      }
    }

    /* Nieve (igual) */
    #xmas-snow {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 100;
    }

    #xmas-snow .snowflake {
      position: absolute;
      top: -10px;
      color: rgba(255, 255, 255, .95);
      text-shadow: 0 0 6px rgba(0, 0, 0, .15);
      animation: snow linear forwards;
      will-change: transform;
    }

    @keyframes snow {
      to {
        transform: translate3d(var(--x, 0px), 105vh, 0) rotate(360deg);
        opacity: .95;
      }
    }

    /* Guirnalda SOLO ROJA en el banner */
    .section.banner .xmas-lights {
      position: absolute;
      inset: 0 0 auto 0;
      height: 72px;
      z-index: 4;
      pointer-events: none;
      background:
        url("data:image/svg+xml,%3Csvg width='1200' height='72' viewBox='0 0 1200 72' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3CradialGradient id='gR' cx='50%25' cy='50%25' r='50%25'%3E%3Cstop offset='0%25' stop-color='%23fff' stop-opacity='.8'/%3E%3Cstop offset='100%25' stop-color='%23c9182a'/%3E%3C/radialGradient%3E%3C/defs%3E%3Cg fill='none' stroke='%23e2e8f0' stroke-width='2'%3E%3Cpath d='M0,8 C150,60 300,8 450,60 600,8 750,60 900,8 1050,60 1200,8 1350,60'/%3E%3C/g%3E%3Cg%3E%3Ccircle cx='60' cy='36' r='10' fill='url(%23gR)'/%3E%3Ccircle cx='140' cy='36' r='10' fill='url(%23gR)'/%3E%3Ccircle cx='220' cy='36' r='10' fill='url(%23gR)'/%3E%3Ccircle cx='300' cy='36' r='10' fill='url(%23gR)'/%3E%3Ccircle cx='380' cy='36' r='10' fill='url(%23gR)'/%3E%3Ccircle cx='460' cy='36' r='10' fill='url(%23gR)'/%3E%3Ccircle cx='540' cy='36' r='10' fill='url(%23gR)'/%3E%3Ccircle cx='620' cy='36' r='10' fill='url(%23gR)'/%3E%3Ccircle cx='700' cy='36' r='10' fill='url(%23gR)'/%3E%3Ccircle cx='780' cy='36' r='10' fill='url(%23gR)'/%3E%3Ccircle cx='860' cy='36' r='10' fill='url(%23gR)'/%3E%3Ccircle cx='940' cy='36' r='10' fill='url(%23gR)'/%3E%3Ccircle cx='1020' cy='36' r='10' fill='url(%23gR)'/%3E%3Ccircle cx='1100' cy='36' r='10' fill='url(%23gR)'/%3E%3Ccircle cx='1180' cy='36' r='10' fill='url(%23gR)'/%3E%3C/g%3E%3C/svg%3E") center/1200px 72px repeat-x;
      opacity: .95;
      filter: drop-shadow(0 6px 10px rgba(0, 0, 0, .15));
      animation: twinkle 2.6s ease-in-out infinite alternate;
    }

    @keyframes twinkle {
      from {
        opacity: .8
      }

      to {
        opacity: 1
      }
    }

    /* Gorro Pap√° Noel (rojo/blanco) */
    .banner-overlay .santa-hat {
      position: absolute;
      width: 64px;
      height: 64px;
      left: calc(50% + 140px);
      top: calc(50% - 120px);
      transform: rotate(-18deg);
      background: url("data:image/svg+xml,%3Csvg width='64' height='64' viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M8 44c10-18 28-26 38-22 3 1 6 5 5 8-1 2-4 3-7 3-10 1-24 7-36 11z' fill='%23c9182a'/%3E%3Ccircle cx='51' cy='19' r='6' fill='%23ffffff'/%3E%3Cpath d='M5 46h44a4 4 0 0 1 0 8H5a4 4 0 1 1 0-8z' fill='%23ffffff'/%3E%3C/svg%3E") center/contain no-repeat;
      z-index: 5;
      pointer-events: none;
    }

    /* Un toque de brillo rojito en chips */
    [data-theme="xmas"] .chip-stat {
      box-shadow: 0 8px 24px rgba(201, 24, 42, .25);
      border-color: rgba(201, 24, 42, .35);
    }

    /* ====== FX NAVIDAD (a√±adir al final de tu CSS) ====== */

    /* (si ya lo tienes en tu CSS, puedes omitir este bloque de nieve) */
    #xmas-snow {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 100;
    }

    #xmas-snow .snowflake {
      position: absolute;
      top: -10px;
      color: rgba(255, 255, 255, .95);
      text-shadow: 0 0 6px rgba(0, 0, 0, .15);
      animation: snow linear forwards;
      will-change: transform, opacity;
    }

    @keyframes snow {
      to {
        transform: translate3d(var(--x, 0px), 105vh, 0) rotate(360deg);
        opacity: .95;
      }
    }

    /* Trineo Pap√° Noel (usa tu GIF como background) */
    #xmas-sleigh {
      position: fixed;
      left: 0;
      top: 10vh;
      width: min(28vw, 260px);
      height: min(18vw, 160px);
      background: center / contain no-repeat;
      pointer-events: none;
      z-index: 1500;
      opacity: 0;
      filter: drop-shadow(0 6px 12px rgba(0, 0, 0, .25));
      will-change: transform, opacity;
    }

    /* de izquierda a derecha */
    @keyframes sleigh-ltr {
      0% {
        transform: translateX(-120%) scaleX(1);
        opacity: 0;
      }

      10% {
        opacity: 1;
      }

      90% {
        opacity: 1;
      }

      100% {
        transform: translateX(120%) scaleX(1);
        opacity: 0;
      }
    }

    /* de derecha a izquierda (espejado) */
    @keyframes sleigh-rtl {
      0% {
        transform: translateX(120%) scaleX(-1);
        opacity: 0;
      }

      10% {
        opacity: 1;
      }

      90% {
        opacity: 1;
      }

      100% {
        transform: translateX(-120%) scaleX(-1);
        opacity: 0;
      }
    }

    /* Lucecitas rojas en el banner (ya las definiste como .xmas-lights) */


    /* ===== FX NAVIDAD ‚Äì nieve + trineo (solo rojo) ===== */

    /* Nieve */
    #xmas-snow {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 100;
    }

    #xmas-snow .snowflake {
      position: absolute;
      top: -10px;
      color: rgba(255, 255, 255, .95);
      text-shadow: 0 0 6px rgba(0, 0, 0, .15);
      animation: snow linear forwards;
      will-change: transform, opacity;
    }

    @keyframes snow {
      to {
        transform: translate3d(var(--x, 0px), 105vh, 0) rotate(360deg);
        opacity: .95;
      }
    }

    /* Trineo (usamos un DIV con background GIF) */
    #xmas-sleigh {
      position: fixed;
      left: 0;
      top: 10vh;
      width: min(28vw, 260px);
      height: min(18vw, 160px);
      background: center / contain no-repeat;
      pointer-events: none;
      z-index: 1500;
      opacity: 0;
      filter: drop-shadow(0 6px 12px rgba(0, 0, 0, .25));
      will-change: transform, opacity;
    }

    /* Fallback de animaci√≥n horizontal (por si no soporta Web Animations API) */
    @keyframes sleigh-ltr {
      0% {
        transform: translateX(-120%) scaleX(-1);
        opacity: 0;
      }

      /* flip porque el GIF es R‚ÜíL */
      10% {
        opacity: 1;
      }

      90% {
        opacity: 1;
      }

      100% {
        transform: translateX(120%) scaleX(-1);
        opacity: 0;
      }
    }

    @keyframes sleigh-rtl {
      0% {
        transform: translateX(120%) scaleX(1);
        opacity: 0;
      }

      /* natural: R‚ÜíL */
      10% {
        opacity: 1;
      }

      90% {
        opacity: 1;
      }

      100% {
        transform: translateX(-120%) scaleX(1);
        opacity: 0;
      }
    }

    /* Capa global de fondo para efectos de Navidad */
    #xmas-stage {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      /* detr√°s del contenido */
    }

    /* La nieve y el trineo viven dentro del stage y no reciben clicks */
    #xmas-stage,
    #xmas-stage * {
      pointer-events: none;
    }

    /* Asegura que el fondo rosita del body quede por detr√°s del stage */
    body::before {
      z-index: -1;
    }

    /* (Opcional, solo si en tu UI algo raro se cuela por debajo)
body > *:not(#xmas-stage){ position: relative; z-index: 1; }
*/

    /* Capa global de fondo para la Navidad */
    #xmas-stage {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      /* detr√°s del contenido */
    }

    /* La nieve y el trineo van dentro del stage */
    #xmas-stage,
    #xmas-stage * {
      pointer-events: none;
    }

    /* El fondo del body queda por detr√°s del stage (¬°importante!) */
    body::before {
      z-index: -1;
    }

    /* Si a√∫n no lo ves y quieres probar, S√ìLO para test:
#xmas-stage { z-index: 1; }  body > *:not(#xmas-stage){ position: relative; z-index: 2; }
*/






    /* ===== Chat & Reacciones de Pregunta del D√≠a ===== */
    .dq-extra {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .dq-reactions-card,
    .dq-chat-card {
      background: #fff;
      border: 1px solid rgba(0, 0, 0, .05);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, .06);
    }

    .dq-reactions-title {
      font-weight: 600;
      font-size: .95rem;
      color: #555;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .dq-reactions-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 8px;
    }

    .dq-reactions-buttons button {
      background: #f8f8f8;
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 8px 12px;
      font-size: 1.2rem;
      cursor: pointer;
      line-height: 1;
    }

    .dq-reaction-current,
    .dq-reaction-partner {
      font-size: .9rem;
      color: #666;
    }

    .dq-reaction-current .big-reaction,
    .dq-reaction-partner .big-reaction {
      font-size: 1.3rem;
      margin-left: 4px;
    }

    .dq-chat-header {
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--primary-color);
      margin-bottom: 10px;
      font-size: .95rem;
    }

    .dq-chat-messages {
      max-height: 180px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 8px 0;
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: 12px;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, .05);
      margin-bottom: 12px;
    }

    .dq-chat-empty {
      text-align: center;
      font-size: .9rem;
      color: #999;
      padding: 20px 10px;
    }

    .dq-chat-msg {
      display: flex;
      flex-direction: column;
      max-width: 80%;
    }

    .dq-chat-msg.me {
      margin-left: auto;
      text-align: right;
    }

    .dq-chat-msg.them {
      margin-right: auto;
      text-align: left;
    }

    .dq-chat-meta {
      font-size: .7rem;
      color: #888;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 4px;
    }

    .dq-chat-bubble {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 14px;
      padding: 10px 12px;
      font-size: .9rem;
      line-height: 1.4;
      box-shadow: 0 3px 6px rgba(0, 0, 0, .07);
    }

    .dq-chat-msg.me .dq-chat-bubble {
      background: var(--accent-color);
      border-color: var(--accent-color);
      color: #fff;
      box-shadow: 0 4px 8px rgba(162, 155, 254, .3);
    }

    .dq-chat-form {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .dq-chat-form input[type="text"] {
      flex: 1;
      border: 2px solid #eee;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 1rem;
      background: #fff;
      outline: none;
    }

    .dq-chat-form input[type="text"]:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(162, 155, 254, .2);
    }

    .dq-chat-form button {
      background: var(--accent-color);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      line-height: 1;
      box-shadow: 0 6px 14px rgba(162, 155, 254, .4);
    }




    /* pinta el chip */
    .points-chip {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 10px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 9999px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, .08);
    }

    /* mini filas dentro del chip */
    .points-chip .pp {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .avatar-mini {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #f3f4f6;
      font-weight: 600;
      font-size: .8rem;
    }

    .avatar-mini img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }


    /* Puntos debajo del bot√≥n "Cerrar sesi√≥n" */
    .points-float {
      position: fixed;
      right: 30px;
      top: 90px;
      /* justo bajo el bot√≥n */
      z-index: 1200;
    }

    @media (max-width: 768px) {

      /* En m√≥vil, el logout deja de ser fijo; los puntos siguen el flujo */
      .points-float {
        position: static;
        margin: 10px 0 0 auto;
      }
    }


    .quick-links {
      position: static;
      z-index: 2100;
    }

    .quick-icon i {
      font-size: 16px;
    }

    /* El men√∫ se posiciona con JS bajo el bot√≥n */
    .quick-menu {
      position: fixed;
      /* IMPORTANTE: fijo para anclar al bot√≥n */
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .12);
      padding: 6px;
      min-width: 170px;
      display: flex;
      flex-direction: column;
    }

    .quick-menu[hidden] {
      display: none;
    }

    .quick-menu a {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      color: #111;
      text-decoration: none;
      font-size: 14px;
    }

    .quick-menu a:hover {
      background: #f5f5f5;
    }

    @media (max-width:640px) {
      .quick-menu {
        min-width: 150px;
      }

      .quick-menu a {
        padding: 10px 12px;
        font-size: 14px;
      }
    }


    /* Loader Styles Corregidos */
    #loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #ffe8f3 0%, #dfe6e9 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.8s ease, visibility 0.8s ease;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .loader-content {
      text-align: center;
      color: #e84393;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transform: translateY(-10%);
      /* Ajuste fino para centrado visual */
    }

    .loader-heart {
      font-size: 4rem;
      margin-bottom: 1.5rem;
      animation: heartbeat 1.5s ease-in-out infinite;
    }

    .loader-text {
      font-family: 'Dancing Script', cursive;
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: #e84393;
    }

    .loader-subtext {
      font-family: 'Montserrat', sans-serif;
      font-size: 1rem;
      color: #2d3436;
      opacity: 0.8;
      margin-bottom: 1.5rem;
    }

    .loader-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(232, 67, 147, 0.2);
      border-top: 5px solid #e84393;
      border-radius: 50%;
      animation: spin 1.5s linear infinite;
    }

    @keyframes heartbeat {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }

      100% {
        transform: scale(1);
      }
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    body.loading {
      overflow: hidden;
      /* Evita el scroll durante la carga */
    }

    body.loading #main-content {
      opacity: 0;
      visibility: hidden;
    }

    body.loaded #loader {
      opacity: 0;
      visibility: hidden;
    }

    body.loaded #main-content {
      opacity: 1;
      visibility: visible;
      transition: opacity 0.8s ease;
    }

    /* Estilos espec√≠ficos para el bot√≥n de historial */
    .btn-historial {
      background: var(--gradient);
      color: white;
      font-weight: 600;
      border: none;
      border-radius: 50px;
      padding: 15px 25px;
      font-size: 1rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 5px 15px rgba(232, 67, 147, .4);
      transition: all .3s ease;
      position: relative;
      overflow: hidden;
      z-index: 1;
      text-decoration: none;
      font-family: 'Montserrat', sans-serif;
    }

    .btn-historial::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 0%;
      height: 100%;
      background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
      transition: all .5s ease;
      z-index: -1;
    }

    .btn-historial:hover::before {
      width: 100%;
    }

    .btn-historial:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(232, 67, 147, .5);
    }

    .historial-container {
      margin: 20px 0;
      text-align: center;
    }

    /* ===== MINI TARJETA DE PUNTOS (HUD SUPERIOR DERECHA) ===== */
    .points-mini-card {
      position: fixed;
      top: 90px;
      right: 20px;
      z-index: 1500;

      background: #ffffffee;
      backdrop-filter: blur(6px);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 18px;
      box-shadow: 0 10px 28px rgba(15, 23, 42, .14);
      padding: 10px 14px;

      width: 220px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .pmc-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .pmc-user {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pmc-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #374151;
      overflow: hidden;
    }

    .pmc-avatar img {
      width: 100%;
      height: 100%;
      object-fitver;
    }

    .pmc-info {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }

    .pmc-name {
      font-size: 13px;
      font-weight: 600;
    }

    .pmc-points {
      font-size: 12px;
      font-weight: 700;
      color: #374151;
    }

    .pmc-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }

    .pmc-btn {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
      text-decoration: none;
      transition: all .15s ease;
    }

    .pmc-btn-ghost {
      background: #ffffff;
      border: 1px solid rgba(148, 163, 184, 0.50);
      color: #111827;
    }

    .pmc-btn-ghost:hover {
      background: #f3f4f6;
    }

    .pmc-btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: #fff;
      border: 1px solid transparent;
    }

    .pmc-btn-primary:hover {
      filter: brightness(1.08);
    }


    @media (max-width:768px) {
      .points-mini-card {
        right: 10px;
        top: 85px;
        width: 185px;
        padding: 8px 10px;
      }
    }

    .pmc-btn {
      width: auto;
      min-width: 70px;
      padding: 0 10px;
      gap: 6px;
    }

    .pmc-btn-label {
      font-size: 12px;
      font-weight: 600;
    }

    /* Distancia sencilla (juntos / separados) */
    .distance-status-card {
      margin-top: 20px;
      border-radius: 20px;
      padding: 18px 18px 16px;
      background: #fff;
      box-shadow: 0 10px 26px rgba(0, 0, 0, .08);
    }

    .ds-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 14px;
    }

    .ds-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: .82rem;
      font-weight: 600;
      background: rgba(232, 67, 147, .08);
      color: #c2185b;
    }

    .ds-sub {
      font-size: .9rem;
      color: #555;
    }

    .ds-modes {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 14px;
    }

    .ds-mode-btn {
      border: none;
      border-radius: 14px;
      padding: 10px 12px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      background: #fafafa;
      cursor: pointer;
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
    }

    .ds-mode-btn .ds-icon {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      /* Usa tu gradiente rosa principal */
      background: var(--gradient);
      color: #fff;
    }

    .ds-mode-btn .ds-text {
      text-align: left;
    }

    .ds-mode-title {
      font-weight: 600;
      font-size: .98rem;
      display: block;
    }

    .ds-mode-sub {
      font-size: .82rem;
      color: #666;
    }

    .ds-mode-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, .08);
      background: #fff;
    }

    .ds-mode-btn.active {
      box-shadow: 0 10px 26px rgba(232, 67, 147, .25);
      background: linear-gradient(135deg, rgba(232, 67, 147, .12), rgba(255, 255, 255, 1));
      border: 1px solid rgba(232, 67, 147, .3);
    }

    .distance-bar {
      margin-top: 6px;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #f0f0f0;
      overflow: hidden;
    }

    .distance-bar .fill {
      height: 100%;
      width: 22%;
      border-radius: inherit;
      background: var(--gradient);
      transition: width .25s ease-out;
    }

    .ds-footnote {
      margin-top: 16px;
      font-size: .78rem;
      color: #777;
    }



    /* === Ruleta diaria (bot√≥n flotante + modal) === */

    .floating-wheel-btn {
      position: fixed;
      right: 18px;
      bottom: 96px;
      z-index: 1100;
      width: 54px;
      height: 54px;
      border-radius: 999px;
      border: none;
      background:
        radial-gradient(circle at 30% 0%, #f9a8d4, #e84393);
      color: #fff;
      font-size: 26px;
      box-shadow: 0 16px 30px rgba(0, 0, 0, .28);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform .16s ease, box-shadow .16s ease, opacity .2s ease;
    }

    .floating-wheel-btn:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 20px 40px rgba(0, 0, 0, .32);
    }

    .floating-wheel-btn:active {
      transform: translateY(1px) scale(.97);
      box-shadow: 0 10px 24px rgba(0, 0, 0, .24);
    }

    /* Modal */

    .daily-wheel-modal {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15, 23, 42, .65), rgba(15, 23, 42, .88));
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1200;
    }

    .daily-wheel-modal.open {
      display: flex;
    }

    .daily-wheel-card {
      position: relative;
      width: 100%;
      max-width: 380px;
      border-radius: 24px;
      padding: 20px 18px 18px;
      background:
        radial-gradient(140% 120% at 0% 0%, rgba(236, 72, 153, .20), transparent 55%),
        radial-gradient(150% 140% at 110% 0%, rgba(129, 140, 248, .30), transparent 55%),
        #ffffff;
      box-shadow: 0 24px 60px rgba(15, 23, 42, .55);
      color: #111827;
      overflow: hidden;
    }

    .dw-close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      border: none;
      border-radius: 999px;
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, .06);
      color: #374151;
      cursor: pointer;
    }

    .dw-close-btn:hover {
      background: rgba(15, 23, 42, .12);
    }

    .dw-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .dw-header-icon {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 0%, #f9a8d4, #8b5cf6);
      box-shadow: 0 8px 18px rgba(109, 40, 217, .45);
      font-size: 22px;
    }

    .dw-header h2 {
      margin: 8px 0 2px;
      font-size: 1.25rem;
    }

    .dw-header .dw-sub {
      margin: 0;
      font-size: .85rem;
      opacity: .8;
    }

    .dw-chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: .75rem;
      font-weight: 600;
      letter-spacing: .06em;
      text-transform: uppercase;
      background: rgba(59, 130, 246, .08);
      color: #1d4ed8;
    }

    /* Ruleta */

    .dw-wheel-wrap {
      position: relative;
      margin: 18px auto 10px;
      width: 230px;
      height: 230px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dw-pointer {
      position: absolute;
      top: 4px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-bottom: 18px solid #111827;
      z-index: 2;
      filter: drop-shadow(0 3px 6px rgba(0, 0, 0, .45));
    }

    /* MUY IMPORTANTE: from 270deg, nada de -30deg ni 0deg */
    .dw-wheel {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 999px;
      background:
        conic-gradient(from 270deg,
          #f9a8d4 0deg 60deg,
          /* idx 0 ‚Üí 0 pts   */
          #a5b4fc 60deg 120deg,
          /* idx 1 ‚Üí 5 pts   */
          #fef3c7 120deg 180deg,
          /* idx 2 ‚Üí 10 pts  */
          #bbf7d0 180deg 240deg,
          /* idx 3 ‚Üí 20 pts  */
          #fed7aa 240deg 300deg,
          /* idx 4 ‚Üí 50 pts  */
          #e5e7eb 300deg 360deg
          /* idx 5 ‚Üí 100 pts */
        );
      box-shadow: 0 14px 30px rgba(15, 23, 42, .35);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 4s cubic-bezier(0.17, 0.89, 0.32, 1.28);
    }

    .dw-wheel::before {
      content: "";
      position: absolute;
      inset: 6px;
      border-radius: inherit;
      border: 4px solid rgba(255, 255, 255, .7);
      box-shadow:
        0 0 0 3px rgba(255, 255, 255, .6),
        0 0 18px rgba(236, 72, 153, .35);
      pointer-events: none;
    }

    .dw-center {
      width: 80px;
      height: 80px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0%, #fef3c7, #111827);
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      box-shadow:
        inset 0 0 0 4px rgba(255, 255, 255, .3),
        0 6px 14px rgba(15, 23, 42, .70);
    }

    /* Etiquetas alrededor (centro exacto de cada sector) */

    .dw-seg-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform-origin: center center;
      font-size: .80rem;
      font-weight: 700;
      color: #111827;
      text-shadow: 0 1px 3px rgba(255, 255, 255, .8);
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .9);
      box-shadow: 0 6px 14px rgba(15, 23, 42, .18);
      white-space: nowrap;
    }

    /* Centros f√≠sicos con from 270deg:
   idx0: 300¬∞, idx1: 0¬∞, idx2: 60¬∞, idx3: 120¬∞, idx4: 180¬∞, idx5: 240¬∞ */

    .dw-seg-0 {
      /* 0 pts */
      transform: translate(-50%, -50%) rotate(300deg) translate(0, -78px) rotate(-300deg);
    }

    .dw-seg-1 {
      /* +5 */
      transform: translate(-50%, -50%) rotate(0deg) translate(0, -78px) rotate(0deg);
    }

    .dw-seg-2 {
      /* +10 */
      transform: translate(-50%, -50%) rotate(60deg) translate(0, -78px) rotate(-60deg);
    }

    .dw-seg-3 {
      /* +20 */
      transform: translate(-50%, -50%) rotate(120deg) translate(0, -78px) rotate(-120deg);
    }

    .dw-seg-4 {
      /* +50 */
      transform: translate(-50%, -50%) rotate(180deg) translate(0, -78px) rotate(-180deg);
    }

    .dw-seg-5 {
      /* +100 */
      transform: translate(-50%, -50%) rotate(240deg) translate(0, -78px) rotate(-240deg);
    }

    /* Texto y bot√≥n */

    .dw-actions {
      text-align: center;
      margin-top: 10px;
    }

    .dw-spin-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 9px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #e84393, #8b5cf6);
      color: #fff;
      font-weight: 600;
      font-size: .95rem;
      box-shadow: 0 10px 24px rgba(109, 40, 217, .45);
    }

    .dw-spin-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(109, 40, 217, .55);
    }

    .dw-spin-btn:disabled {
      opacity: .6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .dw-spin-btn.used {
      background: #e5e7eb;
      color: #4b5563;
      box-shadow: none;
    }

    .dw-status {
      margin-top: 6px;
      font-size: .85rem;
      color: #4b5563;
    }

    .dw-timer {
      margin-top: 4px;
      font-size: .8rem;
      color: #6b7280;
    }

    .dw-result {
      margin-top: 4px;
      font-size: .95rem;
      font-weight: 600;
      color: #111827;
    }

    .dw-footer {
      margin-top: 10px;
      font-size: .75rem;
      opacity: .75;
    }


    /* Texto de la pareja */
    .dw-partner {
      margin-top: 6px;
      font-size: .85rem;
      color: #6b7280;
    }

    /* Responsive peque√±o */
    @media (max-width: 480px) {
      .floating-wheel-btn {
        bottom: 88px;
        right: 14px;
      }

      .dw-wheel-wrap {
        width: 210px;
        height: 210px;
      }
    }

    /* L√≠neas de puntos con avatar dentro del modal */
    .dw-user-line {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }

    .dw-user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
    }

    .dw-user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .dw-line-text {
      font-size: .9rem;
      color: #111827;
    }


    /* ===========================================================
   üéÑ ESTILOS NAVIDE√ëOS COMPLETOS: LOADER + RULETA üéÑ
   =========================================================== */

    /* --- 1. LOADER: AMBIENTE M√ÅGICO --- */

    [data-theme="xmas"] #loader {
      /* Fondo rojo profundo tipo terciopelo con vi√±eta oscura */
      background: radial-gradient(circle at center, #d32f2f 0%, #8e0000 60%, #3f0000 100%);
    }

    /* Spinner: Anillo de luces o bast√≥n de caramelo */
    [data-theme="xmas"] .loader-spinner {
      border: 5px solid rgba(255, 255, 255, 0.1);
      /* Base sutil */
      border-top: 5px solid #ff1f1f;
      /* Luz Roja */
      border-bottom: 5px solid #22c55e;
      /* Luz Verde */
      /* Resplandor brillante festivo */
      box-shadow:
        0 0 15px rgba(255, 31, 31, 0.6),
        0 0 15px rgba(34, 197, 94, 0.6);
    }

    /* Coraz√≥n: Adorno navide√±o dorado iluminado */
    [data-theme="xmas"] .loader-heart {
      color: #ffb300;
      /* Dorado c√°lido */
      /* Doble resplandor para efecto bombilla */
      filter:
        drop-shadow(0 0 10px rgba(255, 215, 0, 0.9)) drop-shadow(0 0 25px rgba(255, 100, 0, 0.5));
      transform-origin: center;
      animation: heartbeat 1.5s ease-in-out infinite, swing 3s ease-in-out infinite;
    }

    /* Texto: Efecto nevado */
    [data-theme="xmas"] .loader-text {
      color: #ffffff;
      font-family: 'Dancing Script', cursive;
      text-shadow:
        0 -2px 1px rgba(255, 255, 255, 0.9),
        /* Borde nieve arriba */
        0 3px 6px rgba(0, 0, 0, 0.5);
      /* Sombra profundidad */
    }

    [data-theme="xmas"] .loader-subtext {
      color: #ffecec;
      font-weight: 600;
      letter-spacing: 1px;
    }


    /* --- 2. RULETA NAVIDE√ëA (MODAL) --- */

    /* Tarjeta del modal: Marco festivo */
    [data-theme="xmas"] .daily-wheel-card {
      background: #fff;
      /* Borde rojo grueso como una tarjeta de regalo */
      border: 4px solid #b91c1c;
      border-radius: 24px;
      box-shadow: 0 0 0 4px #fcd34d inset, 0 20px 50px rgba(0, 0, 0, 0.5);
      /* Doble borde dorado interior */
    }

    /* Icono cabecera: Verde pino */
    [data-theme="xmas"] .dw-header-icon {
      background: radial-gradient(circle at 30% 0%, #4ade80, #15803d);
      box-shadow: 0 6px 15px rgba(21, 128, 61, 0.3);
      color: #fff;
    }

    /* T√≠tulo */
    [data-theme="xmas"] .dw-header h2 {
      color: #b91c1c;
      /* Rojo Navidad */
      font-family: 'Dancing Script', cursive;
      font-size: 2rem;
    }

    /* --- La Rueda: Colores de temporada --- */
    [data-theme="xmas"] .dw-wheel {
      /* Borde dorado brillante */
      border: 6px solid #f59e0b;
      background: conic-gradient(from 270deg,
          #ef4444 0deg 60deg,
          /* Rojo */
          #22c55e 60deg 120deg,
          /* Verde */
          #fcd34d 120deg 180deg,
          /* Dorado */
          #ef4444 180deg 240deg,
          /* Rojo */
          #22c55e 240deg 300deg,
          /* Verde */
          #f3f4f6 300deg 360deg
          /* Blanco Nieve */
        );
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
    }

    /* Centro de la rueda: Bola de √°rbol roja */
    [data-theme="xmas"] .dw-center {
      background: radial-gradient(circle at 35% 35%, #ff8a8a, #b91c1c);
      color: white;
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.3), 0 5px 10px rgba(0, 0, 0, 0.3);
      border: 2px solid #fcd34d;
    }

    /* Etiquetas de premios */
    [data-theme="xmas"] .dw-seg-label {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #fecaca;
      /* Borde rosado suave */
      color: #991b1b;
      /* Texto rojo oscuro */
      font-weight: 800;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    /* Bot√≥n de girar: Verde con brillo */
    [data-theme="xmas"] .dw-spin-btn {
      background: linear-gradient(135deg, #22c55e 0%, #166534 100%);
      border: 2px solid #bbf7d0;
      box-shadow: 0 8px 20px rgba(22, 163, 74, 0.4);
    }

    [data-theme="xmas"] .dw-spin-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 25px rgba(22, 163, 74, 0.5);
    }

    [data-theme="xmas"] .dw-spin-btn.used {
      background: #e5e7eb;
      border-color: #d1d5db;
      box-shadow: none;
    }

    /* --- 3. BOT√ìN FLOTANTE DE INICIO (La bola colgante) --- */
    [data-theme="xmas"] .floating-wheel-btn {
      /* Parece una bola de navidad roja y brillante */
      background: radial-gradient(circle at 30% 10%, #ffaaaa, #dc2626);
      border: 2px solid #fcd34d;
      /* Anilla dorada */
      color: #fff;
      box-shadow: 0 10px 25px rgba(220, 38, 38, 0.5);
      font-size: 28px;
    }

    /* Efecto de balanceo al pasar el rat√≥n */
    [data-theme="xmas"] .floating-wheel-btn:hover {
      animation: swing 1s ease-in-out infinite;
    }

    /* Animaci√≥n suave de balanceo */
    @keyframes swing {
      0% {
        transform: rotate(0deg);
      }

      25% {
        transform: rotate(10deg);
      }

      50% {
        transform: rotate(-10deg);
      }

      75% {
        transform: rotate(5deg);
      }

      100% {
        transform: rotate(0deg);
      }
    }

    /* === MOCHIREAL (Dise√±o Mochitos) === */
    .mochireal-section {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 30px;
      text-align: center;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 255, 255, .5);
      /* Un borde superior bonito para destacar */
      border-top: 5px solid var(--primary-color);
    }

    .mr-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px dashed #eee;
    }

    .mr-title {
      font-family: 'Playfair Display', serif;
      font-weight: 900;
      font-size: 1.6rem;
      color: var(--primary-color);
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mr-timer {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      color: var(--accent-color);
      background: #f0f0ff;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
    }

    /* Grid de fotos */
    .mr-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }

    .mr-photo-container {
      aspect-ratio: 3/4;
      background: #000;
      /* CAMBIO 1: Fondo negro para que parezca cine/profesional */
      border-radius: 16px;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
      border: 1px solid #eee;
    }

    /* Estado vac√≠o (placeholder) */
    .mr-empty {
      border: 2px dashed var(--accent-color);
      background: rgba(162, 155, 254, 0.05);
      color: var(--accent-color);
    }

    .mr-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      /* CAMBIO 2: Cambia 'cover' por 'contain' */
      border-radius: 16px;
    }

    /* Efecto borroso (Blur) */
    .mr-blur {
      filter: blur(18px) brightness(1.1);
      /* Brillo m√°s alto para que no se vea gris */
      transform: scale(1.1);
    }

    /* Candado sobre foto borrosa */
    .mr-lock-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2;
      color: var(--primary-color);
      background: rgba(255, 255, 255, 0.4);
      /* Capa blanca semitransparente */
      backdrop-filter: blur(2px);
      text-shadow: 0 2px 10px rgba(255, 255, 255, 1);
    }

    /* Bot√≥n de subir (estilo gradiente de tu web) */
    .mr-upload-btn {
      background: var(--gradient);
      color: white;
      font-weight: 700;
      padding: 12px 30px;
      border-radius: 50px;
      border: none;
      cursor: pointer;
      margin-top: 20px;
      font-size: 1rem;
      transition: transform 0.2s, box-shadow 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 5px 15px rgba(232, 67, 147, 0.3);
    }

    .mr-upload-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(232, 67, 147, 0.5);
    }

    /* Animaci√≥n de latido suave (rosa) */
    .pulse-pink {
      animation: pulse-pink 2s infinite;
    }

    @keyframes pulse-pink {
      0% {
        box-shadow: 0 0 0 0 rgba(232, 67, 147, 0.4);
      }

      70% {
        box-shadow: 0 0 0 15px rgba(232, 67, 147, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(232, 67, 147, 0);
      }
    }

    /* Etiquetas de nombre sobre la foto */
    .mr-name-tag {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 800;
      color: var(--dark-text);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    /* === MochiReal Historial === */
    .mr-history-container {
      padding: 10px;
      max-width: 800px;
      margin: 0 auto;
    }

    .mr-day-card {
      background: white;
      border-radius: 18px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
      border: 1px solid #f0f0f0;
    }

    .mr-day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px dashed #f0f0f0;
    }

    .mr-date-label {
      font-weight: 800;
      color: var(--primary-color);
      font-size: 1.1rem;
      text-transform: capitalize;
    }

    .mr-time-badge {
      background: #f0f2f5;
      color: #666;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .mr-day-grid {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .mr-history-photo {
      flex: 1;
      max-width: 200px;
      aspect-ratio: 3/4;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .mr-history-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .mr-history-photo:hover img {
      transform: scale(1.05);
    }

    .mr-history-user {
      position: absolute;
      bottom: 8px;
      left: 8px;
      background: rgba(255, 255, 255, 0.9);
      padding: 3px 8px;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 800;
      color: #333;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Bot√≥n para ver historial en la tarjeta principal */
    .btn-mr-history {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.6);
      color: var(--primary-color);
      font-size: 0.9rem;
      margin-top: 15px;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .btn-mr-history:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }


    /* === MOCHIREAL CAMERA UI 2.0 === */
    #mr-camera-overlay {
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 99999;
      /* Muy alto para tapar todo */
      display: none;
      flex-direction: column;
    }

    #mr-camera-overlay.active {
      display: flex;
    }

    /* Contenedor del video */
    .mr-cam-view {
      flex: 1;
      position: relative;
      overflow: hidden;
      background: #000;
      border-radius: 0 0 24px 24px;
      /* Bordes redondeados abajo estilo iOS */
    }

    #mr-video-feed {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #mr-video-feed.mirrored {
      transform: scaleX(-1);
    }

    /* Efecto Flash al hacer foto */
    .flash-effect {
      animation: flash-animation 0.2s ease-out;
    }

    @keyframes flash-animation {
      0% {
        background-color: rgba(255, 255, 255, 0.8);
      }

      100% {
        background-color: transparent;
      }
    }

    /* Interfaz superpuesta (mensajes) */
    .mr-cam-ui-top {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      padding: 20px;
      padding-top: max(20px, env(safe-area-inset-top));
      text-align: center;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.6), transparent);
      pointer-events: none;
    }

    .mr-cam-msg {
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      background: rgba(0, 0, 0, 0.3);
      padding: 8px 16px;
      border-radius: 20px;
      display: inline-block;
      backdrop-filter: blur(4px);
    }

    /* --- BARRA DE CONTROL INFERIOR --- */
    .mr-cam-controls {
      background: #000;
      /* Fondo negro s√≥lido abajo */
      padding: 20px 30px;
      padding-bottom: max(30px, env(safe-area-inset-bottom));
      display: flex;
      align-items: center;
      justify-content: space-between;
      /* Distribuye botones */
      height: 140px;
    }

    /* Bot√≥n disparador PRO */
    #btn-snap {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 4px solid white;
      background: transparent;
      position: relative;
      cursor: pointer;
      transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* C√≠rculo interior del bot√≥n */
    #btn-snap::after {
      content: "";
      width: 68px;
      height: 68px;
      background: white;
      border-radius: 50%;
      transition: all 0.2s;
    }

    #btn-snap:active {
      transform: scale(0.95);
    }

    #btn-snap:active::after {
      width: 60px;
      height: 60px;
      opacity: 0.8;
    }

    /* Botones laterales (cerrar y cambiar c√°mara) */
    .icon-cam-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .icon-cam-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* --- PANTALLA DE CARGA (FUSIONANDO) --- */
    .mr-processing-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      z-index: 20;
      display: none;
      /* Oculto por defecto */
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .mr-processing-overlay.active {
      display: flex;
    }

    /* Spinner animado */
    .mr-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-left-color: var(--primary-color);
      border-radius: 50%;
      animation: mr-spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes mr-spin {
      to {
        transform: rotate(360deg);
      }
    }

    .mr-processing-text {
      font-family: 'Montserrat', sans-serif;
      font-size: 1.2rem;
      font-weight: 600;
      letter-spacing: 1px;
      animation: pulse 1.5s infinite;
    }

    /* Canvas oculto para procesar */
    #mr-canvas {
      display: none;
    }


    /* Mapa de distancia (nuevo dise√±o) */
    .distance-map-container {
      position: relative;
      height: 360px;
      border-radius: 32px;
      overflow: hidden;
      background: #ffe8f3;
      /* Color de fondo por si tarda en cargar */
    }

    /* El mapa rellena el contenedor */
    #distanceMap {
      width: 100%;
      height: 100%;
      z-index: 1;
    }


    /* Panel de info flotante (arriba a la izquierda) */
    .distance-floating-info {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 20;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .distance-current-label {
      padding: 10px 14px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 10px 25px rgba(15, 23, 42, .18);
      max-width: 260px;
    }

    .distance-current-label .ds-label {
      display: block;
      font-weight: 700;
      font-size: 0.9rem;
      color: #be185d;
    }

    .distance-current-label .ds-sub {
      display: block;
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 2px;
    }

    /* Pastilla de km */
    .distance-km-pill {
      align-self: flex-start;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 10px 25px rgba(248, 113, 169, .35);
      font-size: 0.85rem;
      color: #ec4899;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .distance-km-pill i {
      font-size: 0.9rem;
    }

    /* Controles flotantes (glassmorphism) */
    .distance-floating-controls {
      position: absolute;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      z-index: 20;
      display: flex;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.82);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 22px 60px rgba(15, 23, 42, .35);
    }

    /* Estilo espec√≠fico de los botones dentro del panel flotante */
    .distance-floating-controls .ds-mode-btn {
      border: none;
      background: transparent;
      border-radius: 999px;
      padding: 8px 12px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 0.78rem;
      color: #374151;
      transition: all .18s ease;
      white-space: nowrap;
    }

    .distance-floating-controls .ds-icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(236, 72, 153, 0.08);
      color: #ec4899;
      font-size: 0.9rem;
    }

    .distance-floating-controls .ds-mode-title {
      display: block;
      font-weight: 600;
    }

    .distance-floating-controls .ds-mode-sub {
      display: none;
      /* para que no se sature el chip */
      font-size: 0.7rem;
      opacity: 0.7;
    }

    .distance-floating-controls .ds-mode-btn.active {
      background: rgba(236, 72, 153, 0.1);
      color: #9d174d;
      box-shadow: 0 10px 30px rgba(236, 72, 153, .4);
      transform: translateY(-1px);
    }

    .distance-floating-controls .ds-mode-btn:hover:not(.active) {
      background: rgba(248, 250, 252, 0.9);
      transform: translateY(-1px);
    }

    /* Tarjeta general Distancia */
    .distance-status-card {
      margin-top: 14px;
      border-radius: 18px;
      padding: 0;
      background: transparent;
      border: none;
    }

    /* Pie peque√±o debajo del mapa */
    .ds-footnote {
      margin-top: 10px;
      font-size: 0.8rem;
      color: #6b7280;
    }

    /* Avatares tipo radar en el mapa */
    .avatar-marker {
      position: relative;
      width: 48px;
      height: 48px;
    }

    .avatar-marker .avatar-circle {
      position: relative;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid #ffffff;
      box-shadow: 0 10px 25px rgba(15, 23, 42, .45);
      background: linear-gradient(135deg, #f9a8d4, #fbcfe8);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .avatar-marker .avatar-circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Anillo de radar / latido */
    .avatar-marker .avatar-pulse {
      position: absolute;
      inset: -4px;
      border-radius: 999px;
      border: 2px solid rgba(236, 72, 153, .6);
      animation: radarPulse 2.4s ease-out infinite;
      transform-origin: center;
    }

    /* Un segundo anillo m√°s suave para m√°s "magia" */
    .avatar-marker .avatar-pulse::after {
      content: "";
      position: absolute;
      inset: 6px;
      border-radius: inherit;
      border: 2px solid rgba(236, 72, 153, .35);
    }

    /* Variar color sutil entre uno y otro */
    .avatar-marker--christian .avatar-pulse {
      border-color: rgba(59, 130, 246, .6);
    }

    .avatar-marker--christian .avatar-circle {
      background: linear-gradient(135deg, #93c5fd, #bfdbfe);
    }

    .avatar-marker--clara .avatar-pulse {
      border-color: rgba(236, 72, 153, .65);
    }

    .avatar-marker--clara .avatar-circle {
      background: linear-gradient(135deg, #f9a8d4, #fecdd3);
    }

    @keyframes radarPulse {
      0% {
        transform: scale(0.7);
        opacity: 0.8;
      }

      70% {
        transform: scale(1.6);
        opacity: 0;
      }

      100% {
        transform: scale(1.9);
        opacity: 0;
      }
    }

    /* L√≠nea de energ√≠a animada (entre vosotros) */
    .leaflet-overlay-pane .distance-flow {
      stroke: #e84393;
      stroke-width: 4;
      stroke-linecap: round;
      stroke-dasharray: 12 18;
      animation: dashFlow 2s linear infinite;
    }

    @keyframes dashFlow {
      to {
        stroke-dashoffset: -60;
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .distance-map-container {
        height: 320px;
      }

      .distance-floating-info {
        top: 10px;
        left: 10px;
        right: 10px;
      }

      .distance-current-label {
        max-width: 100%;
      }

      .distance-floating-controls {
        left: 50%;
        bottom: 10px;
        transform: translateX(-50%);
        padding-inline: 8px;
        gap: 4px;
      }

      .distance-floating-controls .ds-mode-btn {
        padding-inline: 8px;
        font-size: 0.72rem;
      }
    }
  </style>
</head>

<body class="loading">
  <div id="loader">
    <div class="loader-content">
      <div class="loader-heart">‚ù§Ô∏è</div>
      <div class="loader-text">Christian & Clara</div>
      <div class="loader-subtext">Cargando...</div>
      <div class="loader-spinner"></div>
    </div>
  </div>
  <div id="main-content">

    <!-- NAVIDAD (tema) se puede borrar-->
    <div id="xmas-stage" aria-hidden="true"></div>

    {% set flash_messages = get_flashed_messages(with_categories=true) %}

    <!-- Zona toasts -->
    <div id="toasts" aria-live="polite" aria-atomic="true"></div>

    <!-- Corazones flotantes -->
    <div class="floating-hearts" id="hearts-container"></div>



    <!-- MODAL EDITAR WISHLIST -->
    <div id="editWishlistModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Editar producto</h2>
          <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
          <form method="POST" action="/edit_wishlist_item" id="editWishlistForm">
            <input type="hidden" name="item_id" id="editItemId">
            <input type="text" name="product_name" id="editProductName" placeholder="Nombre del producto" required>
            <input type="url" name="product_link" id="editProductLink" placeholder="Enlace (opcional)">

            <select name="priority" id="editPriority" required>
              <option value="alta">Prioridad: Alta üî¥</option>
              <option value="media">Prioridad: Media üü°</option>
              <option value="baja">Prioridad: Baja üü¢</option>
            </select>
            <textarea name="notes" id="editNotes" placeholder="Notas (opcional)" rows="3"></textarea>
            <input type="text" name="size" id="editSize" placeholder="Talla (opcional)">

            <div style="display:flex; align-items:center; gap:10px; margin: 6px 0 16px 0;">
              <input type="checkbox" id="editIsGift" name="is_gift" style="width:auto;">
              <label for="editIsGift" style="margin:0;">¬øEs un regalo? üéÅ</label>
            </div>

            <button type="submit"><i class="fas fa-save"></i> Guardar cambios</button>
          </form>
        </div>
      </div>
    </div>

    <div class="container">
      {% if not session.username %}
      <!-- LOGIN MEJORADO -->
      <div class="login-container">
        <div class="login-box animate-in" id="loginBox">
          <div style="margin-bottom:18px">
            <div
              style="width:72px;height:72px;border-radius:20px;background:var(--gradient);display:flex;align-items:center;justify-content:center;margin:0 auto 10px auto;box-shadow:0 10px 24px rgba(232,67,147,.25)">
              <i class="fas fa-heart" style="color:#fff;font-size:26px"></i>
            </div>
            <h3 style="margin:0">Bienvenido/a</h3>
          </div>

          {% if error %}
          <div class="error-message" role="alert">{{ error }}</div>
          {% endif %}

          <form method="POST" id="loginForm" novalidate>
            <!-- Usuario -->
            <div class="input-group">
              <i class="fas fa-user input-icon" aria-hidden="true"></i>
              <input type="text" name="username" id="username" placeholder="Usuario" autocomplete="username" required>
            </div>

            <!-- Contrase√±a -->
            <div class="input-group">
              <i class="fas fa-lock input-icon" aria-hidden="true"></i>
              <input type="password" name="password" id="password" placeholder="Contrase√±a"
                autocomplete="current-password" required>
              <button type="button" class="toggle-pass" aria-label="Mostrar u ocultar contrase√±a">
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <div class="caps-hint" id="capsHint" aria-live="polite" style="display:none">
              <i class="fas fa-exclamation-triangle"></i> Tienes <b>Bloq May√∫s</b> activado
            </div>

            <!-- Recordarme + Olvid√© -->
            <div class="remember-row">
              <label class="remember-check">
                <input type="checkbox" id="rememberMe" name="remember_me" value="1"> Recordarme
              </label>
              <a class="forgot-link" href="#"
                onclick="event.preventDefault(); showToast?.('info','P√≠dele a tu Mochito que te resetee la clave üòÖ');">¬øOlvidaste
                la contrase√±a?</a>
            </div>

            <!-- Bot√≥n enviar -->
            <button type="submit" id="loginBtn" class="btn-full">
              <span class="btn-text">Entrar</span>
              <span class="btn-spinner" aria-hidden="true"></span>
            </button>
          </form>

        </div>
      </div>
      {% else %}

      <a href="/logout" class="logout"><i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n</a>
      <!-- Puntos debajo de "Cerrar sesi√≥n" -->

      <!-- MINI TARJETA DE PUNTOS ARRIBA DERECHA -->
      <div class="points-mini-card">
        <div class="pmc-row">
          <div class="pmc-user">
            <div class="pmc-avatar">
              {% if profile_pictures.get(username) %}
              <img src="{{ profile_pictures.get(username) }}">
              {% else %}
              {{ username[0] | upper }}
              {% endif %}
            </div>
            <div class="pmc-info">
              <span class="pmc-name">{{ username }}</span>
              <span class="pmc-points">{{ user_points }} pts</span>
            </div>
          </div>

          <div class="pmc-user">
            <div class="pmc-avatar">
              {% if profile_pictures.get(other_user) %}
              <img src="{{ profile_pictures.get(other_user) }}">
              {% else %}
              {{ other_user[0] | upper }}
              {% endif %}
            </div>
            <div class="pmc-info">
              <span class="pmc-name">{{ other_user }}</span>
              <span class="pmc-points">{{ other_points }} pts</span>
            </div>
          </div>
        </div>

        <div class="pmc-actions">
          <a href="/medallas" class="pmc-btn pmc-btn-ghost">
            <i class="fas fa-medal"></i>
            <span class="pmc-btn-label">Medallas</span>
          </a>
          <a href="/tienda" class="pmc-btn pmc-btn-primary">
            <i class="fas fa-gift"></i>
            <span class="pmc-btn-label">Tienda</span>
          </a>
        </div>

      </div>


      <!-- NAVBAR FONT AWESOME -->
      <nav class="app-nav" aria-label="Navegaci√≥n principal">
        <button class="nav-btn active" data-goto="home" title="Inicio">
          <i class="fas fa-house" aria-hidden="true"></i>
          <span class="nav-label">Inicio</span>
        </button>
        <button class="nav-btn" data-goto="question" title="Pregunta del d√≠a">
          <i class="fa-solid fa-question" aria-hidden="true"></i>
          <span class="nav-label">Pregunta del d√≠a</span>
        </button>
        <button class="nav-btn" data-goto="mochireal" title="MochiReal">
          <i class="fas fa-camera-retro" aria-hidden="true"></i>
          <span class="nav-label">MochiReal</span>
        </button>
        <button class="nav-btn" data-goto="wishlist" title="Wishlist">
          <i class="fa-solid fa-gifts" aria-hidden="true"></i>
          <span class="nav-label">Wishlist</span>
        </button>
        <button class="nav-btn" data-goto="media" title="Pel√≠culas y Series">
          <i class="fas fa-film" aria-hidden="true"></i>
          <span class="nav-label">Pel√≠culas/Series</span>
        </button>
        <button class="nav-btn" data-goto="travels" title="Viajes">
          <i class="fa-solid fa-plane" aria-hidden="true"></i>
          <span class="nav-label">Viajes</span>
        </button>
        <button class="nav-btn" data-goto="schedules" title="Horarios">
          <i class="fas fa-calendar-days" aria-hidden="true"></i>
          <span class="nav-label">Horarios</span>
        </button>
        <button class="nav-btn" data-goto="intim" title="Intimidad">
          <i class="fas fa-lock" aria-hidden="true"></i>
          <span class="nav-label">Intimidad</span>
        </button>
        <button class="nav-btn" title="Ciclo (Regla)" onclick="location.href='{{ url_for('regla_page') }}'">
          <i class="fa-solid fa-droplet" aria-hidden="true"></i>
          <span class="nav-label">Regla</span>
        </button>
        <button class="nav-btn" data-goto="profile" title="Perfil">
          <i class="fas fa-user" aria-hidden="true"></i>
          <span class="nav-label">Perfil</span>
        </button>
      </nav>

      <!-- Contenedor de p√°ginas -->
      <div id="pages"></div>

      <div id="page-mr-history" class="page" style="display:none;">
        <div class="section animate-in">
          <div style="display:flex; align-items:center; justify-content: space-between; margin-bottom:20px;">
            <div style="display:flex; align-items:center;">
              <button onclick="closeMochiHistory()" class="icon-btn" style="margin-right:15px;">
                <i class="fas fa-arrow-left"></i>
              </button>
              <h3 style="margin:0; font-size: 1.5rem;">Historial üì∏</h3>
            </div>
            <span id="mr-page-indicator" style="font-size:0.9rem; color:#888; font-weight:600;"></span>
          </div>

          <div id="mr-history-content" class="mr-history-container">
            <div style="text-align:center; padding:40px;">
              <i class="fas fa-spinner fa-spin fa-2x" style="color:var(--primary-color)"></i>
            </div>
          </div>

          <div class="pager" id="mr-history-pager" style="margin-top: 20px; display:none;">
            <button type="button" id="mr-btn-prev" class="page-btn">¬´ Anterior</button>
            <button type="button" id="mr-btn-next" class="page-btn">Siguiente ¬ª</button>
          </div>
        </div>
      </div>

      <!-- BANNER -->
      <div class="section banner animate-in">
        {% if banner_file %}
        <img src="{{ banner_file }}" alt="Banner">
        {% else %}
        <img
          src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 450'%3E%3Crect width='1200' height='450' fill='%23ffe8f3'/%3E%3C/svg%3E"
          alt="Banner por defecto">
        {% endif %}
        <div class="banner-overlay">
          <div class="scroll-hint" aria-hidden="true"></div>

          <h1>Christian Clara</h1>
          <!-- CHIPS R√ÅPIDOS EN BANNER -->
          <div class="home-chips" id="homeChips">

            <div class="chip-stat">
              <i class="fa-solid fa-heart"></i>
              <span>{{ days_together }}</span> d√≠as juntos
            </div>

            <div class="chip-stat" id="chipDistance">
              <i class="fa-solid fa-route"></i>
              ‚Äî km
            </div>


            {% if days_until_meeting is number and days_until_meeting >= 0 %}
            <div class="chip-stat {{ 'soon' if days_until_meeting <= 3 else '' }}" id="chipMeeting">
              <i class="fa-solid fa-calendar-day"></i>
              {% if days_until_meeting == 0 %}
              ¬°Hoy os veis! ‚ù§Ô∏è
              {% elif days_until_meeting == 1 %}
              Ma√±ana üí´
              {% else %}
              En {{ days_until_meeting }} d√≠as
              {% endif %}
            </div>
            {% endif %}
          </div>

          <form method="POST" enctype="multipart/form-data" class="banner-form">
            <label for="banner-upload" class="custom-file-upload">
              <i class="fas fa-image"></i> Elegir imagen
            </label>
            <input id="banner-upload" type="file" name="banner" accept="image/*" required style="display: none;">
            <button type="submit"><i class="fas fa-sync-alt"></i> Cambiar banner</button>
          </form>
        </div>
      </div>
      <div class="hud-stack" id="hudStack">
        {% if username == 'mochito' %}
        <a target="_blank" href="/admin" class="settings-icon admin-icon" title="Admin" aria-label="Admin">
          <i class="fa-solid fa-toolbox" aria-hidden="true"></i>
        </a>
        {% endif %}


        <script>
          (function () {
            const btn = document.getElementById('quickIcon');
            const menu = document.getElementById('quickMenu');
            if (!btn || !menu) return;

            function placeMenu() {
              const r = btn.getBoundingClientRect();
              const top = window.scrollY + r.bottom + 8;  // 8px bajo el bot√≥n
              const left = window.scrollX + r.left;        // alineado al borde izq
              menu.style.top = top + 'px';
              menu.style.left = left + 'px';
            }
            function open() {
              placeMenu();
              menu.hidden = false;
              btn.setAttribute('aria-expanded', 'true');
            }
            function close() {
              menu.hidden = true;
              btn.setAttribute('aria-expanded', 'false');
            }

            btn.addEventListener('click', (e) => {
              e.preventDefault();
              menu.hidden ? open() : close();
            });

            // Recolocar si se hace scroll o resize mientras est√° abierto
            window.addEventListener('scroll', () => { if (!menu.hidden) placeMenu(); }, { passive: true });
            window.addEventListener('resize', () => { if (!menu.hidden) placeMenu(); });

            // Cerrar al hacer click fuera
            document.addEventListener('click', (e) => {
              if (menu.hidden) return;
              if (e.target.closest('#quickMenu') || e.target.closest('#quickIcon')) return;
              close();
            });

            // Cerrar con ESC
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });
          })();
        </script>





        <!-- PRESENCIA (chip junto al icono de perfil) -->
        <div id="presenceChip" class="presence-chip" aria-live="polite" title="Estado en tiempo real">
          <div class="avatar-mini">
            {% if profile_pictures.get(other_user) %}
            <img src="{{ profile_pictures.get(other_user) }}" alt="{{ other_user }}">
            {% else %}
            <span>{{ other_user[0]|upper }}</span>
            {% endif %}
          </div>
          <span class="presence-name">{{ other_user }}:</span>
          <span class="presence-dot" id="presenceDot" aria-hidden="true"></span>
          <span class="presence-text" id="presenceText">‚Ä¶</span>
        </div>




        <!-- MODAL EDITAR EVENTO INTIMIDAD -->
        <div id="editIntimModal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h2>Editar momento</h2>
              <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
              <form method="POST" action="/edit_intim_event" id="editIntimForm">
                <input type="hidden" name="event_id" id="editEventId">

                <input type="text" name="intim_place_edit" id="editIntimPlace" placeholder="Lugar (opcional)"
                  style="margin-bottom: 15px;">

                <textarea name="intim_notes_edit" id="editIntimNotes" placeholder="Notas privadas (opcional)" rows="4"
                  style="margin-bottom: 15px;"></textarea>

                <button type="submit">
                  <i class="fas fa-save"></i> Guardar cambios
                </button>
              </form>
            </div>
          </div>
        </div>


        <!-- MODAL PERFIL -->
        <div id="profileModal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h2>Mi Perfil</h2>
              <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
              <div class="profile-section">
                {% if profile_pictures.get(session.username) %}
                <img src="{{ profile_pictures.get(session.username) }}" alt="Foto de perfil" class="profile-picture">
                {% else %}
                <div class="profile-picture"
                  style="background: var(--gradient); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: bold;">
                  {{ session.username[0]|upper }}
                </div>
                {% endif %}
                <div>
                  <h4>Hola, {{ session.username }}</h4>
                  <p>Actualiza tu foto o cambia tu contrase√±a.</p>
                </div>
              </div>

              <!-- FORM: Cambiar foto -->
              <form method="POST" enctype="multipart/form-data" class="profile-form" style="margin-bottom: 20px;">
                <label for="profile-upload" class="custom-file-upload">
                  <i class="fas fa-user-circle"></i> Elegir foto de perfil
                </label>
                <input id="profile-upload" type="file" name="profile_picture" accept="image/*" style="display: none;">
                <button type="submit" name="update_profile"><i class="fas fa-sync-alt"></i> Actualizar foto</button>
              </form>

              <hr style="border:none;border-top:1px solid #eee;margin: 10px 0 20px 0;">

              <!-- FORM: Cambiar contrase√±a -->
              <form method="POST" class="profile-form">
                <input type="hidden" name="change_password" value="1">
                <input type="password" name="current_password" placeholder="Contrase√±a actual" required>
                <input type="password" name="new_password" placeholder="Nueva contrase√±a" required>
                <input type="password" name="confirm_password" placeholder="Repite la nueva contrase√±a" required>
                <button type="submit">
                  <i class="fas fa-lock"></i> Cambiar contrase√±a
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Contadores -->
        <div class="section animate-in delay-1">
          <h3>Nosotros</h3>
          <div class="counters">
            <div class="counter-item">
              <h4>D√≠as juntos</h4>
              <p>{{ days_together }}</p>
            </div>

            <div class="counter-item">
              <h4>D√≠as hasta vernos</h4>
              {% set d = days_until_meeting if days_until_meeting is number else none %}
              {% if d is none or d < 0 %} <p class="tag tag-muted">Sin fecha</p>
                {% elif d == 0 %}
                <p class="tag tag-today">Hoy nos vemos‚ù§Ô∏è</p>
                {% elif d == 1 %}
                <p class="tag">1</p> {# <- sin tag-soon #} {% else %} <p class="tag">{{ d }} d√≠as</p>
                  {% endif %}
            </div>
          </div>

          <div class="mini-note" style="margin-top:6px; color:#6b7280; font-size:.95rem;">
            Actualiza la fecha del pr√≥ximo encuentro para que el chip del banner se ponga en modo ‚Äúpronto‚Äù
            autom√°ticamente. ‚ú®
          </div>


          <form method="POST" class="inline-form">
            <input type="date" name="meeting_date" required>
            <button type="submit"><i class="fas fa-calendar-alt"></i> Actualizar fecha</button>
          </form>
        </div>


        <!-- INTIMIDAD (discreto) -->
        <div class="section animate-in">
          <h3>Intimidad <small style="font-size:.9rem; opacity:.7;">(privado)</small></h3>

          {% if not intim_unlocked %}

          <p>Este m√≥dulo est√° oculto. Introduce el PIN para verlo.</p>
          <form method="POST" class="intim-pin-wrap">
            <input type="password" name="intim_pin" placeholder="PIN" required>
            <button type="submit" name="intim_unlock_pin">
              <i class="fas fa-lock-open"></i> Desbloquear
            </button>
          </form>

          {% else %}

          <!-- Acciones -->
          <form method="POST" class="intim-actions">
            <button type="submit" name="intim_register" title="Registrar momento (suma 1 a hoy)">
              <i class="fas fa-heart"></i> Registrar momento
            </button>

            <input type="text" name="intim_place" placeholder="Lugar (opcional)">
            <textarea name="intim_notes" placeholder="Notas privadas (opcional)" rows="1"></textarea>

            <button type="submit" name="intim_lock" style="margin-left:auto;">
              <i class="fas fa-lock"></i> Bloquear m√≥dulo
            </button>
          </form>

          <!-- KPIs (hoy / mes / a√±o) cargados por fetch -->
          <div class="intim-kpis" id="intim-kpis">
            <p class="intim-loading-msg" style="color:#888; margin:10px 0;">
              Pulsa la pesta√±a de Intimidad para cargar las estad√≠sticas‚Ä¶
            </p>
          </div>

          <!-- Historial de momentos: se rellena por JS -->
          <div class="intim-events" style="margin-top: 20px;">
            <h4 style="color: var(--primary-color); margin-bottom: 15px;">Historial de momentos</h4>
            <div id="intim-events-list">
              <!-- Aqu√≠ meteremos las tarjetas v√≠a fetch /api/intimidad -->
            </div>
          </div>

          <!-- Detalle: √∫ltima vez + rachas (tambi√©n por fetch) -->
          <div class="intim-stats" id="intim-stats">
            <!-- Relleno por JS -->
          </div>

          {% endif %}
        </div>


        <!-- Distancia / Estado de ciudades -->
        <div class="section animate-in delay-2">
          <h3>Distancia</h3>
          <p>Nuestro estado ahora mismo üíå</p>

          <div class="distance-status-card">
            <div class="distance-map-container">
              <!-- Mapa Leaflet -->
              <div id="distanceMap"></div>

              <!-- Panel flotante arriba (estado + km) -->
              <div class="distance-floating-info">
                <div class="distance-current-label">
                  <span class="ds-label" id="distanceStatusLabel">Separados</span>
                  <span class="ds-sub" id="distanceStatusSub">Mochito en Algemes√≠ ¬∑ Mochita en C√≥rdoba</span>
                </div>

                <div class="distance-km-pill">
                  <i class="fa-solid fa-route"></i>
                  <span id="distanceValue">‚Äî km</span>
                </div>
              </div>

              <!-- Controles flotantes juntos/separados (glassmorphism) -->
              <div class="distance-floating-controls">
                <button type="button" class="ds-mode-btn active" data-mode="separated">
                  <span class="ds-icon"><i class="fa-solid fa-route"></i></span>
                  <span class="ds-text">
                    <span class="ds-mode-title">Separados</span>
                  </span>
                </button>

                <button type="button" class="ds-mode-btn" data-mode="together_alg">
                  <span class="ds-icon"><i class="fa-solid fa-house-chimney-heart"></i></span>
                  <span class="ds-text">
                    <span class="ds-mode-title">Juntos en Algemes√≠</span>
                  </span>
                </button>

                <button type="button" class="ds-mode-btn" data-mode="together_cor">
                  <span class="ds-icon"><i class="fa-solid fa-city"></i></span>
                  <span class="ds-text">
                    <span class="ds-mode-title">Juntos en C√≥rdoba</span>
                  </span>
                </button>
              </div>
            </div>

            <p class="ds-footnote">
              Cualquiera de los dos puede cambiarlo y se actualizar√° para los dos en tiempo real ‚ú®
            </p>
          </div>
        </div>


        {% if mr_data and mr_data.active %}
        <style>
          #mr-camera-overlay {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 10000;
            display: none;
            flex-direction: column;
          }

          #mr-camera-overlay.active {
            display: flex;
          }

          .mr-cam-view {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
          }

          #mr-video-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
          }

          /* Espejo solo visual para la c√°mara frontal */
          #mr-video-feed.mirrored {
            transform: scaleX(-1);
          }

          .mr-cam-ui {
            position: absolute;
            inset: 0;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
          }

          .mr-cam-msg {
            color: white;
            text-align: center;
            font-weight: 800;
            font-size: 1.4rem;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
            margin-top: 40px;
          }

          .mr-cam-controls {
            pointer-events: auto;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            margin-bottom: 40px;
          }

          #btn-snap {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 5px solid white;
            background: transparent;
            position: relative;
            cursor: pointer;
            transition: transform 0.1s;
          }

          #btn-snap::after {
            content: "";
            position: absolute;
            inset: 4px;
            background: white;
            border-radius: 50%;
          }

          #btn-snap:active {
            transform: scale(0.9);
          }

          .icon-cam-btn {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
          }
        </style>

        <div class="mochireal-section pulse-warning" id="mochireal">
          <div class="mr-header">
            <div class="mr-title">‚ö†Ô∏è MochiReal</div>
            <div style="font-size:0.9rem; opacity:0.8">{{ mr_data.triggered_at[11:16] }}</div>
          </div>

          {% if not mr_data.my_post %}
          <p style="margin-bottom:15px;">¬°Sube tu foto para ver la de tu pareja!</p>

          <div class="mr-grid">
            <div class="mr-photo-container" style="border: 2px dashed #555;">
              <div style="text-align:center; color:#777;">
                <i class="fas fa-camera fa-2x"></i><br>Tu foto
              </div>
            </div>

            <div class="mr-photo-container">
              {% if mr_data.other_post %}
              <img src="{{ url_for('mochireal_image', post_id=mr_data.other_post.id) }}" class="mr-img mr-blur">
              <div class="mr-lock-overlay">
                <i class="fas fa-lock fa-2x"></i>
                <span style="font-weight:bold; margin-top:5px;">BLOQUEADA</span>
              </div>
              {% else %}
              <div style="text-align:center; color:#777;">
                <i class="fas fa-hourglass-half fa-2x"></i><br>Esperando a {{ other_user }}...
              </div>
              {% endif %}
            </div>
          </div>

          <div style="margin-top:15px">
            <button type="button" class="mr-upload-btn" onclick="startMochiCamera()">
              <i class="fas fa-camera"></i> Hacer MochiReal (Doble C√°mara)
            </button>
          </div>

          <div id="mr-camera-overlay">

            <div class="mr-cam-view" id="mr-cam-view-container">
              <video id="mr-video-feed" autoplay playsinline muted></video>

              <div id="mr-flash" style="position:absolute; inset:0; pointer-events:none;"></div>

              <div class="mr-cam-ui-top">
                <div class="mr-cam-msg" id="mr-msg">üì∏ Foto Trasera</div>
              </div>

              <div id="mr-processing" class="mr-processing-overlay">
                <div class="mr-spinner"></div>
                <div class="mr-processing-text">Fusionando fotos...</div>
                <small style="margin-top:10px; opacity:0.7;">Creando magia ‚ú®</small>
              </div>
            </div>

            <div class="mr-cam-controls">
              <button class="icon-cam-btn" onclick="closeMochiCamera()" title="Cancelar">
                <i class="fas fa-times"></i>
              </button>

              <button id="btn-snap" title="Hacer foto"></button>

              <button class="icon-cam-btn" onclick="switchCamMode()" title="Cambiar c√°mara">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
          </div>

          <canvas id="mr-canvas" style="display:none;"></canvas>

          {% else %}
          <div class="mr-grid">
            <div class="mr-photo-container">
              <img src="{{ url_for('mochireal_image', post_id=mr_data.my_post.id) }}" class="mr-img">
              <div
                style="position:absolute; bottom:10px; left:10px; font-weight:bold; text-shadow:0 2px 4px rgba(0,0,0,0.8); color:white;">
                T√∫
              </div>
            </div>

            <div class="mr-photo-container">
              {% if mr_data.other_post %}
              <img src="{{ url_for('mochireal_image', post_id=mr_data.other_post.id) }}" class="mr-img">
              <div
                style="position:absolute; bottom:10px; left:10px; font-weight:bold; text-shadow:0 2px 4px rgba(0,0,0,0.8); color:white;">
                {{ other_user }}
              </div>
              {% else %}
              <div style="text-align:center; color:#777;">
                <i class="fas fa-clock fa-2x"></i><br>{{ other_user }} a√∫n no ha subido
              </div>
              {% endif %}
            </div>
          </div>
          <p style="margin-top:15px; font-size:0.9rem; opacity:0.7">
            <i class="fas fa-check-circle"></i> Has cumplido por hoy
          </p>
          {% endif %}

          <div style="margin-top: 15px; border-top: 1px dashed rgba(0,0,0,0.1); padding-top: 10px;">
            <button type="button" class="btn-mr-history" style="color: inherit; border-color: currentColor;"
              onclick="openMochiHistory()">
              <i class="fas fa-history"></i> Ver recuerdos anteriores
            </button>
          </div>
        </div>

        <script>
          (function () {
            let stream = null;
            let backPhoto = null;
            let frontPhoto = null;
            let isFront = false; // false = trasera, true = frontal

            const overlay = document.getElementById('mr-camera-overlay');
            const video = document.getElementById('mr-video-feed');
            const msg = document.getElementById('mr-msg');
            const canvas = document.getElementById('mr-canvas');
            const ctx = canvas ? canvas.getContext('2d') : null;
            const processingOverlay = document.getElementById('mr-processing');
            const flashEl = document.getElementById('mr-flash');

            if (!overlay) return;

            // Configuraci√≥n inicial
            const constraints = {
              audio: false,
              video: {
                width: { ideal: 1920 },
                height: { ideal: 1080 },
                facingMode: "environment"
              }
            };

            // Efecto de flash visual
            function triggerFlash() {
              flashEl.classList.remove('flash-effect');
              void flashEl.offsetWidth; // forzar reflow
              flashEl.classList.add('flash-effect');
            }

            window.startMochiCamera = async function () {
              isFront = false; backPhoto = null; frontPhoto = null;
              overlay.classList.add('active');
              processingOverlay.classList.remove('active'); // asegurar que el loader est√© oculto
              msg.innerText = "üì∏ 1. Paisaje (Trasera)";
              await initCamera("environment");
            };

            window.initCamera = async function (mode) {
              if (stream) stream.getTracks().forEach(t => t.stop());
              constraints.video.facingMode = mode;
              try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;

                // Espejo solo visual para la frontal
                if (mode === 'user') {
                  video.classList.add('mirrored');
                  isFront = true;
                } else {
                  video.classList.remove('mirrored');
                  isFront = false;
                }

                video.onloadedmetadata = () => video.play();
              } catch (err) {
                alert("Error de c√°mara: " + err);
                closeMochiCamera();
              }
            };

            window.closeMochiCamera = function () {
              overlay.classList.remove('active');
              processingOverlay.classList.remove('active');
              if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
            };

            window.switchCamMode = function () {
              triggerFlash(); // peque√±o flash al cambiar para feedback visual
              isFront = !isFront;
              initCamera(isFront ? "user" : "environment");
              msg.innerText = isFront ? "üôÇ Selfie (Frontal)" : "üì∏ Paisaje (Trasera)";
            };

            document.getElementById('btn-snap')?.addEventListener('click', async () => {
              // Flashazo al hacer la foto
              triggerFlash();

              // 1. Configurar canvas
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;

              // 2. Dibujar frame
              if (isFront) {
                ctx.save();
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                ctx.restore();
              } else {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
              }

              const data = canvas.toDataURL('image/jpeg', 0.9);

              if (!backPhoto) {
                // --- FOTO 1: TRASERA COMPLETADA ---
                backPhoto = await loadImage(data);

                // Pausa breve para feedback
                video.pause();
                msg.innerText = "üôÇ 2. ¬°Ahora tu cara!";

                setTimeout(() => {
                  isFront = true;
                  video.play();
                  initCamera("user"); // Cambiar a frontal autom√°ticamente
                }, 600);

              } else {
                // --- FOTO 2: FRONTAL COMPLETADA ---
                frontPhoto = await loadImage(data);
                processMochiReal();
              }
            });

            function loadImage(src) {
              return new Promise(r => { const i = new Image(); i.onload = () => r(i); i.src = src; });
            }

            async function processMochiReal() {
              // 1. Mostrar pantalla de carga bonita
              processingOverlay.classList.add('active');

              // Ocultar mensaje superior para limpiar
              msg.innerText = "";

              // 2. Procesamiento de imagen (Fusi√≥n)
              // Usamos la trasera como lienzo base
              canvas.width = backPhoto.width;
              canvas.height = backPhoto.height;
              ctx.drawImage(backPhoto, 0, 0);

              // Calcular recuadro peque√±o (30% del ancho)
              const w = backPhoto.width * 0.30;
              const h = (frontPhoto.height / frontPhoto.width) * w;
              const x = 50, y = 50;

              // Sombra para dar profundidad
              ctx.shadowColor = "rgba(0,0,0,0.5)";
              ctx.shadowBlur = 20;

              // Borde negro estilo Polaroid/BeReal
              ctx.lineWidth = 15;
              ctx.strokeStyle = "black";
              ctx.strokeRect(x, y, w, h);
              ctx.shadowBlur = 0; // reset sombra para la imagen

              // Dibujar frontal
              ctx.drawImage(frontPhoto, x, y, w, h);

              // Borde fino blanco interno para resaltar
              ctx.lineWidth = 4;
              ctx.strokeStyle = "white";
              ctx.strokeRect(x, y, w, h);

              // 3. Subir al servidor
              canvas.toBlob(async (blob) => {
                const fd = new FormData();
                fd.append('photo', blob, 'mochireal_dual.jpg');
                try {
                  const res = await fetch('/mochireal/upload', { method: 'POST', body: fd });
                  if (res.ok || res.redirected) {
                    // √âxito: recargar
                    window.location.reload();
                  } else {
                    alert("Error subiendo imagen");
                    closeMochiCamera();
                  }
                } catch (e) {
                  alert("Error red: " + e);
                  closeMochiCamera();
                }
              }, 'image/jpeg', 0.85);
            }
          })();
        </script>

        {% endif %}
        <!-- Horarios -->
        <div class="section animate-in delay-2">
          <h3>Nuestros Horarios</h3>
          <p>Nuestros horarios y activiades (editables).</p>
          <a href="{{ url_for('schedule_page') }}">
            <button style="width: 100%;">
              <i class="fas fa-calendar-alt"></i> Ver Horarios
            </button>
          </a>
        </div>

        <!-- Pregunta diaria -->
        <div class="section animate-in delay-2">
          <h3>Pregunta del d√≠a</h3>

          <div class="dq-countdown">
            <div class="dq-countdown-card">
              <div class="dq-countdown-title">
                <i class="fas fa-clock" aria-hidden="true"></i>
                Pr√≥ximo cambio de pregunta
              </div>
              <div class="dq-countdown-time" id="dqTimer" aria-live="polite">--:--:--</div>
            </div>
          </div>

          <p class="question"><b>{{ question }}</b></p>

          <div class="streak-badges">
            <div class="streak-badge">
              <i class="fas fa-fire"></i>
              Racha actual: {{ current_streak }} d√≠a{% if current_streak != 1 %}s{% endif %}
            </div>
            <div class="streak-badge best">
              <i class="fas fa-trophy"></i>
              Mejor racha: {{ best_streak }} d√≠a{% if best_streak != 1 %}s{% endif %}
            </div>
          </div>

          <!-- {# === A) Ambos respondieron === #} -->
          {% if show_answers %}
          <div class="answers" style="gap:12px;">
            {# Tu bloque (editable) #}
            <div class="answer-item" style="flex-wrap:wrap;">
              <div class="user-avatar">
                {% if profile_pictures.get(username) %}
                <img src="{{ profile_pictures.get(username) }}" alt="{{ username }}">
                {% else %} {{ username[0]|upper }} {% endif %}
              </div>

              <div class="answer-content" style="flex:1;">
                <div class="answer-head" style="display:flex; align-items:center; gap:10px;">
                  <div style="flex:1;">
                    <b>T√∫:</b>
                    <span id="ans-text-me" class="answer-text">{{ user_answer }}</span>
                    {% if answers_edited and answers_edited.get(username) %}
                    <small class="edited-pill">(editado)</small>
                    {% endif %}
                  </div>
                  <a href="#" class="edit-link" onclick="return toggleEdit('me');">Editar</a>
                </div>


                <form method="POST" id="ans-form-me" style="display:none; margin-top:10px;">
                  <input type="text" name="answer" value="{{ user_answer }}" required>
                  <button type="submit"><i class="fas fa-save"></i> Guardar</button>
                  <button type="button" onclick="toggleEdit('me')"
                    style="background:#fff;color:#e84393;border:1px solid #eee">
                    Cancelar
                  </button>
                </form>
              </div>
            </div>

            <!-- {# Bloque de la otra persona (solo lectura) #} -->
            <div class="answer-item">
              <div class="user-avatar">
                {% if profile_pictures.get(other_user) %}
                <img src="{{ profile_pictures.get(other_user) }}" alt="{{ other_user }}">
                {% else %} {{ other_user[0]|upper }} {% endif %}
              </div>
              <div>
                <b>{{ other_user }}:</b>
                <span class="answer-text">{{ other_answer }}</span>
                {% if answers_edited and answers_edited.get(other_user) %}
                <small class="edited-pill">(editado)</small>
                {% endif %}
              </div>

            </div>
          </div>
          <!-- {# === B) T√∫ respondiste y falta el/la otr@ (puedes editar mientras) === #} -->
          {% elif user_answer and not other_answer %}
          <div class="answers" style="gap:12px;">
            <div class="answer-item" style="flex-wrap:wrap;">
              <div class="user-avatar">
                {% if profile_pictures.get(username) %}
                <img src="{{ profile_pictures.get(username) }}" alt="{{ username }}">
                {% else %} {{ username[0]|upper }} {% endif %}
              </div>

              <div class="answer-content" style="flex:1;">
                <div class="answer-head" style="display:flex; align-items:center; gap:10px;">
                  <div style="flex:1;">
                    <b>T√∫:</b>
                    <span id="ans-text-me" class="answer-text">{{ user_answer }}</span>
                    {% if answers_edited and answers_edited.get(username) %}
                    <small class="edited-pill">(editado)</small>
                    {% endif %}
                  </div>
                  <a href="#" class="edit-link" onclick="return toggleEdit('me');">Editar</a>
                </div>


                <form method="POST" id="ans-form-me" style="display:none; margin-top:10px;">
                  <input type="text" name="answer" value="{{ user_answer }}" required>
                  <button type="submit"><i class="fas fa-save"></i> Guardar</button>
                  <button type="button" onclick="toggleEdit('me')"
                    style="background:#fff;color:#e84393;border:1px solid #eee">
                    Cancelar
                  </button>
                </form>
              </div>
            </div>
          </div>

          <p style="margin-top:8px;opacity:.75;">A√∫n falta la respuesta de <b>{{ other_user }}</b> üïí</p>

          <!-- {# === C) El/la otr@ ya respondi√≥ y t√∫ no: su bloque borroso + tu caja para responder === #} -->
          {% elif (not user_answer) and other_answer %}
          <form method="POST" class="inline-form" style="margin-bottom:15px; display:flex; gap:8px;">
            <input type="text" name="answer" placeholder="Tu respuesta‚Ä¶" required style="flex:1;">
            <button type="submit"><i class="fas fa-paper-plane"></i> Enviar</button>
          </form>

          <div class="answers">
            <div class="answer-item blurred">
              <div class="user-avatar">
                {% if profile_pictures.get(other_user) %}
                <img src="{{ profile_pictures.get(other_user) }}" alt="{{ other_user }}">
                {% else %} {{ other_user[0]|upper }} {% endif %}
              </div>
              <div>
                <b>{{ other_user }}:</b>
                <span class="answer-text">{{ other_answer }}</span>
                {% if answers_edited and answers_edited.get(other_user) %}
                <small class="edited-pill">(editado)</small>
                {% endif %}
              </div>

            </div>
          </div>

          {# === D) Nadie ha respondido a√∫n === #}
          {% else %}
          <form method="POST" class="inline-form" style="display:flex; gap:8px;">
            <input type="text" name="answer" placeholder="Tu respuesta‚Ä¶" required style="flex:1;">
            <button type="submit"><i class="fas fa-paper-plane"></i> Enviar</button>
          </form>
          {% endif %}

          <!-- A√ëADE ESTO JUSTO AQU√ç - Enlace al historial -->
          <!-- Ejemplo de implementaci√≥n del bot√≥n en tu web -->
          <div class="historial-container">
            <a href="/historial" class="btn-historial">
              <i class="fas fa-history"></i> Ver historial completo
            </a>
          </div>
        </div>



        <!-- Lista de deseos -->
        <div class="section animate-in delay-3">
          <h3>Nuestra Lista de Deseos</h3>
          <p>Cosas que nos gustar√≠a tener o regalarnos mutuamente.</p>

          <div class="wishlist-tools">
            <div id="wishlist-sort-toggle" class="sort-toggle" role="group" aria-label="Ordenar lista de deseos"
              tabindex="0">
              <div class="slider" aria-hidden="true"></div>
              <button type="button" data-mode="recent" aria-pressed="true">
                <i class="fas fa-clock"></i> Recientes
              </button>
              <button type="button" data-mode="priority" aria-pressed="false">
                <i class="fas fa-flag"></i> Prioridad
              </button>
            </div>
          </div>



          <div class="wishlist-tabs" id="wishlist-tabs-container">
            <div class="wishlist-tab active" data-tab="wanted">Deseados</div>
            <div class="wishlist-tab" data-tab="purchased">Comprados</div>
            <div class="wishlist-tab" data-tab="add-wishlist">A√±adir Deseo</div>
          </div>

          <!-- Deseados -->
          <div class="wishlist-content active" id="wanted-tab">
            <div class="wishlist-grid">
              {% for id, product_name, product_link, notes, created_by, created_at, is_purchased, priority, is_gift,
              size, track_price, last_price_cents, currency, last_checked, alert_drop_percent, alert_below_cents in
              wishlist_items if not is_purchased %}
              {% set pri = (priority or 'media') %}
              {% set soy_creador = (created_by == username) %}
              {% set oculto_para_mi = (is_gift and not soy_creador) %}

              <div class="wishlist-card {% if oculto_para_mi %}locked{% endif %}"
                data-created="{{ (created_at or '') }}" data-priority="{{ pri }}">
                <div class="wishlist-status status-wanted">Deseado</div>

                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <div
                    class="priority-chip {{ 'priority-high' if pri=='alta' else 'priority-low' if pri=='baja' else 'priority-mid' }}">
                    <i class="fas fa-flag"></i> {{ pri|capitalize }}
                  </div>
                  {% if is_gift %}
                  <div class="gift-chip" title="Marcado como regalo">
                    <i class="fas fa-gift"></i> Regalo
                  </div>
                  {% endif %}
                </div>

                {% if oculto_para_mi %}
                <div class="gift-mask">
                  üéÅ <div>¬°Esto es un regalo para ti!</div>
                  <small>Los detalles est√°n ocultos para mantener la sorpresa.</small>
                </div>
                {% else %}
                <h3 class="wishlist-product">{{ product_name }}</h3>

                {% if product_link %}
                <a href="{{ product_link }}" target="_blank" rel="noopener noreferrer" class="wishlist-link">
                  <i class="fas fa-link"></i> Ver producto
                </a>
                {% if (size or '')|trim %}
                <div class="wishlist-size"><strong>Talla:</strong> {{ size }}</div>
                {% endif %}
                {% endif %}

                {% if notes %}
                <p class="wishlist-notes">{{ notes }}</p>
                {% endif %}
                {% endif %}

                <div class="wishlist-meta">
                  <span>
                    <div class="user-avatar"
                      style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 5px;">
                      {% if profile_pictures.get(created_by) %}
                      <img src="{{ profile_pictures.get(created_by) }}" alt="{{ created_by }}">
                      {% else %}
                      {{ created_by[0]|upper }}
                      {% endif %}
                    </div>
                    Creado por {{ created_by }}
                  </span>
                  <span>{{ created_at[:10] }}</span>
                </div>

                {% if not oculto_para_mi %}
                <div class="wishlist-actions">
                  <form method="POST" action="/toggle_wishlist_item">
                    <input type="hidden" name="item_id" value="{{ id }}">
                    <button type="submit" class="icon-btn" title="Marcar como comprado">
                      <i class="fas fa-check"></i>
                    </button>
                  </form>

                  <button class="icon-btn" title="Editar" onclick='openEditModal(
                      {{ id }},
                      {{ product_name|tojson }},
                      {{ product_link|tojson }},
                      {{ (notes or "")|tojson }},
                      {{ pri|tojson }},
                      {{ is_gift|tojson }},
                      {{ (size or "")|tojson }}
                    )'>
                    <i class="fas fa-edit"></i>
                  </button>

                  {% if created_by == username %}
                  <form method="POST" action="/delete_wishlist_item"
                    onsubmit="return confirm('¬øEst√°s seguro de que quieres eliminar este producto?');">

                    <input type="hidden" name="item_id" value="{{ id }}">
                    <button type="submit" class="icon-btn" title="Eliminar">
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% else %}
              <p>No hay productos en tu lista de deseos. ¬°A√±ade el primero!</p>
              {% endfor %}
            </div>
          </div>

          <!-- Comprados -->
          <div class="wishlist-content" id="purchased-tab">
            <div class="wishlist-grid">
              {% for id, product_name, product_link, notes, created_by, created_at, is_purchased, priority, is_gift,
              size, track_price, last_price_cents, currency, last_checked, alert_drop_percent, alert_below_cents in
              wishlist_items if is_purchased %}
              {% set pri = (priority or 'media') %}
              {% set soy_creador = (created_by == username) %}
              {% set oculto_para_mi = (is_gift and not soy_creador) %}

              <div class="wishlist-card purchased {% if oculto_para_mi %}locked{% endif %}"
                data-created="{{ (created_at or '') }}" data-priority="{{ pri }}">
                <div class="wishlist-status status-purchased">Comprado</div>

                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <div
                    class="priority-chip {{ 'priority-high' if pri=='alta' else 'priority-low' if pri=='baja' else 'priority-mid' }}">
                    <i class="fas fa-flag"></i> {{ pri|capitalize }}
                  </div>
                  {% if is_gift %}
                  <div class="gift-chip" title="Marcado como regalo">
                    <i class="fas fa-gift"></i> Regalo
                  </div>
                  {% endif %}
                </div>

                {% if oculto_para_mi %}
                <div class="gift-mask">
                  üéÅ <div>¬°Esto es (o era) un regalo para ti!</div>
                  <small>Detalles ocultos para mantener la sorpresa.</small>
                </div>
                {% else %}
                <h3 class="wishlist-product">{{ product_name }}</h3>

                {% if product_link %}
                <a href="{{ product_link }}" target="_blank" rel="noopener noreferrer" class="wishlist-link">
                  <i class="fas fa-link"></i> Ver producto
                </a>
                {% if (size or '')|trim %}
                <div class="wishlist-size"><strong>Talla:</strong> {{ size }}</div>
                {% endif %}
                {% endif %}

                {% if notes %}
                <p class="wishlist-notes">{{ notes }}</p>
                {% endif %}
                {% endif %}

                <div class="wishlist-meta">
                  <span>
                    <div class="user-avatar"
                      style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 5px;">
                      {% if profile_pictures.get(created_by) %}
                      <img src="{{ profile_pictures.get(created_by) }}" alt="{{ created_by }}">
                      {% else %}
                      {{ created_by[0]|upper }}
                      {% endif %}
                    </div>
                    Creado por {{ created_by }}
                  </span>
                  <span>{{ created_at[:10] }}</span>
                </div>

                {% if not oculto_para_mi %}
                <div class="wishlist-actions">
                  <form method="POST" action="/toggle_wishlist_item">
                    <input type="hidden" name="item_id" value="{{ id }}">
                    <button type="submit" class="icon-btn" title="Marcar como no comprado">
                      <i class="fas fa-undo"></i>
                    </button>
                  </form>

                  <button class="icon-btn" title="Editar" onclick='openEditModal(
                      {{ id }},
                      {{ product_name|tojson }},
                      {{ product_link|tojson }},
                      {{ (notes or "")|tojson }},
                      {{ pri|tojson }},
                      {{ is_gift|tojson }},
                      {{ (size or "")|tojson }}
                    )'>
                    <i class="fas fa-edit"></i>
                  </button>

                  {% if created_by == username %}
                  <form method="POST" action="/delete_wishlist_item"
                    onsubmit="return confirm('¬øEst√°s seguro de que quieres eliminar este producto?');">
                    <input type="hidden" name="item_id" value="{{ id }}">
                    <button type="submit" class="icon-btn" title="Eliminar">
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% else %}
              <p>No hay productos comprados todav√≠a.</p>
              {% endfor %}
            </div>
          </div>

          <!-- A√±adir deseo -->
          <div class="wishlist-content" id="add-wishlist-tab">
            <div class="wishlist-form">
              <h4>A√±adir nuevo producto</h4>
              <form method="POST">
                <input type="text" name="product_name" placeholder="Nombre del producto" required>
                <input type="url" name="product_link" placeholder="Enlace (opcional)">
                <textarea name="wishlist_notes" placeholder="Notas (opcional)" rows="3"></textarea>

                <!-- Talla -->
                <input type="text" name="size" placeholder="Talla (opcional)" />

                <select name="priority" required style="margin-bottom:15px;">
                  <option value="alta">Prioridad: Alta üî¥</option>
                  <option value="media" selected>Prioridad: Media üü°</option>
                  <option value="baja">Prioridad: Baja üü¢</option>
                </select>

                <!-- Regalo (estilizado como bot√≥n) -->
                <div class="gift-toggle-row">
                  <input type="checkbox" id="is_gift" name="is_gift">
                  <label for="is_gift">¬øEs un regalo (ocultar a la otra persona)?</label>
                </div>

                <!-- Precio: eliminado por petici√≥n -->

                <button type="submit"><i class="fas fa-plus"></i> A√±adir a la lista</button>
              </form>
            </div>
          </div>
        </div>
        <!-- =========================
     PEL√çCULAS & SERIES
     ========================= -->
        <div class="section animate-in" data-section="media">
          <h3>Pel√≠culas & Series</h3>
          <p>Lo que queremos ver y lo que ya vimos üí´</p>

          <div class="media-tools">
            <input type="search" id="media-search" placeholder="Buscar t√≠tulo/plataforma‚Ä¶">
            <div id="media-sort-toggle" class="sort-toggle" role="group" aria-label="Ordenar" tabindex="0">
              <div class="slider" aria-hidden="true"></div>
              <button type="button" data-mode="recent" aria-pressed="true"><i class="fas fa-clock"></i>
                Recientes</button>
              <button type="button" data-mode="rating" aria-pressed="false"><i class="fas fa-star"></i>
                Rating</button>
              <button type="button" data-mode="platform" aria-pressed="false"><i class="fas fa-tv"></i>
                Plataforma</button>
            </div>
          </div>

          <div class="media-tabs">
            <div class="media-tab active" data-tab="towatch">Por ver</div>
            <div class="media-tab" data-tab="watched">Vistas</div>
            <div class="media-tab" data-tab="add-media">A√±adir</div>
          </div>

          <!-- Por ver -->
          <div class="media-content active" id="towatch-tab">
            <div class="media-grid">
              {% for m in media_to_watch %}
              <div class="media-card" data-id="{{ m.get('id') }}" data-title="{{ (m.get('title') or '')|e }}"
                data-kind="{{ (m.get('kind') or 'movie')|e }}"
                data-platform="{% if m.get('on_netflix') and m.get('on_prime') %}both{% elif m.get('on_netflix') %}netflix{% elif m.get('on_prime') %}prime{% else %}zzz{% endif %}"
                data-link="{{ (m.get('link_url') or '')|e }}" data-notes="{{ (m.get('comment') or '')|e }}"
                data-priority="{{ (m.get('priority') or 'media') }}" data-cover="{{ (m.get('cover_url') or '')|e }}"
                data-created="{{ (m.get('created_at') or '') }}"
                data-rating-me="{{ (m.get('reviews', {}).get(username, {}).get('rating') or m.get('rating_me') or 0) }}"
                data-rating-other="{{ (m.get('reviews', {}).get(other_user, {}).get('rating') or m.get('rating_other') or 0) }}"
                data-comment-me="{{ (m.get('reviews', {}).get(username, {}).get('comment') or m.get('comment_me') or '')|e }}"
                data-comment-other="{{ (m.get('reviews', {}).get(other_user, {}).get('comment') or m.get('comment_other') or '')|e }}"
                data-avg="{{ (m.get('avg_rating') or m.get('rating') or 0) }}" data-watched="0">
                <div class="media-status badge-wanted">Por ver</div>

                <div class="media-head">
                  <span class="media-kind movie">T√≠tulo</span>
                  {% if m.get('on_netflix') %}
                  <span class="platform-chip" aria-label="Netflix">
                    <img src="{{ url_for('static', filename='icons/netflix.png') }}" alt="Netflix" loading="lazy">
                  </span>
                  {% endif %}
                  {% if m.get('on_prime') %}
                  <span class="platform-chip" aria-label="Prime Video">
                    <img src="{{ url_for('static', filename='icons/prime-video.png') }}" alt="Prime Video"
                      loading="lazy">
                  </span>
                  {% endif %}


                </div>

                {% if m.get('cover_url') %}
                <div class="media-cover">
                  <img src="{{ m.get('cover_url') }}" alt="Portada de {{ m.get('title')|e }}">
                </div>
                {% endif %}

                <h3 class="media-title">{{ m.get('title') }}</h3>

                {% if m.get('link_url') %}
                <a class="media-link" href="{{ m.get('link_url') }}" target="_blank" rel="noopener">
                  <i class="fas fa-link"></i> Abrir enlace
                </a>
                {% endif %}

                {% if m.get('comment') %}<p class="media-notes">{{ m.get('comment') }}</p>{% endif %}

                <div class="media-meta">
                  {% set who = m.get('created_by') or '' %}
                  <span>
                    <div class="user-avatar"
                      style="width:20px;height:20px;display:inline-block;vertical-align:middle;margin-right:5px;">
                      {% if profile_pictures.get(who) %}
                      <img src="{{ profile_pictures.get(who) }}" alt="{{ who }}">
                      {% else %}
                      {{ (who[:1] or '?')|upper }}
                      {% endif %}
                    </div>
                    {{ who or '‚Äî' }}
                  </span>
                  <span>{{ (m.get('created_at') or '')[:10] }}</span>
                </div>

                <div class="media-actions">
                  <!-- Valorar/comentar (modal B) -->
                  <button type="button" class="icon-btn" title="Marcar como vista y valorar"
                    onclick="openRateMedia(this)">
                    <i class="fas fa-check"></i>
                  </button>

                  <!-- Editar ficha (modal A) -->
                  <button type="button" class="icon-btn" title="Editar ficha" onclick="openBasicEditMedia(this)">
                    <i class="fas fa-pen-to-square"></i>
                  </button>

                  {% if m.get('created_by') == username %}
                  <form method="POST" action="/media/delete" onsubmit="return confirm('¬øEliminar este t√≠tulo?');">
                    <input type="hidden" name="id" value="{{ m.get('id') }}">
                    <button class="icon-btn" title="Eliminar"><i class="fas fa-trash"></i></button>
                  </form>
                  {% endif %}
                </div>
              </div>
              {% else %}
              <p>No hay t√≠tulos por ver. ¬°A√±ade alguno!</p>
              {% endfor %}
            </div>
            <div class="pager" id="media-pager-towatch"></div>
          </div>

          <!-- Vistas -->
          <div class="media-content" id="watched-tab">
            <div class="media-grid">
              {% for m in media_watched %}
              {% set reviews = m.get('reviews') or {} %}
              {% set avg = m.get('avg_rating') or m.get('rating') or 0 %}
              {% set my_rating = reviews.get(username, {}).get('rating') or m.get('rating_me') or 0 %}
              {% set other_rating = reviews.get(other_user, {}).get('rating') or m.get('rating_other') or 0 %}
              {% set my_comment = reviews.get(username, {}).get('comment') or m.get('comment_me') or
              (m.get('watched_comment') if m.get('created_by') == username else '') %}
              {% set other_comment = reviews.get(other_user, {}).get('comment') or m.get('comment_other') %}
              <div class="media-card watched" data-id="{{ m.get('id') }}" data-title="{{ (m.get('title') or '')|e }}"
                data-kind="{{ (m.get('kind') or 'movie')|e }}"
                data-platform="{% if m.get('on_netflix') and m.get('on_prime') %}both{% elif m.get('on_netflix') %}netflix{% elif m.get('on_prime') %}prime{% else %}zzz{% endif %}"
                data-link="{{ (m.get('link_url') or '')|e }}" data-notes="{{ (m.get('comment') or '')|e }}"
                data-priority="{{ (m.get('priority') or 'media') }}" data-cover="{{ (m.get('cover_url') or '')|e }}"
                data-created="{{ (m.get('watched_at') or m.get('created_at') or '') }}" data-rating-me="{{ my_rating }}"
                data-rating-other="{{ other_rating }}" data-comment-me="{{ (my_comment or '')|e }}"
                data-comment-other="{{ (other_comment or '')|e }}" data-avg="{{ avg }}" data-watched="1">
                <div class="media-status badge-watched">Vista</div>

                <div class="media-head">
                  <span class="media-kind movie">T√≠tulo</span>
                  {% if m.get('on_netflix') %}
                  <span class="platform-chip" aria-label="Netflix">
                    <img src="{{ url_for('static', filename='icons/netflix.png') }}" alt="Netflix" loading="lazy">
                  </span>
                  {% endif %}
                  {% if m.get('on_prime') %}
                  <span class="platform-chip" aria-label="Prime Video">
                    <img src="{{ url_for('static', filename='icons/prime-video.png') }}" alt="Prime Video"
                      loading="lazy">
                  </span>
                  {% endif %}

                </div>

                {% if m.get('cover_url') %}
                <div class="media-cover">
                  <img src="{{ m.get('cover_url') }}" alt="Portada de {{ m.get('title')|e }}">
                </div>
                {% endif %}

                <h3 class="media-title">{{ m.get('title') }}</h3>

                {% if m.get('link_url') %}
                <a class="media-link" href="{{ m.get('link_url') }}" target="_blank" rel="noopener">
                  <i class="fas fa-link"></i> Abrir enlace
                </a>
                {% endif %}

                <!-- Media de ambos (con medias) -->
                <div class="rating readonly" aria-label="Valoraci√≥n media">
                  {% set av = (avg or 0)|float %}
                  {% for i in range(1, 6) %}
                  {% set diff = av - (i - 1) %}
                  {% if diff >= 1 %}
                  <i class="fas fa-star"></i>
                  {% elif diff >= 0.5 %}
                  <i class="fas fa-star-half-stroke"></i>
                  {% else %}
                  <i class="far fa-star"></i>
                  {% endif %}
                  {% endfor %}
                </div>

                <!-- Chips por usuario -->
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin:6px 0;">
                  {% if my_rating %}
                  <span class="chip">‚≠ê {{ my_rating }}/5 T√∫</span>
                  {% endif %}
                  {% if other_rating %}
                  <span class="chip">‚≠ê {{ other_rating }}/5 {{ other_user }}</span>
                  {% endif %}
                </div>

                <!-- Comentarios separados -->
                <div class="review-duo" style="display:grid; gap:10px;">
                  {% if my_comment %}
                  <div class="answer-item">
                    <div class="user-avatar">
                      {% if profile_pictures.get(username) %}<img src="{{ profile_pictures.get(username) }}"
                        alt="{{ username }}">{% else %}{{ username[0]|upper }}{% endif %}
                    </div>
                    <div><b>T√∫:</b> <span class="answer-text">{{ my_comment }}</span></div>
                  </div>
                  {% endif %}

                  {% if other_comment %}
                  <div class="answer-item">
                    <div class="user-avatar">
                      {% if profile_pictures.get(other_user) %}<img src="{{ profile_pictures.get(other_user) }}"
                        alt="{{ other_user }}">{% else %}{{ other_user[0]|upper }}{% endif %}
                    </div>
                    <div><b>{{ other_user }}:</b> <span class="answer-text">{{ other_comment }}</span></div>
                  </div>
                  {% endif %}
                </div>

                <div class="media-meta">
                  <span>Vista: {{ ((m.get('watched_at') or '')|string)[:10] }}</span>
                  <span>‚≠ê {{ avg }}/5</span>
                </div>

                <div class="media-actions">
                  <form method="POST" action="/media/unwatch">
                    <input type="hidden" name="id" value="{{ m.get('id') }}">
                    <button class="icon-btn" title="Marcar como no vista"><i class="fas fa-undo"></i></button>
                  </form>

                  <!-- Valorar/comentar (modal B) -->
                  <button type="button" class="icon-btn" title="Editar valoraci√≥n/comentario"
                    onclick="openRateMedia(this)">
                    <i class="fas fa-star"></i>
                  </button>

                  <!-- Editar ficha (modal A) -->
                  <button type="button" class="icon-btn" title="Editar ficha" onclick="openBasicEditMedia(this)">
                    <i class="fas fa-pen-to-square"></i>
                  </button>

                  {% if m.get('created_by') == username %}
                  <form method="POST" action="/media/delete" onsubmit="return confirm('¬øEliminar este t√≠tulo?');">
                    <input type="hidden" name="id" value="{{ m.get('id') }}">
                    <button class="icon-btn" title="Eliminar"><i class="fas fa-trash"></i></button>
                  </form>
                  {% endif %}
                </div>
              </div>
              {% else %}
              <p>No hay t√≠tulos vistos a√∫n.</p>
              {% endfor %}
            </div>
            <div class="pager" id="media-pager-watched"></div>
          </div>

          <!-- A√±adir -->
          <div class="media-content" id="add-media-tab">
            <div class="media-form">
              <h4>A√±adir t√≠tulo</h4>
              <form method="POST" action="/media/add" id="addMediaForm">
                <div class="grid2">
                  <div class="input-wrap">
                    <label>T√≠tulo</label>
                    <input type="text" name="title" required>
                  </div>
                  <div class="input-wrap">
                    <label>Portada (URL, opcional)</label>
                    <input type="url" name="cover_url" placeholder="https://‚Ä¶">
                  </div>
                </div>

                <div class="grid2">
                  <div class="input-wrap">
                    <label>Enlace (opcional)</label>
                    <input type="url" name="link_url" placeholder="https://‚Ä¶">
                  </div>
                  <div class="input-wrap">
                    <label>Prioridad</label>
                    <select name="priority">
                      <option value="alta">Alta</option>
                      <option value="media" selected>Media</option>
                      <option value="baja">Baja</option>
                    </select>
                  </div>
                </div>

                <div class="input-wrap">
                  <label style="font-weight:800;">Disponible en</label>
                  <div class="brand-toggles-min" role="group" aria-label="Disponible en plataformas">
                    <!-- Netflix -->
                    <div class="brand-icon-toggle">
                      <input type="checkbox" id="on_netflix" name="on_netflix">
                      <label for="on_netflix" class="netflix" title="Est√° en Netflix">
                        <img src="{{ url_for('static', filename='icons/Netflix_N.png') }}" alt="Netflix">
                        <span class="brand-caption">Netflix</span>
                        <span class="sr-only">Est√° en Netflix</span>
                      </label>
                    </div>

                    <!-- Prime Video -->
                    <div class="brand-icon-toggle">
                      <input type="checkbox" id="on_prime" name="on_prime">
                      <label for="on_prime" class="prime" title="Est√° en Prime Video">
                        <img src="{{ url_for('static', filename='icons/prime_logo.png') }}" alt="Prime Video">
                        <span class="brand-caption">Prime</span>
                        <span class="sr-only">Est√° en Prime</span>
                      </label>
                    </div>
                  </div>
                </div>




                <div class="input-wrap">
                  <label>Notas (opcional)</label>
                  <textarea name="comment" rows="3" placeholder="Por qu√© queremos verla, recordatorios‚Ä¶"></textarea>
                </div>

                <button type="submit"><i class="fas fa-plus"></i> A√±adir</button>
              </form>
            </div>
          </div>
        </div>


        <!-- MODAL B: Valorar / comentar -->
        <div id="editMediaModal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h2 id="editMediaHeading">Valorar / comentar</h2>
              <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
              <form method="POST" action="/media/watch" id="editMediaForm">
                <input type="hidden" name="id" id="mediaId">

                <div class="rating editable" aria-label="Valoraci√≥n" id="ratingStars">
                  <i class="fa-star far" data-val="1"></i>
                  <i class="fa-star far" data-val="2"></i>
                  <i class="fa-star far" data-val="3"></i>
                  <i class="fa-star far" data-val="4"></i>
                  <i class="fa-star far" data-val="5"></i>
                  <span class="rating-help">Haz clic para valorar</span>
                </div>
                <!-- vac√≠o = sin nota (mejor que poner 0) -->
                <input type="hidden" name="rating" id="ratingInput" value="">

                <div class="input-wrap">
                  <label>Tu comentario</label>
                  <textarea name="watched_comment" id="mediaComment" rows="3" placeholder="¬øQu√© tal estuvo?"></textarea>
                </div>

                <!-- Esta casilla es opcional; el backend /media/watch SIEMPRE marca como vista -->
                <label class="checkbox" style="display:inline-flex;gap:8px;align-items:center;margin:8px 0 16px">
                  <input type="checkbox" id="markWatched" name="mark_watched" checked> Marcar como vista
                </label>

                <button type="submit"><i class="fas fa-save"></i> Guardar</button>
              </form>
            </div>
          </div>
        </div>

        <!-- MODAL A: Editar ficha (t√≠tulo/link/portada/plataformas/prioridad) -->
        <div id="basicEditMediaModal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h2>Editar ficha</h2>
              <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
              <form method="POST" action="/media/update" id="basicEditMediaForm">
                <input type="hidden" name="id" id="basicMediaId">

                <div class="input-wrap">
                  <label>T√≠tulo</label>
                  <input type="text" name="title" id="basicTitle" required>
                </div>

                <div class="input-wrap">
                  <label>Portada (URL)</label>
                  <input type="url" name="cover_url" id="basicCover" placeholder="https://‚Ä¶">
                </div>

                <div class="input-wrap">
                  <label>Enlace</label>
                  <input type="url" name="link_url" id="basicLink" placeholder="https://‚Ä¶">
                </div>

                <div class="grid2" style="margin:10px 0;">
                  <label class="checkbox"><input type="checkbox" name="on_netflix" id="basicNetflix"> Est√° en
                    Netflix</label>
                  <label class="checkbox"><input type="checkbox" name="on_prime" id="basicPrime"> Est√° en
                    Prime</label>
                </div>

                <div class="input-wrap">
                  <label>Prioridad</label>
                  <select name="priority" id="basicPriority">
                    <option value="alta">Alta</option>
                    <option value="media">Media</option>
                    <option value="baja">Baja</option>
                  </select>
                </div>

                <div class="input-wrap">
                  <label>Notas (lista)</label>
                  <textarea name="comment" id="basicNotes" rows="3"
                    placeholder="Notas generales (no es la rese√±a)"></textarea>
                </div>

                <button type="submit"><i class="fas fa-save"></i> Guardar ficha</button>
              </form>
            </div>
          </div>
        </div>

        <!-- ===== JS para los dos modales ===== -->
        <script>
          function getCardFromBtn(btn) { return btn.closest('.media-card'); }
          /* Pinta estrellas (fas/far) dentro del contenedor dado */
          function paintStars(container, val) {
            if (!container) return;
            const n = Number(val || 0);
            container.querySelectorAll('.fa-star').forEach((i, idx) => {
              i.classList.toggle('fas', idx < n);
              i.classList.toggle('far', idx >= n);
            });
          }

          /* Bind click de estrellas (con toggle para quitar) */
          (function bindStarsOnce() {
            const starsEl = document.getElementById('ratingStars');
            if (!starsEl) return;
            const inputEl = document.getElementById('ratingInput');

            starsEl.addEventListener('click', (e) => {
              const i = e.target.closest('.fa-star');
              if (!i) return;
              const val = Number(i.dataset.val || 0);
              // si clicas la misma, quita la nota (vac√≠o)
              if (Number(inputEl.value || 0) === val) {
                inputEl.value = '';
                paintStars(starsEl, 0);
              } else {
                inputEl.value = String(val);
                paintStars(starsEl, val);
              }
            });
          })();

          /* Modal B: Valorar/Comentar (por usuario) */
          window.openRateMedia = function (btn) {
            const card = getCardFromBtn(btn);
            if (!card) return;

            const modal = document.getElementById('editMediaModal');
            const idEl = document.getElementById('mediaId');
            const starsEl = document.getElementById('ratingStars');
            const inputEl = document.getElementById('ratingInput');
            const textEl = document.getElementById('mediaComment');
            const checkEl = document.getElementById('markWatched');
            const formEl = document.getElementById('editMediaForm');

            const id = card.dataset.id;
            const rawRating = card.dataset.ratingMe;                 // <- puede venir vac√≠o
            const myRating = rawRating ? Number(rawRating) : 0;     // n√∫mero para pintar estrellas
            const myCom = card.dataset.commentMe || '';
            const watched = card.dataset.watched === '1';

            idEl.value = id || '';
            inputEl.value = rawRating ? String(myRating) : '';     // <- VAC√çO si no hay nota
            textEl.value = myCom;
            checkEl.checked = watched;

            // usa el endpoint existente (no 404)
            formEl.action = "/media/watch";

            paintStars(starsEl, myRating);
            modal.style.display = 'block';
          };


          /* Modal A: Editar ficha (t√≠tulo, portada, enlace, plataformas, prioridad, notas) */
          window.openBasicEditMedia = function (btn) {
            const card = getCardFromBtn(btn);
            if (!card) return;

            const modal = document.getElementById('basicEditMediaModal');

            document.getElementById('basicMediaId').value = card.dataset.id || '';
            document.getElementById('basicTitle').value = card.dataset.title || '';
            document.getElementById('basicCover').value = card.dataset.cover || '';
            document.getElementById('basicLink').value = card.dataset.link || '';
            document.getElementById('basicNotes').value = card.dataset.notes || '';
            document.getElementById('basicPriority').value = card.dataset.priority || 'media';

            const plat = (card.dataset.platform || '').toLowerCase();
            document.getElementById('basicNetflix').checked = plat.includes('netflix') || plat.includes('both');
            document.getElementById('basicPrime').checked = plat.includes('prime') || plat.includes('both');

            modal.style.display = 'block';
          };
        </script>


        <!-- Viajes -->
        <div class="section animate-in delay-4">
          <h3>Nuestros Viajes</h3>
          <p>Lugares que hemos visitado y destinos que so√±amos conocer juntos.</p>

          <div class="travel-tabs" id="travel-tabs-container">
            <div class="travel-tab active" data-tab="visited">Lugares Visitados</div>
            <div class="travel-tab" data-tab="wishlist-travel">Quiero Ir</div>
            <div class="travel-tab" data-tab="add-travel">A√±adir Viaje</div>
          </div>

          <!-- Visitados -->
          <div class="travel-content active" id="visited-tab">
            <div class="travel-tools">
              <input type="search" id="visited-search" placeholder="Buscar destino/pa√≠s en visitados.">
              <button type="button" class="clear-btn" onclick="clearTravelSearch('visited')">Limpiar</button>
            </div>

            <div class="travels-grid" id="visited-grid">
              <!-- Se rellenar√° por JS con fetch /api/travels -->
              <p class="travel-loading-msg">Pulsa la pesta√±a de Viajes para cargar los destinos‚Ä¶</p>
            </div>
            <div class="pager" id="visited-pager"></div>
          </div>

          <!-- Quiero ir -->
          <div class="travel-content" id="wishlist-travel-tab">
            <div class="travel-tools">
              <input type="search" id="wishlist-search" placeholder="Buscar destino/pa√≠s en quiero ir.">
              <button type="button" class="clear-btn" onclick="clearTravelSearch('wishlist')">Limpiar</button>
            </div>

            <div class="travels-grid" id="wishlist-grid">
              <!-- Se rellenar√° por JS con fetch /api/travels -->
            </div>
            <div class="pager" id="wishlist-pager"></div>
          </div>

          <!-- A√±adir Viaje -->
          <!-- deja aqu√≠ EXACTO tu bloque actual de "add-travel-tab" tal cual lo tienes -->
          <div class="travel-content" id="add-travel-tab">
            <div class="travel-form">
              <h4>A√±adir nuevo viaje</h4>
              <form method="POST">
                <input type="text" name="travel_destination" placeholder="Destino" required>
                <textarea name="travel_description" placeholder="Descripci√≥n (opcional)" rows="3"></textarea>
                <input type="date" name="travel_date">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                  <input type="checkbox" id="travel_visited" name="travel_visited"
                    style="width: auto; margin-right: 10px;">
                  <label for="travel_visited">¬øYa lo hemos visitado?</label>
                </div>
                <button type="submit"><i class="fas fa-plus"></i> A√±adir viaje</button>
              </form>
            </div>
          </div>

          {% endif %}
        </div>
        <!-- TODO tu contenido actual aqu√≠ -->
      </div>

      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

      <script>

        if (!window.isSecureContext && location.hostname !== 'localhost') {
          document.getElementById('enablePushBtn')?.addEventListener('click', () => {
            showToast?.('error', 'Necesitas HTTPS para activar notificaciones');
          });
        }
        // =====================
        // TOASTS (Flash + helper)
        // =====================
        (function () {
          const msgs = {{ (flash_messages if flash_messages is defined else get_flashed_messages(with_categories = true)) | tojson | safe
        }};
        const wrap = document.getElementById('toasts');
        if (!wrap) return;

        function closeToast(el) {
          el.classList.add('closing');
          el.addEventListener('animationend', () => el.remove(), { once: true });
        }

        // B√°sico: showToast(tipo, texto, vidaMs?)
        window.showToast = function (category, text, lifeMs) {
          const type = (category || 'info');
          const life = Number.isFinite(lifeMs) ? lifeMs : 3500;

          // M√°x 4 visibles
          while (wrap.childElementCount >= 4) wrap.firstElementChild?.remove();

          const el = document.createElement('div');
          el.className = 'toast ' + type;
          el.style.setProperty('--life', `${life}ms`);
          el.setAttribute('role', 'status');
          el.setAttribute('aria-live', 'polite');
          el.innerHTML = `
      <div class="toast-content">
        <span class="icon" aria-hidden="true">
          <i class="fas ${type === 'success' ? 'fa-circle-check' : type === 'error' ? 'fa-triangle-exclamation' : 'fa-circle-info'}"></i>
        </span>
        <div class="text"></div>
        <button class="close" aria-label="Cerrar">&times;</button>
      </div>
      <div class="progress"></div>
    `;
          el.querySelector('.text').textContent = text || '';
          el.querySelector('.close').addEventListener('click', () => closeToast(el));

          wrap.appendChild(el);
          setTimeout(() => closeToast(el), life);
        };

        // Con bot√≥n de acci√≥n (opcional)
        window.showToastAction = function (category, text, actionLabel, onAction, lifeMs) {
          const type = (category || 'info');
          const life = Number.isFinite(lifeMs) ? lifeMs : 6000;

          const el = document.createElement('div');
          el.className = 'toast ' + type;
          el.style.setProperty('--life', `${life}ms`);
          el.setAttribute('role', 'alert');
          el.innerHTML = `
      <div class="toast-content">
        <span class="icon" aria-hidden="true">
          <i class="fas ${type === 'success' ? 'fa-circle-check' : type === 'error' ? 'fa-triangle-exclamation' : 'fa-circle-info'}"></i>
        </span>
        <div class="text">${text || ''}</div>
        <div class="actions">
          <button class="btn act">${actionLabel || 'Ver'}</button>
        </div>
        <button class="close" aria-label="Cerrar">&times;</button>
      </div>
      <div class="progress"></div>
    `;
          el.querySelector('.close').addEventListener('click', () => closeToast(el));
          el.querySelector('.act').addEventListener('click', () => {
            try { onAction && onAction(); } finally { closeToast(el); }
          });
          wrap.appendChild(el);
          setTimeout(() => closeToast(el), life);
        };

        // Renderiza los flash del backend
        if (Array.isArray(msgs)) {
          msgs.forEach(([cat, txt], i) => {
            setTimeout(() => window.showToast(cat, txt), i * 150);
          });
        }
}) ();

        // =====================
        // Corazones de fondo
        // =====================
        function createHearts() {
          const container = document.getElementById('hearts-container');
          if (!container) return;
          const heartCount = 15;
          for (let i = 0; i < heartCount; i++) {
            const heart = document.createElement('div');
            heart.classList.add('heart');
            heart.innerHTML = '‚ù§';
            heart.style.left = Math.random() * 100 + 'vw';
            heart.style.animationDelay = Math.random() * 5 + 's';
            heart.style.fontSize = (Math.random() * 15 + 15) + 'px';
            container.appendChild(heart);
          }
        }


        // =====================
        // Tabs: Wishlist & Viajes
        // =====================
        function setupTabs() {
          // Wishlist
          document.querySelectorAll('#wishlist-tabs-container .wishlist-tab').forEach(tab => {
            tab.addEventListener('click', () => {
              document.querySelectorAll('#wishlist-tabs-container .wishlist-tab').forEach(t => t.classList.remove('active'));
              document.querySelectorAll('.wishlist-content').forEach(c => c.classList.remove('active'));
              tab.classList.add('active');
              const tabId = tab.getAttribute('data-tab');
              const target = document.getElementById(`${tabId}-tab`);
              if (target) target.classList.add('active');
            });
          });




          // Travel
          document.querySelectorAll('#travel-tabs-container .travel-tab').forEach(tab => {
            tab.addEventListener('click', () => {
              document.querySelectorAll('#travel-tabs-container .travel-tab').forEach(t => t.classList.remove('active'));
              document.querySelectorAll('.travel-content').forEach(c => c.classList.remove('active'));
              tab.classList.add('active');
              const tabId = tab.getAttribute('data-tab');
              const target = document.getElementById(`${tabId}-tab`);
              if (target) target.classList.add('active');
            });
          });
        }


        // =====================
        // Modal gen√©rico
        // =====================
        (function setupModals() {
          document.addEventListener('click', (e) => {
            if (e.target.matches('.close-modal')) {
              document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            }
          });
          window.addEventListener('click', (event) => {
            document.querySelectorAll('.modal').forEach(modal => {
              if (event.target === modal) modal.style.display = 'none';
            });
          });
          const settingsIcon = document.getElementById('settingsIcon');
          const profileModal = document.getElementById('profileModal');
          if (settingsIcon && profileModal) {
            settingsIcon.addEventListener('click', () => { profileModal.style.display = 'block'; });
          }
        })();

        // Editor wishlist
        // Antes: window.openEditModal = function(id, name, link, notes, priority, is_gift)
        window.openEditModal = function (id, name, link, notes, priority, is_gift, size) {
          const modal = document.getElementById('editWishlistModal');
          if (!modal) return;
          const $ = (sel) => document.getElementById(sel);

          $('editItemId').value = id;
          $('editProductName').value = name || '';
          $('editProductLink').value = link || '';
          $('editNotes').value = notes || '';
          $('editPriority').value = priority || 'media';
          $('editIsGift').checked = !!is_gift;

          // NUEVO:
          const editSize = $('editSize');
          if (editSize) editSize.value = size || '';

          modal.style.display = 'block';
        };



        // =====================
        // Popover fotos (viajes)
        // =====================
        function togglePhotoMenu(key) {
          const id = 'photo-popover-' + key;
          const target = document.getElementById(id);
          if (!target) return;
          document.querySelectorAll('.photo-popover.open').forEach(p => { if (p.id !== id) p.classList.remove('open'); });
          target.classList.toggle('open');
          if (target.classList.contains('open')) {
            const input = target.querySelector('input[type="url"]');
            if (input) { setTimeout(() => input.focus(), 120); }
          }
        }
        window.togglePhotoMenu = togglePhotoMenu;

        function closePhotoMenuAfterSubmit(key) {
          const id = 'photo-popover-' + key;
          const target = document.getElementById(id);
          if (target) setTimeout(() => target.classList.remove('open'), 50);
        }
        window.closePhotoMenuAfterSubmit = closePhotoMenuAfterSubmit;

        document.addEventListener('click', (e) => {
          const openPop = document.querySelector('.photo-popover.open');
          if (!openPop) return;
          const isInsidePopover = openPop.contains(e.target);
          const isPlusBtn = e.target.closest('.icon-btn.plus');
          if (!isInsidePopover && !isPlusBtn) { openPop.classList.remove('open'); }
        });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { document.querySelectorAll('.photo-popover.open').forEach(p => p.classList.remove('open')); } });




        // =====================
        // Paginaci√≥n + Buscador (viajes) ‚Äì 6 por p√°gina
        // =====================
        function paginateGrid(gridEl, pagerEl, pageSize = 6) {
          if (!gridEl || !pagerEl) return { goToFirst() { }, refresh() { } };
          const allCards = Array.from(gridEl.querySelectorAll(':scope > .travel-card'));
          let emptyMsg = gridEl.querySelector('.no-results');
          if (!emptyMsg) {
            emptyMsg = document.createElement('p');
            emptyMsg.className = 'no-results';
            emptyMsg.textContent = 'Sin resultados.';
            emptyMsg.style.display = 'none';
            emptyMsg.style.gridColumn = '1/-1';
            gridEl.appendChild(emptyMsg);
          }
          let current = 1;
          function getMatched() { return allCards.filter(el => el.dataset.match !== '0'); }
          function hideAll() { allCards.forEach(el => { el.style.display = 'none'; }); }
          function makeBtn(label, onClick, opts = {}) {
            const b = document.createElement('button');
            b.textContent = label;
            b.className = 'page-btn' + (opts.active ? ' active' : '');
            if (opts.title) b.title = opts.title;
            if (opts.disabled) b.disabled = true;
            if (!opts.disabled && onClick) b.addEventListener('click', onClick);
            return b;
          }



          // --- Utils ---
          function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }
          function countGridColumns(gridEl) {
            const cs = getComputedStyle(gridEl);
            const cols = cs.gridTemplateColumns?.split(' ').filter(Boolean).length || 1;
            return cols;
          }

          // --- Paginaci√≥n que rellena filas completas en grids de media ---
          function setupMediaPagination(gridEl, pagerEl) {
            if (!gridEl || !pagerEl) return { refresh() { } };

            let current = 1;
            let pageSize = 9; // se recalcula
            let cards = Array.from(gridEl.querySelectorAll(':scope > .media-card'));


            // --- Inicializaci√≥n de paginadores de Media ---
            document.addEventListener('DOMContentLoaded', () => {
              const gToWatch = document.querySelector('#towatch-tab .media-grid');
              const pToWatch = document.getElementById('media-pager-towatch');
              const gWatched = document.querySelector('#watched-tab .media-grid');
              const pWatched = document.getElementById('media-pager-watched');

              // Crea los dos paginadores (si existen los nodos)
              window.mediaTowatchPager = gToWatch && pToWatch
                ? setupMediaPagination(gToWatch, pToWatch)
                : null;

              window.mediaWatchedPager = gWatched && pWatched
                ? setupMediaPagination(gWatched, pWatched)
                : null;

              // √ötil cuando filtras/ordenas/buscas
              window.refreshMediaPagination = function () {
                window.mediaTowatchPager?.refresh();
                window.mediaWatchedPager?.refresh();
              };
            });

            // calcula tama√±o de p√°gina en m√∫ltiplos de columnas (3 filas desktop, 2 m√≥vil/tablet)
            function computePageSize() {
              const cols = Math.max(1, countGridColumns(gridEl));
              const rows = (window.innerWidth >= 992) ? 3 : 2; // 3 filas desktop; 2 en m√≥vil/tablet
              pageSize = cols * rows;
            }




            function renderPager(totalPages) {
              pagerEl.innerHTML = '';
              const mk = (txt, on, opts = {}) => {
                const b = document.createElement('button');
                b.textContent = txt;
                b.className = 'page-btn' + (opts.active ? ' active' : '');
                if (opts.title) b.title = opts.title;
                if (opts.disabled) { b.disabled = true; return b; }
                b.addEventListener('click', on); return b;
              };
              pagerEl.appendChild(mk('¬´', () => { current = 1; render(); }, { disabled: current === 1, title: 'Primera' }));
              pagerEl.appendChild(mk('‚Äπ', () => { current = Math.max(1, current - 1); render(); }, { disabled: current === 1, title: 'Anterior' }));
              const windowSize = 5;
              let from = Math.max(1, current - Math.floor(windowSize / 2));
              let to = Math.min(totalPages, from + windowSize - 1);
              from = Math.max(1, to - windowSize + 1);
              for (let p = from; p <= to; p++) {
                pagerEl.appendChild(mk(String(p), () => { current = p; render(); }, { active: p === current }));
              }
              pagerEl.appendChild(mk('‚Ä∫', () => { current = Math.min(totalPages, current + 1); render(); }, { disabled: current === totalPages, title: 'Siguiente' }));
              pagerEl.appendChild(mk('¬ª', () => { current = totalPages; render(); }, { disabled: current === totalPages, title: '√öltima' }));
            }

            function render() {
              computePageSize(); // <- clave: siempre m√∫ltiplo de columnas
              const total = cards.length;
              const totalPages = Math.max(1, Math.ceil(total / pageSize));
              if (current > totalPages) current = totalPages;

              // Mostrar solo los de la p√°gina actual
              const start = (current - 1) * pageSize, end = current * pageSize;
              cards.forEach((el, i) => { el.style.display = (i >= start && i < end) ? '' : 'none'; });

              // Pager visible solo si hace falta
              if (totalPages <= 1) { pagerEl.style.display = 'none'; pagerEl.innerHTML = ''; }
              else { pagerEl.style.display = 'flex'; renderPager(totalPages); }
            }

            // Recalcular al redimensionar (cambian columnas -> cambia pageSize)
            const onResize = debounce(() => {
              const old = pageSize;
              computePageSize();
              if (pageSize !== old) render();
            }, 120);
            window.addEventListener('resize', onResize);

            // API para recontar si a√±ades/elimin√°s cartas din√°micamente
            function refresh() {
              cards = Array.from(gridEl.querySelectorAll(':scope > .media-card'));
              render();
            }

            render();
            return { refresh };
          }


          function renderPager(totalPages) {
            pagerEl.innerHTML = '';
            pagerEl.appendChild(makeBtn('¬´', () => { current = 1; renderPage(); }, { disabled: current === 1, title: 'Primera' }));
            pagerEl.appendChild(makeBtn('‚Äπ', () => { current = Math.max(1, current - 1); renderPage(); }, { disabled: current === 1, title: 'Anterior' }));
            const windowSize = 5;
            let from = Math.max(1, current - Math.floor(windowSize / 2));
            let to = Math.min(totalPages, from + windowSize - 1);
            from = Math.max(1, to - windowSize + 1);
            for (let p = from; p <= to; p++) {
              pagerEl.appendChild(makeBtn(String(p), () => { current = p; renderPage(); }, { active: p === current }));
            }
            pagerEl.appendChild(makeBtn('‚Ä∫', () => { current = Math.min(totalPages, current + 1); renderPage(); }, { disabled: current === totalPages, title: 'Siguiente' }));
            pagerEl.appendChild(makeBtn('¬ª', () => { current = totalPages; renderPage(); }, { disabled: current === totalPages, title: '√öltima' }));
          }
          function renderPage() {
            const matched = getMatched();
            const total = matched.length;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            if (current > totalPages) current = totalPages;
            if (total === 0) {
              hideAll(); emptyMsg.style.display = ''; pagerEl.style.display = 'none'; pagerEl.innerHTML = ''; return;
            } else { emptyMsg.style.display = 'none'; }
            if (totalPages <= 1) {
              pagerEl.style.display = 'none'; pagerEl.innerHTML = '';
              hideAll(); matched.forEach(el => { el.style.display = ''; });
              return;
            }
            pagerEl.style.display = 'flex';
            const start = (current - 1) * pageSize;
            const end = start + pageSize;
            hideAll();
            matched.forEach((el, i) => { el.style.display = (i >= start && i < end) ? '' : 'none'; });
            renderPager(totalPages);
          }
          renderPage();
          return { goToFirst: () => { current = 1; renderPage(); }, refresh: () => renderPage() };
        }
        let visitedPagerAPI = null;
        let wishlistPagerAPI = null;

        function setupTravelPagination() {
          const visitedGrid = document.querySelector('#visited-tab .travels-grid');
          const visitedPager = document.getElementById('visited-pager');
          const wishlistGrid = document.querySelector('#wishlist-travel-tab .travels-grid');
          const wishlistPager = document.getElementById('wishlist-pager');
          visitedPagerAPI = paginateGrid(visitedGrid, visitedPager, 6);
          wishlistPagerAPI = paginateGrid(wishlistGrid, wishlistPager, 6);
        }

        function setupTravelSearch(scopeId, inputId, pagerAPI) {
          const grid = document.querySelector(`#${scopeId} .travels-grid`);
          const input = document.getElementById(inputId);
          if (!grid || !input) return;

          const cards = Array.from(grid.querySelectorAll(':scope > .travel-card'));
          function applyFilter(termRaw) {
            const term = (termRaw || '').trim().toLowerCase();
            cards.forEach(card => {
              const dest = (card.querySelector('.travel-destination')?.textContent || '').toLowerCase();
              const desc = (card.querySelector('.travel-description')?.textContent || '').toLowerCase();
              const date = (card.querySelector('.travel-date')?.textContent || '').toLowerCase();
              const match = term === '' || dest.includes(term) || desc.includes(term) || date.includes(term);
              card.dataset.match = match ? '1' : '0';
            });
            pagerAPI?.goToFirst?.();
            pagerAPI?.refresh?.();
          }
          input.addEventListener('input', () => applyFilter(input.value));
          applyFilter(input.value);
        }
        function clearTravelSearch(which) {
          if (which === 'visited') {
            const i = document.getElementById('visited-search');
            if (i) { i.value = ''; setupTravelSearch('visited-tab', 'visited-search', visitedPagerAPI); }
          }
          if (which === 'wishlist') {
            const i = document.getElementById('wishlist-search');
            if (i) { i.value = ''; setupTravelSearch('wishlist-travel-tab', 'wishlist-search', wishlistPagerAPI); }
          }
        }


        // ==== Viajes: lazy load con fetch /api/travels ====
        (function () {
          let loaded = false;
          let loading = false;

          async function loadTravels() {
            if (loaded || loading) return;
            loading = true;

            const visitedGrid = document.getElementById('visited-grid');
            const wishlistGrid = document.getElementById('wishlist-grid');
            if (!visitedGrid || !wishlistGrid) {
              loading = false;
              return;
            }

            visitedGrid.innerHTML = '<p class="travel-loading-msg">Cargando viajes‚Ä¶</p>';
            wishlistGrid.innerHTML = '';

            try {
              const resp = await fetch('/api/travels', {
                headers: { 'Accept': 'application/json' }
              });

              if (!resp.ok) {
                throw new Error('HTTP ' + resp.status);
              }

              const data = await resp.json();
              if (!data.ok) {
                throw new Error(data.error || 'Respuesta no OK');
              }

              const travels = data.travels || [];
              const photosById = data.photos || {};

              // Crea una tarjeta igual de ‚Äúbonita‚Äù que las tuyas, pero en JS
              function createCard(travel) {
                const id = travel.id;
                const destination = travel.destination || '';
                const description = travel.description || '';
                const travel_date = travel.travel_date || '';
                const created_by = travel.created_by || '';
                const created_at = (travel.created_at || '').slice(0, 10);
                const isVisited = !!travel.is_visited;
                const photos = photosById[id] || [];

                const card = document.createElement('div');
                card.className = 'travel-card ' + (isVisited ? 'visited' : 'wishlist');
                card.dataset.id = id;

                // COVER
                const cover = document.createElement('div');
                cover.className = 'travel-cover';

                if (photos.length) {
                  const phWrap = document.createElement('div');
                  phWrap.className = 'travel-photos';
                  photos.forEach(p => {
                    const img = document.createElement('img');
                    img.src = p.image_url;
                    img.alt = destination;
                    img.style.maxWidth = '100%';
                    img.style.borderRadius = '10px';
                    img.style.margin = '5px 0';
                    phWrap.appendChild(img);
                  });
                  cover.appendChild(phWrap);
                } else {
                  const empty = document.createElement('div');
                  empty.className = 'empty-album';
                  empty.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
                  cover.appendChild(empty);
                }

                const status = document.createElement('div');
                status.className = 'travel-status ' + (isVisited ? 'status-visited' : 'status-wishlist');
                status.textContent = isVisited ? 'Visitado' : 'Deseado';
                cover.appendChild(status);
                card.appendChild(cover);

                // INFO
                const info = document.createElement('div');
                info.className = 'travel-info';

                const h3 = document.createElement('h3');
                h3.className = 'travel-destination';
                h3.textContent = destination;
                info.appendChild(h3);

                if (travel_date) {
                  const p = document.createElement('p');
                  p.className = 'travel-date';
                  p.textContent = travel_date;
                  info.appendChild(p);
                }

                if (description) {
                  const p = document.createElement('p');
                  p.className = 'travel-description';
                  p.textContent = description;
                  info.appendChild(p);
                }

                const meta = document.createElement('div');
                meta.className = 'travel-meta';
                const inicial = (created_by || '?').trim().charAt(0).toUpperCase() || '?';
                meta.innerHTML = `
          <span>
            <div class="avatar-circle small">${inicial}</div>
            Creado por ${created_by || '‚Äî'}
          </span>
          <span>${created_at}</span>
        `;
                info.appendChild(meta);

                // ACCIONES (usar tus endpoints actuales)
                const actions = document.createElement('div');
                actions.className = 'travel-actions';

                // Cambiar visitado / quiero ir
                const formToggle = document.createElement('form');
                formToggle.method = 'POST';
                formToggle.action = '/toggle_travel_status';
                formToggle.innerHTML = `
          <input type="hidden" name="travel_id" value="${id}">
          <button type="submit" class="icon-btn" title="Cambiar estado">
            <i class="fas fa-exchange-alt"></i>
          </button>
        `;
                actions.appendChild(formToggle);

                // Eliminar viaje
                const formDelete = document.createElement('form');
                formDelete.method = 'POST';
                formDelete.action = '/delete_travel';
                formDelete.onsubmit = function () {
                  return confirm('¬øEst√°s seguro de que quieres eliminar este viaje?');
                };
                formDelete.innerHTML = `
          <input type="hidden" name="travel_id" value="${id}">
          <button type="submit" class="icon-btn" title="Eliminar viaje">
            <i class="fas fa-trash"></i>
          </button>
        `;
                actions.appendChild(formDelete);

                info.appendChild(actions);
                card.appendChild(info);

                return card;
              }

              // Rellenar grids
              visitedGrid.innerHTML = '';
              wishlistGrid.innerHTML = '';

              travels.forEach(t => {
                const card = createCard(t);
                if (t.is_visited) {
                  visitedGrid.appendChild(card);
                } else {
                  wishlistGrid.appendChild(card);
                }
              });

              // Re-crear paginaci√≥n y buscador con tu c√≥digo actual
              if (typeof setupTravelPagination === 'function') {
                setupTravelPagination();
              }
              if (typeof setupTravelSearch === 'function') {
                setupTravelSearch('visited-tab', 'visited-search', window.visitedPagerAPI);
                setupTravelSearch('wishlist-travel-tab', 'wishlist-search', window.wishlistPagerAPI);
              }

              loaded = true;
            } catch (e) {
              console.error('[travels] error cargando viajes', e);
              visitedGrid.innerHTML = '<p class="travel-loading-msg">No se pudieron cargar los viajes. Int√©ntalo de nuevo m√°s tarde.</p>';
            } finally {
              loading = false;
            }
          }

          // Exponer para el router
          window.ensureTravelsLoaded = loadTravels;
        })();



        // ==== Intimidad: lazy load desde /api/intimidad ====
        (function () {
          let loaded = false;
          let loading = false;

          function pluralDias(n) {
            return (n === 1) ? "d√≠a" : "d√≠as";
          }

          async function loadIntim() {
            if (loaded || loading) return;
            loading = true;

            const kpisEl = document.getElementById('intim-kpis');
            const statsEl = document.getElementById('intim-stats');
            const eventsEl = document.getElementById('intim-events-list');

            if (!kpisEl || !statsEl || !eventsEl) {
              loading = false;
              return;
            }

            kpisEl.innerHTML = '<p class="intim-loading-msg" style="color:#888; margin:10px 0;">Cargando estad√≠sticas‚Ä¶</p>';
            statsEl.innerHTML = '';
            eventsEl.innerHTML = '';

            try {
              const resp = await fetch('/api/intimidad', {
                headers: { 'Accept': 'application/json' }
              });
              if (!resp.ok) {
                throw new Error('HTTP ' + resp.status);
              }
              const data = await resp.json();
              if (!data.ok) {
                throw new Error(data.error || 'Respuesta no OK');
              }

              if (!data.unlocked) {
                kpisEl.innerHTML = '<p style="color:#888;">El m√≥dulo est√° bloqueado. Recarga la p√°gina si acabas de introducir el PIN.</p>';
                return;
              }

              const s = data.stats || {};
              const ev = data.events || [];

              // --- KPIs: Hoy / Mes / A√±o ---
              kpisEl.innerHTML = '';
              const kpiNames = [
                { key: 'today_count', label: 'Hoy' },
                { key: 'month_total', label: 'Este mes' },
                { key: 'year_total', label: 'Este a√±o' }
              ];
              kpiNames.forEach(k => {
                const div = document.createElement('div');
                div.className = 'kpi';
                const h4 = document.createElement('h4');
                h4.textContent = k.label;
                const p = document.createElement('p');
                p.textContent = s[k.key] ?? 0;
                div.appendChild(h4);
                div.appendChild(p);
                kpisEl.appendChild(div);
              });

              // --- Stats: √∫ltima vez / racha / d√≠as sin ---
              statsEl.innerHTML = '';

              // √öltima vez
              const cardLast = document.createElement('div');
              cardLast.className = 'intim-card';
              cardLast.innerHTML = '<b>√öltima vez</b><br>';
              if (s.last_dt) {
                const span = document.createElement('span');
                const days = s.days_since_last;
                const info = (typeof days === 'number')
                  ? `Hace ${days} ${pluralDias(days)}`
                  : '';
                span.textContent = s.last_dt + (info ? ` (${info})` : '');
                cardLast.appendChild(span);
              } else {
                cardLast.appendChild(document.createTextNode('A√∫n no hay registros.'));
              }
              statsEl.appendChild(cardLast);

              // Racha actual
              const cardStreak = document.createElement('div');
              cardStreak.className = 'intim-card';
              cardStreak.innerHTML = '<b>Racha actual (d√≠as seguidos con intimidad)</b><br>';
              const streak = s.streak_days ?? 0;
              cardStreak.appendChild(
                document.createTextNode(`${streak} ${pluralDias(streak)}`)
              );
              statsEl.appendChild(cardStreak);

              // D√≠as sin üëâüëå
              const cardNo = document.createElement('div');
              cardNo.className = 'intim-card';
              cardNo.innerHTML = '<b>D√≠as sin üëâüëå</b><br>';
              if (typeof s.days_since_last === 'number') {
                const d = s.days_since_last;
                cardNo.appendChild(
                  document.createTextNode(`${d} ${pluralDias(d)}`)
                );
              } else {
                cardNo.appendChild(document.createTextNode('‚Äî'));
              }
              statsEl.appendChild(cardNo);

              // --- Eventos ---
              if (!ev.length) {
                eventsEl.innerHTML = '<p style="text-align:center; color:#888; padding:20px;">A√∫n no hay eventos registrados.</p>';
              } else {
                ev.forEach(e => {
                  eventsEl.appendChild(createIntimEventCard(e));
                });
              }

              loaded = true;
            } catch (err) {
              console.error('[intimidad] error', err);
              kpisEl.innerHTML = '<p style="color:#c00;">No se pudieron cargar las estad√≠sticas de intimidad.</p>';
              eventsEl.innerHTML = '<p style="text-align:center; color:#888; padding:20px;">Int√©ntalo de nuevo m√°s tarde.</p>';
            } finally {
              loading = false;
            }
          }

          function createIntimEventCard(ev) {
            const card = document.createElement('div');
            card.className = 'intim-event-card';
            card.style.background = '#fff';
            card.style.borderRadius = '14px';
            card.style.padding = '14px';
            card.style.boxShadow = '0 4px 10px rgba(0,0,0,.08)';
            card.style.borderLeft = '4px solid var(--accent-color)';

            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.justifyContent = 'space-between';
            row.style.alignItems = 'flex-start';
            row.style.gap = '12px';

            const left = document.createElement('div');
            left.style.flex = '1';

            // Cabecera usuario + fecha
            const head = document.createElement('div');
            head.style.display = 'flex';
            head.style.alignItems = 'center';
            head.style.gap = '8px';
            head.style.marginBottom = '8px';

            const avatar = document.createElement('div');
            avatar.className = 'user-avatar';
            avatar.style.width = '32px';
            avatar.style.height = '32px';
            avatar.style.display = 'flex';
            avatar.style.alignItems = 'center';
            avatar.style.justifyContent = 'center';
            avatar.style.overflow = 'hidden';

            if (ev.avatar_url) {
              const img = document.createElement('img');
              img.src = ev.avatar_url;
              img.alt = ev.username || '';
              img.style.width = '100%';
              img.style.height = '100%';
              img.style.objectFit = 'cover';
              avatar.appendChild(img);
            } else {
              avatar.textContent = (ev.username || '?').charAt(0).toUpperCase();
            }


            const nameEl = document.createElement('strong');
            nameEl.style.color = 'var(--primary-color)';
            nameEl.textContent = ev.username || '‚Äî';

            const tsEl = document.createElement('small');
            tsEl.style.color = '#888';
            tsEl.style.marginLeft = 'auto';
            tsEl.textContent = (ev.ts || '').slice(0, 16);

            head.appendChild(avatar);
            head.appendChild(nameEl);
            head.appendChild(tsEl);

            left.appendChild(head);

            // Lugar
            if (ev.place) {
              const placeEl = document.createElement('div');
              placeEl.style.marginBottom = '6px';
              const b = document.createElement('strong');
              b.textContent = 'Lugar:';
              placeEl.appendChild(b);
              placeEl.appendChild(document.createTextNode(' ' + ev.place));
              left.appendChild(placeEl);
            }

            // Notas
            if (ev.notes) {
              const notesWrap = document.createElement('div');
              notesWrap.style.background = '#f8f9fa';
              notesWrap.style.padding = '10px';
              notesWrap.style.borderRadius = '8px';
              notesWrap.style.marginTop = '8px';

              const b = document.createElement('strong');
              b.textContent = 'Notas:';
              const span = document.createElement('span');
              span.style.whiteSpace = 'pre-wrap';
              span.style.marginLeft = '4px';
              span.textContent = ev.notes;

              notesWrap.appendChild(b);
              notesWrap.appendChild(span);
              left.appendChild(notesWrap);
            }

            row.appendChild(left);

            // Acciones (editar / borrar)
            const actions = document.createElement('div');
            actions.className = 'event-actions';
            actions.style.display = 'flex';
            actions.style.flexDirection = 'column';
            actions.style.gap = '6px';

            const btnEdit = document.createElement('button');
            btnEdit.type = 'button';
            btnEdit.className = 'icon-btn';
            btnEdit.title = 'Editar evento';
            btnEdit.innerHTML = '<i class="fas fa-edit"></i>';
            btnEdit.addEventListener('click', () => {
              if (window.openEditIntimModal) {
                window.openEditIntimModal(ev.id, ev.place || '', ev.notes || '');
              }
            });
            actions.appendChild(btnEdit);

            const formDelete = document.createElement('form');
            formDelete.method = 'POST';
            formDelete.action = '/delete_intim_event';
            formDelete.onsubmit = function () {
              return confirm('¬øEst√°s seguro de que quieres eliminar este evento?');
            };
            formDelete.innerHTML = `
      <input type="hidden" name="event_id" value="${ev.id}">
      <button type="submit" class="icon-btn" title="Eliminar evento">
        <i class="fas fa-trash"></i>
      </button>
    `;
            actions.appendChild(formDelete);

            row.appendChild(actions);
            card.appendChild(row);

            return card;
          }

          // Exponer para el router
          window.ensureIntimLoaded = loadIntim;
        })();



        // =====================
        // DOMContentLoaded
        // =====================
        document.addEventListener('DOMContentLoaded', function () {
          createHearts();
          setupTabs();
          initMap();
          setupLocationForm();
          setupUseMyLocation(); // <-- activa el bot√≥n de ubicaci√≥n real
          setupTravelPagination();
          startDailyQuestionCountdown();
          setupTravelSearch('visited-tab', 'visited-search', visitedPagerAPI);
          setupTravelSearch('wishlist-travel-tab', 'wishlist-search', wishlistPagerAPI);

          document.querySelectorAll('.section, .banner').forEach((el, index) => {
            el.classList.add('animate-in');
            el.classList.add(`delay-${index % 5}`);
          });

          document.querySelectorAll('input[type="file"]').forEach(input => {
            input.addEventListener('change', function () {
              const label = this.previousElementSibling;
              if (label && this.files.length > 0) {
                const icon = label.querySelector('i');
                if (icon) icon.className = 'fas fa-check';
              }
            });
          });
        });


        // Funci√≥n para abrir modal de edici√≥n de evento de intimidad
        window.openEditIntimModal = function (eventId, place, notes) {
          const modal = document.getElementById('editIntimModal');
          if (!modal) return;

          // Asegura que siempre hay inputs
          const idEl = document.getElementById('editEventId');
          const placeEl = document.getElementById('editIntimPlace');
          const notesEl = document.getElementById('editIntimNotes');

          // Normaliza valores
          const safeId = (eventId ?? '').toString();
          const safePlace = (place ?? '');
          const safeNotes = (notes ?? '');

          idEl.value = safeId;
          placeEl.value = safePlace;
          notesEl.value = safeNotes;

          // Mini validaci√≥n visual por si el id no llegara
          if (!safeId) {
            alert('No se pudo cargar el ID del evento. Recarga la p√°gina e int√©ntalo de nuevo.');
            return;
          }

          modal.style.display = 'block';
        };

        (function () {
          const TZ = 'Europe/Madrid';

          // Hora "ahora" en la zona horaria dada (mantiene coherencia incluso con cambios DST)
          function nowInTz(tz) {
            // Truco: convertimos a string en esa TZ y lo volvemos a Date;
            // as√≠ los componentes reflejan el reloj de la TZ.
            return new Date(new Date().toLocaleString('en-US', { timeZone: tz }));
          }

          // Milisegundos hasta la pr√≥xima medianoche en esa TZ
          function msUntilNextMidnightTz(tz) {
            const now = nowInTz(tz);
            const next = new Date(now);
            // 24:00 del "hoy" de la TZ => pr√≥xima medianoche de esa TZ
            next.setHours(24, 0, 0, 0);
            return next - now;
          }

          function formatHMS(ms) {
            if (ms < 0) ms = 0;
            const totalSec = Math.floor(ms / 1000);
            const h = String(Math.floor(totalSec / 3600)).padStart(2, '0');
            const m = String(Math.floor((totalSec % 3600) / 60)).padStart(2, '0');
            const s = String(totalSec % 60).padStart(2, '0');
            return `${h}:${m}:${s}`;
          }

          window.startDailyQuestionCountdown = function () {
            const el = document.getElementById('dqTimer');
            if (!el) return;

            function tick() {
              const ms = msUntilNextMidnightTz(TZ);
              // Si lleg√≥ la medianoche en Espa√±a, refresca para cargar la nueva pregunta
              if (ms <= 0) {
                el.textContent = '00:00:00';
                // Peque√±o delay para evitar bucles
                setTimeout(() => location.reload(), 800);
                return;
              }
              el.textContent = formatHMS(ms);
            }

            tick(); // primer pintado inmediato
            setInterval(tick, 1000);
          };
        })();

        // === Login UX helpers ===
        (function () {
          const form = document.getElementById('loginForm');
          const userEl = document.getElementById('username');
          const passEl = document.getElementById('password');
          const capsEl = document.getElementById('capsHint');
          const toggle = document.querySelector('.toggle-pass');
          const btn = document.getElementById('loginBtn');
          const rememberEl = document.getElementById('rememberMe');

          // Autocompletar usuario recordado
          try {
            const savedU = localStorage.getItem('cc_username');
            if (savedU) {
              userEl.value = savedU;
              rememberEl.checked = true;
              passEl.focus();
            }
          } catch { }

          // Mostrar/Ocultar contrase√±a
          toggle?.addEventListener('click', () => {
            const isPwd = passEl.type === 'password';
            passEl.type = isPwd ? 'text' : 'password';
            toggle.innerHTML = `<i class="fas ${isPwd ? 'fa-eye-slash' : 'fa-eye'}"></i>`;
            passEl.focus();
          });

          // Aviso de Bloq May√∫s
          ['keydown', 'keyup'].forEach(ev => {
            passEl.addEventListener(ev, (e) => {
              const on = e.getModifierState && e.getModifierState('CapsLock');
              if (on) { capsEl.style.display = ''; } else { capsEl.style.display = 'none'; }
            });
          });

          // Bot√≥n con "loading" + recordar usuario
          form?.addEventListener('submit', () => {
            btn.classList.add('btn-loading');
            // recuerda el usuario si el checkbox est√° marcado
            try {
              if (rememberEl.checked && userEl.value.trim()) {
                localStorage.setItem('cc_username', userEl.value.trim());
                // cookie 'remember' para que el backend pueda leerlo si quiere
                document.cookie = "remember=1; max-age=" + (60 * 60 * 24 * 30) + "; path=/; SameSite=Lax";
              } else {
                localStorage.removeItem('cc_username');
                document.cookie = "remember=; Max-Age=0; path=/";
              }
            } catch { }
          });
        })();


        // Extra: si tienes CSP que bloquea inline styles, este helper asegura visibilidad
        (function ensureModalCSS() {
          const modal = document.getElementById('editIntimModal');
          if (!modal) return;
          // Si tu .modal usa display:none por defecto, luego lo abrimos con 'block'
          // Aseg√∫rate que ning√∫n otro CSS lo tape:
          modal.style.zIndex = 1000; // ya lo tra√≠as, refuerzo por si acaso
        })();


        // abre/cierra el formulario de edici√≥n de TU respuesta
        function toggleEdit(key) {
          const form = document.getElementById('ans-form-' + key);
          if (!form) return false;
          form.style.display = (form.style.display === 'none' || !form.style.display) ? 'block' : 'none';
          if (form.style.display === 'block') {
            const input = form.querySelector('input[name="answer"]');
            if (input) setTimeout(() => input.focus(), 50);
          }
          return false; // evita el salto del enlace
        }
        window.toggleEdit = toggleEdit;


        /* SSE ‚Äúdrop-in‚Äù compatible con tu HTML antiguo.
           - No depende de IDs concretos.
           - Si el navegador no soporta SSE, no pasa nada.
           - Ante un evento, recarga para reflejar cambios (r√°pido y robusto).
        */
        (function () {
          if (!('EventSource' in window)) return;

          var es = new EventSource('/events');  // endpoint SSE del backend
          // Mantener viva la conexi√≥n:
          es.addEventListener('ping', function () { /* noop */ });

          // Cualquier cambio relevante dispara una recarga ligera
          es.addEventListener('update', function (e) {
            try {
              var data = JSON.parse(e.data || '{}');
              // Puedes filtrar si quieres, pero recargar es lo m√°s s√≥lido sin tocar HTML
              if (['question', 'answer', 'wishlist', 'travel', 'intim', 'banner', 'profile', 'schedules', 'locations', 'couple_mode'].includes(data.kind)) {
                // Espera un micro-tick por si llegan varios eventos seguidos
                setTimeout(function () { location.reload(); }, 80);
              }
            } catch (_) {
              // En caso de payload raro, recarga tambi√©n
              setTimeout(function () { location.reload(); }, 120);
            }
          });

          es.onerror = function () {
            // Deja que el navegador reintente solo; no cierres la conexi√≥n
          };
        })();

        // === Web Push ===
        async function setupPush() {
          try {
            if (!("serviceWorker" in navigator) || !("PushManager" in window)) {
              console.warn("Push no soportado en este navegador");
              return;
            }

            // 1) registra el SW
            const reg = await navigator.serviceWorker.register("/sw.js");

            // 2) permiso de notificaciones
            let perm = Notification.permission;
            if (perm === "default") perm = await Notification.requestPermission();
            if (perm !== "granted") {
              console.warn("Permiso de notificaciones denegado");
              return;
            }

            // 3) VAPID p√∫blica desde el backend
            const r = await fetch("/push/vapid-public");
            const data = await r.json();
            const key = data.vapidPublicKey || data.key; // admite ambos por si acaso
            if (!key) { console.warn("VAPID p√∫blica no configurada"); return; }


            // 4) suscripci√≥n (o reutiliza la existente)
            const appServerKey = urlBase64ToUint8Array(key);
            let sub = await reg.pushManager.getSubscription();
            if (!sub) {
              sub = await reg.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: appServerKey
              });
            }

            // 5) env√≠a la suscripci√≥n al servidor
            await fetch("/push/subscribe", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(sub)
            });

            window.showToast?.("success", "Notificaciones activadas en este dispositivo ‚úÖ");
          } catch (e) {
            console.error("setupPush error:", e);
            window.showToast?.("error", "No se pudieron activar las notificaciones");
          }
        }

        // --- Helper: NO async ---
        function urlBase64ToUint8Array(base64String) {
          const padding = '='.repeat((4 - base64String.length % 4) % 4);
          const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
          const raw = atob(base64);
          const out = new Uint8Array(raw.length);
          for (let i = 0; i < raw.length; ++i) out[i] = raw.charCodeAt(i);
          return out;
        }
        // Registra SIEMPRE el SW al cargar
        (async function registerSWOnLoad() {
          if (!('serviceWorker' in navigator)) return;
          try {
            // OJO: ra√≠z, no /static
            const reg = await navigator.serviceWorker.register("/sw.js");

            // Espera a que est√© listo
            await navigator.serviceWorker.ready;
            console.log('[SW] listo', reg.scope);
          } catch (err) {
            console.error('[SW] registro fall√≥', err);
            window.showToast?.('error', 'No se pudo registrar el Service Worker');
          }
        })();

        async function enablePush() {
          try {
            // Checks b√°sicos
            if (!('Notification' in window)) { showToast?.('error', 'Este navegador no soporta notificaciones'); return; }
            if (!('serviceWorker' in navigator)) { showToast?.('error', 'Service Worker no soportado'); return; }
            if (!('PushManager' in window)) { showToast?.('error', 'Push no soportado'); return; }

            // Asegura que el SW est√© registrado (por si el registro inicial fall√≥)
            let reg = await navigator.serviceWorker.getRegistration('/');
            if (!reg) {
              try {
                // ‚úÖ Corr√≠gelo
                reg = await navigator.serviceWorker.register("/sw.js");

              } catch (e) {
                console.error('Registro SW fall√≥:', e);
                showToast?.('error', 'No se pudo registrar el Service Worker');
                return;
              }
            }
            reg = await navigator.serviceWorker.ready;

            // Pide permiso
            let perm = Notification.permission;
            if (perm === 'default') perm = await Notification.requestPermission();
            if (perm !== 'granted') { showToast?.('error', 'Permiso de notificaciones denegado'); return; }

            // VAPID p√∫blica
            const r = await fetch('/push/vapid-public');
            if (!r.ok) { showToast?.('error', '/push/vapid-public devolvi√≥ error'); return; }
            const data = await r.json().catch(() => ({}));
            const vapidPublicKey = data.vapidPublicKey || data.key;
            if (!vapidPublicKey) { showToast?.('error', 'VAPID p√∫blica vac√≠a'); return; }

            // Suscripci√≥n (reutiliza si existe)
            let sub = await reg.pushManager.getSubscription();
            if (!sub) {
              sub = await reg.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
              });
            }

            // Enviar al servidor
            const rr = await fetch('/push/subscribe', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(sub)
            });
            if (!rr.ok) { showToast?.('error', 'No se pudo guardar la suscripci√≥n'); return; }

            showToast?.('success', 'Notificaciones activadas ‚úÖ');
            document.getElementById('enablePushBtn')?.remove();
          } catch (e) {
            console.error('enablePush error:', e);
            showToast?.('error', 'Fallo al activar notificaciones (mira consola)');
          }
        }

        // Bot√≥n
        document.getElementById('enablePushBtn')?.addEventListener('click', enablePush);



        (async function setupPush() {
          const btn = document.getElementById('enablePushBtn');
          if (!btn) return;

          // iOS: guiar al usuario si no est√° instalada como app
          const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

          btn.addEventListener('click', async () => {
            try {
              if (!window.isSecureContext && location.hostname !== 'localhost') {
                showToast?.('error', 'Necesitas HTTPS para activar notificaciones'); return;
              }
              if (isIOS && !isStandalone) {
                showToast?.('info', 'En iPhone, primero A√±ade la web a la pantalla de inicio y √°brela desde ah√≠ para activar notificaciones.');
                // En iOS, el prompt solo aparece en la PWA instalada.
                // Contin√∫o igualmente para otros navegadores.
              }

              // 1) Registrar Service Worker
              if (!('serviceWorker' in navigator)) {
                showToast?.('error', 'Tu navegador no soporta Service Workers'); return;
              }
              const reg = await navigator.serviceWorker.register('/sw.js');
              await navigator.serviceWorker.ready;

              // 2) Pedir permiso (tiene que venir de este gesto de bot√≥n)
              const perm = await Notification.requestPermission();
              if (perm !== 'granted') {
                showToast?.('error', 'Has denegado el permiso de notificaciones'); return;
              }

              // 3) Obtener VAPID public key (base64url)
              const r = await fetch('/push/vapid-public');
              const j = await r.json();
              if (!j.vapidPublicKey) {
                showToast?.('error', 'No se pudo obtener la clave p√∫blica VAPID'); return;
              }

              // 4) Convertir base64url -> Uint8Array
              const appServerKey = (function b64urlToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const b64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
                const raw = atob(b64);
                const arr = new Uint8Array(raw.length);
                for (let i = 0; i < raw.length; i++) arr[i] = raw.charCodeAt(i);
                return arr;
              })(j.vapidPublicKey);

              // 5) Suscribirse
              const sub = await reg.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: appServerKey
              });

              // 6) Enviar la suscripci√≥n a tu backend
              const res = await fetch('/push/subscribe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(sub)
              });
              const ok = (await res.json()).ok;
              if (ok) {
                showToast?.('success', '¬°Notificaciones activadas!');
              } else {
                showToast?.('error', 'No se pudo guardar la suscripci√≥n');
              }
            } catch (e) {
              console.error(e);
              showToast?.('error', 'Error activando notificaciones');
            }
          });
        })();

        // ======== PRESENCIA (frontend robusto) ========
        (function () {
          const chip = document.getElementById('presenceChip');
          const dotEl = document.getElementById('presenceDot');
          const textEl = document.getElementById('presenceText');
          if (!chip || !dotEl || !textEl) return;

          const ME = {{ (session.username or '') | tojson
        }};
        // Deriva OTHER si no viene bien del template
        let OTHER = {{ (other_user if other_user is defined else '') | tojson }};
        if (!OTHER) OTHER = (ME === 'mochito') ? 'mochita' : 'mochito';

        function setOfflineMessage(msg) {
          dotEl.classList.remove('online');
          textEl.classList.add('offline');
          textEl.textContent = msg || 'Sin conexi√≥n';
        }

        function timeAgo(sec) {
          sec = Math.max(0, Math.floor(sec || 0));
          if (sec < 60) return 'hace unos segundos';
          const m = Math.floor(sec / 60);
          if (m < 60) return `hace ${m} min`;
          const h = Math.floor(m / 60);
          if (h < 24) return `hace ${h} h`;
          const d = Math.floor(h / 24);
          return `hace ${d} d√≠a${d !== 1 ? 's' : ''}`;
        }

        async function pingPresence() {
          try {
            await fetch('/presence/ping', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ device: 'web' }),
              keepalive: true  // importante en cambios de pesta√±a
            });
          } catch (e) {
            console.warn('[presence] ping error:', e);
          }
        }

        // Opcional: tambi√©n al cerrar pesta√±a, usa sendBeacon
        window.addEventListener('beforeunload', () => {
          try {
            if (navigator.sendBeacon) {
              navigator.sendBeacon('/presence/ping',
                new Blob([JSON.stringify({ device: 'unload' })], { type: 'application/json' }));
            }
          } catch (_) { }
        });

        async function refreshPresence() {
          try {
            const r = await fetch('/presence/other', { headers: { 'Accept': 'application/json' } });
            if (!r.ok) {
              console.warn('[presence] GET /presence/other ->', r.status);
              setOfflineMessage('Sin conexi√≥n');
              return;
            }
            const j = await r.json();
            if (!j || j.ok === false) {
              setOfflineMessage('Sin datos');
              return;
            }
            const online = !!j.online;
            if (online) {
              dotEl.classList.add('online');
              textEl.classList.remove('offline');
              textEl.textContent = 'En l√≠nea';
            } else {
              dotEl.classList.remove('online');
              textEl.classList.add('offline');
              textEl.textContent = j.ago_seconds != null
                ? ('√öltima vez ' + timeAgo(j.ago_seconds))
                : '√öltima vez desconocida';
            }
          } catch (e) {
            console.warn('[presence] refresh error:', e);
            setOfflineMessage('Sin conexi√≥n');
          }
        }

        // Arranque
        if (!ME) { setOfflineMessage('No autenticado'); return; }
        pingPresence();
        refreshPresence();

        // Reintentos / actualizaci√≥n
        setInterval(pingPresence, 25_000);
        setInterval(refreshPresence, 7_000);

        // Al volver de segundo plano
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) { pingPresence(); refreshPresence(); }
        });

        // (Opcional) refresco inmediato por SSE
        if ('EventSource' in window) {
          try {
            const es = new EventSource('/events');
            es.addEventListener('presence', () => refreshPresence());
          } catch (_) { }
        }
}) ();


      </script>



      <footer class="site-footer">
        <p>Esta web ha sido realizada por
          <a href="https://www.instagram.com/chriismartinezz/" target="_blank" class="autor-link">Christian
            Mart√≠nez</a>
          ‚ù§Ô∏è
        </p>
      </footer>

      <script>
        (function () {
          function log(s) { try { const el = document.getElementById('noti-status'); if (!el) return; el.style.display = 'block'; el.textContent = s; setTimeout(() => { el.style.display = 'none'; }, 4500); } catch (e) { } }
          window.activarNotificaciones = async function activarNotificaciones() {
            try {
              if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                log('Tu navegador no soporta notificaciones.'); return;
              }
              // Pide permiso si a√∫n no est√° concedido
              let perm = (window.Notification && Notification.permission) || 'default';
              if (perm !== 'granted') {
                perm = await Notification.requestPermission();
                log('Permiso: ' + perm);
                if (perm !== 'granted') return;
              }

              const r = await fetch('/push/vapid-public');
              let j = {}; try { j = await r.json(); } catch (e) { }
              const vapidPublicKey = j && j.vapidPublicKey;
              if (!vapidPublicKey) { log('VAPID p√∫blica no configurada en servidor.'); return; }

              function b64ToBytes(s) {
                const pad = '='.repeat((4 - s.length % 4) % 4);
                const b64 = (s + pad).replace(/-/g, '+').replace(/_/g, '/');
                const raw = atob(b64); const arr = new Uint8Array(raw.length);
                for (let i = 0; i < raw.length; i++) arr[i] = raw.charCodeAt(i); return arr;
              }

              const reg = await navigator.serviceWorker.ready;
              let sub = await reg.pushManager.getSubscription();
              if (!sub) sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: b64ToBytes(vapidPublicKey) });

              const rr = await fetch('/push/subscribe', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(sub) });
              const jj = await rr.json().catch(() => ({}));
              if (jj && jj.ok) log('¬°Notificaciones activadas!');
              else log('Error al suscribir: ' + JSON.stringify(jj || {}));
            } catch (e) {
              log('Error: ' + (e.message || e));
            }
          }
        })();



        /* ===== Wishlist: orden por "M√°s recientes" o "Prioridad" ===== */
        (function () {
          const RANK = { alta: 3, media: 2, baja: 1 };

          function toTs(s) {
            if (!s) return 0;
            const core = String(s).trim().slice(0, 19).replace(' ', 'T');
            const t = Date.parse(core);
            return Number.isFinite(t) ? t : 0;
          }

          function sortGrid(grid, mode) {
            const cards = Array.from(grid.querySelectorAll('.wishlist-card'));
            const pos = new Map(cards.map((el, i) => [el, i]));
            cards.sort((a, b) => {
              const A = { p: RANK[(a.dataset.priority || '').toLowerCase()] || 0, t: toTs(a.dataset.created) };
              const B = { p: RANK[(b.dataset.priority || '').toLowerCase()] || 0, t: toTs(b.dataset.created) };
              if (mode === 'priority') return (B.p - A.p) || (B.t - A.t) || (pos.get(a) - pos.get(b));
              return (B.t - A.t) || (B.p - A.p) || (pos.get(a) - pos.get(b));
            });
            cards.forEach(c => grid.appendChild(c));
          }

          function applyWishlistSort(mode) {
            ['wanted-tab', 'purchased-tab'].forEach(id => {
              const grid = document.querySelector(`#${id} .wishlist-grid`);
              if (grid) sortGrid(grid, mode);
            });
            try { localStorage.setItem('wishlist_sort', mode); } catch { }
          }

          function initToggle() {
            const toggle = document.getElementById('wishlist-sort-toggle');
            if (!toggle) return;
            const btns = Array.from(toggle.querySelectorAll('button[data-mode]'));
            const slider = toggle.querySelector('.slider');

            function positionSlider() {
              const active = toggle.querySelector('button.active');
              if (!active || !slider) return;
              slider.style.width = active.offsetWidth + 'px';
              slider.style.transform = `translateX(${active.offsetLeft}px)`;
            }

            function setMode(mode) {
              btns.forEach(b => {
                const on = b.dataset.mode === mode;
                b.classList.toggle('active', on);
                b.setAttribute('aria-pressed', on ? 'true' : 'false');
              });
              positionSlider();
              applyWishlistSort(mode);
            }

            // Estado inicial
            let initial = 'recent';
            try { initial = localStorage.getItem('wishlist_sort') || initial; } catch { }
            setMode(initial);

            // Eventos
            btns.forEach(b => b.addEventListener('click', () => setMode(b.dataset.mode)));
            window.addEventListener('resize', positionSlider);

            // Accesibilidad teclado
            toggle.addEventListener('keydown', (e) => {
              if (e.key !== 'ArrowRight' && e.key !== 'ArrowLeft') return;
              e.preventDefault();
              const idx = btns.findIndex(b => b.classList.contains('active'));
              const next = e.key === 'ArrowRight' ? Math.min(btns.length - 1, idx + 1) : Math.max(0, idx - 1);
              setMode(btns[next].dataset.mode);
            });
          }

          // Exponer si lo necesitas
          window.applyWishlistSort = applyWishlistSort;

          document.addEventListener('DOMContentLoaded', initToggle);
        })();


        // El backend ya pasa 'username' a la plantilla:
        // --- El backend ya pasa 'username'...
        const ME = "{{ username }}";
        const OTHER = (ME === "mochito") ? "mochita" : "mochito";

        // 1) Mantener mi presencia viva
        async function pingPresence() {
          try {
            await fetch('/presence/ping', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ device: 'web-app' })
            });
          } catch (_) { }
        }
        // Ping cada 45s (la ventana server por defecto es 70s)
        pingPresence();
        setInterval(pingPresence, 45_000);

        // 2) Mostrar estado del OTRO usuario (cambia los selectores a los tuyos)
        const dot = document.querySelector('#presenceDot');   //...
        const label = document.querySelector('#presenceText');  // ‚¨ÖÔ∏è texto ‚ÄúEn l√≠nea/Desconectado/Comprobando‚Ä¶‚Äù

        function humanizeAgo(sec) {
          if (sec == null) return 'desconocido';
          if (sec < 60) return `${sec}s`;
          const m = Math.floor(sec / 60), s = sec % 60;
          return `${m}m ${s}s`;
        }

        async function refreshOtherPresence() {
          try {
            const r = await fetch('/presence/other?user=' + encodeURIComponent(OTHER));
            const j = await r.json();
            if (!j.ok) throw new Error('resp not ok');

            if (j.online) {
              label.textContent = 'En l√≠nea';
              dot?.classList.add('ok');
              dot?.classList.remove('err');
            } else {
              label.textContent = '(' + humanizeAgo(j.ago_seconds) + ')';

              dot?.classList.add('err');
              dot?.classList.remove('ok');
            }
          } catch (e) {
            label.textContent = 'Error';
            dot?.classList.remove('ok');
            dot?.classList.remove('err');
          }
        }

        // Arrancar y refrescar cada 15s
        label && (label.textContent = '‚Ä¶');
        refreshOtherPresence();
        setInterval(refreshOtherPresence, 15_000);




        function humanizeAgo(seconds) {
          if (seconds == null) return '‚Äî';
          seconds = Math.max(0, seconds | 0);
          if (seconds < 60) return `hace ${seconds} s`;
          const m = Math.floor(seconds / 60);
          if (m < 60) return `hace ${m} min`;
          let h = Math.floor(m / 60), mm = m % 60;
          if (h < 24) return `hace ${h} h${mm ? ` ${mm} min` : ''}`;
          const d = Math.floor(h / 24); h = h % 24;
          return `hace ${d} d${h ? ` ${h} h` : ''}`;
        }


        /* ============================================
           ROUTER LIGERO: convierte tu p√°gina en ‚Äúpantallas‚Äù
           sin tocar backend ni IDs. Solo mueve nodos.
           ============================================ */

        (function () {
          // Mapea pantallas -> t√≠tulo (para encontrar secciones por h3)
          const TITLE_KEYS = {
            question: ['pregunta del d√≠a', 'pregunta diaria', 'pregunta'],
            wishlist: ['nuestra lista de deseos', 'lista de deseos', 'wishlist'],
            travels: ['nuestros viajes', 'viajes'],
            schedules: ['nuestros horarios', 'horarios'],
            intim: ['intimidad'],
            mochireal: ['mochireal', 'historial mochi']  // üëà nuevo
          };


          // 1) Crea p√°ginas vac√≠as
          function ensurePagesContainer() {
            let pages = document.getElementById('pages');
            if (!pages) {
              pages = document.createElement('div');
              pages.id = 'pages';
              document.querySelector('.container')?.appendChild(pages);
            }
            const make = (id) => {
              let el = document.getElementById('page-' + id);
              if (!el) {
                el = document.createElement('section');
                el.id = 'page-' + id;
                el.className = 'page';
                pages.appendChild(el);
              }
              return el;
            };
            return {
              home: make('home'),
              question: make('question'),
              wishlist: make('wishlist'),
              travels: make('travels'),
              schedules: make('schedules'),
              intim: make('intim'),
              mochireal: make('mochireal'),   // üëà nuevo
            };

          }

          // 2) Helpers para localizar secciones por el t√≠tulo <h3>
          function findSectionByTitleIncludes(words) {
            const sections = Array.from(document.querySelectorAll('.section'));
            const lower = (s) => (s || '').toLowerCase().trim();
            for (const s of sections) {
              const h = s.querySelector('h3');
              if (!h) continue;
              const txt = lower(h.textContent);
              if (words.some(w => txt.includes(w))) return s;
            }
            return null;
          }

          // 3) Construye Home: banner + ‚ÄúNosotros‚Äù (d√≠as) + ‚ÄúDistancia‚Äù
          function buildHome(home) {
            const banner = document.querySelector('.section.banner');
            const nosotros = findSectionByTitleIncludes(['nosotros']);   // d√≠as juntos / vernos
            const distancia = findSectionByTitleIncludes(['distancia']); // mapa
            [banner, nosotros, distancia].forEach(el => { if (el) home.appendChild(el); });
          }

          // 4) Resto de pantallas por t√≠tulo
          function buildByTitles(pages) {
            const pick = (key) => findSectionByTitleIncludes(TITLE_KEYS[key]);

            const q = pick('question'); if (q) pages.question.appendChild(q);
            const wl = pick('wishlist'); if (wl) pages.wishlist.appendChild(wl);
            const tr = pick('travels'); if (tr) pages.travels.appendChild(tr);
            const sc = pick('schedules'); if (sc) pages.schedules.appendChild(sc);
            const inx = pick('intim'); if (inx) pages.intim.appendChild(inx);

            // üî¥ MochiReal ‚Äî metemos el historial (la secci√≥n con <h3> "Historial MochiReal üì∏")
            const mrHist = pick('mochireal');
            if (mrHist) pages.mochireal.appendChild(mrHist);

            // üî¥ MochiReal ‚Äî metemos el bloque activo (la tarjeta con id="mochireal")
            const mrActive = document.getElementById('mochireal'); // <div class="mochireal-section ... id="mochireal">
            if (mrActive) pages.mochireal.appendChild(mrActive);
          }


          // 5) Cambiar de pantalla
          function setScreen(name) {
            const valid = ['home', 'question', 'wishlist', 'travels', 'schedules', 'intim', 'mochireal'];
            if (!valid.includes(name)) name = 'home';
            document.body.dataset.screen = name;

            // Activa la p√°gina
            document.querySelectorAll('#pages .page').forEach(p => p.classList.remove('active'));
            const page = document.getElementById('page-' + name);
            if (page) page.classList.add('active');

            // Activa el bot√≥n
            document.querySelectorAll('.app-nav .nav-btn').forEach(b => {
              b.classList.toggle('active', b.dataset.goto === name);
              b.setAttribute('aria-pressed', b.dataset.goto === name ? 'true' : 'false');
            });

            // Ajustes al entrar en Home: recalcular mapa
            // Ajustes al entrar en Home: recalcular mapa
            // --- CAMBIA ESTE BLOQUE ---
            // Ajustes al entrar en Home: recalcular mapa
            if (name === 'home') {
              // Hacemos dos intentos para asegurar que el DOM ya pint√≥ el div
              [100, 500, 1000].forEach(delay => {
                setTimeout(() => {
                  try {
                    if (window.map && typeof map.invalidateSize === 'function') {
                      map.invalidateSize(); // Obliga al mapa a rellenar el hueco

                      // Si tienes las coordenadas, rec√©ntralo para que se vean los dos
                      if (window.christianMarker && window.claraMarker) {
                        const group = new L.featureGroup([window.christianMarker, window.claraMarker]);
                        map.fitBounds(group.getBounds().pad(0.1));
                      }

                      if (typeof renderDistance === 'function') renderDistance();
                    }
                  } catch (_) { }
                }, delay);
              });
            }

            // ‚ö° Lazy-load Viajes
            if (name === 'travels' && typeof window.ensureTravelsLoaded === 'function') {
              window.ensureTravelsLoaded();
            }

            // ‚ö° Lazy-load Intimidad
            if (name === 'intim' && typeof window.ensureIntimLoaded === 'function') {
              window.ensureIntimLoaded();
            }

            // ‚ö° Lazy-load MochiReal (historial)
            if (name === 'mochireal' && typeof window.ensureMochiRealHistoryLoaded === 'function') {
              window.ensureMochiRealHistoryLoaded();
            }

            // Guarda preferencia
            try { localStorage.setItem('cc_screen', name); } catch (_) { }
            window.scrollTo(0, 0);
          }


          // 6) Listener del navbar (incluye perfil como modal)
          function hookNavbar() {
            const nav = document.querySelector('.app-nav');
            if (!nav) return;
            nav.addEventListener('click', (e) => {
              const btn = e.target.closest('.nav-btn');
              if (!btn) return;
              const to = btn.dataset.goto;
              if (to === 'profile') {
                // Abrimos modal perfil sin cambiar de pantalla
                const modal = document.getElementById('profileModal');
                if (modal) modal.style.display = 'block';
                return;
              }
              setScreen(to);
            });
          }

          // 7) Re-inicializa cosas que dependen de estar en su sitio
          function reinitAfterMove() {
            // Reconfigurar paginaci√≥n y buscadores de viajes si existen
            try { if (typeof setupTravelPagination === 'function') setupTravelPagination(); } catch (_) { }
            try {
              if (typeof setupTravelSearch === 'function') {
                if (typeof visitedPagerAPI !== 'undefined') setupTravelSearch('visited-tab', 'visited-search', visitedPagerAPI);
                if (typeof wishlistPagerAPI !== 'undefined') setupTravelSearch('wishlist-travel-tab', 'wishlist-search', wishlistPagerAPI);
              }
            } catch (_) { }
            // Recoloca slider de orden en wishlist si existe
            try {
              if (typeof applyWishlistSort === 'function') {
                const saved = localStorage.getItem('wishlist_sort') || 'recent';
                applyWishlistSort(saved);
              }
            } catch (_) { }
          }

          // 8) Boot
          function bootRouter() {
            const pages = ensurePagesContainer();
            buildHome(pages.home);
            buildByTitles(pages);
            hookNavbar();

            // Pantalla inicial (recuerda √∫ltima, por defecto home)
            let initial = 'home';
            try { initial = localStorage.getItem('cc_screen') || 'home'; } catch (_) { }
            setScreen(initial);

            // Reinit dependencias
            reinitAfterMove();
          }

          // Ejecuta despu√©s de que tu DOM ya est√© listo
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', bootRouter);
          } else {
            bootRouter();
          }
        })();


        /* ========= Media: tabs ========= */
        function setupMediaTabs() {
          document.querySelectorAll('.media-tabs .media-tab').forEach(tab => {
            tab.addEventListener('click', () => {
              document.querySelectorAll('.media-tabs .media-tab').forEach(t => t.classList.remove('active'));
              document.querySelectorAll('.media-content').forEach(c => c.classList.remove('active'));
              tab.classList.add('active');
              const id = tab.getAttribute('data-tab');
              document.getElementById(id + '-tab')?.classList.add('active');
              // Reaplica b√∫squeda al cambiar de tab
              const q = document.getElementById('media-search')?.value || '';
              applyMediaSearch(q);
              // Reposiciona slider del toggle
              positionMediaSortSlider();
              // Refresca paginaci√≥n del tab visible
              refreshMediaPagination();
            });
          });
        }

        /* ========= Media: sort ========= */
        function positionMediaSortSlider() {
          const toggle = document.getElementById('media-sort-toggle');
          if (!toggle) return;
          const slider = toggle.querySelector('.slider');
          const active = toggle.querySelector('button.active');
          if (!slider || !active) return;
          slider.style.width = active.offsetWidth + 'px';
          slider.style.transform = `translateX(${active.offsetLeft}px)`;
        }
        function applyMediaSort(mode) {
          const grids = [
            document.querySelector('#towatch-tab .media-grid'),
            document.querySelector('#watched-tab .media-grid')
          ];
          grids.forEach(grid => {
            if (!grid) return;
            const cards = Array.from(grid.querySelectorAll(':scope > .media-card'));
            const pos = new Map(cards.map((el, i) => [el, i]));
            const ts = s => {
              if (!s) return 0;
              const core = String(s).trim().slice(0, 19).replace(' ', 'T');
              const t = Date.parse(core);
              return Number.isFinite(t) ? t : 0;
            };
            cards.sort((a, b) => {
              const A = {
                t: ts(a.dataset.created),
                r: +a.dataset.rating || 0,
                p: (a.dataset.platform || 'zzz'),
                title: (a.dataset.title || '')
              };
              const B = {
                t: ts(b.dataset.created),
                r: +b.dataset.rating || 0,
                p: (b.dataset.platform || 'zzz'),
                title: (b.dataset.title || '')
              };
              if (mode === 'rating') return (B.r - A.r) || (B.t - A.t) || (pos.get(a) - pos.get(b));
              if (mode === 'platform') return (A.p.localeCompare(B.p)) || A.title.localeCompare(B.title) || (B.t - A.t);
              // recent
              return (B.t - A.t) || (B.r - A.r) || (pos.get(a) - pos.get(b));
            });
            cards.forEach(c => grid.appendChild(c));
          });
        }
        function setupMediaSortToggle() {
          const toggle = document.getElementById('media-sort-toggle');
          if (!toggle) return;
          const btns = Array.from(toggle.querySelectorAll('button[data-mode]'));
          let current = 'recent';
          try { current = localStorage.getItem('media_sort') || 'recent'; } catch { }
          function setMode(mode) {
            current = mode;
            btns.forEach(b => {
              const on = b.dataset.mode === mode;
              b.classList.toggle('active', on);
              b.setAttribute('aria-pressed', on ? 'true' : 'false');
            });
            applyMediaSort(mode);
            positionMediaSortSlider();
            try { localStorage.setItem('media_sort', mode); } catch { }
          }
          btns.forEach(b => b.addEventListener('click', () => setMode(b.dataset.mode)));
          toggle.addEventListener('keydown', (e) => {
            if (e.key !== 'ArrowRight' && e.key !== 'ArrowLeft') return;
            e.preventDefault();
            const i = btns.findIndex(b => b.classList.contains('active'));
            const next = e.key === 'ArrowRight' ? Math.min(btns.length - 1, i + 1) : Math.max(0, i - 1);
            setMode(btns[next].dataset.mode);
          });
          // init
          setMode(current);
          window.addEventListener('resize', positionMediaSortSlider);
        }

        /* ========= Media: b√∫squeda + paginaci√≥n ========= */
        function activeMediaGrid() {
          if (document.getElementById('towatch-tab')?.classList.contains('active'))
            return { grid: document.querySelector('#towatch-tab .media-grid'), pager: document.getElementById('media-pager-towatch') };
          if (document.getElementById('watched-tab')?.classList.contains('active'))
            return { grid: document.querySelector('#watched-tab .media-grid'), pager: document.getElementById('media-pager-watched') };
          return null;
        }
        let mediaPager = { refresh() { }, goToFirst() { } };
        function paginateMediaGrid(gridEl, pagerEl, pageSize = 8) {
          if (!gridEl || !pagerEl) return { refresh() { }, goToFirst() { } };
          const allCards = Array.from(gridEl.querySelectorAll(':scope > .media-card'));
          let current = 1;
          let emptyMsg = gridEl.querySelector('.no-results');
          if (!emptyMsg) {
            emptyMsg = document.createElement('p');
            emptyMsg.className = 'no-results';
            emptyMsg.textContent = 'Sin resultados.';
            emptyMsg.style.display = 'none';
            emptyMsg.style.gridColumn = '1/-1';
            gridEl.appendChild(emptyMsg);
          }
          function getMatched() { return allCards.filter(el => el.dataset.match !== '0'); }
          function hideAll() { allCards.forEach(el => el.style.display = 'none'); }
          function makeBtn(label, onClick, opts = {}) {
            const b = document.createElement('button');
            b.textContent = label;
            b.className = 'page-btn' + (opts.active ? ' active' : '');
            if (opts.title) b.title = opts.title;
            if (opts.disabled) b.disabled = true;
            if (!opts.disabled && onClick) b.addEventListener('click', onClick);
            return b;
          }
          function render() {
            const matched = getMatched();
            const total = matched.length;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            if (current > totalPages) current = totalPages;
            if (total === 0) {
              hideAll(); emptyMsg.style.display = ''; pagerEl.style.display = 'none'; pagerEl.innerHTML = ''; return;
            } else { emptyMsg.style.display = 'none'; }
            if (totalPages <= 1) {
              pagerEl.style.display = 'none'; pagerEl.innerHTML = '';
              hideAll(); matched.forEach(el => el.style.display = '');
              return;
            }
            pagerEl.style.display = 'flex';
            const start = (current - 1) * pageSize;
            const end = start + pageSize;
            hideAll();
            matched.forEach((el, i) => { el.style.display = (i >= start && i < end) ? '' : 'none'; });
            // controls
            pagerEl.innerHTML = '';
            pagerEl.appendChild(makeBtn('¬´', () => { current = 1; render(); }, { disabled: current === 1, title: 'Primera' }));
            pagerEl.appendChild(makeBtn('‚Äπ', () => { current = Math.max(1, current - 1); render(); }, { disabled: current === 1, title: 'Anterior' }));
            const windowSize = 5;
            let from = Math.max(1, current - Math.floor(windowSize / 2));
            let to = Math.min(totalPages, from + windowSize - 1);
            from = Math.max(1, to - windowSize + 1);
            for (let p = from; p <= to; p++) {
              pagerEl.appendChild(makeBtn(String(p), () => { current = p; render(); }, { active: p === current }));
            }
            pagerEl.appendChild(makeBtn('‚Ä∫', () => { current = Math.min(totalPages, current + 1); render(); }, { disabled: current === totalPages, title: 'Siguiente' }));
            pagerEl.appendChild(makeBtn('¬ª', () => { current = totalPages; render(); }, { disabled: current === totalPages, title: '√öltima' }));
          }
          render();
          return {
            refresh: render,
            goToFirst: () => { current = 1; render(); }
          };
        }
        function setupMediaPagination() {
          const act = activeMediaGrid();
          if (!act) return;
          mediaPager = paginateMediaGrid(act.grid, act.pager, 8);
        }
        function refreshMediaPagination() {
          const act = activeMediaGrid();
          if (!act) return;
          mediaPager = paginateMediaGrid(act.grid, act.pager, 8);
        }
        function applyMediaSearch(termRaw) {
          const act = activeMediaGrid();
          if (!act) return;
          const term = (termRaw || '').trim().toLowerCase();
          const cards = Array.from(act.grid.querySelectorAll(':scope > .media-card'));
          cards.forEach(card => {
            const title = (card.dataset.title || '');
            const platf = (card.dataset.platform || '');
            const match = term === '' || title.includes(term) || platf.includes(term);
            card.dataset.match = match ? '1' : '0';
          });
          mediaPager.goToFirst?.();
          mediaPager.refresh?.();
        }
        function setupMediaSearch() {
          const input = document.getElementById('media-search');
          if (!input) return;
          input.addEventListener('input', () => applyMediaSearch(input.value));
          applyMediaSearch(input.value);
        }

        /* ========= Media: rating widgets ========= */
        function attachRating(container) {
          const box = (typeof container === 'string') ? document.querySelector(container) : container;
          if (!box) return;
          const stars = Array.from(box.querySelectorAll('i.fa-star'));
          const inputId = box.getAttribute('data-target');
          const hidden = inputId ? document.getElementById(inputId) : box.querySelector('input[type="hidden"][name="rating"]');
          if (!hidden) return;
          function paint(val) {
            stars.forEach(st => {
              const v = +st.dataset.v;
              st.classList.toggle('fas', v <= val);
              st.classList.toggle('far', v > val);
            });
            hidden.value = val;
          }
          stars.forEach(st => {
            st.addEventListener('mouseenter', () => paint(+st.dataset.v));
            st.addEventListener('click', () => paint(+st.dataset.v));
          });
          box.addEventListener('mouseleave', () => paint(+hidden.value || 0));
          // init
          paint(+hidden.value || 0);
        }
        function initAllEditableRatings() {
          document.querySelectorAll('.rating.editable').forEach(attachRating);
        }

        /* ========= Media: modal edici√≥n ========= */
        function toggleEpisodesRow(selectEl, rowEl) {
          if (!selectEl || !rowEl) return;
          rowEl.style.display = (selectEl.value === 'show') ? '' : 'none';
        }
        window.openEditMediaModal = function (id, title, kind, platform, link, notes, rating, epsTotal, epsSeen, isWatched) {
          const modal = document.getElementById('editMediaModal');
          if (!modal) return;

          // fill
          document.getElementById('mediaId').value = id || '';
          document.getElementById('mediaTitle').value = title || '';
          document.getElementById('mediaKind').value = kind || 'movie';
          document.getElementById('mediaPlatform').value = platform || '';
          document.getElementById('mediaLink').value = link || '';
          document.getElementById('mediaNotes').value = notes || '';
          document.getElementById('mediaRating').value = Number(rating || 0);

          const row = document.getElementById('editEpisodesRow');
          const sel = document.getElementById('mediaKind');
          toggleEpisodesRow(sel, row);
          document.getElementById('mediaEpsTotal').value = Number(epsTotal || 0);
          document.getElementById('mediaEpsSeen').value = Number(epsSeen || 0);

          const watched = document.getElementById('mediaWatchedToggle');
          watched.checked = !!isWatched;

          // init stars
          initAllEditableRatings();

          // open
          modal.style.display = 'block';
        };

        // Cerrar modal gen√©rico ya lo tienes (delegaci√≥n .close-modal)

        /* ========= Media: init on DOMContentLoaded ========= */
        document.addEventListener('DOMContentLoaded', () => {
          setupMediaTabs();
          setupMediaSortToggle();
          setupMediaPagination();
          setupMediaSearch();
          initAllEditableRatings();

          // "A√±adir" ‚Äî mostrar episodios si es serie
          const addKind = document.getElementById('addKind');
          const addRow = document.getElementById('addEpisodesRow');
          if (addKind && addRow) {
            toggleEpisodesRow(addKind, addRow);
            addKind.addEventListener('change', () => toggleEpisodesRow(addKind, addRow));
          }

          // "Editar" ‚Äî cambiar visibilidad episodios al cambiar tipo
          const editKind = document.getElementById('mediaKind');
          const editRow = document.getElementById('editEpisodesRow');
          if (editKind && editRow) {
            editKind.addEventListener('change', () => toggleEpisodesRow(editKind, editRow));
          }
        });


        // Navegaci√≥n simple entre "Inicio" y "Pel√≠culas/Series"
        function setupSimplePages() {
          const btns = document.querySelectorAll('.app-nav .nav-btn');
          btns.forEach(btn => {
            btn.addEventListener('click', () => {
              // estado visual de la barra
              btns.forEach(b => b.classList.remove('active'));
              btn.classList.add('active');

              const dest = btn.dataset.goto;

              // Si es "media", activamos la p√°gina de pel√≠culas/series.
              // Si no, volvemos al inicio.
              if (dest === 'media') {
                document.body.classList.add('page-media');
                window.scrollTo({ top: 0, behavior: 'smooth' });
              } else {
                document.body.classList.remove('page-media');
              }
            });
          });
        }

        document.addEventListener('DOMContentLoaded', function () {
          setupSimplePages();
        });


        (function () {
          // pinta estado de estrellas seg√∫n value (0-5)
          function paintStars(container, value) {
            const v = Number(value) || 0;
            container.querySelectorAll('i[data-v]').forEach(star => {
              const n = Number(star.dataset.v);
              star.classList.toggle('fas', n <= v);
              star.classList.toggle('far', n > v);
            });
          }

          // engancha clicks en estrellas para actualizar el hidden
          function wireStars(container, hiddenInput) {
            container.querySelectorAll('i[data-v]').forEach(star => {
              star.addEventListener('click', () => {
                const v = Number(star.dataset.v) || 0;
                hiddenInput.value = v;
                paintStars(container, v);
              });
            });
          }

          // mapa de platform para el campo "platform" del modal
          function platformText(key) {
            return key === 'both' ? 'Netflix + Prime'
              : key === 'netflix' ? 'Netflix'
                : key === 'prime' ? 'Prime'
                  : '';
          }

          // Abre el modal a partir del bot√≥n dentro de .media-card
          window.openEditMedia = function (btn, forceWatched) {
            const card = btn.closest('.media-card');
            if (!card) return;

            const modal = document.getElementById('editMediaModal');
            const form = document.getElementById('editMediaForm');
            if (!modal || !form) return;

            // inputs
            const idEl = document.getElementById('mediaId');
            const titleEl = document.getElementById('mediaTitle');
            const kindEl = document.getElementById('mediaKind');
            const platEl = document.getElementById('mediaPlatform');
            const linkEl = document.getElementById('mediaLink');
            const notesEl = document.getElementById('mediaNotes');
            const rateHid = document.getElementById('mediaRating');
            const rateBox = modal.querySelector('.rating.editable');
            const watchedT = document.getElementById('mediaWatchedToggle');
            const epsRow = document.getElementById('editEpisodesRow');

            // dataset -> campos
            idEl.value = card.dataset.id || '';
            titleEl.value = card.dataset.title || '';
            kindEl.value = (card.dataset.kind || 'movie');
            platEl.value = platformText(card.dataset.platform || '');
            linkEl.value = card.dataset.link || '';
            notesEl.value = card.dataset.notes || '';

            // rating y estado "vista"
            const currentRating = Number(card.dataset.rating || 0);
            rateHid.value = currentRating;
            paintStars(rateBox, currentRating);
            watchedT.checked = forceWatched ? true : (card.dataset.watched === '1');

            // mostrar inputs de episodios si es serie
            if (epsRow) epsRow.style.display = (kindEl.value === 'show') ? '' : 'none';

            // (re)wire estrellas una sola vez
            if (!rateBox.__wired) {
              wireStars(rateBox, rateHid);
              rateBox.__wired = true;
            }

            // abre modal
            modal.style.display = 'block';
          };

          // cierra modal (reutiliza tus handlers globales)
          document.querySelectorAll('#editMediaModal .close-modal').forEach(x => {
            x.addEventListener('click', () => {
              document.getElementById('editMediaModal').style.display = 'none';
            });
          });
        })();


        // Seleccionamos el footer
        const footer = document.querySelector('.site-footer');

        // Variables para almacenar la posici√≥n de desplazamiento anterior
        let lastScrollTop = 0;

        // Detectamos el evento de scroll
        window.addEventListener('scroll', () => {
          let scrollTop = window.scrollY || document.documentElement.scrollTop;

          if (scrollTop > lastScrollTop) {
            // Si el usuario ha hecho scroll hacia abajo
            footer.style.transform = 'translateY(0)'; // Mostrar el footer
          } else {
            // Si el usuario ha hecho scroll hacia arriba
            footer.style.transform = 'translateY(100%)'; // Ocultar el footer
          }

          // Actualizamos la posici√≥n de scroll
          lastScrollTop = scrollTop <= 0 ? 0 : scrollTop; // Para que no haya valores negativos
        });

        (function () {
          const modal = document.getElementById('editMediaModal');
          const form = document.getElementById('editMediaForm');
          const idInput = document.getElementById('mediaId');
          const commentInput = document.getElementById('mediaComment');
          const ratingInput = document.getElementById('ratingInput');
          const starsWrap = document.getElementById('ratingStars');
          const markWatched = document.getElementById('markWatched');
          const heading = document.getElementById('editMediaHeading');

          function paintStars(val) {
            ratingInput.value = String(val);
            starsWrap.querySelectorAll('i.fa-star').forEach(i => {
              const v = +i.dataset.val;
              i.classList.toggle('fas', v <= val);
              i.classList.toggle('far', v > val);
            });
          }

          starsWrap?.addEventListener('click', (e) => {
            const i = e.target.closest('i.fa-star');
            if (!i) return;
            paintStars(+i.dataset.val || 0);
          });

          // La funci√≥n que faltaba:
          window.openEditMedia = function (btn, mark) {
            const card = btn.closest('.media-card');
            if (!card) return;

            const title = card.querySelector('.media-title')?.textContent?.trim() || 'T√≠tulo';
            const watched = card.dataset.watched === '1';

            idInput.value = card.dataset.id || '';
            commentInput.value = (card.dataset.notes || '').trim();
            paintStars(parseInt(card.dataset.rating || '0', 10) || 0);

            // Si est√° en "Por ver" y pulsas l√°piz, forzamos "marcar como vista"
            // (porque no tienes endpoint de edici√≥n de pendientes)
            const shouldWatch = mark || !watched;
            markWatched.checked = !!shouldWatch;

            // Acci√≥n seg√∫n el checkbox
            form.action = markWatched.checked ? '/media/watch' : '/media/unwatch';

            // T√≠tulo del modal
            heading.textContent = (watched || markWatched.checked)
              ? `Valorar: ${title}`
              : `Editar: ${title}`;

            modal.style.display = 'block';
          };

          // Cambiar destino del form si alternan el checkbox
          markWatched?.addEventListener('change', () => {
            form.action = markWatched.checked ? '/media/watch' : '/media/unwatch';
          });
        })();

        (function () {
          const stars = Array.from(document.querySelectorAll('#ratingStars .fa-star'));
          const ratingInput = document.getElementById('ratingInput');

          function paint(v) {
            stars.forEach(s => {
              const on = Number(s.dataset.val) <= Number(v || 0);
              s.classList.toggle('fas', on); // s√≥lida
              s.classList.toggle('far', !on); // borde
            });
          }

          stars.forEach(s => {
            s.addEventListener('click', () => {
              const v = Number(s.dataset.val);
              // si clicas de nuevo la misma estrella, ‚Äúdesmarca‚Äù (sin nota)
              ratingInput.value = (Number(ratingInput.value) === v) ? '' : String(v);
              paint(ratingInput.value);
            });
          });

          // Si al abrir el modal rellenas ratingInput, pinta estrellitas:
          paint(ratingInput.value || '');
        })();

        document.querySelectorAll('.brand-toggle input').forEach(inp => {
          const lab = inp.nextElementSibling;
          const sync = () => lab.setAttribute('aria-pressed', inp.checked ? 'true' : 'false');
          inp.addEventListener('change', sync);
          sync();
        });




        // ===== Helpers de orden =====
        function getActiveMediaGrid() {
          // coge el grid del tab "Por ver" o "Vistas" que est√© activo
          const active = document.querySelector('.media-content.active .media-grid');
          return active || null;
        }

        function parseTs(s) {
          // convierte fecha en timestamp; si no hay, 0
          const t = Date.parse(s || '');
          return Number.isFinite(t) ? t : 0;
        }

        function platformRank(p) {
          // prioridad: both > netflix > prime > zzz
          const v = (p || '').toLowerCase();
          if (v === 'both') return 0;
          if (v === 'netflix') return 1;
          if (v === 'prime') return 2;
          return 3; // zzz/otros
        }

        function sortCards(grid, mode) {
          if (!grid) return;
          const cards = Array.from(grid.querySelectorAll('.media-card'));
          const byRecent = (a, b) => parseTs(b.dataset.created) - parseTs(a.dataset.created);
          const byRating = (a, b) => {
            const ra = parseFloat(a.dataset.avg || '0') || 0;
            const rb = parseFloat(b.dataset.avg || '0') || 0;
            if (rb !== ra) return rb - ra;
            // desempate: m√°s reciente primero
            return byRecent(a, b);
          };
          const byPlatform = (a, b) => {
            const pa = platformRank(a.dataset.platform);
            const pb = platformRank(b.dataset.platform);
            if (pa !== pb) return pa - pb;
            return byRecent(a, b);
          };

          const cmp = mode === 'rating' ? byRating : mode === 'platform' ? byPlatform : byRecent;

          // Re-orden estable: crea un √≠ndice original para no romper empates iguales
          cards.forEach((c, i) => c.__idx = i);
          cards.sort((a, b) => {
            const r = cmp(a, b);
            return r !== 0 ? r : (a.__idx - b.__idx);
          });

          // Reinsertar en orden
          const frag = document.createDocumentFragment();
          cards.forEach(c => frag.appendChild(c));
          grid.appendChild(frag);
        }

        // ===== UI del sort-toggle =====
        (function setupMediaSort() {
          const wrap = document.getElementById('media-sort-toggle');
          if (!wrap) return;

          const slider = wrap.querySelector('.slider');
          const btns = Array.from(wrap.querySelectorAll('button'));
          let mode = (btns.find(b => b.getAttribute('aria-pressed') === 'true')?.dataset.mode) || 'recent';

          function moveSliderTo(btn) {
            if (!slider || !btn) return;
            const rWrap = wrap.getBoundingClientRect();
            const rBtn = btn.getBoundingClientRect();
            const w = rBtn.width;
            const x = rBtn.left - rWrap.left;
            slider.style.width = `${w}px`;
            slider.style.transform = `translateX(${x}px)`;
          }

          function setActive(btn) {
            btns.forEach(b => {
              const on = (b === btn);
              b.classList.toggle('active', on);
              b.setAttribute('aria-pressed', on ? 'true' : 'false');
            });
            moveSliderTo(btn);
          }

          function apply() {
            const grid = getActiveMediaGrid();
            sortCards(grid, mode);
          }

          // Clicks
          wrap.addEventListener('click', (e) => {
            const b = e.target.closest('button[data-mode]');
            if (!b) return;
            mode = b.dataset.mode;
            setActive(b);
            apply();
          });

          // Al cargar / al cambiar de tab, recoloca slider + aplica sort
          window.addEventListener('load', () => {
            const current = btns.find(b => b.dataset.mode === mode) || btns[0];
            setActive(current);
            apply();
          });
          window.addEventListener('resize', () => {
            const current = btns.find(b => b.classList.contains('active'));
            if (current) moveSliderTo(current);
          });

          // Si no tienes listeners para tabs de media, a√±ade esto:
          document.querySelectorAll('.media-tabs .media-tab').forEach(tab => {
            tab.addEventListener('click', () => {
              // activar pesta√±a
              document.querySelectorAll('.media-tabs .media-tab').forEach(t => t.classList.remove('active'));
              document.querySelectorAll('.media-content').forEach(c => c.classList.remove('active'));
              tab.classList.add('active');
              const id = tab.dataset.tab;
              document.getElementById(id + '-tab')?.classList.add('active');

              // volver a aplicar el orden al nuevo grid visible
              const current = btns.find(b => b.classList.contains('active')) || btns[0];
              moveSliderTo(current);
              apply();
            });
          });
        })();
        // === Buscar SOLO por T√çTULO en Pel√≠culas/Series ===
        (function mediaTitleOnlySearch() {
          const box = document.getElementById('media-search');
          if (!box) return;

          // 1) Quita cualquier listener previo (clon) y cambia placeholder
          const newBox = box.cloneNode(true);
          box.replaceWith(newBox);
          newBox.placeholder = 'Buscar por t√≠tulo‚Ä¶';

          // Normaliza (quita acentos, pasa a min√∫sculas)
          const norm = (s) => (s || '')
            .toString()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .toLowerCase()
            .trim();

          // Devuelve true si el t√≠tulo contiene TODAS las palabras buscadas
          function matchTitle(title, q) {
            const hay = norm(title);
            const needles = norm(q).split(/\s+/).filter(Boolean);
            if (needles.length === 0) return true;
            return needles.every(t => hay.includes(t));
          }

          function applyFilter() {
            const q = newBox.value;
            const lists = [
              document.querySelector('#towatch-tab .media-grid'),
              document.querySelector('#watched-tab .media-grid')
            ];

            lists.forEach((grid, idx) => {
              if (!grid) return;
              let visibles = 0;

              grid.querySelectorAll('.media-card').forEach(card => {
                const title = card.dataset.title || '';
                const ok = matchTitle(title, q);
                card.style.display = ok ? '' : 'none';
                if (ok) visibles++;
              });

              // Si tienes paginaci√≥n propia, repagina tras el filtro (opcional)
              // Aseg√∫rate de que tu funci√≥n exista:
              if (typeof window.rePageMedia === 'function') {
                window.rePageMedia(idx === 0 ? 'towatch' : 'watched');
              }
            });
          }

          // Filtra en tiempo real
          newBox.addEventListener('input', applyFilter);
          // Primera pasada (por si el input viene con valor)
          applyFilter();
        })();



        // === Buscador SOLO por t√≠tulo con 3 modos: Contiene | Empieza por | Ambos ===
        (function mediaTitleSearchWithModes() {
          const box = document.getElementById('media-search');
          if (!box) return;

          // 1) Sustituimos el input para limpiar listeners previos y ajustamos placeholder
          const input = box.cloneNode(true);
          box.replaceWith(input);
          input.placeholder = 'Buscar por t√≠tulo‚Ä¶';

          // 2) Inyectamos un toggle de modo al lado del input
          const tools = input.parentElement; // .media-tools
          const toggle = document.createElement('div');
          toggle.id = 'media-search-mode';
          toggle.className = 'sort-toggle';
          toggle.setAttribute('role', 'group');
          toggle.setAttribute('aria-label', 'Modo de b√∫squeda');
          toggle.innerHTML = `
    <div class="slider" aria-hidden="true"></div>
    <button type="button" data-mode="contains" aria-pressed="true"  class="active"><i class="fas fa-magnifying-glass"></i> Contiene</button>
    <button type="button" data-mode="starts"   aria-pressed="false"><i class="fas fa-arrow-right-to-bracket"></i> Empieza</button>
    <button type="button" data-mode="either"   aria-pressed="false"><i class="fas fa-toggle-on"></i> Ambos</button>
  `;
          tools.appendChild(toggle);

          // === Helpers de UI (slider del toggle) ===
          function positionSlider(group) {
            const slider = group.querySelector('.slider');
            const active = group.querySelector('button.active');
            if (!slider || !active) return;
            const r = active.getBoundingClientRect();
            const g = group.getBoundingClientRect();
            slider.style.width = r.width + 'px';
            slider.style.transform = `translateX(${r.left - g.left}px)`;
          }
          window.addEventListener('resize', () => positionSlider(toggle));
          // end helpers

          // 3) Normalizador (quita tildes, min√∫sculas)
          const norm = (s) => (s || '').toString()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .toLowerCase().trim();

          // 4) Estrategias de matching
          function needlesOf(q) { return norm(q).split(/\s+/).filter(Boolean); }

          function matchContains(hay, needles) {
            if (needles.length === 0) return true;
            return needles.every(n => hay.includes(n));
          }

          // "Empieza por": o bien el t√≠tulo empieza por toda la frase,
          // o bien cada palabra buscada empareja el inicio de alguna palabra del t√≠tulo.
          function matchStarts(hay, needles) {
            if (needles.length === 0) return true;
            const phrase = needles.join(' ');
            if (hay.startsWith(phrase)) return true;
            const words = hay.split(/\s+/);
            return needles.every(n => words.some(w => w.startsWith(n)));
          }

          function matchEither(hay, needles) {
            return matchContains(hay, needles) || matchStarts(hay, needles);
          }

          let mode = 'contains'; // por defecto

          // 5) Aplicar filtro a ambas listas (Por ver / Vistas)
          function applyFilter() {
            const q = input.value;
            const needles = needlesOf(q);

            const lists = [
              document.querySelector('#towatch-tab .media-grid'),
              document.querySelector('#watched-tab .media-grid')
            ];

            lists.forEach((grid, idx) => {
              if (!grid) return;
              grid.querySelectorAll('.media-card').forEach(card => {
                const title = card.dataset.title || '';
                const hay = norm(title);

                let ok = true;
                if (mode === 'contains') ok = matchContains(hay, needles);
                else if (mode === 'starts') ok = matchStarts(hay, needles);
                else ok = matchEither(hay, needles);

                card.style.display = ok ? '' : 'none';
              });

              // Si tienes repaginador, lo llamamos (si no existe, no pasa nada)
              if (typeof window.rePageMedia === 'function') {
                window.rePageMedia(idx === 0 ? 'towatch' : 'watched');
              }
            });
          }

          // 6) Eventos
          input.addEventListener('input', applyFilter);

          toggle.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-mode]');
            if (!btn) return;
            // actualizar estado visual
            toggle.querySelectorAll('button').forEach(b => {
              b.classList.toggle('active', b === btn);
              b.setAttribute('aria-pressed', b === btn ? 'true' : 'false');
            });
            mode = btn.dataset.mode || 'contains';
            positionSlider(toggle);
            applyFilter();
          });

          // Primera pasada + posicionar slider
          positionSlider(toggle);
          applyFilter();
        })();

        // === Buscador autom√°tico SOLO por T√çTULO ===
        // 1¬∫ prueba "empieza por"; si no hay resultados, cae a "contiene".
        (function mediaTitleSearchAuto() {
          const old = document.getElementById('media-search');
          if (!old) return;

          // Elimina el toggle si existiera (de la versi√≥n anterior)
          document.getElementById('media-search-mode')?.remove();

          // Clona el input para limpiar listeners previos
          const input = old.cloneNode(true);
          old.replaceWith(input);
          input.placeholder = 'Buscar por t√≠tulo‚Ä¶';

          // Normalizador: sin tildes, min√∫sculas
          const norm = (s) => (s || '')
            .toString()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .toLowerCase().trim();

          const needlesOf = (q) => norm(q).split(/\s+/).filter(Boolean);

          // Contiene: todas las palabras deben aparecer
          function matchContains(hay, needles) {
            if (needles.length === 0) return true;
            return needles.every(n => hay.includes(n));
          }

          // Empieza por: el t√≠tulo empieza por la frase completa
          //   o cada palabra coincide con el inicio de alguna palabra del t√≠tulo
          function matchStarts(hay, needles) {
            if (needles.length === 0) return true;
            const phrase = needles.join(' ');
            if (hay.startsWith(phrase)) return true;
            const words = hay.split(/\s+/);
            return needles.every(n => words.some(w => w.startsWith(n)));
          }

          // Aplica el filtro con el modo elegido y devuelve n¬∫ de visibles
          function applyWith(mode) {
            const nls = needlesOf(input.value);
            let total = 0;

            [
              ['#towatch-tab .media-grid', 'towatch'],
              ['#watched-tab .media-grid', 'watched']
            ].forEach(([sel, key]) => {
              const grid = document.querySelector(sel);
              if (!grid) return;

              grid.querySelectorAll('.media-card').forEach(card => {
                const hay = norm(card.dataset.title || '');
                const ok = nls.length === 0
                  ? true
                  : (mode === 'starts' ? matchStarts(hay, nls) : matchContains(hay, nls));
                card.style.display = ok ? '' : 'none';
                if (ok) total++;
              });

              // Si tienes repaginador, lo llamamos (si no existe, no pasa nada)
              if (typeof window.rePageMedia === 'function') {
                window.rePageMedia(key);
              }
            });

            return total;
          }

          function applyFilter() {
            const q = input.value.trim();
            if (!q) {
              applyWith('contains'); // vac√≠o = mostrar todo
              return;
            }
            // 1) intenta "empieza por"
            const hits = applyWith('starts');
            // 2) si no hay resultados, cae a "contiene"
            if (hits === 0) applyWith('contains');
          }

          input.addEventListener('input', applyFilter);
          // Primera pasada
          applyFilter();
        })();


        // === Buscador autom√°tico SOLO por T√çTULO (empieza por ‚Üí si 0 hits ‚Üí contiene) ===
        document.addEventListener('DOMContentLoaded', function mediaTitleSearchAutoFix() {
          const input = document.getElementById('media-search');
          if (!input) return;

          // Suaviza el placeholder si quieres
          try { if (!/t√≠tulo/i.test(input.placeholder)) input.placeholder = 'Buscar por t√≠tulo‚Ä¶'; } catch (e) { }

          // Normaliza: sin tildes, min√∫sculas
          const norm = (s) => (s || '')
            .toString()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .toLowerCase()
            .trim();

          const needlesOf = (q) => norm(q).split(/\s+/).filter(Boolean);

          function getGrids() {
            return [
              ['towatch', document.querySelector('#towatch-tab .media-grid')],
              ['watched', document.querySelector('#watched-tab .media-grid')]
            ].filter(([, g]) => !!g);
          }

          // Saca el t√≠tulo real (dataset o <h3>)
          function cardTitle(card) {
            const ds = card.dataset?.title || '';
            const h3 = card.querySelector?.('.media-title')?.textContent || '';
            return ds || h3 || '';
          }

          function matchContains(hay, needles) {
            if (needles.length === 0) return true;
            return needles.every(n => hay.includes(n));
          }

          // Empieza por: o el t√≠tulo entero empieza por la frase,
          // o cada palabra buscada casa con el inicio de alguna palabra del t√≠tulo
          function matchStarts(hay, needles) {
            if (needles.length === 0) return true;
            const phrase = needles.join(' ');
            if (hay.startsWith(phrase)) return true;
            const words = hay.split(/\s+/);
            return needles.every(n => words.some(w => w.startsWith(n)));
          }

          // Cuenta coincidencias sin tocar el display (para decidir el modo)
          function countMatches(needles, mode) {
            let total = 0;
            getGrids().forEach(([, grid]) => {
              grid.querySelectorAll('.media-card').forEach(card => {
                const hay = norm(cardTitle(card));
                const ok = needles.length === 0 ? true :
                  (mode === 'starts' ? matchStarts(hay, needles) : matchContains(hay, needles));
                if (ok) total++;
              });
            });
            return total;
          }

          // Aplica el display seg√∫n el modo final
          function applyDisplay(needles, mode) {
            getGrids().forEach(([key, grid]) => {
              grid.querySelectorAll('.media-card').forEach(card => {
                const hay = norm(cardTitle(card));
                const ok = needles.length === 0 ? true :
                  (mode === 'starts' ? matchStarts(hay, needles) : matchContains(hay, needles));
                card.style.display = ok ? '' : 'none';
              });
              // Si tienes repaginador, lo llamamos sin romper nada si no existe
              if (typeof window.rePageMedia === 'function') {
                try { window.rePageMedia(key); } catch (e) { }
              }
            });
          }

          function applyFilter() {
            const q = input.value || '';
            const needles = needlesOf(q);

            // Sin texto: mostrar todo
            if (needles.length === 0) {
              applyDisplay(needles, 'contains');
              return;
            }

            // 1) Intentar "empieza por" (sin pintar)
            const hitsStarts = countMatches(needles, 'starts');

            // 2) Si 0 resultados, caer a "contiene"; si no, mantener "empieza por"
            const mode = (hitsStarts > 0) ? 'starts' : 'contains';
            applyDisplay(needles, mode);
          }

          // Evita duplicar listeners si ya hab√≠a uno
          if (!input.dataset.titleSearchAutoBound) {
            input.addEventListener('input', applyFilter);
            input.dataset.titleSearchAutoBound = '1';
          }

          // Reaplicar al cambiar de pesta√±a por si el DOM oculta/ense√±a tarjetas
          document.addEventListener('click', (e) => {
            const tab = e.target.closest?.('.media-tab');
            if (tab) setTimeout(applyFilter, 0);
          });

          // Primera pasada
          applyFilter();
        });



      </script>



      <!-- NAVIDAD (tema) se puede borrar-->

      <script>
        (function () {
          // --- Config / refs
          var ROOT = document.documentElement;
          var BODY = document.body;
          var META = document.querySelector('meta[name="theme-color"]');

          // Ajusta esta ruta a tu GIF (R‚ÜíL). En Jinja:
          var sleighGif = "{{ url_for('static', filename='icons/papa_noel.gif') }}";

          // Estado interno
          var stage = null;
          var snowWrap = null;
          var sleighEl = null;
          var snowTimer = null;
          var nextFlyTimer = null;

          // --- Temporada: 1 dic ‚Äì 8 ene (inclusive)
          function inSeason(d) {
            d = d || new Date();
            var m = d.getMonth();  // 0..11
            var day = d.getDate();
            return (m === 11 && day >= 1) || (m === 0 && day <= 8);
          }
          function msToNextCheck() {
            var now = new Date();
            // Siguiente 00:01 local
            var next = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 1, 0, 0);
            return next - now;
          }

          // --- Utils
          function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }
          function rand(min, max) { return min + Math.random() * (max - min); }
          function lerp(a, b, t) { return a + (b - a) * t; }

          // --- Stage global para los efectos (nieve + trineo)
          function ensureStage() {
            if (!stage) {
              stage = document.getElementById('xmas-stage');
              if (!stage) {
                stage = document.createElement('div');
                stage.id = 'xmas-stage';
                stage.setAttribute('aria-hidden', 'true');
                stage.style.pointerEvents = 'none';
                BODY.prepend(stage);
              }
            }
            return stage;
          }

          // --- Nieve
          function ensureSnowWrap() {
            ensureStage();
            if (!snowWrap) {
              snowWrap = document.getElementById('xmas-snow');
              if (!snowWrap) {
                snowWrap = document.createElement('div');
                snowWrap.id = 'xmas-snow';
              } else {
                snowWrap.remove(); // re-insert para limpiar
              }
              stage.appendChild(snowWrap);
            }
          }
          function spawnFlake() {
            if (!snowWrap) return;
            var f = document.createElement('div');
            f.className = 'snowflake';
            f.textContent = '‚ùÑ';
            f.style.left = (Math.random() * 100) + 'vw';
            f.style.fontSize = (10 + Math.random() * 16) + 'px';
            f.style.animationDuration = (6 + Math.random() * 8) + 's';
            f.style.setProperty('--x', (Math.random() * 80 - 40) + 'px');
            f.addEventListener('animationend', function () { f.remove(); });
            snowWrap.appendChild(f);
          }
          function startSnow() {
            ensureSnowWrap();
            if (snowTimer) clearInterval(snowTimer);
            // r√°faga inicial
            for (var i = 0; i < 60; i++) spawnFlake();
            // flujo continuo
            snowTimer = setInterval(function () {
              for (var j = 0; j < 4; j++) spawnFlake();
            }, 500);
          }
          function stopSnow() {
            if (snowTimer) clearInterval(snowTimer);
            snowTimer = null;
            if (snowWrap) {
              var nodes = snowWrap.querySelectorAll('.snowflake');
              for (var i = 0; i < nodes.length; i++) nodes[i].remove();
            }
          }

          // --- Trineo
          function ensureSleigh() {
            ensureStage();
            if (!sleighEl) {
              sleighEl = document.getElementById('xmas-sleigh');
              if (!sleighEl) {
                sleighEl = document.createElement('div');
                sleighEl.id = 'xmas-sleigh';
              } else {
                sleighEl.remove(); // re-insert para resetear animaci√≥n
              }
              sleighEl.style.background = 'center / contain no-repeat';
              sleighEl.style.pointerEvents = 'none';
              sleighEl.style.opacity = '0';
              stage.appendChild(sleighEl);
            }
            // Aplica/actualiza el GIF
            if (sleighGif) sleighEl.style.backgroundImage = 'url("' + sleighGif + '")';
          }

          function flyOnce() {
            ensureSleigh();

            var vw = window.innerWidth, vh = window.innerHeight;
            var w = sleighEl.offsetWidth || vw * 0.28;
            var h = sleighEl.offsetHeight || vh * 0.18;

            // Direcci√≥n fija: derecha ‚Üí izquierda
            var fromLeft = false;
            var sx = 1; // tu GIF ya es R‚ÜíL (si tu GIF fuera L‚ÜíR, usa -1)

            var yStart = rand(0.08 * vh, 0.80 * vh);
            var yDrift = (Math.random() < 0.65) ? rand(-0.22 * vh, 0.22 * vh) : 0;
            var yEnd = clamp(yStart + yDrift, 0.06 * vh, 0.86 * vh);

            var xStart = (vw + 40);
            var xEnd = (-w - 40);

            var duration = 8000 + Math.random() * 7000;  // 8‚Äì15 s
            var pause = 2000 + Math.random() * 4000;  // 2‚Äì6 s

            if (sleighEl.animate) {
              sleighEl.style.opacity = 1;
              var frames = [
                { transform: `translate(${xStart}px, ${yStart}px) scaleX(${sx})`, opacity: 0 },
                { transform: `translate(${lerp(xStart, xEnd, 0.1)}px, ${lerp(yStart, yEnd, 0.1)}px) scaleX(${sx})`, opacity: 1, offset: 0.1 },
                (Math.random() < 0.5) ? { transform: `translate(${lerp(xStart, xEnd, 0.5)}px, ${lerp(yStart, yEnd, 0.5) + rand(-0.12 * vh, 0.12 * vh)}px) scaleX(${sx})`, opacity: 1, offset: 0.5 } : null,
                { transform: `translate(${lerp(xStart, xEnd, 0.9)}px, ${lerp(yStart, yEnd, 0.9)}px) scaleX(${sx})`, opacity: 1, offset: 0.9 },
                { transform: `translate(${xEnd}px, ${yEnd}px) scaleX(${sx})`, opacity: 0 }
              ].filter(Boolean);

              var anim = sleighEl.animate(frames, { duration: duration, easing: 'linear', fill: 'forwards' });
              anim.onfinish = function () {
                sleighEl.style.opacity = 0;
                if (nextFlyTimer) clearTimeout(nextFlyTimer);
                nextFlyTimer = setTimeout(flyOnce, pause);
              };
            } else {
              // Fallback CSS keyframes
              sleighEl.style.top = yStart + 'px';
              sleighEl.style.animation = 'none'; void sleighEl.offsetWidth;
              sleighEl.style.animation = 'sleigh-rtl ' + (duration / 1000) + 's linear 1';
              sleighEl.onanimationend = function () {
                sleighEl.style.opacity = 0;
                if (nextFlyTimer) clearTimeout(nextFlyTimer);
                nextFlyTimer = setTimeout(flyOnce, pause);
              };
            }
          }

          function startSleigh() {
            ensureSleigh();
            if (nextFlyTimer) clearTimeout(nextFlyTimer);
            flyOnce();
          }
          function stopSleigh() {
            if (nextFlyTimer) clearTimeout(nextFlyTimer);
            nextFlyTimer = null;
            if (sleighEl) {
              sleighEl.remove();
              sleighEl = null;
            }
          }

          // --- Lucecitas rojas en el banner (usa tu .xmas-lights del CSS)
          function addLights() {
            var banner = document.querySelector('.section.banner');
            if (banner && !document.getElementById('xmasLights')) {
              var d = document.createElement('div');
              d.id = 'xmasLights';
              d.className = 'xmas-lights';
              banner.appendChild(d);
            }
          }
          function removeLights() {
            var l = document.getElementById('xmasLights');
            if (l) l.remove();
          }

          // --- On/Off tema navidad
          function enable(gifUrl) {
            if (gifUrl) sleighGif = gifUrl;
            ROOT.setAttribute('data-theme', 'xmas');
            BODY.setAttribute('data-theme', 'xmas');
            if (META) META.setAttribute('content', '#c9182a'); // rojo navbar en PWA
            // quita gorro si existiera
            var hat = document.querySelector('.banner-overlay .santa-hat');
            if (hat) hat.remove();

            addLights();
            startSnow();
            startSleigh();
          }
          function disable() {
            ROOT.removeAttribute('data-theme');
            BODY.removeAttribute('data-theme');
            if (META) META.setAttribute('content', '#e84393'); // color base de tu app
            stopSnow();
            stopSleigh();
            removeLights();
          }
          function setSleigh(url) {
            if (!url) return;
            sleighGif = url;
            if (sleighEl) sleighEl.style.backgroundImage = 'url("' + url + '")';
          }
          function updateBySchedule() {
            if (inSeason()) enable(); else disable();
          }

          // --- API global
          window.XMAS = {
            enable: enable,
            disable: disable,
            setSleigh: setSleigh,
            fly: flyOnce,
            snow: { start: startSnow, stop: stopSnow }
          };

          // --- Auto por fechas + re-chequeo diario + bot√≥n opcional .xmas-toggle
          document.addEventListener('DOMContentLoaded', function () {
            updateBySchedule();
            var ms = msToNextCheck();
            setTimeout(function tick() {
              updateBySchedule();
              setTimeout(tick, msToNextCheck());
            }, ms);

            var toggleBtn = document.querySelector('.xmas-toggle');
            if (toggleBtn) {
              toggleBtn.addEventListener('click', function () {
                var on = ROOT.getAttribute('data-theme') === 'xmas' || BODY.getAttribute('data-theme') === 'xmas';
                if (on) { disable(); this.setAttribute('aria-pressed', 'false'); }
                else { enable(); this.setAttribute('aria-pressed', 'true'); }
              });
            }
          });
        })();
      </script>


      <script>
        (async function () {
          async function fetchPoints(user) {
            try {
              const r = await fetch(`/api/points?user=${encodeURIComponent(user)}`, { credentials: 'same-origin' });
              if (!r.ok) return null;
              const j = await r.json();
              return (j && j.ok && typeof j.points === 'number') ? j.points : null;
            } catch (e) { return null; }
          }

          // Inicial: ya est√°n los valores del servidor.
          // Hidrataci√≥n: refrescamos cada <b data-user="...">
          const els = document.querySelectorAll('.points-chip b[data-user]');
          for (const el of els) {
            const u = el.getAttribute('data-user');
            const pts = await fetchPoints(u);
            if (pts !== null) el.textContent = pts;
          }
        })();
      </script>

      <script>
        window.addEventListener('load', function () {
          setTimeout(function () {
            document.body.classList.remove('loading');
            document.body.classList.add('loaded');
          }, 800);
        });

      </script>
      {% if username in ('mochito','mochita') %}
      <button onclick="location.href='/push/debug'" class="debug-fab" aria-label="Debug push">üîß
        Notificaciones</button>
      <style>
        .debug-fab {
          position: fixed;
          right: 16px;
          bottom: 16px;
          z-index: 9999;
          padding: 10px 12px;
          background: rgba(232, 67, 147, .4);
          color: #fff;
          border-radius: 999px;
          text-decoration: none;
          opacity: .85;
          font: 600 14px system-ui;
        }
      </style>
      {% endif %}
      {% if username %}
      <button id="openWheelBtn" class="floating-wheel-btn" type="button" aria-label="Ruleta diaria">
        üé°
      </button>

      <div id="dailyWheelModal" class="daily-wheel-modal" aria-hidden="true">
        <div class="daily-wheel-card">
          <button id="closeWheelBtn" class="dw-close-btn" type="button" aria-label="Cerrar">
            <i class="fas fa-times"></i>
          </button>

          <div class="dw-header">
            <div class="dw-header-icon">üéÅ</div>
            <div>
              <h2>Ruleta diaria de puntos</h2>
              <p class="dw-sub">
                Cada d√≠a un giro por persona. A ver qu√© cae hoy. üíñ
              </p>
              <span class="dw-chip">Gamificaci√≥n</span>
            </div>
          </div>

          <div class="dw-wheel-wrap">
            <div class="dw-pointer"></div>
            <div id="dailyWheel" class="dw-wheel">
              <div class="dw-seg-label dw-seg-0">üò¥ 0</div>
              <div class="dw-seg-label dw-seg-1">‚ú® +5</div>
              <div class="dw-seg-label dw-seg-2">üíñ +10</div>
              <div class="dw-seg-label dw-seg-3">üåà +20</div>
              <div class="dw-seg-label dw-seg-4">üíé +50</div>
              <div class="dw-seg-label dw-seg-5">üëë +100</div>

              <div class="dw-center">
                <span>üé°</span>
              </div>
            </div>
          </div>

          <div class="dw-actions">
            <button id="dailyWheelSpinBtn" type="button" class="dw-spin-btn">
              <i class="fas fa-sync-alt"></i> Girar ahora
            </button>
            <div class="dw-status" id="dailyWheelStatus"></div>
            <div class="dw-timer" id="dailyWheelTimer"></div>
            <div class="dw-result" id="dailyWheelResult"></div>
            <div class="dw-partner" id="dailyWheelPartner"></div>
          </div>

          <p class="dw-footer">
            Se desbloquea cada d√≠a a una hora aleatoria entre las 09:00 y las 22:00 (hora Espa√±a).
            Si ya has girado hoy, ver√°s tu resultado guardado.
          </p>

        </div>
      </div>
      {% endif %}


      {% if username is defined and username %}
      <script>
        // === Ruleta diaria (JS) ===
        (function () {
          const modal = document.getElementById('dailyWheelModal');
          const openBtn = document.getElementById('openWheelBtn');
          const closeBtn = document.getElementById('closeWheelBtn');
          const wheel = document.getElementById('dailyWheel');
          const spinBtn = document.getElementById('dailyWheelSpinBtn');
          const statusEl = document.getElementById('dailyWheelStatus');
          const timerEl = document.getElementById('dailyWheelTimer');
          const resultEl = document.getElementById('dailyWheelResult');
          const partnerEl = document.getElementById('dailyWheelPartner');

          if (!modal || !openBtn || !closeBtn || !wheel || !spinBtn) return;

          const N_SEGMENTS = 6;
          const SEG_ANGLE = 360 / N_SEGMENTS; // 60¬∫
          let currentRotation = 0;
          let countdownId = null;

          function startWheelCountdown(nextResetIso, canSpinNow) {
            if (!timerEl) {
              if (countdownId) clearInterval(countdownId);
              countdownId = null;
              return;
            }
            if (!nextResetIso) {
              timerEl.textContent = '';
              if (countdownId) clearInterval(countdownId);
              countdownId = null;
              return;
            }
            const targetMs = new Date(nextResetIso).getTime();
            if (!isFinite(targetMs)) {
              return;
            }
            if (countdownId) clearInterval(countdownId);

            function tick() {
              const now = Date.now();
              let diff = Math.floor((targetMs - now) / 1000);
              if (diff <= 0) {
                if (canSpinNow) {
                  timerEl.textContent = 'La ruleta est√° a punto de resetearse‚Ä¶ ‚ú®';
                  clearInterval(countdownId);
                  countdownId = null;
                } else {
                  timerEl.textContent = 'La ruleta deber√≠a desbloquearse ya‚Ä¶ recarga si no la ves.';
                  clearInterval(countdownId);
                  countdownId = null;
                  setTimeout(() => location.reload(), 800);
                }
                return;
              }
              const h = String(Math.floor(diff / 3600)).padStart(2, '0');
              const m = String(Math.floor((diff % 3600) / 60)).padStart(2, '0');
              const s = String(diff % 60).padStart(2, '0');
              timerEl.textContent = canSpinNow
                ? `Pr√≥ximo reset en ${h}:${m}:${s}`
                : `Disponible en ${h}:${m}:${s}`;
            }

            tick();
            countdownId = setInterval(tick, 1000);
          }

          // === Avatares y nombres (inyectados desde Jinja) ===
          const SELF_NAME = "{{ username }}";
          const SELF_AVATAR_HTML = `{% if profile_pictures.get(username) %}
    <img src="{{ profile_pictures.get(username) }}" alt="{{ username }}">
  {% else %}
    {{ (username or '?')[0] | upper }}
  {% endif %}`;

          {% if username == 'mochito' %}
          const PARTNER_NAME = "mochita";
          const PARTNER_AVATAR_HTML = `{% if profile_pictures.get('mochita') %}
      <img src="{{ profile_pictures.get('mochita') }}" alt="mochita">
    {% else %}
      M
    {% endif %}`;
          {% elif username == 'mochita' %}
          const PARTNER_NAME = "mochito";
          const PARTNER_AVATAR_HTML = `{% if profile_pictures.get('mochito') %}
      <img src="{{ profile_pictures.get('mochito') }}" alt="mochito">
    {% else %}
      M
    {% endif %}`;
          {% else %}
          const PARTNER_NAME = "";
          const PARTNER_AVATAR_HTML = "";
          {% endif %}

          // === √Ångulo correcto (ya probado) ===
          // El backend manda idx (0..5), pero vimos que la ruleta se quedaba
          // un sector por delante ‚Üí usamos idxVisual = idx - 1.
          function angleForIndex(idx) {
            if (typeof idx !== "number" || !isFinite(idx)) idx = 0;
            idx = Math.round(idx);
            const n = N_SEGMENTS;
            let idxVisual = idx - 1;
            idxVisual = ((idxVisual % n) + n) % n; // 0..5
            return -SEG_ANGLE * idxVisual;         // 0, -60, -120, ...
          }

          // === Helpers para pintar l√≠neas con avatar ===
          function renderSelfLine(text) {
            if (!resultEl) return;
            resultEl.innerHTML = `
      <div class="dw-user-line">
        <div class="user-avatar dw-user-avatar">
          ${SELF_AVATAR_HTML}
        </div>
        <div class="dw-line-text">${text}</div>
      </div>
    `;
          }


          function formatDateShort(iso) {
            if (!iso) return "";
            const d = new Date(iso);
            if (Number.isNaN(d.getTime())) return iso;
            const dd = String(d.getDate()).padStart(2, "0");
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            return `${dd}/${mm}`;
          }


          function renderPartnerLine(other, otherLast) {
            if (!partnerEl || !PARTNER_NAME) return;

            const hasToday = other && other.has_spun;
            const hasLast = otherLast && otherLast.has_spun;

            // No hay info de nada
            if (!hasToday && !hasLast) {
              partnerEl.innerHTML = `
        <div class="dw-user-line">
          <div class="user-avatar dw-user-avatar">
            ${PARTNER_AVATAR_HTML}
          </div>
          <div class="dw-line-text">
            ${PARTNER_NAME} todav√≠a no ha usado la ruleta üòá
          </div>
        </div>
      `;
              return;
            }

            // Tiene giro de HOY
            if (hasToday) {
              const delta = other.delta ?? 0;
              const label = other.label ?? (delta >= 0 ? `+${delta}` : String(delta));
              partnerEl.innerHTML = `
        <div class="dw-user-line">
          <div class="user-avatar dw-user-avatar">
            ${PARTNER_AVATAR_HTML}
          </div>
          <div class="dw-line-text">
            ${PARTNER_NAME} hoy ha conseguido ${label} puntos.
          </div>
        </div>
      `;
              return;
            }

            // No ha girado hoy, pero s√≠ otro d√≠a
            const deltaL = otherLast.delta ?? 0;
            const labelL = otherLast.label ?? (deltaL >= 0 ? `+${deltaL}` : String(deltaL));
            const dateTxt = otherLast.date ? formatDateShort(otherLast.date) : "";

            partnerEl.innerHTML = `
      <div class="dw-user-line">
        <div class="user-avatar dw-user-avatar">
          ${PARTNER_AVATAR_HTML}
        </div>
        <div class="dw-line-text">
          ${PARTNER_NAME} a√∫n no ha girado la ruleta hoy.
          ${dateTxt ? ` √öltimo giro (${dateTxt}): ${labelL} puntos.` : ""}
        </div>
      </div>
    `;
          }


          function openModal() {
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
            loadStatus();
          }
          function closeModal() {
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
          }

          openBtn.addEventListener('click', openModal);
          closeBtn.addEventListener('click', closeModal);
          modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
          });

          function showToast(type, msg) {
            if (window.showToast) {
              window.showToast(type, msg);
            } else {
              alert(msg);
            }
          }

          // === Cargar estado al abrir ===
          async function loadStatus() {
            statusEl.textContent = '';
            if (timerEl) timerEl.textContent = '';
            resultEl.textContent = '';
            if (partnerEl) partnerEl.textContent = '';

            try {
              const resp = await fetch('/api/daily-wheel-status', {
                headers: { 'Accept': 'application/json' }
              });
              if (!resp.ok) return;
              const data = await resp.json().catch(() => ({}));
              if (!data.ok) return;

              const me = data.me || {};
              const other = data.other || null;
              const meLast = data.me_last || null;
              const otherLast = data.other_last || null;

              const canSpinNow = !!data.can_spin_now;
              const nextResetIso = data.next_reset_iso || null;

              renderPartnerLine(other, otherLast);


              if (me.has_spun) {
                const idx = (typeof me.idx === 'number') ? me.idx : 0;
                const delta = me.delta ?? 0;
                const label = me.label ?? (delta >= 0 ? `+${delta}` : String(delta));

                const base = angleForIndex(idx);
                currentRotation = base;
                wheel.style.transition = 'none';
                wheel.style.transform = `rotate(${currentRotation}deg)`;

                spinBtn.disabled = true;
                spinBtn.classList.add('used');
                spinBtn.innerHTML = 'Ya la has usado hoy';
                statusEl.textContent = 'Hoy ya has girado la ruleta üíñ';

                renderSelfLine(`Resultado de hoy: ${label} puntos`);
              } else {
                if (!canSpinNow) {
                  spinBtn.disabled = true;
                  spinBtn.classList.remove('used');
                  spinBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Girar ahora';
                  statusEl.textContent = 'La ruleta a√∫n no est√° disponible üïí';
                } else {
                  spinBtn.disabled = false;
                  spinBtn.classList.remove('used');
                  spinBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Girar ahora';
                  statusEl.textContent = 'Tienes un giro disponible hoy ‚ú®';
                }

                // Mostrar √∫ltimo resultado aunque sea de ayer
                if (meLast && meLast.has_spun) {
                  const deltaL = meLast.delta ?? 0;
                  const labelL = meLast.label ?? (deltaL >= 0 ? `+${deltaL}` : String(deltaL));
                  const dateTxt = meLast.date ? formatDateShort(meLast.date) : "";
                  const txt = dateTxt
                    ? `√öltimo resultado (${dateTxt}): ${labelL} puntos`
                    : `√öltimo resultado: ${labelL} puntos`;
                  renderSelfLine(txt);
                }
              }

              startWheelCountdown(nextResetIso, canSpinNow);
            } catch (e) {
              console.error(e);
            }
          }

          // === Girar ===
          async function spin() {
            if (spinBtn.disabled) return;

            spinBtn.disabled = true;
            spinBtn.classList.remove('used');
            spinBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Girando‚Ä¶';
            statusEl.textContent = 'Girando la ruleta‚Ä¶';
            resultEl.textContent = '';

            try {
              const resp = await fetch('/api/daily-wheel-spin', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Accept': 'application/json'
                }
              });

              const data = await resp.json().catch(() => ({}));

              if (!resp.ok || !data.ok) {
                const msg = data.error || 'No se ha podido girar la ruleta.';
                showToast('error', msg);

                // Si el backend ya nos manda info de tiempos, actualizamos el contador
                if (typeof data.can_spin_now !== 'undefined' && data.next_reset_iso) {
                  startWheelCountdown(data.next_reset_iso, !!data.can_spin_now);
                }

                spinBtn.disabled = false;
                spinBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Girar ahora';
                // Dejamos statusEl como est√©; loadStatus se encarga al abrir.
                return;
              }


              renderPartnerLine(data.other || null, data.other_last || null);

              // Ya hab√≠a girado hoy (sin animar otra vez)
              if (data.already) {
                const idx = (typeof data.idx === 'number') ? data.idx : 0;
                const delta = data.delta ?? 0;
                const label = data.label ?? (delta >= 0 ? `+${delta}` : String(delta));

                const base = angleForIndex(idx);
                currentRotation = base;
                wheel.style.transition = 'none';
                wheel.style.transform = `rotate(${currentRotation}deg)`;

                spinBtn.innerHTML = 'Ya la has usado hoy';
                spinBtn.classList.add('used');
                statusEl.textContent = 'Hoy ya has girado la ruleta üíñ';

                renderSelfLine(`Resultado de hoy: ${label} puntos`);
                return;
              }

              // Giro nuevo
              const idx = (typeof data.idx === 'number') ? data.idx : 0;
              const delta = data.delta ?? 0;
              const label = data.label ?? (delta >= 0 ? `+${delta}` : String(delta));
              const total = (typeof data.new_total === 'number') ? data.new_total : null;

              const rounds = 4 + Math.floor(Math.random() * 2); // 4 √≥ 5 vueltas
              const base = angleForIndex(idx);
              const target = 360 * rounds + base;

              currentRotation = target;

              wheel.style.transition = 'none';
              wheel.offsetHeight; // reflow
              wheel.style.transition = 'transform 4s cubic-bezier(0.17, 0.89, 0.32, 1.28)';
              wheel.style.transform = `rotate(${currentRotation}deg)`;

              setTimeout(() => {
                spinBtn.classList.add('used');
                spinBtn.innerHTML = 'Ma√±ana m√°s ‚ù§Ô∏è';
                statusEl.textContent = 'Ruleta usada por hoy';

                if (delta === 0) {
                  renderSelfLine('Hoy no han ca√≠do puntos‚Ä¶ ¬°ma√±ana m√°s suerte!');
                } else {
                  const txt = total !== null
                    ? `¬°Has ganado ${delta} puntos y ahora tienes ${total} en total!`
                    : `¬°Has ganado ${delta} puntos!`;
                  renderSelfLine(txt);
                }

                try {
                  fetch('/api/daily-wheel-push-self', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }
                  }).catch(() => { });
                } catch (_) { }

                // üîÅ actualizamos el contador al siguiente reset
                if (data.next_reset_iso) {
                  startWheelCountdown(data.next_reset_iso, true);
                }
              }, 4000);


            } catch (e) {
              console.error(e);
              showToast('error', 'Error de conexi√≥n al girar la ruleta.');
              spinBtn.disabled = false;
              spinBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Girar ahora';
              statusEl.textContent = '';
            }
          }

          spinBtn.addEventListener('click', spin);
        })();
      </script>
      {% endif %}





      <!-- COMENTAR PARA QUITAR TEMA DE NAVIDAD -->

      <script>
        document.addEventListener('DOMContentLoaded', function () {
          // 1. Forzar el tema rojo (CSS)
          document.documentElement.setAttribute('data-theme', 'xmas');
          document.body.setAttribute('data-theme', 'xmas');

          // 2. Forzar la nieve y el trineo (JS)
          // Usamos un peque√±o timeout para asegurar que window.XMAS existe
          setTimeout(function () {
            if (window.XMAS) {
              window.XMAS.enable();
              // Si quieres otro GIF de trineo, pon la URL dentro de enable('URL')
            }
          }, 500);
        });
      </script>


      <script>
        // === L√≥gica Historial MochiReal con Paginaci√≥n ===
        (function () {
          let allHistoryData = []; // Guardamos todos los datos aqu√≠
          let currentPage = 1;
          const ITEMS_PER_PAGE = 5; // D√≠as por p√°gina

          // Funci√≥n principal para abrir el historial
          window.openMochiHistory = async function () {
            // 1. Ocultar vista principal, mostrar historial
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const page = document.getElementById('page-mr-history');
            if (page) {
              page.style.display = 'block'; // Asegurar display
              page.classList.add('active');
            }
            window.scrollTo(0, 0);

            // 2. Si ya tenemos datos, solo renderizamos la p√°gina 1
            if (allHistoryData.length > 0) {
              renderHistoryPage();
              return;
            }

            // 3. Si no, cargamos del servidor
            const container = document.getElementById('mr-history-content');
            container.innerHTML = '<div style="text-align:center; padding:40px;"><i class="fas fa-spinner fa-spin fa-2x" style="color:var(--primary-color)"></i><p>Recuperando recuerdos...</p></div>';

            try {
              const r = await fetch('/api/mochireal/history');
              const data = await r.json();

              if (!data.ok || !data.history || data.history.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:20px; color:#888;">No hay recuerdos guardados a√∫n.</p>';
                document.getElementById('mr-history-pager').style.display = 'none';
                return;
              }

              // Guardamos datos y reseteamos a p√°gina 1
              allHistoryData = data.history;
              currentPage = 1;
              renderHistoryPage();

            } catch (e) {
              console.error(e);
              container.innerHTML = '<p style="text-align:center; color:salmon;">Error cargando recuerdos. Int√©ntalo luego.</p>';
            }
          };

          // Funci√≥n para cerrar y volver a MochiReal principal
          window.closeMochiHistory = function () {
            const histPage = document.getElementById('page-mr-history');
            if (histPage) {
              histPage.classList.remove('active');
              histPage.style.display = 'none';
            }
            // Volver a la pantalla "mochireal" usando tu router existente
            if (typeof setScreen === 'function') {
              setScreen('mochireal');
            }
          };

          // Renderiza la p√°gina actual
          function renderHistoryPage() {
            const container = document.getElementById('mr-history-content');
            const pager = document.getElementById('mr-history-pager');
            const indicator = document.getElementById('mr-page-indicator');
            const btnPrev = document.getElementById('mr-btn-prev');
            const btnNext = document.getElementById('mr-btn-next');

            // Calcular √≠ndices
            const totalItems = allHistoryData.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

            // Validar p√°gina actual
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;

            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, totalItems);

            // Slice de datos para esta p√°gina
            const pageItems = allHistoryData.slice(startIndex, endIndex);

            // Generar HTML
            let html = '';
            pageItems.forEach(day => {
              // Formatear fecha
              const d = new Date(day.date);
              const dateStr = d.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });

              let postsHtml = '';
              day.posts.forEach(post => {
                postsHtml += `
            <div class="mr-history-photo">
                <img src="/mochireal/image/${post.post_id}" loading="lazy" onclick="window.open(this.src, '_blank')">
                <div class="mr-history-user">${post.username}</div>
            </div>
          `;
              });

              html += `
          <div class="mr-day-card animate-in">
              <div class="mr-day-header">
                  <div class="mr-date-label"><i class="far fa-calendar-alt"></i> ${dateStr}</div>
                  <div class="mr-time-badge"><i class="far fa-clock"></i> ${day.time}</div>
              </div>
              <div class="mr-day-grid">
                  ${postsHtml}
              </div>
          </div>
        `;
            });

            container.innerHTML = html;
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Actualizar UI de Paginaci√≥n
            if (totalPages > 1) {
              pager.style.display = 'flex';
              indicator.textContent = `P√°gina ${currentPage} de ${totalPages}`;

              btnPrev.disabled = (currentPage === 1);
              btnNext.disabled = (currentPage === totalPages);

              // Eventos (limpiamos anteriores para no duplicar)
              btnPrev.onclick = () => { currentPage--; renderHistoryPage(); };
              btnNext.onclick = () => { currentPage++; renderHistoryPage(); };
            } else {
              pager.style.display = 'none';
              indicator.textContent = '';
            }
          }

          // Funci√≥n del router para carga perezosa (si se accede directamente)
          window.ensureMochiRealHistoryLoaded = function () {
            // En este dise√±o, preferimos que cargue al pulsar el bot√≥n "Ver recuerdos"
            // as√≠ que lo dejamos vac√≠o o precargamos sin mostrar.
          };
        })();
      </script>





</body>

</html>
