<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Regla - Mochita</title>
<link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">

<style>
@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Dancing+Script:wght@700&display=swap');

:root{
  --primary:#e84393; --secondary:#fd79a8; --accent:#a29bfe;
  --ink:#2d3436; --muted:#6b7280; --card:#fff; --line:#eee;
  --shadow:0 15px 30px rgba(0,0,0,.08);
  --gradient:linear-gradient(135deg,#e84393,#fd79a8 50%,#a29bfe);
  --flow-none:#e5e7eb; --flow-low:#60a5fa; --flow-mid:#f59e0b; --flow-high:#ef4444;
  --secondary-color:var(--accent);
}

*{box-sizing:border-box}
html,body{margin:0;padding:0}
body{
  font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  color:var(--ink); background:linear-gradient(135deg,#ffe8f3,#dfe6e9); min-height:100vh; padding:16px;
}

/* Contenedor y cabecera */
.container{
  background:var(--card); border-radius:20px; box-shadow:var(--shadow);
  overflow:hidden; max-width:1100px; margin:24px auto; border:1px solid rgba(255,255,255,.6);
}
.container > h1{
  font-family:'Dancing Script',cursive; font-size:42px; margin:0; padding:22px 16px 8px;
  text-align:center; background:var(--gradient); -webkit-background-clip:text; background-clip:text;
  color:transparent; text-shadow:0 3px 6px rgba(0,0,0,.15);
}
.subtitle{
  margin:0 0 18px; text-align:center; color:#fff; padding:0 16px 18px;
  background:var(--gradient); border-bottom:1px solid rgba(255,255,255,.3); font-weight:600; opacity:.95;
}

/* Tarjetas */
.card{ background:#fff; border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:var(--shadow); margin:18px; }

/* Toolbar */
.toolbar{
  display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:space-between;
  background:#fafafa; border:1px solid #eee; border-radius:16px; padding:14px 16px; box-shadow:0 6px 14px rgba(0,0,0,.05);
}
.toolbar .left,.toolbar .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.pill{
  padding:10px 14px; border:none; border-radius:999px; background:#eee; font-weight:700; cursor:pointer;
  transition:.2s; box-shadow:0 6px 14px rgba(0,0,0,.06);
}
.pill:hover{ transform:translateY(-2px) }
.pill.primary{ color:#fff; background:var(--primary) }
.pill.accent{ color:#fff; background:var(--accent) }
.pill.danger{ color:#fff; background:#ff7675 }
.pill[disabled]{ opacity:.55; cursor:not-allowed; transform:none }
select.pill{ background:#fff; border:2px solid #eee; }

/* Calendario */
.cal-head{ display:flex; align-items:center; gap:10px; margin-bottom:10px; padding:4px 0 8px; border-bottom:1px solid #f0f0f0; }
.arrow{
  width:40px; height:40px; border:none; border-radius:12px; background:#fff; cursor:pointer; display:grid; place-items:center;
  box-shadow:0 6px 14px rgba(0,0,0,.06); transition:.2s;
}
.arrow:hover{ transform:translateY(-2px); background:#f7f7f7 }
.month-title{ font-weight:800; font-size:1.15rem }

.week{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-bottom:8px; color:#6b7280; font-weight:700; text-transform:uppercase; font-size:.85rem }
.grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:8px }
.day{
  position:relative; background:#fff; border:1px solid #eee; border-radius:14px;
  min-height:110px; padding:10px; display:flex; flex-direction:column; gap:6px;
  box-shadow:0 6px 14px rgba(0,0,0,.04); transition:.15s;
}
.day:hover{ transform:translateY(-2px); box-shadow:0 10px 22px rgba(0,0,0,.08) }
.day.muted{ background:#fafafa }
.day.today{ outline:2px dashed var(--secondary-color); outline-offset:-6px; background:#fcfcff }
.day .top{ display:flex; align-items:center; justify-content:space-between; gap:6px; }
.day .num{ font-weight:800 }

/* Etiquetas Inicio/Fin (chips bajo el número) */
.labels{ display:flex; gap:6px; flex-wrap:wrap; }
.label-chip{ font-size:.75rem; padding:3px 8px; border-radius:999px; border:1px solid; font-weight:800; }
.label-chip.start{ background:#ffe4e6; border-color:#fecdd3; color:#9f1239 }
.label-chip.end{   background:#ede9fe; border-color:#ddd6fe; color:#4c1d95 }

/* Botón de ánimo */
.mood-btn{
  min-width:34px; height:28px; padding:0 8px; border:none; border-radius:999px; background:#f5f5f5; cursor:pointer;
  font-weight:800; display:flex; align-items:center; justify-content:center; box-shadow:0 1px 4px rgba(0,0,0,.06);
  opacity:.95;
}
.mood-btn[disabled]{ opacity:.5; cursor:not-allowed }
.mood-btn:hover{ filter:brightness(1.02) }

/* Menús inline */
.menu{
  position:absolute; left:10px; right:10px; bottom:10px; z-index:5; display:none;
  background:#fff; border:1px solid #eee; border-radius:12px; padding:8px; box-shadow:0 16px 40px rgba(0,0,0,.15);
}
.menu .row{ display:flex; gap:8px; flex-wrap:wrap; }
.menu .chip{
  padding:8px 10px; border-radius:999px; border:1px solid #eee; background:#fafafa; font-weight:700; cursor:pointer;
}
.menu .chip:hover{ filter:brightness(1.03) }
.day.show-flow-menu .flow-menu{ display:block }
.day.show-emoji-menu .emoji-menu{ display:block }

/* Barra de flujo (clicable) */
.flow-dot{ width:100%; height:12px; border-radius:7px; background:var(--flow-none); margin-top:auto; border:1px solid rgba(0,0,0,.05); cursor:pointer }
.flow-low{  background:var(--flow-low) }
.flow-mid{  background:var(--flow-mid) }
.flow-high{ background:var(--flow-high) }
.flow-none{ background:var(--flow-none) }

/* Rango (preview) */
.day.range{ box-shadow:0 0 0 3px rgba(232,67,147,.25) inset }

/* Decoración inicio/fin (bordes) */
.day.start-day{ box-shadow:0 0 0 3px rgba(232,67,147,.55), 0 10px 24px rgba(232,67,147,.18); border-color:#fda4af }
.day.end-day{   box-shadow:0 0 0 3px rgba(162,155,254,.55), 0 10px 24px rgba(162,155,254,.18); border-color:#c7d2fe }

.help{ color:var(--muted); font-size:.9rem; text-align:center; padding:6px 0 }

/* Responsivo */
@media (max-width:640px){
  .container > h1{ font-size:34px }
  .day{ min-height:100px }
}



/* ==== Leyenda ==== */
.legend { display:grid; gap:14px; }
.legend-title{ margin:0 0 6px; font-weight:800; font-size:1.05rem }
.legend-grid{
  display:grid; gap:14px;
  grid-template-columns: repeat(3, minmax(0,1fr));
}
.legend-group{ background:#fafafa; border:1px solid #eee; border-radius:12px; padding:12px }
.legend-sub{ font-weight:800; margin-bottom:8px; color:#374151; font-size:.95rem }
.legend-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin:6px 0 }

/* Muestras de flujo */
.legend-swatch{ display:inline-block; width:46px; height:12px; border-radius:7px; border:1px solid rgba(0,0,0,.08) }
.legend-swatch.none{  background:var(--flow-none) }
.legend-swatch.low{   background:var(--flow-low) }
.legend-swatch.mid{   background:var(--flow-mid) }
.legend-swatch.high{  background:var(--flow-high) }

/* “Hoy” */
.legend-badge-today{
  display:inline-block; padding:2px 8px; border-radius:999px;
  background:#fcfcff; border:2px dashed var(--secondary-color); font-weight:800; font-size:.8rem;
}

/* Emojis */
.emo{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
  background:#fff; border:1px solid #eee; box-shadow:0 1px 3px rgba(0,0,0,.04); font-weight:700; }
.emo b{ font-weight:800 }
@media (max-width:860px){ .legend-grid{ grid-template-columns:1fr } }



</style>
</head>
<body>
<div class="container">
  <h1>Regla Mochita</h1>
  <p class="subtitle">Flujo y ánimo se ponen <b>por día</b>. Rango es solo si quieres aplicar a varios días a la vez.</p>

  <!-- Toolbar -->
  <div class="toolbar card">
    <div class="left">
      <button class="pill" id="rangeToggle" aria-pressed="false">📏 Modo rango</button>
      <label style="font-weight:700;">Flujo para rango:</label>
      <select id="rangeFlow" class="pill">
        <option value="poco">poco</option>
        <option value="medio" selected>medio</option>
        <option value="mucho">mucho</option>
      </select>
      <button class="pill primary" id="applyRange" disabled>💾 Guardar rango</button>
      <button class="pill danger" id="clearRange" disabled>🗑️ Borrar rango</button>
    </div>
    <div class="right">
      <button class="pill" id="todayBtn">Hoy</button>
      <button class="pill danger" id="wipeAllBtn" title="Eliminar todos los registros">🧨 Eliminar TODO</button>
    </div>
  </div>


  <!-- Leyenda -->
<div class="card legend">
  <div class="legend-title">Leyenda</div>
  <div class="legend-grid">
    <!-- Flujo -->
    <div class="legend-group">
      <div class="legend-sub">Flujo</div>
      <div class="legend-row"><span class="legend-swatch none"></span> Sin</div>
      <div class="legend-row"><span class="legend-swatch low"></span> Poco</div>
      <div class="legend-row"><span class="legend-swatch mid"></span> Medio</div>
      <div class="legend-row"><span class="legend-swatch high"></span> Mucho</div>
    </div>

    <!-- Inicio / Fin / Hoy -->
    <div class="legend-group">
      <div class="legend-sub">Marcadores</div>
      <div class="legend-row">
        <span class="label-chip start">Inicio</span>
        <span class="label-chip end">Fin</span>
        <span class="legend-badge-today">Hoy</span>
      </div>
    </div>

    <!-- Emojis de ánimo -->
    <div class="legend-group">
      <div class="legend-sub">Ánimo (elige solo donde quieras)</div>
      <div class="legend-row" style="gap:8px">
        <span class="emo">😀 <b>feliz</b></span>
        <span class="emo">🙂 <b>normal</b></span>
        <span class="emo">😔 <b>triste</b></span>
        <span class="emo">😵‍💫 <b>estresada</b></span>
        <span class="emo">🥺 <b>sensible</b></span>
        <span class="emo">😴 <b>cansada</b></span>
        <span class="emo">😠 <b>irritable</b></span>
        <span class="emo">⚡ <b>con energía</b></span>
      </div>
    </div>
  </div>
</div>


  <div class="card">
    <div class="cal-head">
      <button class="arrow" id="prevBtn" aria-label="Mes anterior">‹</button>
      <div class="month-title" id="monthTitle">—</div>
      <button class="arrow" id="nextBtn" aria-label="Mes siguiente">›</button>
    </div>
    <div class="week"><div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div></div>
    <div class="grid" id="daysGrid"></div>
    <div class="help" id="rangeHelp" style="display:none;">Elige <b>inicio</b> y <b>fin</b> con un click.</div>
  </div>
</div>

<script>
// ------- Permisos -------
const CAN_EDIT = {{ 'true' if (session.get('username')=='mochita') else 'false' }};

// ------- Helpers -------
const $ = (s,p=document)=>p.querySelector(s);
const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));

// ------- Fechas -------
const MONTHS = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
const pad=n=>n<10?'0'+n:n;
const iso=(y,m,d)=>`${y}-${pad(m)}-${pad(d)}`;
const parseIso=s=>{const [Y,M,D]=s.split('-').map(Number); return new Date(Y,M-1,D);};
const addDays=(dt,n)=>{const d=new Date(dt); d.setDate(d.getDate()+n); return d;};
const toIsoDate=d=>iso(d.getFullYear(), d.getMonth()+1, d.getDate());
const daysInMonth=(y,m)=>new Date(y,m,0).getDate();
const firstWeekday=(y,m)=>{const js=new Date(y,m-1,1).getDay(); return (js+6)%7;};
const isToday=(y,m,d)=>{const t=new Date();return t.getFullYear()==y && t.getMonth()+1==m && t.getDate()==d;};

// ------- API -------
const API_LIST='/api/cycle';
const SAVE_DAY='/cycle/save';
const DEL_DAY='/cycle/delete';

// ------- Estado -------
const state = {
  y:(new Date()).getFullYear(),
  m:(new Date()).getMonth()+1,
  entries:{}, // { 'YYYY-MM-DD': {mood, flow} }
  range:{start:null,end:null},
  rangeMode:false
};

// ------- Opciones -------
const MOODS = ['feliz','normal','triste','estresada','sensible','cansada','irritable','con_energia'];
const MOOD_EMO = { feliz:'😀', normal:'🙂', triste:'😔', estresada:'😵‍💫', sensible:'🥺', cansada:'😴', irritable:'😠', con_energia:'⚡' };

// ------- Carga (3 meses centrados) -------
function ymPrev(y,m){ const d=new Date(y,m-2,1); return [d.getFullYear(), d.getMonth()+1]; }
async function loadMonth(){
  const [py, pm] = ymPrev(state.y, state.m);
  const from = `${py}-${pad(pm)}`;
  const url = `${API_LIST}?from=${from}&months=3&user=mochita`;
  try{
    const res = await fetch(url, {credentials:'same-origin'});
    const j = await res.json();
    const map={};
    (j.entries||[]).forEach(e=>{
      const day=(e.day||e.date||'').trim(); if(!day) return;
      map[day]={ mood:(e.mood||'')||'', flow:(e.flow||'')||'' };
    });
    state.entries = map;
  }catch(e){ state.entries = {}; }
  renderCalendar();
}

// ------- Render -------
function setMonthTitle(){ $('#monthTitle').textContent = `${MONTHS[state.m-1][0].toUpperCase()+MONTHS[state.m-1].slice(1)} ${state.y}`; }
function inPreviewRange(dayIso){ const {start,end}=state.range; return !!(start && end && dayIso>=start && dayIso<=end); }

function closeAllMenus(){
  $$('.day.show-flow-menu').forEach(d=>d.classList.remove('show-flow-menu'));
  $$('.day.show-emoji-menu').forEach(d=>d.classList.remove('show-emoji-menu'));
}

function renderCalendar(){
  setMonthTitle();
  const grid = $('#daysGrid'); grid.innerHTML='';
  const prev = firstWeekday(state.y, state.m);
  for(let i=0;i<prev;i++){ const d=document.createElement('div'); d.className='day muted'; grid.appendChild(d); }

  const DIM=daysInMonth(state.y,state.m);
  for(let d=1; d<=DIM; d++){
    const wrap=document.createElement('div'); wrap.className='day';
    if(isToday(state.y,state.m,d)) wrap.classList.add('today');
    const id = iso(state.y,state.m,d); wrap.dataset.iso = id;
    if(state.rangeMode && inPreviewRange(id)) wrap.classList.add('range');

    const entry = state.entries[id] || {};

    // --- Top: número + botón de emoji (solo si CAN_EDIT o ya hay mood) ---
    const top=document.createElement('div'); top.className='top';
    const num=document.createElement('div'); num.className='num'; num.textContent=d;

    const moodBtn=document.createElement('button');
    moodBtn.className='mood-btn';
    moodBtn.title = entry.mood ? 'Cambiar ánimo' : 'Añadir ánimo';
    moodBtn.textContent = entry.mood ? (MOOD_EMO[entry.mood]||'🙂') : '＋';
    if(!CAN_EDIT || state.rangeMode){
      // Mostrar emoji existente, pero sin permitir edición en modo rango o sin permisos
      if(entry.mood){ top.appendChild(num); top.appendChild(moodBtn); moodBtn.disabled = true; }
      else{ top.appendChild(num); }
    }else{
      // Editar libremente: aparece siempre para poder poner emoji solo donde quiera
      top.appendChild(num); top.appendChild(moodBtn);
      moodBtn.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        if(!CAN_EDIT) return;
        if(wrap.classList.contains('show-emoji-menu')){ wrap.classList.remove('show-emoji-menu'); return; }
        closeAllMenus(); wrap.classList.add('show-emoji-menu');
      });
    }

    // --- Chips Inicio/Fin bajo el número (no superponen) ---
    const labels=document.createElement('div'); labels.className='labels';
    const prevId = toIsoDate(addDays(parseIso(id), -1));
    const nextId = toIsoDate(addDays(parseIso(id), +1));
    const hasFlow = !!entry.flow;
    const prevFlow = !!(state.entries[prevId]?.flow);
    const nextFlowB = !!(state.entries[nextId]?.flow);
    if(hasFlow && !prevFlow){ const c=document.createElement('span'); c.className='label-chip start'; c.textContent='Inicio'; labels.appendChild(c); wrap.classList.add('start-day'); }
    if(hasFlow && !nextFlowB){ const c=document.createElement('span'); c.className='label-chip end';   c.textContent='Fin';    labels.appendChild(c); wrap.classList.add('end-day'); }

    // --- Barra de flujo (abre menú por día) ---
    const dot=document.createElement('div');
    dot.className='flow-dot ' + (
      entry.flow==='poco'  ? 'flow-low'  :
      entry.flow==='medio' ? 'flow-mid'  :
      entry.flow==='mucho' ? 'flow-high' : 'flow-none'
    );
    if(CAN_EDIT && !state.rangeMode){
      dot.title='Elegir flujo (por día)';
      dot.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        if(wrap.classList.contains('show-flow-menu')){ wrap.classList.remove('show-flow-menu'); return; }
        closeAllMenus(); wrap.classList.add('show-flow-menu');
      });
    }else{
      dot.style.cursor='default';
    }

    // --- Menú flujo (por día) ---
    const flowMenu=document.createElement('div'); flowMenu.className='menu flow-menu';
    flowMenu.innerHTML = `
      <div class="row">
        <button class="chip" data-flow="">Sin</button>
        <button class="chip" data-flow="poco">Poco</button>
        <button class="chip" data-flow="medio">Medio</button>
        <button class="chip" data-flow="mucho">Mucho</button>
      </div>`;
    flowMenu.querySelectorAll('[data-flow]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const val = btn.getAttribute('data-flow')||'';
        await saveOrDelete(id, entry.mood||'', val);
        wrap.classList.remove('show-flow-menu');
        renderCalendar();
      });
    });

    // --- Menú emoji (por día) ---
    const emojiMenu=document.createElement('div'); emojiMenu.className='menu emoji-menu';
    const emoChips = MOODS.map(k=>`<button class="chip" data-mood="${k}">${MOOD_EMO[k]} ${k.replace('_',' ')}</button>`).join('');
    emojiMenu.innerHTML = `
      <div class="row">
        ${emoChips}
        <button class="chip" data-mood="">Quitar</button>
      </div>`;
    emojiMenu.querySelectorAll('[data-mood]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const m = btn.getAttribute('data-mood')||'';
        await saveOrDelete(id, m, entry.flow||'');
        wrap.classList.remove('show-emoji-menu');
        renderCalendar();
      });
    });

    // --- Rango (clic en tarjeta) ---
    wrap.addEventListener('click', ()=>{
      if(!state.rangeMode) return;
      selectInRange(id);
    });

    wrap.appendChild(top);
    if(labels.children.length) wrap.appendChild(labels);
    wrap.appendChild(dot);
    wrap.appendChild(flowMenu);
    wrap.appendChild(emojiMenu);
    grid.appendChild(wrap);
  }

  const total = prev + DIM;
  const post = (7 - (total % 7)) % 7;
  for(let i=0;i<post;i++){ const d=document.createElement('div'); d.className='day muted'; grid.appendChild(d); }

  const hasSel = !!(state.range.start && state.range.end);
  $('#applyRange').disabled = !CAN_EDIT || !hasSel;
  $('#clearRange').disabled = !CAN_EDIT || !hasSel;
}

document.addEventListener('click', (e)=>{
  if(!e.target.closest('.day')) closeAllMenus();
});

// ------- Guardar / borrar -------
async function saveOneDay(dayIso, mood, flow){
  const payload = { for_user:'mochita', day:dayIso, mood:(mood||''), flow:(flow||'') };
  const res = await fetch(SAVE_DAY, {
    method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'},
    body: JSON.stringify(payload), credentials:'same-origin'
  });
  if(res.ok){ state.entries[dayIso] = { mood:(mood||''), flow:(flow||'') }; }
}

async function deleteOneDay(dayIso){
  const fd = new URLSearchParams(); fd.set('for_user','mochita'); fd.set('day',dayIso);
  const res = await fetch(DEL_DAY, { method:'POST', body:fd, credentials:'same-origin' });
  if(res.ok){ delete state.entries[dayIso]; }
}

// Si ambos vacíos => borrar; si no => guardar
async function saveOrDelete(dayIso, mood, flow){
  if(!CAN_EDIT) return;
  const mm=(mood||'').trim(), ff=(flow||'').trim();
  if(!mm && !ff){
    await deleteOneDay(dayIso);
  }else{
    await saveOneDay(dayIso, mm, ff);
  }
}

// ------- Rango (opcional) -------
function resetRange(){ state.range={start:null,end:null}; $('#rangeHelp').style.display='none'; renderCalendar(); }
function selectInRange(id){
  const {start,end}=state.range;
  if(!start){
  state.range.start=id;
  const h = $('#rangeHelp');
  h.style.display='block';
  h.innerHTML = `Inicio: <b>${id}</b>. Ahora navega al mes anterior/siguiente para elegir el fin.`;
}
  else if(!end){
    if(id < start){ state.range={start:id,end:start}; }
    else { state.range.end=id; }
  } else {
    state.range={start:id,end:null};
  }
  renderCalendar();
}
function isoList(a,b){
  const A=parseIso(a), B=parseIso(b); const out=[];
  for(let d=new Date(A); d<=B; d.setDate(d.getDate()+1)){ out.push(toIsoDate(d)); }
  return out;
}
async function applyRange(flowVal){
  const {start,end}=state.range; if(!start||!end) return;
  const days = isoList(start,end);
  for(const d of days){
    const existing = state.entries[d]||{};
    await saveOrDelete(d, existing.mood||'', flowVal||'');
  }
  resetRange();
}
async function clearRange(){
  const {start,end}=state.range; if(!start||!end) return;
  const days = isoList(start,end);
  for(const d of days){ await saveOrDelete(d, (state.entries[d]?.mood||''), ''); }
  resetRange();
}

// ------- Eliminar TODO -------
async function wipeAll(){
  if(!CAN_EDIT) return;
  const sure = confirm('¿Eliminar TODOS los registros del ciclo (todas las fechas) para Mochita?');
  if(!sure) return;
  const extra = confirm('Esta acción no se puede deshacer. ¿Confirmas eliminar TODO?');
  if(!extra) return;

  try{
    const res = await fetch(`${API_LIST}?from=2000-01&months=600&user=mochita`, {credentials:'same-origin'});
    const j = await res.json();
    const days = (j.entries||[]).map(e=>(e.day||e.date||'').trim()).filter(Boolean);
    for(const d of days){ await deleteOneDay(d); }
    alert('Listo: se eliminaron todos los registros.');
  }catch(e){
    alert('No se pudo eliminar todo.');
  }
  loadMonth();
}

// ------- Controles -------

function goMonth(delta){
  const dt = new Date(state.y, state.m - 1 + delta, 1);
  state.y = dt.getFullYear();
  state.m = dt.getMonth() + 1;

  // Si estoy en modo rango y ya elegí INICIO pero aún no FIN, NO borres la selección
  const keepRange = (state.rangeMode && state.range.start && !state.range.end);
  if(!keepRange){ resetRange(); }

  loadMonth(); // ya traes prev/actual/siguiente, así que el inicio sigue visible cuando toque
}

$('#prevBtn').addEventListener('click', ()=> goMonth(-1));
$('#nextBtn').addEventListener('click', ()=> goMonth(+1));
$('#todayBtn').addEventListener('click', ()=>{
  const t = new Date(); state.y=t.getFullYear(); state.m=t.getMonth()+1; resetRange(); loadMonth();
});

$('#rangeToggle').addEventListener('click', ()=>{
  if(!CAN_EDIT) return;
  state.rangeMode = !state.rangeMode;
  $('#rangeToggle').classList.toggle('primary', state.rangeMode);
  $('#rangeToggle').setAttribute('aria-pressed', String(state.rangeMode));
  $('#rangeHelp').style.display = state.rangeMode ? 'block' : 'none';
  if(!state.rangeMode) resetRange(); else renderCalendar();
});
$('#applyRange').addEventListener('click', ()=> applyRange($('#rangeFlow').value||'medio'));
$('#clearRange').addEventListener('click', ()=> clearRange());
$('#wipeAllBtn').addEventListener('click', wipeAll);

// Permisos
(function applyPermissions(){
  if(!CAN_EDIT){
    $('#rangeToggle').setAttribute('disabled','');
    $('#rangeFlow').setAttribute('disabled','');
    $('#applyRange').setAttribute('disabled','');
    $('#clearRange').setAttribute('disabled','');
    $('#wipeAllBtn').setAttribute('disabled','');
  }
})();

// ------- SSE live -------
try{
  const es = new EventSource('/events');
  es.addEventListener('cycle_update', (ev)=>{
    const j = JSON.parse(ev.data||'{}');
    if(!j.user || j.user==='mochita'){ loadMonth(); }
  });
}catch(e){ console.warn('SSE no disponible', e); }

// ------- Init -------
(function init(){
  const t=new Date(); state.y=t.getFullYear(); state.m=t.getMonth()+1;
  loadMonth();
})();
</script>
</body>
</html>
