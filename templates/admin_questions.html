<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Banco de Preguntas ‚Äî Admin</title>
  <style>
    :root {
      --brand: #e84393;
      --brand-2: #ff7ab6;
      --bg: #faf7fb;
      --card: #ffffff;
      --ink: #111827;
      --muted: #6b7280;
      --line: #ece8ef;
      --ok: #10b981;
      --warn: #f59e0b;
      --err: #ef4444;
      --inactive: #9ca3af;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif
    }

    .container {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 14px
    }

    /* Header */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 5;
      background: linear-gradient(#faf7fb, rgba(250, 247, 251, .8));
      backdrop-filter: saturate(1.2) blur(4px);
      border-bottom: 1px solid var(--line)
    }

    .topbar .inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 10px 14px;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between
    }

    h1 {
      font-size: 1.25rem;
      margin: 0;
      display: flex;
      gap: 8px;
      align-items: center
    }

    h1 .pill {
      font-size: .78rem;
      background: #f3f4f6;
      color: #111;
      padding: 3px 8px;
      border-radius: 999px
    }

    a.back {
      color: var(--brand);
      text-decoration: none;
      border-bottom: 1px dotted var(--brand)
    }

    a.back:hover {
      text-decoration: underline
    }

    /* Cards & controls */
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      margin: 14px 0;
      box-shadow: 0 6px 14px rgba(0, 0, 0, .04)
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    button,
    .btn {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      font-weight: 600
    }

    button.brand {
      background: var(--brand);
      color: #fff;
      border-color: var(--brand)
    }

    button.ghost {
      background: #fff
    }

    button.dark {
      background: #1f2937;
      color: #fff;
      border-color: #1f2937
    }

    button:disabled {
      opacity: .6;
      cursor: not-allowed
    }

    input[type=text],
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: #fff
    }

    textarea {
      min-height: 46px;
      resize: vertical
    }

    /* Filters */
    .toolbar {
      display: grid;
      gap: 10px
    }

    @media(min-width:880px) {
      .toolbar {
        grid-template-columns: 1fr auto
      }
    }

    .filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center
    }

    .chip {
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: #fff;
      color: #111;
      font-size: .875rem;
      cursor: pointer
    }

    .chip.active {
      border-color: var(--brand);
      box-shadow: 0 0 0 2px rgba(232, 67, 147, .12)
    }

    .chip[data-key="pending"].active {
      background: rgba(16, 185, 129, .08)
    }

    .chip[data-key="used"].active {
      background: rgba(245, 158, 11, .10)
    }

    .chip[data-key="inactive"].active {
      background: rgba(156, 163, 175, .12)
    }

    .meta {
      color: var(--muted);
      font-size: .92rem
    }

    /* Progress mini */
    .progress {
      height: 8px;
      background: #eee;
      border-radius: 999px;
      overflow: hidden
    }

    .progress>span {
      display: block;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--brand), var(--brand-2));
      transition: width .35s
    }

    /* Table */
    .table-wrap {
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 14px
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0
    }

    th,
    td {
      padding: 12px;
      border-bottom: 1px solid var(--line);
      text-align: left;
      vertical-align: top
    }

    thead th {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 2
    }

    tbody tr:hover {
      background: #fff6fb
    }

    td.id {
      white-space: nowrap;
      color: #374151;
      font-variant-numeric: tabular-nums
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: .78rem
    }

    .badge.ok {
      background: #ecfdf5;
      color: #065f46
    }

    .badge.warn {
      background: #fffbeb;
      color: #92400e
    }

    .badge.muted {
      background: #f3f4f6;
      color: #374151
    }

    .badge.inactive {
      background: #f3f4f6;
      color: #6b7280;
      text-decoration: line-through
    }

    .row-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap
    }

    small.time {
      color: var(--muted)
    }

    /* Checkbox styles */
    .check-col {
      width: 40px;
      text-align: center
    }

    input[type=checkbox].row-check {
      width: 18px;
      height: 18px;
      accent-color: var(--brand);
      cursor: pointer
    }

    /* Bulk Action Bar */
    .bulk-bar {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(150%);
      background: #111827;
      color: #fff;
      padding: 10px 20px;
      border-radius: 999px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 16px;
      z-index: 100;
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      opacity: 0;
    }

    .bulk-bar.visible {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .bulk-bar strong {
      margin-right: 8px;
    }

    /* Utilities */
    hr.sep {
      border: 0;
      height: 1px;
      background: var(--line);
      margin: 12px 0
    }

    .kbd {
      font-family: ui-monospace, Menlo, Consolas, monospace;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-bottom-width: 2px;
      border-radius: 6px;
      padding: 2px 6px
    }

    .right {
      margin-left: auto
    }

    .nowrap {
      white-space: nowrap
    }
  </style>
</head>

<body>

  <div class="topbar">
    <div class="inner">
      <div>
        <a class="back" href="/admin">‚Üê Volver al panel</a>
        <h1>Banco de Preguntas <span class="pill">Admin</span></h1>
      </div>
      <div class="nowrap meta">
        Total: <b id="count-total">{{ stats.total }}</b> ¬∑
        Pendientes: <b id="count-pending">{{ stats.pend }}</b> ¬∑
        Usadas: <b id="count-used">{{ stats.used }}</b>
      </div>
    </div>
  </div>

  <div class="container">

    <div class="card">
      <div class="actions">
        <form method="post" action="/admin/questions/rotate_now"><button class="brand">üîÑ Rotar pregunta de HOY</button>
        </form>
        <form method="post" action="/admin/questions/reset_used"><button class="ghost">‚ôªÔ∏è Resetear usadas</button>
        </form>
        <form method="post" action="/admin/questions/delete_all"
          onsubmit="return confirm('‚ö†Ô∏è Esto eliminar√° TODAS las preguntas del banco. ¬øSeguro?');">
          <button class="ghost">üóëÔ∏è Borrar todas</button>
        </form>
        <div class="right" style="min-width:200px">
          <div class="progress" title="Pendientes sobre total">
            <span id="progressBar" style="width:0%"></span>
          </div>
        </div>
      </div>
      <div class="meta">Consejo: selecciona varias casillas para borrar en lote.</div>
    </div>

    <div class="card">
      <div class="toolbar">
        <form method="post" action="/admin/questions" class="actions" onsubmit="return !!this.text.value.trim()">
          <input type="text" name="text" placeholder="Nueva pregunta‚Ä¶" required>
          <button class="brand" type="submit">‚ûï A√±adir</button>
        </form>
        <div class="filters">
          <span class="chip active" data-key="all">Todas</span>
          <span class="chip" data-key="pending">Pendientes</span>
          <span class="chip" data-key="used">Usadas</span>
          <span class="chip" data-key="inactive">Inactivas</span>
          <input id="q" type="text" placeholder="Buscar por texto o #id‚Ä¶" style="min-width:240px">
        </div>
      </div>

      <form method="post" action="/admin/questions/import" style="margin-top:12px">
        <textarea name="bulk" rows="3" placeholder="Pega preguntas (una por l√≠nea)"></textarea>
        <div class="actions" style="margin-top:8px">
          <button type="submit" class="ghost">üì• Importar en bloque</button>
        </div>
      </form>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th class="check-col"><input type="checkbox" id="selectAll" class="row-check"></th>
              <th style="width:80px">ID</th>
              <th>Pregunta</th>
              <th style="width:220px">Estado</th>
              <th style="width:260px">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
            <tr data-id="{{ r.id }}" data-used="{{ '1' if r.used else '0' }}"
              data-active="{{ '1' if r.active else '0' }}">
              <td class="check-col">
                <input type="checkbox" class="row-check item-check" value="{{ r.id }}">
              </td>

              <td class="id">#{{ r.id }}</td>

              <td>
                <form method="post" action="/admin/questions/{{ r.id }}/edit" class="edit-form"
                  style="display:grid;gap:6px">
                  <textarea name="text" oninput="autoSize(this)">{{ r.text }}</textarea>
                  <div class="row-actions">
                    <button type="submit" class="brand">Guardar</button>
                    <button type="button" class="ghost" onclick="copyText(this)">Copiar</button>
                  </div>
                </form>
              </td>

              <td>
                <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
                  {% if not r.active %}
                  <span class="badge inactive">Inactiva</span>
                  {% else %}
                  <span class="badge muted">Activa</span>
                  {% endif %}
                  {% if r.used %}
                  <span class="badge warn">Usada</span>
                  {% else %}
                  <span class="badge ok">Pendiente</span>
                  {% endif %}
                </div>
                {% if r.used_at %}
                <small class="time">Usada el {{ r.used_at[:16] }}</small>
                {% endif %}
              </td>

              <td class="nowrap">
                <div class="row-actions">
                  <form method="post" action="/admin/questions/{{ r.id }}/toggle_used">
                    <button type="submit" class="ghost">{{ 'Marcar pendiente' if r.used else 'Marcar usada' }}</button>
                  </form>

                  {% if r.active %}
                  <form method="post" action="/admin/questions/{{ r.id }}/delete"
                    onsubmit="return confirm('¬øDesactivar pregunta #{{ r.id }}?');">
                    <button type="submit" class="ghost">Desactivar</button>
                  </form>
                  {% endif %}
                </div>
                <form method="post" action="/admin/questions/{{ r.id }}/assign_tomorrow" style="margin-top:6px">
                  <button type="submit" class="ghost" style="width:100%" {% if (not r.active) or r.used %}disabled{%
                    endif %}>
                    üìÖ Poner ma√±ana
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <div class="bulk-bar" id="bulkBar">
    <span><strong id="selCount">0</strong> seleccionadas</span>

    <form id="bulkForm" method="post">
      <button type="submit" formaction="/admin/questions/bulk_delete" class="dark"
        onclick="return confirm('¬øDesactivar las preguntas seleccionadas? (Dejar√°n de salir en la ruleta)');">
        üí§ Desactivar
      </button>

      <button type="submit" formaction="/admin/questions/bulk_destroy" class="dark"
        style="background: #ef4444; border-color: #ef4444;"
        onclick="return confirm('‚ö†Ô∏è ¬øEst√°s seguro? Se ELIMINAR√ÅN DEFINITIVAMENTE de la base de datos.');">
        üóëÔ∏è Eliminar
      </button>
    </form>
  </div>
  <script>
    /* ---- UI helpers ---- */
    function autoSize(el) {
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight + 2) + 'px';
    }
    function copyText(btn) {
      const ta = btn.closest('form').querySelector('textarea');
      if (!ta) return;
      navigator.clipboard.writeText(ta.value).then(() => {
        btn.textContent = 'Copiado ‚úì';
        setTimeout(() => btn.textContent = 'Copiar', 900);
      }).catch(() => { btn.textContent = 'Error'; setTimeout(() => btn.textContent = 'Copiar', 900); });
    }

    document.querySelectorAll('textarea[name="text"]').forEach(autoSize);

    /* ---- Filters & search ---- */
    const chips = document.querySelectorAll('.chip');
    const q = document.getElementById('q');
    const rows = Array.from(document.querySelectorAll('#tbl tbody tr'));
    const countTotal = document.getElementById('count-total');
    const countPending = document.getElementById('count-pending');
    const countUsed = document.getElementById('count-used');
    const progressBar = document.getElementById('progressBar');

    function applyProgress() {
      const t = parseInt(countTotal.textContent || '0', 10);
      const p = parseInt(countPending.textContent || '0', 10);
      const pct = t ? Math.round((p / t) * 100) : 0;
      progressBar.style.width = pct + '%';
    }
    applyProgress();

    function activeFilterKey() {
      const act = document.querySelector('.chip.active');
      return act ? act.dataset.key : 'all';
    }

    function matchesRow(r, key, term) {
      const used = r.dataset.used === '1';
      const active = r.dataset.active === '1';
      if (key === 'pending' && used) return false;
      if (key === 'used' && !used) return false;
      if (key === 'inactive' && active) return false;

      if (term) {
        const idText = r.dataset.id || '';
        const text = r.querySelector('textarea')?.value || '';
        const t = term.toLowerCase();
        if (!('#' + idText).includes(term) && !text.toLowerCase().includes(t)) return false;
      }
      return true;
    }

    function refreshTable() {
      const key = activeFilterKey();
      const term = (q.value || '').trim();
      let vis = 0, pend = 0, used = 0;
      rows.forEach(r => {
        const show = matchesRow(r, key, term);
        r.style.display = show ? '' : 'none';
        if (show) {
          vis++;
          if (r.dataset.used === '1') used++; else pend++;
        }
      });
      document.getElementById('count-used').textContent = used;
      document.getElementById('count-pending').textContent = pend;
      document.getElementById('count-total').textContent = vis;
      applyProgress();

      // Limpiar selecci√≥n al filtrar para evitar borrar cosas invisibles
      clearSelection();
    }

    chips.forEach(c => c.addEventListener('click', () => {
      chips.forEach(x => x.classList.remove('active'));
      c.classList.add('active');
      refreshTable();
    }));
    q.addEventListener('input', refreshTable);

    /* ---- BULK ACTIONS LOGIC ---- */
    const selectAll = document.getElementById('selectAll');
    const itemChecks = document.querySelectorAll('.item-check');
    const bulkBar = document.getElementById('bulkBar');
    const selCount = document.getElementById('selCount');
    const bulkForm = document.getElementById('bulkForm');

    function updateBulkUI() {
      const checked = document.querySelectorAll('.item-check:checked');
      const count = checked.length;
      selCount.textContent = count;

      if (count > 0) {
        bulkBar.classList.add('visible');
      } else {
        bulkBar.classList.remove('visible');
        selectAll.checked = false;
      }
    }

    function clearSelection() {
      itemChecks.forEach(ch => ch.checked = false);
      updateBulkUI();
    }

    // Handle "Select All"
    selectAll.addEventListener('change', (e) => {
      const isChecked = e.target.checked;
      // Solo selecciona las visibles
      rows.forEach(r => {
        if (r.style.display !== 'none') {
          const ck = r.querySelector('.item-check');
          if (ck) ck.checked = isChecked;
        }
      });
      updateBulkUI();
    });

    // Handle individual selection (con Shift+Click b√°sico)
    let lastChecked = null;
    itemChecks.forEach(chk => {
      chk.addEventListener('click', (e) => {
        if (e.shiftKey && lastChecked) {
          let start = Array.from(itemChecks).indexOf(chk);
          let end = Array.from(itemChecks).indexOf(lastChecked);
          const slice = Array.from(itemChecks).slice(Math.min(start, end), Math.max(start, end) + 1);
          slice.forEach(c => {
            // Solo marca si la fila es visible
            if (c.closest('tr').style.display !== 'none') c.checked = lastChecked.checked;
          });
        }
        lastChecked = chk;
        updateBulkUI();
      });
    });

    // Prepare form submission
    bulkForm.addEventListener('submit', (e) => {
      // Limpiamos inputs viejos ocultos si hubiera
      bulkForm.querySelectorAll('input[name="ids"]').forEach(i => i.remove());

      const checked = document.querySelectorAll('.item-check:checked');
      if (checked.length === 0) {
        e.preventDefault();
        return;
      }

      // Inyectamos IDs en el form
      checked.forEach(c => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'ids';
        input.value = c.value;
        bulkForm.appendChild(input);
      });
    });

    refreshTable();
  </script>
</body>

</html>