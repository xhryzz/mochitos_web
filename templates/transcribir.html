<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Transcribir audio ‚Äî Scribe (ElevenLabs)</title>
<link rel="icon" href="/static/favicon.ico" />
<style>
:root{ --brand:#e84393; --ink:#202124; --muted:#5f6368; --bg:#fafafa; --card:#fff; --line:#ececec; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.container{max-width:960px;margin:24px auto;padding:0 16px}
h1{font-size:1.6rem;margin:0 0 12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin:14px 0;box-shadow:0 2px 10px rgba(0,0,0,.03)}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
input[type="text"],select{padding:10px;border:1px solid var(--line);border-radius:10px;width:100%;max-width:360px}
input[type="file"]{padding:6px}
button{padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
button.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
button:disabled{opacity:.6;cursor:not-allowed}
.badge{display:inline-block;font-size:.8rem;padding:4px 10px;border-radius:999px;background:#f3f4f6;margin-left:8px}
.grid{display:grid;gap:16px}
@media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
pre{white-space:pre-wrap;background:#111;color:#eee;padding:12px;border-radius:12px;min-height:180px}
.small{font-size:.9rem;color:var(--muted)}
label{display:flex;align-items:center;gap:8px}
</style>
</head>
<body>
  <div class="container">
    <h1>üéß Transcribir audio con Scribe</h1>
    <div class="card">
      <div class="row" style="gap:14px">
        <div>
          <label><b>Archivo</b><br><input id="audioFile" type="file" accept="audio/*,video/*" /></label>
        </div>
        <div style="flex:1;min-width:260px">
          <label><b>‚Ä¶o URL</b><br><input id="audioUrl" type="text" placeholder="https://ejemplo.com/audio.mp3" /></label>
          <div class="small">Si indicas URL, el archivo del input se ignora.</div>
        </div>
        <div>
          <label><input id="diarize" type="checkbox" checked /> Diarizar (identificar hablantes)</label>
          <label><input id="tagEvents" type="checkbox" checked /> Etiquetar eventos (risas, aplausos‚Ä¶)</label>
        </div>
        <div>
          <label><b>Idioma</b><br>
            <select id="lang">
              <option value="auto" selected>Detectar autom√°ticamente</option>
              <option value="spa">Espa√±ol (spa)</option>
              <option value="eng">Ingl√©s (eng)</option>
              <option value="fra">Franc√©s (fra)</option>
              <option value="deu">Alem√°n (deu)</option>
              <option value="por">Portugu√©s (por)</option>
              <option value="ita">Italiano (ita)</option>
            </select>
          </label>
        </div>
      </div>
      <div class="row" style="gap:10px;margin-top:8px">
        <button id="btnGo" class="primary">Transcribir</button>
        <button id="btnDlSrt" disabled>Descargar SRT</button>
        <a href="/" style="margin-left:auto">‚Üê Volver</a>
      </div>
      <div class="small">Model: <code>scribe_v1</code> (ElevenLabs)</div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>üìù Texto</h3>
        <pre id="txt">‚Äî</pre>
      </div>
      <div class="card">
        <h3>üî§ Subt√≠tulos (SRT)</h3>
        <pre id="srt">‚Äî</pre>
      </div>
    </div>
  </div>

<script>
const $ = sel => document.querySelector(sel);
const txt = $("#txt"), srt = $("#srt"), btn = $("#btnGo"), btnSrt = $("#btnDlSrt");

btn.onclick = async () => {
  try {
    btn.disabled = true; btn.textContent = "Transcribiendo‚Ä¶";
    txt.textContent = "Procesando‚Ä¶"; srt.textContent = "Procesando‚Ä¶"; btnSrt.disabled = true;

    const url = $("#audioUrl").value.trim();
    const diarize = $("#diarize").checked;
    const tag = $("#tagEvents").checked;
    const language_code = $("#lang").value;

    let res;
    if (url) {
      res = await fetch("/api/transcribe", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ url, diarize, tag_audio_events: tag, language_code })
      });
    } else {
      const file = $("#audioFile").files[0];
      if (!file) { alert("Selecciona un archivo o pon una URL"); btn.disabled=false; btn.textContent="Transcribir"; return; }
      const fd = new FormData();
      fd.append("audio", file);
      fd.append("diarize", String(diarize));
      fd.append("tag_audio_events", String(tag));
      fd.append("language_code", language_code);
      res = await fetch("/api/transcribe", { method:"POST", body: fd });
    }

    const j = await res.json().catch(()=>({}));
    if (!j.ok) {
      txt.textContent = ""; srt.textContent = "";
      alert("Error: " + (j.error || "desconocido"));
      return;
    }
    txt.textContent = j.text || "";
    srt.textContent = (j.srt && j.srt.trim()) ? j.srt : "‚Äî (no hay palabras con timestamps; descarga solo el texto)";
    btnSrt.disabled = !(j.srt && j.srt.trim());
    btnSrt.onclick = () => {
      const blob = new Blob([j.srt], { type: "text/plain;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = (j.meta?.filename ? j.meta.filename.replace(/\.[^/.]+$/, "") : "transcripcion") + ".srt";
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
    };
  } catch (e) {
    alert("Fallo en cliente: " + e);
  } finally {
    btn.disabled = false; btn.textContent = "Transcribir";
  }
};
</script>
</body>
</html>
