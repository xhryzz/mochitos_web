<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medallas & Puntos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
  <style>
    body{
      font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:linear-gradient(135deg,#ffe8f3 0%,#dfe6e9 100%);
      margin:0;
      color:#222;
    }
    .wrap{max-width:1100px;margin:30px auto;padding:0 16px;}
    h1{font-family:'Playfair Display',serif;font-weight:900;margin:0 0 8px 0}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;}
    .card{background:white;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.08);padding:18px;}
    .btn{display:inline-block;padding:10px 14px;border-radius:12px;background:#e84393;color:white;text-decoration:none;border:none;cursor:pointer;font-family:inherit;font-size:14px;}
    .ach{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;}
    .achievements-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:12px;
  margin-bottom:16px;
}
.ach-col{
  background:rgba(255,255,255,0.9);
  border-radius:16px;
  padding:10px 12px;
  box-shadow:0 8px 24px rgba(0,0,0,0.06);
}
.ach-col h3{
  margin:0 0 6px;
  font-size:0.98rem;
}
.ach-col ul{
  list-style:none;
  margin:0;
  padding:0;
}
.ach-col li{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:0.9rem;
  margin:2px 0;
}
.ach-col li span.icon{
  font-size:1.1rem;
}
.ach-col li time{
  margin-left:auto;
  font-size:0.78rem;
  color:#6b7280;
}

/* Historial de puntos */
#historial-puntos .card{
  padding:10px 12px;
}
#historial-puntos table{
  width:100%;
  border-collapse:collapse;
  font-size:0.9rem;
}
#historial-puntos th,
#historial-puntos td{
  padding:6px 8px;
  text-align:left;
}
#historial-puntos tbody tr:nth-child(odd){
  background:rgba(255,255,255,0.7);
}
.delta-pos{color:#15803d;font-weight:600;}
.delta-neg{color:#b91c1c;font-weight:600;}
.badge-source{
  display:inline-flex;
  align-items:center;
  padding:2px 8px;
  border-radius:999px;
  font-size:0.75rem;
  background:#e5e7eb;
}

  </style>
</head>
<body>
  <div class="wrap">

    <!-- CABECERA + BOT√ìN VISTA ADMIN -->
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
      <div>
        <h1>üèÖ Medallas & Puntos</h1>
        <div style="color:#666">Tus logros, rachas y el ranking entre nosotros.</div>
      </div>

      {% if is_admin %}
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
          <form method="post" style="margin:0;">
            <input type="hidden" name="_op" value="toggle_admin">
            <button type="submit" class="btn" style="background:#2d3436;">
              {% if show_admin %}Ocultar vista admin{% else %}Ver vista admin{% endif %}
            </button>
          </form>
          <a class="btn" href="/tienda">Ir a la tienda</a>
        </div>
      {% else %}
        <div>
          <a class="btn" href="/tienda">Ir a la tienda</a>
        </div>
      {% endif %}
    </div>

        <!-- PANEL ADMIN (SOLO MOCHITO + VISTA ACTIVADA) -->
    {% if is_admin and show_admin %}
      <h2 style="margin:32px 0 8px;">‚öôÔ∏è Admin medallas</h2>
      <div class="card">
        <p style="margin-top:0;color:#555;font-size:14px;">
          Aqu√≠ puedes decidir cu√°ntos puntos da cada medalla cuando se desbloquea.
        </p>

        <form method="post">
          <input type="hidden" name="_op" value="update_points">

          <div style="overflow-x:auto;">
            <table style="width:100%;border-collapse:collapse;font-size:14px;">
              <thead>
                <tr style="border-bottom:1px solid #eee;">
                  <th style="text-align:left;padding:6px 4px;">ID</th>
                  <th style="text-align:left;padding:6px 4px;">C√≥digo</th>
                  <th style="text-align:left;padding:6px 4px;">T√≠tulo</th>
                  <th style="text-align:left;padding:6px 4px;">Descripci√≥n</th>
                  <th style="text-align:right;padding:6px 4px;">Puntos al conseguir</th>
                </tr>
              </thead>
              <tbody>
                {% for a in ach_admin %}
                  <tr style="border-bottom:1px solid #f3f3f3;">
                    <td style="padding:6px 4px;">{{ a.id }}</td>
                    <td style="padding:6px 4px;"><code>{{ a.code }}</code></td>
                    <td style="padding:6px 4px;">{{ a.title }}</td>
                    <td style="padding:6px 4px;color:#666;max-width:260px;">
                      {{ a.description or '' }}
                    </td>
                    <td style="padding:6px 4px;text-align:right;white-space:nowrap;">
                      <input
                        type="number"
                        name="points_{{ a.id }}"
                        value="{{ a.points_on_award or 0 }}"
                        step="1"
                        style="width:80px;padding:4px 6px;border-radius:8px;border:1px solid #ddd;text-align:right;"
                      >
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <button type="submit" class="btn" style="margin-top:12px;">
            Guardar puntos
          </button>
        </form>
      </div>

      <!-- NUEVA TARJETA: OTORGAR MEDALLAS MANUALMENTE -->
      <div class="card" style="margin-top:16px;">
        <p style="margin-top:0;color:#555;font-size:14px;">
          Aqu√≠ puedes otorgar manualmente cualquier medalla a cualquier usuario.
          Al concederla se sumar√°n autom√°ticamente los <b>puntos al conseguir</b> que hayas configurado arriba.
        </p>

        <form method="post" style="display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;">
          <input type="hidden" name="_op" value="grant_manual">

          <div style="min-width:180px;">
            <label style="font-size:13px;color:#555;display:block;margin-bottom:4px;">Usuario</label>
            <select name="to_user" style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #ddd;">
              {% for u in admin_users %}
                <option value="{{ u.username }}">{{ u.username }} ({{ u.points }} pts)</option>
              {% endfor %}
            </select>
          </div>

          <div style="min-width:220px;">
            <label style="font-size:13px;color:#555;display:block;margin-bottom:4px;">Medalla</label>
            <select name="achievement_id" style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #ddd;">
              {% for a in ach_admin %}
                <option value="{{ a.id }}">[{{ a.id }}] {{ a.title }}</option>
              {% endfor %}
            </select>
          </div>

          <button type="submit" class="btn">
            Otorgar medalla
          </button>
        </form>

        <p style="margin-top:8px;color:#888;font-size:12px;">
          Si la medalla tiene <code>grant_both = TRUE</code>, tambi√©n se dar√° autom√°ticamente al otro usuario.
        </p>
      </div>
    {% endif %}


    <!-- ESTAD√çSTICAS -->
    <div class="grid" style="margin-top:24px">
      <div class="card">
        <div style="font-size:14px;color:#888;">Puntos</div>
        <div id="pts" style="font-size:38px;font-weight:800;line-height:1.1;">‚Äî</div>
      </div>
      <div class="card">
        <div style="font-size:14px;color:#888;">Racha actual</div>
        <div id="streak" style="font-size:38px;font-weight:800;">‚Äî</div>
        <div style="color:#888;">d√≠as seguidos</div>
      </div>
      <div class="card">
        <div style="font-size:14px;color:#888;">Primeras respuestas</div>
        <div id="firsts" style="font-size:38px;font-weight:800;">‚Äî</div>
      </div>
      <div class="card">
        <div style="font-size:14px;color:#888;">D√≠as totales</div>
        <div id="days" style="font-size:38px;font-weight:800;">‚Äî</div>
      </div>
    </div>

    <h2 style="margin:24px 0 8px;">Tus medallas</h2>
    <div id="medallas-list" class="ach"></div>

    <h2 style="margin:28px 0 8px;">Ranking</h2>
    <div id="ranking" class="grid"></div>
    <section id="logros-historial">
      <h2 style="margin:32px 0 8px;">üèÖ Logros conseguidos</h2>
      <div id="logros-usuarios" class="achievements-grid"></div>
  
      <h2 style="margin:32px 0 8px;">üìú Historial de puntos</h2>
      <div id="historial-puntos"></div>
    </section>
  </div>

  <script>
    fetch('/api/medallas/summary')
      .then(r => r.json())
      .then(d => {
        // --- CABECERA / ESTAD√çSTICAS ---
        document.getElementById('pts').textContent     = d.points;
        document.getElementById('streak').textContent  = d.streak;
        document.getElementById('firsts').textContent  = d.first_count;
        document.getElementById('days').textContent    = d.total_days;
  
        // --- TUS MEDALLAS ---
        const wrap = document.getElementById('medallas-list');
        wrap.innerHTML = '';
        d.achievements.forEach(a => {
          const card = document.createElement('div');
          card.className = 'card';
          card.style.display = 'flex';
          card.style.gap = '12px';
          card.style.alignItems = 'center';
  
          const icon = document.createElement('div');
          icon.style.fontSize = '28px';
          icon.textContent = a.icon || 'üèÖ';
  
          const info = document.createElement('div');
          const title = document.createElement('div');
          title.style.fontWeight = '700';
          title.textContent = a.title;
  
          const desc = document.createElement('div');
          desc.style.color = '#666';
          desc.style.fontSize = '0.95rem';
          desc.textContent = a.description || '';
  
          const chip = document.createElement('div');
          chip.textContent = a.earned ? 'Conseguida' : 'Pendiente';
          chip.style.cssText = 'margin-top:6px;display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;'
            + (a.earned
               ? 'background:#e8fff1;color:#0a8f3f;'
               : 'background:#fff4f4;color:#cc1e3f;');
  
          info.appendChild(title);
          info.appendChild(desc);
          info.appendChild(chip);
  
          card.appendChild(icon);
          card.appendChild(info);
          wrap.appendChild(card);
        });
  
        // --- RANKING ---
        const rk = document.getElementById('ranking');
        rk.innerHTML = '';
        d.ranking.forEach((r,i) => {
          const li = document.createElement('div');
          li.className = 'card';
          li.style.display = 'flex';
          li.style.justifyContent = 'space-between';
          li.style.alignItems = 'center';
          li.innerHTML =
            `<div><strong>#${i+1}</strong> ${r.username}</div>` +
            `<div style="font-weight:800">${r.points} pts</div>`;
          rk.appendChild(li);
        });
  
        // --- LOGROS CONSEGUIDOS POR CADA UNO ---
        const logrosWrap = document.getElementById('logros-usuarios');
        if (logrosWrap) {
          logrosWrap.innerHTML = '';
  
          const earned = d.earned_by_user || {};
          const users  = ['mochito','mochita'];
  
          users.forEach(u => {
            const lista = earned[u] || [];
            const col   = document.createElement('div');
            col.className = 'ach-col';
  
            const title = document.createElement('h3');
            title.textContent = (u === d.user) ? 'T√∫' : u;
            col.appendChild(title);
  
            const ul = document.createElement('ul');
            if (!lista.length) {
              const li = document.createElement('li');
              li.textContent = 'Sin logros todav√≠a.';
              ul.appendChild(li);
            } else {
              lista.forEach(item => {
                const li   = document.createElement('li');
                const icon = document.createElement('span');
                icon.className = 'icon';
                icon.textContent = item.icon || 'üèÖ';
  
                const txt = document.createElement('span');
                txt.textContent = item.title;
  
                const t = document.createElement('time');
                if (item.earned_at) {
                  t.textContent = item.earned_at.replace('T',' ').slice(0,16);
                }
  
                li.appendChild(icon);
                li.appendChild(txt);
                li.appendChild(t);
                ul.appendChild(li);
              });
            }
  
            col.appendChild(ul);
            logrosWrap.appendChild(col);
          });
        }
  
        // --- HISTORIAL DE PUNTOS ---
        const histWrap = document.getElementById('historial-puntos');
        if (histWrap) {
          const hist = d.points_history || [];
  
          function labelSource(src){
          switch(src){
            case 'daily':        return 'Pregunta del d√≠a';
            case 'daily_first':  return 'Pregunta del d√≠a (primero)';
            case 'admin':        return 'Admin';
            case 'achievement':  return 'Logro';
            case 'shop':         return 'Tienda';
            case 'wheel':        return 'Ruleta diaria';  // ‚¨ÖÔ∏è NUEVO
            default:             return src || '';
          }
        }
  
          if (!hist.length) {
            histWrap.innerHTML =
              '<div class="card"><p class="helper">Sin movimientos de puntos todav√≠a.</p></div>';
          } else {
            let html = '<div class="card"><table><thead><tr>'
                     + '<th>Fecha</th><th>Qui√©n</th><th>Detalle</th><th>Origen</th><th>Puntos</th>'
                     + '</tr></thead><tbody>';
  
            hist.forEach(row => {
              const ts    = (row.created_at || '').replace('T',' ').slice(0,16);
              const src   = labelSource(row.source);
              const note  = row.note || '';
              const delta = parseInt(row.delta, 10) || 0;
              const cls   = delta >= 0 ? 'delta-pos' : 'delta-neg';
              const sign  = delta > 0 ? '+' : '';
  
              html += '<tr>'
                   +  `<td>${ts}</td>`
                   +  `<td>${row.username}</td>`
                   +  `<td>${note}</td>`
                   +  `<td><span class="badge-source">${src}</span></td>`
                   +  `<td class="${cls}">${sign}${delta}</td>`
                   +  '</tr>';
            });
  
            html += '</tbody></table></div>';
            histWrap.innerHTML = html;
          }
        }
      });
  </script>
  
</body>
</html>